<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 132 &ndash; ERROR:  duplicate key value violates unique constraint &quot;sl_nodelock-pkey&quot;</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=132&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=132">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=132">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=132">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_slon bz_bug_132">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;132</p>
    </td>

    <td id="subtitle">
      <p class="subheader">ERROR:  duplicate key value violates unique constraint &quot;sl_nodelock-pkey&quot;</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2010-08-27 12:23:48 PDT</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=132" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2010-08-27 12:23:48">
  <input type="hidden" name="longdesclength" value="3">
  <input type="hidden" name="id" value="132">
  <input type="hidden" name="token" value="1348807302-8691a24d48700171205b042074b2de0a">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=132">
        <b>Bug&nbsp;132</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">ERROR:  duplicate key value violates unique constraint &quot;sl_nodelock-pkey&quot;</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>ERROR:  duplicate key value violates unique constraint &quot;sl_nodelock-pkey&quot;
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('ERROR:  duplicate key value violates unique constraint \"sl_nodelock-pkey\"', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>slon
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>2.0
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">PC
       Linux
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>medium
       normal
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Steve Singer</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=132&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=132">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2010-06-01 08:03 PDT by <span class="vcard"><span class="fn">Steve Singer</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2010-08-27 12:23 PDT 
      (<a href="show_activity.cgi?id=132">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>1 
          user
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" >http://bugs.slony.info/bugzilla/show_bug.cgi?id=81</td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="2">
      <a href="attachment.cgi?bugid=132&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=132&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 3;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=132#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-06-01 08:03:52 PDT
        </span>
      </div>



<pre class="bz_comment_text" >A slon exitted with 

&quot;_disorder_replica&quot;.cleanupNodelock(); insert into
&quot;_disorder_replica&quot;.sl_nodelock values (    4, 0,
&quot;pg_catalog&quot;.pg_backend_pid()); &quot; - ERROR:  duplicate key value violates unique
constraint &quot;sl_nodelock-pkey&quot;


What appears to have happened is that following a move set the slon called
slon_retry() and exitted and was restarted  The restarted slon did some
processing and eventually encountered the above error.

At this stage I can't say if the bug is:

1) The first slon instance exitted without cleaning up
2) The second slon instance should have cleaned up after the first (check if
the backend is still alive and if not delete the row)
3) something else




2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG enableSubscription: sub_set=2
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - subscription is
complete:2010-06-01 10:34:17 EDTCONFIG enableSubscription: sub_set=2
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTWARN   remoteWorker_wakeup: node 3 - no worker thread
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG2 sched_wakeup_node(): no_id=3 (0 threads + worker signaled)
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG main: last local event sequence = 5000000002
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG main: configuration complete - starting threads
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   localListenThread: thread starts
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG version for &quot;dbname=test4 host=localhost user=slony
password=slony&quot; is 80309
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG1 local_listen &quot;dbname=test4 host=localhost user=slony
password=slony&quot;: backend pid = 4464
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG slon: worker process created - pid = 4460
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTFATAL  localListenThread: &quot;select
&quot;_disorder_replica&quot;.cleanupNodelock(); insert into
&quot;_disorder_replica&quot;.sl_nodelock values (    4, 0,
&quot;pg_catalog&quot;.pg_backend_pid()); &quot; - ERROR:  duplicate key value violates unique
constraint &quot;sl_nodelock-pkey&quot;
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG2 slon_abort() from pid=4460
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   slon: shutdown requested
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   slon: notify worker process to shutdown
2010-06-01 10:34:17,448 [db4stderr] ERROR
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - NOTICE: 
Slony-I: cleanup stale sl_nodelock entry for pid=4072
2010-06-01 10:34:37,450 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:37 EDTINFO   slon: child termination timeout - kill child
2010-06-01 10:34:37,450 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:37 EDTCONFIG slon: child terminated status: 9; pid: 4460, current worker
pid: 4460
2010-06-01 10:34:37,450 [db4 stdout] INFO 
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - abnormal
termination of slon2010-06-01 10:34:37 EDTCONFIG slon: child terminated status:
9; pid: 4460, current worker pid: 4460
2010-06-01 10:34:37,450 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:37 EDTINFO   slon: done



2010-06-01 10:34:17,412 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG remoteWorkerThread_5: update provider configuration
2010-06-01 10:34:17,412 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   remoteWorkerThread_5: thread done
2010-06-01 10:34:17,412 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG1 cleanupThread: thread done
2010-06-01 10:34:17,412 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG main: done
2010-06-01 10:34:17,412 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG slon: child terminated status: 0; pid: 3974, current worker
pid: 3974
2010-06-01 10:34:17,413 [db4 stdout] INFO 
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - abnormal
termination of slon2010-06-01 10:34:17 EDTCONFIG slon: child terminated status:
0; pid: 3974, current worker pid: 3974
2010-06-01 10:34:17,413 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG slon: restart of worker
2010-06-01 10:34:17,413 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG main: slon version 2.0.3 starting up
2010-06-01 10:34:17,413 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   slon: watchdog process started



2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG enableSubscription: sub_set=2
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - subscription is
complete:2010-06-01 10:34:17 EDTCONFIG enableSubscription: sub_set=2
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTWARN   remoteWorker_wakeup: node 3 - no worker thread
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG2 sched_wakeup_node(): no_id=3 (0 threads + worker signaled)
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG main: last local event sequence = 5000000002
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG main: configuration complete - starting threads
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   localListenThread: thread starts
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG version for &quot;dbname=test4 host=localhost user=slony
password=slony&quot; is 80309
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG1 local_listen &quot;dbname=test4 host=localhost user=slony
password=slony&quot;: backend pid = 4464
2010-06-01 10:34:17,433 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTCONFIG slon: worker process created - pid = 4460
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTFATAL  localListenThread: &quot;select
&quot;_disorder_replica&quot;.cleanupNodelock(); insert into
&quot;_disorder_replica&quot;.sl_nodelock values (    4, 0,
&quot;pg_catalog&quot;.pg_backend_pid()); &quot; - ERROR:  duplicate key value violates unique
constraint &quot;sl_nodelock-pkey&quot;
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTDEBUG2 slon_abort() from pid=4460
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   slon: shutdown requested
2010-06-01 10:34:17,447 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:17 EDTINFO   slon: notify worker process to shutdown
2010-06-01 10:34:17,448 [db4stderr] ERROR
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - NOTICE: 
Slony-I: cleanup stale sl_nodelock entry for pid=4072
2010-06-01 10:34:37,450 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:37 EDTINFO   slon: child termination timeout - kill child
2010-06-01 10:34:37,450 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:37 EDTCONFIG slon: child terminated status: 9; pid: 4460, current worker
pid: 4460
2010-06-01 10:34:37,450 [db4 stdout] INFO 
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - abnormal
termination of slon2010-06-01 10:34:37 EDTCONFIG slon: child terminated status:
9; pid: 4460, current worker pid: 4460
2010-06-01 10:34:37,450 [db4 stdout] DEBUG
info.slony.clustertest.testcoordinator.slony.SlonLauncher db4 - 2010-06-01
10:34:37 EDTINFO   slon: done</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=132#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-03 10:51:05 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I've seen this happen some more often.

I think the following is happening.

-a slon_retry() method is called following the move set
-slon_retry signals the parent slon process which in turn sends a kill to the
child
-The child exits, I can find no 'cleanup' process that the child runs on a kill
to ensure the postgresql connections are closed or to remove entries from
sl_nodelock
-The child is restarted by the parent.
-The child calls cleanupNodelock() which checks to see if the pid for the
backend registered with sl_nodelock is still around.  I think sometimes the old
backend process is still around (hasn't yet exited) maybe because it is in the
middle of a query and hasn't yet noticed that the slon it is talking to has
gone away
-Since the backend process is still around the row isn't deleted from
sl_nodelock causing the insert into sl_nodelock to fail.

Since I've seen thsi happen more than an isolated incident and it causes the
watchdog to exit as well I am bumping the priority.

Options to fix this include
1) Having a the slon worker properly exit and remove itself from the
sl_nodelock table before exiting
2) Increase the 'sleep' time before restarting the child.  This doesn't really
fix the problem it just makes it less likely</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=132#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-27 12:23:48 PDT
        </span>
      </div>



<pre class="bz_comment_text" >This has been committed to REL_2_0_STABLE and master</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=132">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=132">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=132">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=132" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>