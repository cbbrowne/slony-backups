<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 67 &ndash; Array overrun in logtrigger()</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=67&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=67">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=67">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=67">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_trigger_SPI bz_bug_67">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;67</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Array overrun in logtrigger()</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2010-08-18 12:06:38 PDT</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=67" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2010-08-18 12:06:38">
  <input type="hidden" name="longdesclength" value="9">
  <input type="hidden" name="id" value="67">
  <input type="hidden" name="token" value="1399003411-ed14851ec4152fbbf129c4f7b8e91372">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=67">
        <b>Bug&nbsp;67</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Array overrun in logtrigger()</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>Array overrun in logtrigger()
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('Array overrun in logtrigger()', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>trigger SPI
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">All
       All
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>high
       normal
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Slony Bugs List</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=67&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=67">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2008-12-14 02:10 PST by <span class="vcard"><span class="fn">Adam Buraczewski</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2010-08-18 12:06 PDT 
      (<a href="show_activity.cgi?id=67">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>4 
          users
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="devrim">devrim</option>
                <option value="fkieling">fkieling</option>
                <option value="slony1-bugs">slony1-bugs</option>
                <option value="tbe">tbe</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>


      <tr class="">
        <td valign="top">
            <a name="a1" href="attachment.cgi?id=24"
               title="View the content of the attachment">
          <b>A simple patch to detect the end of attkind string.</b></a>

          <span class="bz_attach_extra_info">
              (459 bytes,
                patch)

            <br>
            <a href="#attach_24"
               title="Go to the comment associated with the attachment">2008-12-14 02:10 PST</a>,
<span class="vcard"><span class="fn">Adam Buraczewski</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=24&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=24&amp;action=diff">Diff</a>
        </td>
      </tr>
      <tr class="">
        <td valign="top">
            <a name="a2" href="attachment.cgi?id=25"
               title="View the content of the attachment">
          <b>Modification to test1 to try to exercise attkind bug</b></a>

          <span class="bz_attach_extra_info">
              (7.83 KB,
                patch)

            <br>
            <a href="#attach_25"
               title="Go to the comment associated with the attachment">2008-12-15 14:59 PST</a>,
<span class="vcard"><span class="fn">Christopher Browne</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=25&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=25&amp;action=diff">Diff</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
        </span>
      <a href="attachment.cgi?bugid=67&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=67&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 9;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=67#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Adam Buraczewski</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-14 02:10:38 PST
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=24" name="attach_24" title="A simple patch to detect the end of attkind string.">Created an attachment (id=24)</a> <a href="attachment.cgi?id=24&amp;action=edit" title="A simple patch to detect the end of attkind string.">[details]</a></span>
A simple patch to detect the end of attkind string.

I submitted this bug to slony1-bugs, but found Bugzilla and thought it should
be placed here.

I think I found an array overrun bug in _Slony_I_logTrigger() function
(file: src/backend/slony1_funcs.c). The problematic array is &quot;attkind&quot;
trigger parameter, which is a zero-terminated string containing
letters 'k' and 'v'. These letters determine if the given table column
is a key or an ordinary value. In Slony-I 1.x this string had the
length equal to the number of the columns of the table. However,
starting from Slony-I 2.0.0, this string is trimmed and the trailing
'v' letters are removed. Here is the code from
determineAttkindUnique(text, name) function (file:
src/backend/slony1_funcs.sql, line 4807):

   -- Strip off trailing v characters as they are not needed by the logtrigger
   v_attkind := pg_catalog.rtrim(v_attkind, 'v');

As a result, the &quot;attkind&quot; parameter passed to the
_Slony_I_logTrigger() trigger function is usually shorter than the
number of colunms of the table, but this fact is not taken into
account in the function code. Here is an example (slony1_funcs.c, line
688, but the same is in the loop beginning in line 758):

       for (i = 0, attkind_idx = -1; i &lt; tg-&gt;tg_relation-&gt;rd_att-&gt;natts; i++)
       {
               if (tupdesc-&gt;attrs[i]-&gt;attisdropped)
                       continue;
               attkind_idx++;
               if (attkind[attkind_idx] != 'k')
                       continue;
               /* The rest of the loop... */
       }

These loops iterate over all non-dropped columns of the table and
increment attkind_idx. Since the attkind can be shorter than the
number of columns, the attkind[attkind_idx] expression can read bytes
behind the end of the array. These bytes could have any random value,
including 0x6B (the ASCII code of 'k'), which could lead to random
treatment of an ordinary column as a key column (in fact, we observed
that in our test environment and that's why I investigated the issue).

I attached a small patch against slony1_funcs.c which checks for the 0
byte at the end of the attkind string and stops the iteration. This
patch also adds some error checking in the loop beginning in line 648.
Of course the problem can be removed by not trimming the string in the
determineAttkindUnique(text, name) function, but I think that the end
of a zero-terminated string should be checked in any case.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=67#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Adam Buraczewski</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-15 01:38:39 PST
        </span>
      </div>



<pre class="bz_comment_text" >(From update of <span class=""><a href="attachment.cgi?id=24" name="attach_24" title="A simple patch to detect the end of attkind string.">attachment 24</a> <a href="attachment.cgi?id=24&amp;action=edit" title="A simple patch to detect the end of attkind string.">[details]</a></span>)
*** slony1_funcs.c.orig    2008-09-24 21:54:09.000000000 +0200
--- slony1_funcs.c    2008-12-12 10:56:10.000000000 +0100
***************
*** 649,658 ****
--- 649,661 ----
              {
                  if (tupdesc-&gt;attrs[i]-&gt;attisdropped)
                      continue;

                  attkind_idx++;
+                 if (!attkind[attkind_idx])
+                     elog(ERROR, &quot;Slony-I: no key columns found in
logTrigger() attkind parameter&quot;);
+ 
                  if (attkind[attkind_idx] == 'k')
                      break;
              }
              col_ident = (char *) slon_quote_identifier(SPI_fname(tupdesc, i +
1));
              col_value = slon_quote_literal(SPI_getvalue(old_row, tupdesc, i +
1));
***************
*** 692,701 ****
--- 695,706 ----
               */
              if (tupdesc-&gt;attrs[i]-&gt;attisdropped)
                  continue;

              attkind_idx++;
+             if (!attkind[attkind_idx])
+                 break;
              if (attkind[attkind_idx] != 'k')
                  continue;
              col_ident = (char *) slon_quote_identifier(SPI_fname(tupdesc, i +
1));
              col_value = slon_quote_literal(SPI_getvalue(old_row, tupdesc, i +
1));
              if (col_value == NULL)
***************
*** 759,768 ****
--- 764,775 ----
          {
              if (tupdesc-&gt;attrs[i]-&gt;attisdropped)
                  continue;

              attkind_idx++;
+             if (!attkind[attkind_idx])
+                 break;
              if (attkind[attkind_idx] != 'k')
                  continue;
              col_ident = (char *) slon_quote_identifier(SPI_fname(tupdesc, i +
1));
              col_value = slon_quote_literal(SPI_getvalue(old_row, tupdesc, i +
1));
              if (col_value == NULL)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=67#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-15 14:40:08 PST
        </span>
      </div>



<pre class="bz_comment_text" >Adam, I'd like to augment one of the regression tests to validate this fix.

I'm thinking of having the initial table creation add and drop a number of
columns on one of the tables so as to have a bunch of columns that &quot;aren't
really there&quot; anymore.

Does that seem likely to suffice?</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=67#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-15 14:59:20 PST
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=25" name="attach_25" title="Modification to test1 to try to exercise attkind bug">Created an attachment (id=25)</a> <a href="attachment.cgi?id=25&amp;action=edit" title="Modification to test1 to try to exercise attkind bug">[details]</a></span>
Modification to test1 to try to exercise attkind bug

The above test *tries* to exercise the bug, by repeatedly adding and dropping
columns on table5.

It doesn't succeed at exposing the wrong behaviour.

Adam, can you suggest anything else about your pattern of alterations that
would induce the problem?

I will be more than pleased to fix the bug, but I'd be *really* happy if we
have a test that can reliably induce the condition that exposes the problem, as
that means we can be *really* confident that it is dealt with.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=67#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Adam Buraczewski</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2008-12-15 16:20:42 PST
        </span>
      </div>



<pre class="bz_comment_text" >Hi Christopher,

Thanks a lot for taking the problem up.

(In reply to <a href="show_bug.cgi?id=67#c3">comment #3</a>)
<span class="quote">&gt; The above test *tries* to exercise the bug, by repeatedly adding and dropping
&gt; columns on table5.
&gt; 
&gt; It doesn't succeed at exposing the wrong behaviour.</span >

In the meantime, could you please have a look at the <span class="bz_closed"><a href="show_bug.cgi?id=18" title="RESOLVED FIXED - Patch to shorten &quot;attkind&quot; on logtrigger functions">bug #18</a></span> in the Bugzilla?
It looks the patch attached there tried already to cope with the problem, but
somehow has not been applied, although the idea of trimming the attkind string
was accepted and is used in Slony-I 2.0.0. This patch looks almost exactly as
the one I attached to <span class="bz_closed"><a href="show_bug.cgi?id=67" title="RESOLVED FIXED - Array overrun in logtrigger()">bug #67</a></span> (I swear I have not seen <span class="bz_closed"><a href="show_bug.cgi?id=18" title="RESOLVED FIXED - Patch to shorten &quot;attkind&quot; on logtrigger functions">bug #18</a></span> before ;)

<span class="quote">&gt; Adam, can you suggest anything else about your pattern of alterations that
&gt; would induce the problem?</span >

Well, I will think about it tomorrow (it's 1am in my time zone). The problem is
that to expose this bug there should be some &quot;garbage&quot; containing letter 'k'
immediately after the byte 0 ending the string. This would cause to check if
the column is null and raise an error if it is (&quot;old key column is NULL on
UPDATE/DELETE&quot;) -- in our test environment it happened randomly. I am thinking
about modifying the pg_trigger.tgargs column to achieve this, but I am afraid
it will not work. As I said before, I will check it tomorrow.

<span class="quote">&gt; I will be more than pleased to fix the bug, but I'd be *really* happy if we
&gt; have a test that can reliably induce the condition that exposes the problem, as
&gt; that means we can be *really* confident that it is dealt with.</span >

I second the idea.

Regards,
Adam Buraczewski</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=67#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Adam Buraczewski</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-02-20 04:20:36 PST
        </span>
      </div>



<pre class="bz_comment_text" >*** <span class="bz_closed"><a href="show_bug.cgi?id=73" title="RESOLVED DUPLICATE - Slony-I: old key column xxx.yyy IS NULL on UPDATE">Bug 73</a></span> has been marked as a duplicate of this bug. ***</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=67#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-02-20 15:14:59 PST
        </span>
      </div>



<pre class="bz_comment_text" >Does the material in <span class="bz_closed"><a href="show_bug.cgi?id=73" title="RESOLVED DUPLICATE - Slony-I: old key column xxx.yyy IS NULL on UPDATE">bug #73</a></span> provide us with something closer to a
self-contained test to validate the presence (or &quot;fixedness&quot; :-)) of this bug?

I haven't had time to review #73 properly; if we can distill a simple test out
of it that consistently breaks Slony-I, and which is resolved by the patch
we've got here, that would be *perfect.*  I'm pretty well convinced that the
patch will resolve the issue; I'd just like to demonstrate the validation, if
at all possible.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=67#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Devrim GUNDUZ</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-12-06 16:59:36 PST
        </span>
      </div>



<pre class="bz_comment_text" >Was this ever fixed? We got a report from a customer:

org.postgresql.util.PSQLException: ERROR: Slony-I: old key column xxx.tablename
IS NULL on UPDATE 


This is a table that has 27 columns, but:

&quot;_CLUSTER&quot;.logtrigger('_CLUSTER', '1221', 'kvvvvvvvvvvvvvvvvvvvvvv')

What is the correct fix here?

D.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=67#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-18 12:06:38 PDT
        </span>
      </div>



<pre class="bz_comment_text" >The change is in 2.0 and HEAD, so I'm inclined to mark this as resolved.

Regrettably, the test didn't seem to successfully exercise the bug in an
un-patched version of Slony-I.  Not sure what to do about that.

If this re-emerges, it's certainly fair to reopen it, but we quite badly need
an example of the problem that can be duplicated to further validate things.</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=67">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=67">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=67">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=67" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>