<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 235 &ndash; SYNC GROUP size bugs</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=235&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=235">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=235">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=235">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_slon bz_bug_235">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;235</p>
    </td>

    <td id="subtitle">
      <p class="subheader">SYNC GROUP size bugs</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2011-11-25 08:47:07 PST</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=235" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2011-11-25 08:47:07">
  <input type="hidden" name="longdesclength" value="17">
  <input type="hidden" name="id" value="235">
  <input type="hidden" name="token" value="1469075120-a64e5a0509f741ffc5c28adae16cf228">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=235">
        <b>Bug&nbsp;235</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">SYNC GROUP size bugs</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>SYNC GROUP size bugs
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('SYNC GROUP size bugs', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>slon
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">All
       All
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>low
       enhancement
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=235&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=235">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2011-08-23 11:40 PDT by <span class="vcard"><span class="fn">Steve Singer</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2011-11-25 08:47 PST 
      (<a href="show_activity.cgi?id=235">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>2 
          users
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="dkg">dkg</option>
                <option value="slony1-bugs">slony1-bugs</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>


      <tr class="">
        <td valign="top">
            <a name="a1" href="attachment.cgi?id=125"
               title="View the content of the attachment">
          <b>State diagram for revised SYNC grouping logic</b></a>

          <span class="bz_attach_extra_info">
              (9.44 KB,
                image/png)

            <br>
            <a href="#attach_125"
               title="Go to the comment associated with the attachment">2011-08-25 12:52 PDT</a>,
<span class="vcard"><span class="fn">Christopher Browne</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=125&amp;action=edit">Details</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
        </span>
      <a href="attachment.cgi?bugid=235&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=235&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 17;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=235#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-23 11:40:51 PDT
        </span>
      </div>



<pre class="bz_comment_text" >This bug was reported on the slony mailing list

I think there is a bug in slony's sync group size calculations.  In
particular, the calculation of the next sync group size appears to be
vulnerable to integer overflow.

I'm in a situation where one node is seriously lagged, and i need to
catch up quickly.  So i've set my slon process' desired_sync_time to a
large value (1000 seconds) and its sync_group_maxsize to 3000.

Unfortunately, since there is a serious gap, each sync group takes quite
a while to compute, even if there is only 1 sync group requested
(stevensn on #slony suggests that it's doing a full tablescan of
sl_log_1 each update).

Under these conditions, slon appears to calculate a *negative* ideal
sync group size.  (see the -4030 in the log below):

2011-08-21 03:42:11 UTCCONFIG slon: watchdog ready - pid = 7135
2011-08-21 03:42:11 UTCCONFIG slon: worker process created - pid = 7136
2011-08-21 03:42:11 UTCCONFIG main: Integer option vac_frequency = 3
2011-08-21 03:42:11 UTCCONFIG main: Integer option log_level = 1
2011-08-21 03:42:11 UTCCONFIG main: Integer option sync_interval = 1000
2011-08-21 03:42:11 UTCCONFIG main: Integer option sync_interval_timeout =
10000
2011-08-21 03:42:11 UTCCONFIG main: Integer option sync_group_maxsize = 3000
2011-08-21 03:42:11 UTCCONFIG main: Integer option desired_sync_time = 1000000
2011-08-21 03:42:11 UTCCONFIG main: Integer option syslog = 0
2011-08-21 03:42:11 UTCCONFIG main: Integer option quit_sync_provider = 0
2011-08-21 03:42:11 UTCCONFIG main: Integer option quit_sync_finalsync = 0
2011-08-21 03:42:11 UTCCONFIG main: Integer option sync_max_rowsize = 8192
2011-08-21 03:42:11 UTCCONFIG main: Integer option sync_max_largemem = 5242880
2011-08-21 03:42:11 UTCCONFIG main: Integer option remote_listen_timeout = 300
2011-08-21 03:42:11 UTCCONFIG main: Boolean option log_pid = 0
2011-08-21 03:42:11 UTCCONFIG main: Boolean option log_timestamp = 1
2011-08-21 03:42:11 UTCCONFIG main: Boolean option cleanup_deletelogs = 0
2011-08-21 03:42:11 UTCCONFIG main: Real option real_placeholder = 0.000000
2011-08-21 03:42:11 UTCCONFIG main: String option cluster_name = clustername
2011-08-21 03:42:11 UTCCONFIG main: String option conn_info =
host=foo.example.org dbname=testdb user=slony port=5432 sslmode=require
2011-08-21 03:42:11 UTCCONFIG main: String option pid_file =
/var/run/slony1/node4.pid
2011-08-21 03:42:11 UTCCONFIG main: String option log_timestamp_format =
%Y-%m-%d %H:%M:%S %Z
2011-08-21 03:42:11 UTCCONFIG main: String option archive_dir = [NULL]
2011-08-21 03:42:11 UTCCONFIG main: String option sql_on_connection = [NULL]
2011-08-21 03:42:11 UTCCONFIG main: String option lag_interval = [NULL]
2011-08-21 03:42:11 UTCCONFIG main: String option command_on_logarchive =
[NULL]
2011-08-21 03:42:11 UTCCONFIG main: String option syslog_facility = LOCAL0
2011-08-21 03:42:11 UTCCONFIG main: String option syslog_ident = slon
2011-08-21 03:42:11 UTCCONFIG main: String option cleanup_interval = 10 minutes 
 [...]
2011-08-21 19:20:11 UTCINFO   remoteWorkerThread_3: SYNC 5002089203 done in
381.641 seconds
2011-08-21 19:20:11 UTCDEBUG1 remoteWorkerThread_3: SYNC 5002089203 sync_event
timing:  pqexec (s/count)- provider 0.246/1 - subscriber 0.002/1 - IUD
6.663/7337
2011-08-21 19:20:11 UTCDEBUG1 calc sync size - last time: 1895 last length:
381873 ideal: 4962 proposed size: 3000
2011-08-21 19:20:11 UTCDEBUG1 about to monitor_subscriber_query - pulling big
actionid list for 3
2011-08-21 19:20:11 UTCINFO   remoteWorkerThread_3: syncing set 2 with 7
table(s) from provider 3
2011-08-21 19:25:21 UTCDEBUG1 remoteHelperThread_3_3: 309.699 seconds delay for
first row
2011-08-21 19:25:32 UTCDEBUG1 remoteHelperThread_3_3: 320.586 seconds until
close cursor
2011-08-21 19:25:32 UTCDEBUG1 remoteHelperThread_3_3: inserts=48428
updates=10966 deletes=0
2011-08-21 19:25:32 UTCDEBUG1 remoteWorkerThread_3: sync_helper timing:  pqexec
(s/count)- provider 315.415/122 - subscriber 0.002/122
2011-08-21 19:25:32 UTCDEBUG1 remoteWorkerThread_3: sync_helper timing:  large
tuples 0.000/0
2011-08-21 19:25:32 UTCINFO   remoteWorkerThread_3: SYNC 5002092203 done in
320.936 seconds
2011-08-21 19:25:32 UTCDEBUG1 remoteWorkerThread_3: SYNC 5002092203 sync_event
timing:  pqexec (s/count)- provider 0.064/1 - subscriber 0.002/1 - IUD
10.840/11889
2011-08-21 19:25:32 UTCDEBUG1 calc sync size - last time: 3000 last length:
321314 ideal: -4030 proposed size: 1
2011-08-21 19:25:32 UTCDEBUG1 about to monitor_subscriber_query - pulling big
actionid list for 3

This is with slony 2.0.4 from debian squeeze, on amd64.

the formula for calculating the ideal sync size (line 596 of
src/slon/remote_worker.c) is: 

  ideal_sync = (last_sync_group_size * desired_sync_time) / last_sync_length;

All four variables in the assignment are of type int.

With desired_sync_time of 1000000 (milliseconds), and a
last_sync_group_size of 3000, this code overflows a 32-bit signed
integer :(, resulting in the -4030

There are probably a few bugs here, but the most important bug is:

 0) overflow isn't being handled properly.  The simplest way to fix this
 is probably to do this kind of internal computation in floats, and then
 cast back to integers later.

some secondary issues worth considering are:

 1) this is a 64-bit architecture -- why aren't these using 64-bit
 integers instead of 32-bit?  Maybe there are some odd compiler flags in
 use?

 2) should these ints be unsigned instead of signed?</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=235#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-23 12:46:38 PDT
        </span>
      </div>



<pre class="bz_comment_text" >This is the same problem, no doubt, as the &quot;int versus int64&quot; issues resolved
here:

<a href="http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=a886824b87b8da3a485b8dfea7910734bd6a7bce">http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=a886824b87b8da3a485b8dfea7910734bd6a7bce</a>

As a &quot;first blush,&quot; I'd suggest considering changing the variables to int64,
which is where the above changes ultimately went.

And switching to using float seems like not a terrible idea.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=235#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-23 14:50:30 PDT
        </span>
      </div>



<pre class="bz_comment_text" >It seems to me that in HEAD, we should look at revising the logic in a more
substantial way.

The logic that was added around 1.2 has the conceit that we imagine that SYNCs
are likely to 'typically' take some period of time to process, from whence
comes the configuration option &quot;desired_sync_time&quot;.

This is fairly nonsensical, as how long a SYNC will take to process really
depends on how much data got committed between two SYNCs, which isn't so
predictable.

The logic might be simplified to something more like:

- We define a &quot;max&quot; number of syncs to process, and don't ever consider doing
more than that.

- If there are fewer than that &quot;max&quot;, then group whatever is available.

There's some logic surrounding increasing towards the &quot;max&quot;; it's pretty likely
that trying to do this is just nonsense, and we should just head straight to
the configured maximum.

If the administrator feels that only a few SYNCs should be processed together,
then they can set sync_group_maxsize fairly small, and get the desired result.

If they want lots of grouping, then they can set it high, and get the desired
result.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=235#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Daniel Kahn Gillmor</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-24 01:05:30 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I think the logic behind the &quot;ramping up&quot; is that if the admin says &quot;group at
most 3000 SYNCs at a time&quot; (sync_group_maxsize) and &quot;i want each run to take
about 60 seconds&quot; (desired_sync_time), and it turns out that we can process
about 10 SYNCs per second, then if we just jump straight to 3000 SYNCs, the run
would take 5 times the recommended maximum duration.

So the current logic does a small number of SYNCs and then tries to predict
(based on some implicit assumption that the number of SYNCs varies linearly
with the duration of the SYNC group) what the ideal number of SYNCs would be to
hit the desired_sync_time.

Aside from overflow issues, the big problem with this approach is that the
number of SYNCs processed per group does *not* necessarily vary linearly with
the time it takes for the group to be processed.  Or, if it does vary linearly,
it is with a constant offset that can grow substantially if there are a large
number of elements in sl_log_1 or sl_log_2.

In my case, with &gt; 8 GiB in sl_log_1, a SYNC group of size 1 takes several
hundred seconds, and a sync group of size 3000 *also* takes several hundred
seconds.  (maybe due to the full tablescan of sl_log_1?) 

As a result, the estimate of how many SYNCs to process in a group stays low,
which makes slony take even longer to finish processing its data :(</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=235#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-24 08:02:59 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c3">comment #3</a>)
<span class="quote">&gt; I think the logic behind the &quot;ramping up&quot; is that if the admin says &quot;group at
&gt; most 3000 SYNCs at a time&quot; (sync_group_maxsize) and &quot;i want each run to take
&gt; about 60 seconds&quot; (desired_sync_time), and it turns out that we can process
&gt; about 10 SYNCs per second, then if we just jump straight to 3000 SYNCs, the run
&gt; would take 5 times the recommended maximum duration.
&gt; 
&gt; So the current logic does a small number of SYNCs and then tries to predict
&gt; (based on some implicit assumption that the number of SYNCs varies linearly
&gt; with the duration of the SYNC group) what the ideal number of SYNCs would be to
&gt; hit the desired_sync_time.</span >

That's pretty much right.

We also had a little bit of paranoia about making sure that if there's a
problem at sync #314314 that we replicate at least up to #314313 before giving
up.  That's why it starts by processing 1 SYNC at a time, and ramps up.

<span class="quote">&gt; Aside from overflow issues, the big problem with this approach is that the
&gt; number of SYNCs processed per group does *not* necessarily vary linearly with
&gt; the time it takes for the group to be processed.  Or, if it does vary linearly,
&gt; it is with a constant offset that can grow substantially if there are a large
&gt; number of elements in sl_log_1 or sl_log_2.</span >

Quite right, the &quot;linearity&quot; assumption is not particularly valid.  

It's notably invalidated in the case where someone has some huge &quot;UPDATE
some_big_table SET [something] WHERE [most of the tuples in the table]&quot; query;
when this commits, it'll add a *huge* amount of work to one and only one SYNC.

<span class="quote">&gt; In my case, with &gt; 8 GiB in sl_log_1, a SYNC group of size 1 takes several
&gt; hundred seconds, and a sync group of size 3000 *also* takes several hundred
&gt; seconds.  (maybe due to the full tablescan of sl_log_1?) </span >

That SEQ SCAN is a problem, and further invalidates that &quot;linearity
assumption.&quot;

I'll note that the SEQ SCAN was recognized and fixed in <span class="bz_closed"><a href="show_bug.cgi?id=167" title="RESOLVED FIXED - Slow down of slon with large backlog">Bug #167</a></span>, in version
2.1.  We haven't backpatched because, 2.1 not yet being fully released, there's
not as much feedback on that as we'd like.

<span class="quote">&gt; As a result, the estimate of how many SYNCs to process in a group stays low,
&gt; which makes slony take even longer to finish processing its data :(</span >

Yep.

If the Seq Scan issue goes away in 2.1, prior to changes to this algorithm,
then  I think we can treat that as being likely irrelevant.

I'm inclined to revise the logic to get rid of the &quot;desired sync time&quot; part, as
there's something inherently nonsensical to it.

The direction I'm thinking is to have slon do &quot;start with 1, and then quickly
increment towards sync_group_maxsize&quot;.  

&quot;How quickly?&quot; is a good question that'll get discussed, for sure.  Another
parameter might be a useful idea, but I'm not sure there's necessarily much 
value to adding configuration knobs.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=235#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-24 09:00:58 PDT
        </span>
      </div>



<pre class="bz_comment_text" > &quot;desired sync time&quot; part, as
<span class="quote">&gt; there's something inherently nonsensical to it.
&gt; 
&gt; The direction I'm thinking is to have slon do &quot;start with 1, and then quickly
&gt; increment towards sync_group_maxsize&quot;.  
&gt; 
&gt; &quot;How quickly?&quot; is a good question that'll get discussed, for sure.  Another
&gt; parameter might be a useful idea, but I'm not sure there's necessarily much 
&gt; value to adding configuration knobs.</span >

I agree that the &quot;desired sync time&quot; is confusing and we should move away
towards just specifying a max group size.

Does it make more sense to start at max_group_size and reduce that to smaller
values on failures?  (this only works if slon doens't get restarted/segfault on
the failures)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=235#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-24 09:16:34 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c5">comment #5</a>)
<span class="quote">&gt;  &quot;desired sync time&quot; part, as
&gt; &gt; there's something inherently nonsensical to it.
&gt; &gt; 
&gt; &gt; The direction I'm thinking is to have slon do &quot;start with 1, and then quickly
&gt; &gt; increment towards sync_group_maxsize&quot;.  
&gt; &gt; 
&gt; &gt; &quot;How quickly?&quot; is a good question that'll get discussed, for sure.  Another
&gt; &gt; parameter might be a useful idea, but I'm not sure there's necessarily much 
&gt; &gt; value to adding configuration knobs.
&gt; 
&gt; I agree that the &quot;desired sync time&quot; is confusing and we should move away
&gt; towards just specifying a max group size.
&gt; 
&gt; Does it make more sense to start at max_group_size and reduce that to smaller
&gt; values on failures?  (this only works if slon doens't get restarted/segfault on
&gt; the failures)</span >

Hmm, yeah.

I could see starting with max_group_size, and dividing by two each time it
fails.  That'll quickly head to 1.

The next question would be of how to increase on success.  Whiteboard time :-).</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=235#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Daniel Kahn Gillmor</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-24 11:13:10 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c5">comment #5</a>)
<span class="quote">&gt; I agree that the &quot;desired sync time&quot; is confusing and we should move away
&gt; towards just specifying a max group size.</span >

Yes, fewer configuration options is better :)  We know the db administrator
wants to keep the sync lag low.  Having fiddly knobs labeled &quot;make the sync lag
shorter, except sometimes when it makes them longer&quot; isn't terribly helpful.

<span class="quote">&gt; Does it make more sense to start at max_group_size and reduce that to smaller
&gt; values on failures?  (this only works if slon doens't get restarted/segfault on
&gt; the failures)</span >

The one concern i can see being raised with this approach is that (with a
radically over-provisioned max_group_size) it's possible for a huge sync group
to take forever.  However, if there just aren't that many SYNCs available,
presumably the group would just complete successfully with the set of
currently-available SYNCs?  In that case, i think the starting-large and
falling off is better than starting-small and ramping-up.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=235#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-24 11:56:26 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c7">comment #7</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=235#c5">comment #5</a>)
&gt; &gt; I agree that the &quot;desired sync time&quot; is confusing and we should move away
&gt; &gt; towards just specifying a max group size.
&gt; 
&gt; Yes, fewer configuration options is better :)  We know the db administrator
&gt; wants to keep the sync lag low.  Having fiddly knobs labeled &quot;make the sync lag
&gt; shorter, except sometimes when it makes them longer&quot; isn't terribly helpful.
&gt; 
&gt; &gt; Does it make more sense to start at max_group_size and reduce that to smaller
&gt; &gt; values on failures?  (this only works if slon doens't get restarted/segfault on
&gt; &gt; the failures)
&gt; 
&gt; The one concern i can see being raised with this approach is that (with a
&gt; radically over-provisioned max_group_size) it's possible for a huge sync group
&gt; to take forever.  However, if there just aren't that many SYNCs available,
&gt; presumably the group would just complete successfully with the set of
&gt; currently-available SYNCs?  In that case, i think the starting-large and
&gt; falling off is better than starting-small and ramping-up.</span >

Yeah, this case concerns me a bit.

The &quot;standard&quot; case where there could be a whole lot of syncs outstanding is
where a subscription is requested, and there's so much data in the set that it
takes multiple days to process it.

At that point, there might be thousands of SYNCs outstanding, and it's possible
that you'll be vulnerable to network glitchiness if slon tries to do the whole
thing in one fell swoop.  

Mind you, the &quot;fallback&quot; of dividing by 2 upon failure should address that,
albeit with some potential for several fairly long failed attempted SYNCs until
the &quot;max&quot; falls to the point where it gets processed OK.

I expect that that's reasonably easily addressed by not setting
sync_group_maxsize super high.

During such a huge subscription, it's not actually terribly useful to have a
huge number of SYNCs; it's not a bad idea to set sync_interval a bit higher at
such times.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c9" 
             href="show_bug.cgi?id=235#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-25 12:52:09 PDT
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=125" name="attach_125" title="State diagram for revised SYNC grouping logic">Created an attachment (id=125)</a> <a href="attachment.cgi?id=125&amp;action=edit" title="State diagram for revised SYNC grouping logic">[details]</a></span>
State diagram for revised SYNC grouping logic

Steve Singer and I whiteboarded up a state diagram describing a proposed
revised logic for handling SYNC grouping.  I have turned that into a TCM
diagram, attached.

We basically propose revising the logic to be thus...

- At start time, the initial &quot;max&quot; is set to 1.

- If SYNCs are processed properly, the grouping doubles (e.g. - 1, then 2, 4,
8, 16, ...), until reaching either the maximum SYNCs outstanding, or the
configured maximum.

- Any time things fail, we fall back by 1/2.  max of 32 --&gt; max of 16.

- Once we catch up, we're typically processing one or just a few SYNCs at a
time; if things fall behind, the doubling will kick in, but typically, we only
*have* a few to process at a time.

We discussed the possibility of starting with an initial &quot;max&quot; being as large
as possible (e.g. - the configured max value), and using the &quot;halving upon
failure&quot; to scale back as needed, but this seems to have several disadvantages
to starting with 1 and doubling:

1.  By starting with just a few SYNCs, there's the hope that we *immediately*
get some SYNCs replicated, and the subscriber visibly starts to catch up.

Starting with a huge grouping means there's no such quick feedback, which could
be disconcerting to users.

1a.  More on the &quot;disconcerting&quot; bit...  If the administrator is disconcerted
by seeing no evident progress, they may decide to kill the slon and retry,
which would waste any work that has been done.  And the retry will behave
identically; it'll just look like replication is broken.

Better to let some SYNCs through quickly, if possible.

2.  In 2.1, we expect a fundamentally better behaviour due to the fix of bug
#167.  A small grouping shouldn't be reverting to SEQ SCAN; we can hope for
rather better behaviour of that query.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c10" 
             href="show_bug.cgi?id=235#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Daniel Kahn Gillmor</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-25 13:28:36 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c9">comment #9</a>)
<span class="quote">&gt; - At start time, the initial &quot;max&quot; is set to 1.
&gt; 
&gt; - If SYNCs are processed properly, the grouping doubles (e.g. - 1, then 2, 4,
&gt; 8, 16, ...), until reaching either the maximum SYNCs outstanding, or the
&gt; configured maximum.
&gt; 
&gt; - Any time things fail, we fall back by 1/2.  max of 32 --&gt; max of 16.
&gt; 
&gt; - Once we catch up, we're typically processing one or just a few SYNCs at a
&gt; time; if things fall behind, the doubling will kick in, but typically, we only
&gt; *have* a few to process at a time.</span >

This sounds identical to the current scheme with two exceptions: 

 0) you're not measuring the time consumed, just varying based on failures, and

 1) at a failure, you fall back by halves instead of reverting to 1

As a result, you're only asking the slon administrator one unanswerable
question instead of two, so that's an improvement :)

The questions used to be:

 max_sync_group_size: what is the largest number of SYNCs you'd like to process
at once?

 desired_sync_time: what's the longest time you want a SYNC to take?

The answers any sane admin would give are:

 max_sync_group_size: all outstanding SYNCs
 desired_sync_time: as soon as possible

Which of course are not legitimate configuration parameters :)

Under your new configuration, you seem to be asking just the first question. 
Given that the obvious answer to the first question is &quot;all outstanding SYNCs&quot;,
is there any reason to have this knob be settable at all?  if there are roughly
30 SYNCs created per synchronization pull, then the value will stay at 30, and
fall back to 15 if there is an error.  If there are 6 SYNCs per pull, it will
stay at 6 and fall back to 3.  This seems OK to me.

<span class="quote">&gt; We discussed the possibility of starting with an initial &quot;max&quot; being as large
&gt; as possible (e.g. - the configured max value), and using the &quot;halving upon
&gt; failure&quot; to scale back as needed, but this seems to have several disadvantages
&gt; to starting with 1 and doubling:</span >

the downside to starting at 1, of course, is if the per-pull overhead is huge
it takes a long time to run and you just get farther and farther behind while
slon is incorporating only a handful of updates.

What about parameterizing the initial number of SYNCs to pull in a group?  Sort
of &quot;how many SYNCs do you expect to have outstanding at each pull?&quot;  That
parameter seems more legitimately answerable by an admin, and more directly
relevant for someone who is trying to recover a seriously-lagged replication
(e.g. &quot;please start off with enormous SYNC groups so we can catch up faster!&quot;)

<span class="quote">&gt; 2.  In 2.1, we expect a fundamentally better behaviour due to the fix of bug
&gt; #167.  A small grouping shouldn't be reverting to SEQ SCAN; we can hope for
&gt; rather better behaviour of that query.</span >

From what i understand, this does sound like a more important and more
fundamental problem to fix.  I look forward to 2.1 :)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c11" 
             href="show_bug.cgi?id=235#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-26 10:19:29 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I have set up a branch for this that prototypes the proposed changes.

<a href="https://github.com/cbbrowne/slony1-engine/tree/bug235">https://github.com/cbbrowne/slony1-engine/tree/bug235</a>

There are a few issues outstanding at the moment:

1.  There's still a little question as to whether we start with grouping size
of 1, or if we go for something higher.

I'm assuming 1, at the moment, which has the merit that this is how Slony
already behaves.

2.  I'm logging the result of the computation at SLON_INFO level, which is not
the right verbosity level.

3.  There isn't a good test that validates the behaviour.  None of the
regression tests are really suitable, as they do not impose any big backlogs.

What is needed is a test that:
a) Loads a fair bit of data into some tables, so that subscription takes a
while;
b) After the subscription request is submitted, injects updates for the
duration of the subscription, so that there are backlogged updates during the
subscription.

If one of the disorder tests already has this pattern, then it would be useful
to know which it is so that we might observe the slon logs during that, to
verify that we're getting sensible behaviour.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c12" 
             href="show_bug.cgi?id=235#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-31 10:50:33 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c11">comment #11</a>)
<span class="quote">&gt; I have set up a branch for this that prototypes the proposed changes.
&gt; 
&gt; <a href="https://github.com/cbbrowne/slony1-engine/tree/bug235">https://github.com/cbbrowne/slony1-engine/tree/bug235</a>
&gt; 
&gt; There are a few issues outstanding at the moment:
&gt; 
&gt; 1.  There's still a little question as to whether we start with grouping size
&gt; of 1, or if we go for something higher.
&gt; 
&gt; I'm assuming 1, at the moment, which has the merit that this is how Slony
&gt; already behaves.</span >

According to further discussion that has taken place, there is general
agreement that this is the right place to start.

<span class="quote">&gt; 2.  I'm logging the result of the computation at SLON_INFO level, which is not
&gt; the right verbosity level.</span >

Fixed.

<span class="quote">&gt; 3.  There isn't a good test that validates the behaviour.  None of the
&gt; regression tests are really suitable, as they do not impose any big backlogs.</span >

This isn't something that is amenable to any of our automated testing; it does
not seem appropriate to add any explicit test to the suite.

The apropos test is more &quot;observational&quot;; just...

- Set up a cluster

- Set up a data source that's injecting updates to the origin node

- Manually stop and start a slon, having debugging set to a level that shows
off the SYNC grouping computation.  Stop the slon to let some SYNCs build up,
restart to see how it catches up.

All worked fine for me.

This is apropos as a post-2.1 change; once we open development of 2.1, it
should go to Steve/Jan for review.  Assigning it to Jan to arrange review.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c13" 
             href="show_bug.cgi?id=235#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-11-24 07:10:09 PST
        </span>
      </div>



<pre class="bz_comment_text" >I've taken a lot at the rebased against the current master (2.2).


--- 249,263 ----
  time_t        explain_lastsec;
  int            explain_thistime;

! typedef enum
! {
!     SYNC_INITIAL = 1,
!     SYNC_PENDING,
!     SYNC_SUCCESS,
!     SYNC_FAILURE
! 
! } SlonSyncStatus;

SYNC_FAILURE is a state that is never actually set/checked.  In the event of a
failure applying the sync the remote worker causes the slon to restart
resetting the count to the inital state.  None of the logic to decrease the
group size is used.   We should either get the remote_worker to detect+recover
from this error OR remove the FAILURE state and /2 logic and add a comment that
we depend on restart.

In confoptions.c  
{
        {
            (const char *) &quot;sync_group_maxsize&quot;,
            gettext_noop(&quot;sync group&quot;),
            gettext_noop(&quot;sync group&quot;),
            SLON_C_INT
        },
        &amp;sync_group_maxsize,
        20,
        0,
        10000
    },

isn't part of you diff but should be.   The description (inside gettext_noop)
is insufficient.  It should say something like &quot;The maximum number of SYNC
events that will be applied as part of the same transaction&quot;   

I tested the doubling logic and it seemed fine.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c14" 
             href="show_bug.cgi?id=235#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-11-24 09:22:48 PST
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=235#c13">comment #13</a>)
<span class="quote">&gt; I've taken a lot at the rebased against the current master (2.2).
&gt; 
&gt; 
&gt; --- 249,263 ----
&gt;   time_t        explain_lastsec;
&gt;   int            explain_thistime;
&gt; 
&gt; ! typedef enum
&gt; ! {
&gt; !     SYNC_INITIAL = 1,
&gt; !     SYNC_PENDING,
&gt; !     SYNC_SUCCESS,
&gt; !     SYNC_FAILURE
&gt; ! 
&gt; ! } SlonSyncStatus;
&gt; 
&gt; SYNC_FAILURE is a state that is never actually set/checked.  In the event of a
&gt; failure applying the sync the remote worker causes the slon to restart
&gt; resetting the count to the inital state.  None of the logic to decrease the
&gt; group size is used.   We should either get the remote_worker to detect+recover
&gt; from this error OR remove the FAILURE state and /2 logic and add a comment that
&gt; we depend on restart.</span >

Agreed, SYNC_FAILURE can't occur, as it is never set in the code.  In
principle, the code that checks for SYNC_SUCCESS can &quot;accept&quot; SYNC_FAILURE (at
which point it would does the divide-by-2 logic), but it's fair to say that
this doesn't really occur.

I don't think it makes sense to try to get the remote worker thread to detect
failure and keep the old grouping size between invocations of the thread; that
would be considerable work, with limited value.  So I have added comment that
the logic for the &quot;not SYNC_SUCCESS&quot; amounts to setting the value to 1, as
restarting the remote worker thread forces the value back to 1.

<a href="https://github.com/cbbrowne/slony1-engine/commit/4e1d743c9c8f1d170abb1473907d5aef8dc06de4">https://github.com/cbbrowne/slony1-engine/commit/4e1d743c9c8f1d170abb1473907d5aef8dc06de4</a>

<span class="quote">&gt; In confoptions.c  
&gt; {
&gt;         {
&gt;             (const char *) &quot;sync_group_maxsize&quot;,
&gt;             gettext_noop(&quot;sync group&quot;),
&gt;             gettext_noop(&quot;sync group&quot;),
&gt;             SLON_C_INT
&gt;         },
&gt;         &amp;sync_group_maxsize,
&gt;         20,
&gt;         0,
&gt;         10000
&gt;     },
&gt; 
&gt; isn't part of you diff but should be.   The description (inside gettext_noop)
&gt; is insufficient.  It should say something like &quot;The maximum number of SYNC
&gt; events that will be applied as part of the same transaction&quot;   </span >

Good call.

<a href="https://github.com/cbbrowne/slony1-engine/commit/424f4df643e014bd5358dbec47fd3c665efb5ce1">https://github.com/cbbrowne/slony1-engine/commit/424f4df643e014bd5358dbec47fd3c665efb5ce1</a>

<span class="quote">&gt; I tested the doubling logic and it seemed fine.</span ></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c15" 
             href="show_bug.cgi?id=235#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-11-25 06:07:33 PST
        </span>
      </div>



<pre class="bz_comment_text" >This verison looks fine, except the text you added to the release notes looks a
bit out of place.  The rest of the release notes seem to be 1 or two sentences.

Maybe

- <span class="bz_closed"><a href="show_bug.cgi?id=235" title="RESOLVED FIXED - SYNC GROUP size bugs">Bug #235</a></span> :: SYNC GROUP sizes are now dynamically grow between 2 and a maximum
 size set in the config file.  The old logic based on time it took to complete
the last SYNC has been removed.

What you put in the release notes might be a good commit comment for git.
I would recommend squashing all of your smaller commits into 1 commit + 1
encompassing comment when you merge to master.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c16" 
             href="show_bug.cgi?id=235#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-11-25 08:47:07 PST
        </span>
      </div>



<pre class="bz_comment_text" >Merged into a single commit.

<a href="http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=e0301ce99d8385b592ae5753572f6527fa4c447b">http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=e0301ce99d8385b592ae5753572f6527fa4c447b</a>

Note that I dropped out the 2.1 and earlier release notes, as that's not going
to be relevant to 2.2 anymore</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=235">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=235">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=235">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=235" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>