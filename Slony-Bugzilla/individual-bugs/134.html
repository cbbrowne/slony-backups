<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 134 &ndash; TRUNCATE support</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=134&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=134">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=134">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=134">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_stored_procedures bz_bug_134">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;134</p>
    </td>

    <td id="subtitle">
      <p class="subheader">TRUNCATE support</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2014-04-15 16:01:43 PDT</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=134" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2014-04-15 16:01:43">
  <input type="hidden" name="longdesclength" value="14">
  <input type="hidden" name="id" value="134">
  <input type="hidden" name="token" value="1469075018-52db854168156a277c6e0ccc606ab63f">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=134">
        <b>Bug&nbsp;134</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">TRUNCATE support</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>TRUNCATE support
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('TRUNCATE support', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>stored procedures
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">PC
       Linux
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>low
       enhancement
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <a href="http://github.com/cbbrowne/slony1-engine/commits/local-master/bug-134"><u>U</u>RL</a></b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href="http://github.com/cbbrowne/slony1-engine/commits/local-master/bug-134"><span title="http://github.com/cbbrowne/slony1-engine/commits/local-master/bug-134">http://github.com/cbbrowne/slony1-eng...
        </span></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    <span class="bz_closed"><a href="show_bug.cgi?id=137" title="RESOLVED FIXED - execute script does not get applied in the correct order">137</a></span> 
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=134&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=134">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2010-06-07 01:43 PDT by <span class="vcard"><span class="fn">Peter Eisentraut</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2014-04-15 16:01 PDT 
      (<a href="show_activity.cgi?id=134">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>1 
          user
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>


      <tr class="">
        <td valign="top">
            <a name="a1" href="attachment.cgi?id=74"
               title="View the content of the attachment">
          <b>Differences from test run</b></a>

          <span class="bz_attach_extra_info">
              (945 bytes,
                text/plain)

            <br>
            <a href="#attach_74"
               title="Go to the comment associated with the attachment">2010-11-16 13:16 PST</a>,
<span class="vcard"><span class="fn">Christopher Browne</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=74&amp;action=edit">Details</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
        </span>
      <a href="attachment.cgi?bugid=134&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=134&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 14;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=134#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Peter Eisentraut</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-06-07 01:43:39 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Wishlist: Add support for TRUNCATE.  Either add a trigger that prevents
TRUNCATE on the master, or propagate the TRUNCATE event to the slaves.

Right now, TRUNCATE is a loose foot-gun on a Slony setup.  See
<a href="http://shoaibmir.wordpress.com/2010/06/03/truncate-problems-with-slony/">http://shoaibmir.wordpress.com/2010/06/03/truncate-problems-with-slony/</a> for
example.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=134#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-06-07 08:35:43 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Yep, I had a chat with various people about this at PGCon, and had some
resolutions of outstanding questions.

The trouble with TRUNCATE comes when there are foreign key relationships.  In
the case of circularity, one might find it necessary to submit:

  TRUNCATE a, b, c;

in order to get all three tables emptied.

Supposing that request is submitted, we'd find, logged, 3 TRUNCATE requests
that were captured by ON TRUNCATE triggers.  (I'm assuming here that all 3
tables were replicated.)

I see 4 strategies for implementing the handling of TRUNCATE:

1.  Deny

Basically, we put the same stored function used for &quot;deny_access&quot; onto the ON
TRUNCATE action.

This isn't ideal, but is better than what we have now.

2.  Log truncate, action on subscriber is &quot;TRUNCATE ONLY&quot;

This won't work out in the &quot;TRUNCATE a,b,c;&quot; scenario described earlier, as the
FK is liable to cause each of these truncate requests to fail.

3.  Log truncate...  Try to form sets of successive TRUNCATEs into one request.

This adds substantially to complexity, and there's the question of when to do
the set of truncates:

  a) At the earliest point in the stream, or
  b) At the latest point in the stream.

More thought necessary to see which order is expected to be &quot;compatible.&quot;

[Thinking a bit more...  This might well work...  The transaction claims an
exclusive lock on all the tables, so it ought to be possible to, upon seeing a
TRUNCATE, look for all the adjacent TRUNCATE requests in that same transaction.
 The only trouble is how to not bother reprocessing the subsequent TRUNCATE
requests.]

There is still some risk of failure on the subscriber; supposing there are
differences in FK relations there, there is the possibility of everything
rolling back, and replication becoming blocked at this point.

4.  Log the truncates, and, for each one, submit
   TRUNCATE foo CASCADE;

This has merits over all the others:

- It performs TRUNCATE (unlike 1!)
- Guaranteed to work (unlike 2)
- Much simpler than #3
- No risk of getting stuck because of a FK relationship

There's a big scary demerit:

- It'll blindly truncate everything tied to the table being truncated.

I had a chat about this with Rod Taylor and Greg Sabino Mullane at the EDB
dinner; Rod suggested that #4 was the way to go, and I made sure Greg was aware
of the challenge here.

Peter, your thoughts would definitely be valued.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=134#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Peter Eisentraut</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-06-07 11:41:14 PDT
        </span>
      </div>



<pre class="bz_comment_text" >My immediate interest in this comes more from the point of closing possible
breakage vectors, so prohibiting TRUNCATE on the master would be good for me.

I don't have a qualified opinion at the moment on how to implement replicating
the TRUNCATE event.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=134#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-06-07 11:48:05 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=134#c2">comment #2</a>)
<span class="quote">&gt; My immediate interest in this comes more from the point of closing possible
&gt; breakage vectors, so prohibiting TRUNCATE on the master would be good for me.</span >

Actually, we'd want to prohibit TRUNCATE on all nodes, in that case.

It's not so much of an improvement if you can still easily blow up subscribers! 
:-(</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=134#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-09 14:09:17 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Thinking about implementation...

We could:

a) Try to capture the trigger using the existing C/SPI function.  That seems
like overkill, as we don't need to collect data.

b) Create a trigger function that captures the table ID as its argument, and
uses that to determine which table to truncate.

Consistent with the preceding discussion, I propose using &quot;policy #4&quot; to handle
this, that is, on replicated nodes, we'll run, for each table:
   truncate ONLY my_table CASCADE;</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=134#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-10 09:33:39 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I have a branch out on GitHub that has a preliminary implementation.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=134#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-11 12:38:26 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Add in some more tests, notably involving foreign key relationships.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=134#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-12 14:55:53 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I've got a basically working implementation, here.

<a href="http://github.com/cbbrowne/slony1-engine/commits/local-master/bug-134">http://github.com/cbbrowne/slony1-engine/commits/local-master/bug-134</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=134#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-15 13:45:47 PST
        </span>
      </div>



<pre class="bz_comment_text" >I reviewed a3a2e4839f5cf21bfd076e30e916cd23112daf97 rebased to our current
master (3cbbaba072b38527fa2ac7949ba680e7bd410a9a) with conflicts resolved.

A few comments

1.  Upgrade script support.  As it stands today an upgrade from 2.0
to 2.1 doesn't require re-installing the cluster.  This patch doesn't
warrent (in my opinion) requiring that.  Something else in the future
might but I would like to see an upgrade script add the truncate triggers
to all replicated tables.

2. I manually tested the functionality and it looked okay.  However run I tried
the regression test you added I got the same 'result' against 8.3 and
9.1master.
Since 8.3 doesn't support truncate triggers this confused me, it might just be
my unfamiliarity with the regression tests.  I was expecting a it to say it
failed with 8.3 (is that what we want?)

3. This probably should also have a documentation update, limitations.sgml at a
minimum to say we now support truncate in 8.4 and above.  We also might want to
say somewhere that the truncate on the slave is a CASCADE.   This would be
important to note for setups who have a different schema on their slave vs
master. 

Other than that I'm happy with this for master.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c9" 
             href="show_bug.cgi?id=134#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-15 14:44:30 PST
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=134#c8">comment #8</a>)
<span class="quote">&gt; I reviewed a3a2e4839f5cf21bfd076e30e916cd23112daf97 rebased to our current
&gt; master (3cbbaba072b38527fa2ac7949ba680e7bd410a9a) with conflicts resolved.
&gt; 
&gt; A few comments
&gt; 
&gt; 1.  Upgrade script support.  As it stands today an upgrade from 2.0
&gt; to 2.1 doesn't require re-installing the cluster.  This patch doesn't
&gt; warrent (in my opinion) requiring that.  Something else in the future
&gt; might but I would like to see an upgrade script add the truncate triggers
&gt; to all replicated tables.</span >

Good idea; I will rework it so that it tries to add the triggers, if possible.

<span class="quote">&gt; 2. I manually tested the functionality and it looked okay.  However run I tried
&gt; the regression test you added I got the same 'result' against 8.3 and
&gt; 9.1master.
&gt; Since 8.3 doesn't support truncate triggers this confused me, it might just be
&gt; my unfamiliarity with the regression tests.  I was expecting a it to say it
&gt; failed with 8.3 (is that what we want?)</span >

Hmm.  I'd expect the test to fail on 8.3, because tables would be empty there,
but not on the subscribers.

I don't think I tried running it on 8.3, because I expected it not to work
properly there.

<span class="quote">&gt; 3. This probably should also have a documentation update, limitations.sgml at a
&gt; minimum to say we now support truncate in 8.4 and above.  We also might want to
&gt; say somewhere that the truncate on the slave is a CASCADE.   This would be
&gt; important to note for setups who have a different schema on their slave vs
&gt; master. </span >

Yep, something needs to be put in there.  I think I'll either need to:
a) Merge docs from HEAD into this branch, or
b) Document as part of the merge into HEAD, as
c) Try and muddle docs in as-is won't work out very happily due to the lots of
upstream changes to the docs.

Probably b) is simplest.

<span class="quote">&gt; Other than that I'm happy with this for master.</span ></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c10" 
             href="show_bug.cgi?id=134#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-16 09:35:23 PST
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=134#c9">comment #9</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=134#c8">comment #8</a>)
&gt; &gt; I reviewed a3a2e4839f5cf21bfd076e30e916cd23112daf97 rebased to our current
&gt; &gt; master (3cbbaba072b38527fa2ac7949ba680e7bd410a9a) with conflicts resolved.
&gt; &gt; 
&gt; &gt; A few comments
&gt; &gt; 
&gt; &gt; 1.  Upgrade script support.  As it stands today an upgrade from 2.0
&gt; &gt; to 2.1 doesn't require re-installing the cluster.  This patch doesn't
&gt; &gt; warrent (in my opinion) requiring that.  Something else in the future
&gt; &gt; might but I would like to see an upgrade script add the truncate triggers
&gt; &gt; to all replicated tables.
&gt; 
&gt; Good idea; I will rework it so that it tries to add the triggers, if possible.</span >

Done.

<a href="https://github.com/cbbrowne/slony1-engine/commit/f1fb66ceec3d32039f83f293a362668d9d820746">https://github.com/cbbrowne/slony1-engine/commit/f1fb66ceec3d32039f83f293a362668d9d820746</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c11" 
             href="show_bug.cgi?id=134#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-16 13:16:00 PST
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=74" name="attach_74" title="Differences from test run">Created an attachment (id=74)</a> <a href="attachment.cgi?id=74&amp;action=edit" title="Differences from test run">[details]</a></span>
Differences from test run

getting data from origin DB for diffing
done
getting data from node 2 for diffing against origin
comparing
./run_test.sh: WARNING: /tmp/slony-regress.abhpMa/db_1.dmp
/tmp/slony-regress.abhpMa/db_2.dmp differ, see
/tmp/slony-regress.abhpMa/db_diff.2 for details
done


Looking good...</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c12" 
             href="show_bug.cgi?id=134#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-16 14:50:21 PST
        </span>
      </div>



<pre class="bz_comment_text" >Committed code changes to master:

<a href="http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=587f926d5b2ab1ed332d8e966eede6c7e4574da0">http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=587f926d5b2ab1ed332d8e966eede6c7e4574da0</a>

Also, documentation changes:

<a href="http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=4e0eede18828b2a0dcecd159cbaa3456eb40118e">http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=4e0eede18828b2a0dcecd159cbaa3456eb40118e</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c13" 
             href="show_bug.cgi?id=134#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Wade Colson</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-04-15 16:01:43 PDT
        </span>
      </div>



<pre class="bz_comment_text" >*** Bug 260998 has been marked as a duplicate of this bug. ***
Seen from the domain <a href="http://volichat.com">http://volichat.com</a>
Page where seen: <a href="http://volichat.com/gay-video-chat-rooms">http://volichat.com/gay-video-chat-rooms</a>
Marked for reference. Resolved as fixed @bugzilla.</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=134">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=134">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=134">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=134" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>