<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 156 &ndash; Slon on startup should have &quot;health check&quot;</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=156&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=156">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=156">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=156">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_slon bz_bug_156">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;156</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Slon on startup should have &quot;health check&quot;</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2011-11-30 13:14:35 PST</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=156" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2011-11-30 13:14:35">
  <input type="hidden" name="longdesclength" value="10">
  <input type="hidden" name="id" value="156">
  <input type="hidden" name="token" value="1435032295-e0de8329d2ef0a5722fafd5949413f01">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=156">
        <b>Bug&nbsp;156</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Slon on startup should have &quot;health check&quot;</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>Slon on startup should have &quot;health check&quot;
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('Slon on startup should have \"health check\"', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>slon
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">All
       All
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>low
       enhancement
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    <a href="show_bug.cgi?id=128" title="ASSIGNED - DROP TABLE replicatedTable leaves the cluster in a bad state">128</a> 
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=156&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=156">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2010-09-08 12:18 PDT by <span class="vcard"><span class="fn">Christopher Browne</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2011-11-30 13:14 PST 
      (<a href="show_activity.cgi?id=156">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>2 
          users
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
                <option value="womagrid">womagrid</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="2">
      <a href="attachment.cgi?bugid=156&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=156&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 10;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=156#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-09-08 12:18:32 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Stored function performs some tests, returning t/f, and if f, slon will fail
with fatal error.

Tests we know we ought to run:

- verify that tables match sl_table, complete with triggers

- possibly similar for sl_sequence</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=156#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-09-08 14:50:19 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Set up a branch at GitHub for this:

<a href="http://github.com/cbbrowne/slony1-engine/commits/bug156">http://github.com/cbbrowne/slony1-engine/commits/bug156</a>

I do not have a regression test for this yet, but do have:
a) Health check function
b) slon calls it at startup time, and fails FATAL if it fails
c) documentation indicating why the error might come up, and what one might
do about it.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=156#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-10-28 12:05:09 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I've looked over the patch.

I'm wondering if we shouldn't try to print a more helpful error message.

Would we not be friendlier if we printed the names of the tables (both as
listed in sl_table and as listed in pg_class as part of the slon output.

Asking the user to check the postgresql.log is kind of a pain (for them).

We also might want to explicitly mention REPAIR CONFIG in the error message.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=156#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-10-29 10:30:18 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=156#c2">comment #2</a>)
<span class="quote">&gt; I've looked over the patch.
&gt; 
&gt; I'm wondering if we shouldn't try to print a more helpful error message.
&gt; 
&gt; Would we not be friendlier if we printed the names of the tables (both as
&gt; listed in sl_table and as listed in pg_class as part of the slon output.
&gt; 
&gt; Asking the user to check the postgresql.log is kind of a pain (for them).
&gt; 
&gt; We also might want to explicitly mention REPAIR CONFIG in the error message.</span >

I have done all of this...

- slon pulls the warning messages using PQresultErrorMessage(), and displays
them in its logs.

- I augmented the health check function to suggest that REPAIR CONFIG might fix
the problem.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=156#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-01 13:44:51 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Per discussion on list, add in check that the timezone is GMT/UTC (or, I
suppose, one of the timezones which is stable, that is, does not have Daylight
Savings Time), and raise a WARNING if not.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=156#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-03 07:22:28 PDT
        </span>
      </div>



<pre class="bz_comment_text" >
The latest version of the patch seems to introduce the following compiler
warning

slon.c: In function ‘SlonMain’:
slon.c:460: warning: comparison between pointer and integer

from the line 
if (PQgetvalue(res, 0, 0) == 'f') {
                slon_log(SLON_FATAL, 
                 &quot;slon_node_health_check

I am surprised that your testing was able to get this warning to show up.

PQgetvalue(..) will return  a char * to a null terminated string not a char.
strncmp is probably what we want to be using.

2.  If I modify the code to work around that issue this is all I see when I see
in the slon output.

2010-11-03 10:19:30 EDTCONFIG main: local node id = 1
2010-11-03 10:19:30 EDTFATAL  could not call slon_node_health_check() -
2010-11-03 10:19:30 EDTCONFIG slon: child terminated status: 9; pid: 31474,
current worker pid: 31474
2010-11-03 10:19:30 EDTINFO   slon: done
2010-11-03 10:19:30 EDTINFO   slon: exit(0)


I'm not seeing the details. (ie the specific table that is the issue)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=156#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-04 09:13:34 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=156#c5">comment #5</a>)
<span class="quote">&gt; The latest version of the patch seems to introduce the following compiler
&gt; warning
&gt; 
&gt; slon.c: In function ‘SlonMain’:
&gt; slon.c:460: warning: comparison between pointer and integer
&gt; 
&gt; from the line 
&gt; if (PQgetvalue(res, 0, 0) == 'f') {
&gt;                 slon_log(SLON_FATAL, 
&gt;                  &quot;slon_node_health_check
&gt; 
&gt; I am surprised that your testing was able to get this warning to show up.
&gt; 
&gt; PQgetvalue(..) will return  a char * to a null terminated string not a char.
&gt; strncmp is probably what we want to be using.
&gt; 
&gt; 2.  If I modify the code to work around that issue this is all I see when I see
&gt; in the slon output.
&gt; 
&gt; 2010-11-03 10:19:30 EDTCONFIG main: local node id = 1
&gt; 2010-11-03 10:19:30 EDTFATAL  could not call slon_node_health_check() -
&gt; 2010-11-03 10:19:30 EDTCONFIG slon: child terminated status: 9; pid: 31474,
&gt; current worker pid: 31474
&gt; 2010-11-03 10:19:30 EDTINFO   slon: done
&gt; 2010-11-03 10:19:30 EDTINFO   slon: exit(0)
&gt; 
&gt; 
&gt; I'm not seeing the details. (ie the specific table that is the issue)</span >

Right you are...

I have changed it to 
    if (*(PQgetvalue(res, 0, 0)) == 'f') {

which is consistent with what is done elsewhere:

postgres@cbbrowne [12:08:05] [~/slony1-engine.github/src/slon] [<span class="bz_closed"><a href="show_bug.cgi?id=156" title="RESOLVED FIXED - Slon on startup should have &quot;health check&quot;">bug156</a></span> *]
-&gt; % grep -n PQgetvalue *.c | grep &quot;*&quot; | grep &quot;'&quot;
remote_worker.c:2661:           if (*(PQgetvalue(res1, 0, 0)) == 't')
slon.c:460:                             if (*(PQgetvalue(res, 0, 0)) == 'f') {
slon.c:550:             int                     no_active = (*PQgetvalue(res,
i, 1) == 't') ? 1 : 0;


(Of course, the second instance is for this patch! :-))

Here is a self-contained test of this, run against a node that was initialized
and had tables added in.  I mess with it by breaking sl_table.tab_reloid
values.

postgres@cbbrowne [12:10:00] [~/slony1-engine.github/src/slon] [<span class="bz_closed"><a href="show_bug.cgi?id=156" title="RESOLVED FIXED - Slon on startup should have &quot;health check&quot;">bug156</a></span> *]
-&gt; % psql -d slonyregress1 -c &quot;update _slony_regress1.sl_table set
tab_reloid=tab_id;&quot;
UPDATE 4
postgres@cbbrowne [12:10:47] [~/slony1-engine.github/src/slon] [<span class="bz_closed"><a href="show_bug.cgi?id=156" title="RESOLVED FIXED - Slon on startup should have &quot;health check&quot;">bug156</a></span> *]
-&gt; % slon slony_regress1 'dbname=slonyregress1' &gt; /tmp/stdout.txt 2&gt;
/tmp/stderr.txt
postgres@cbbrowne [12:10:55] [~/slony1-engine.github/src/slon] [<span class="bz_closed"><a href="show_bug.cgi?id=156" title="RESOLVED FIXED - Slon on startup should have &quot;health check&quot;">bug156</a></span> *]
-&gt; % cat /tmp/stdout.txt
2010-11-04 12:10:55 EDTCONFIG main: slon version 2.0.5 starting up
2010-11-04 12:10:55 EDTINFO   slon: watchdog process started
2010-11-04 12:10:55 EDTCONFIG slon: watchdog ready - pid = 29512
2010-11-04 12:10:55 EDTCONFIG slon: worker process created - pid = 29513
2010-11-04 12:10:55 EDTCONFIG main: Integer option vac_frequency = 3
2010-11-04 12:10:55 EDTCONFIG main: Integer option log_level = 0
2010-11-04 12:10:55 EDTCONFIG main: Integer option sync_interval = 2000
2010-11-04 12:10:55 EDTCONFIG main: Integer option sync_interval_timeout =
10000
2010-11-04 12:10:55 EDTCONFIG main: Integer option sync_group_maxsize = 20
2010-11-04 12:10:55 EDTCONFIG main: Integer option desired_sync_time = 60000
2010-11-04 12:10:55 EDTCONFIG main: Integer option syslog = 0
2010-11-04 12:10:55 EDTCONFIG main: Integer option quit_sync_provider = 0
2010-11-04 12:10:55 EDTCONFIG main: Integer option quit_sync_finalsync = 0
2010-11-04 12:10:55 EDTCONFIG main: Integer option sync_max_rowsize = 8192
2010-11-04 12:10:55 EDTCONFIG main: Integer option sync_max_largemem = 5242880
2010-11-04 12:10:55 EDTCONFIG main: Integer option remote_listen_timeout = 300
2010-11-04 12:10:55 EDTCONFIG main: Boolean option log_pid = 0
2010-11-04 12:10:55 EDTCONFIG main: Boolean option log_timestamp = 1
2010-11-04 12:10:55 EDTCONFIG main: Boolean option cleanup_deletelogs = 0
2010-11-04 12:10:55 EDTCONFIG main: Real option real_placeholder = 0.000000
2010-11-04 12:10:55 EDTCONFIG main: String option cluster_name = slony_regress1
2010-11-04 12:10:55 EDTCONFIG main: String option conn_info =
dbname=slonyregress1
2010-11-04 12:10:55 EDTCONFIG main: String option pid_file = [NULL]
2010-11-04 12:10:55 EDTCONFIG main: String option log_timestamp_format =
%Y-%m-%d %H:%M:%S %Z
2010-11-04 12:10:55 EDTCONFIG main: String option archive_dir = [NULL]
2010-11-04 12:10:55 EDTCONFIG main: String option sql_on_connection = [NULL]
2010-11-04 12:10:55 EDTCONFIG main: String option lag_interval = [NULL]
2010-11-04 12:10:55 EDTCONFIG main: String option command_on_logarchive =
[NULL]
2010-11-04 12:10:55 EDTCONFIG main: String option syslog_facility = LOCAL0
2010-11-04 12:10:55 EDTCONFIG main: String option syslog_ident = slon
2010-11-04 12:10:55 EDTCONFIG main: String option cleanup_interval = 10 minutes
2010-11-04 12:10:55 EDTCONFIG main: local node id = 1
2010-11-04 12:10:55 EDTFATAL  slon_node_health_check() returned false - fatal
health problem!

REPAIR CONFIG may be helpful to rectify this problem2010-11-04 12:10:55
EDTCONFIG slon: child terminated status: 9; pid: 29513, current worker pid:
29513
2010-11-04 12:10:55 EDTINFO   slon: done
2010-11-04 12:10:55 EDTINFO   slon: exit(0)
postgres@cbbrowne [12:11:03] [~/slony1-engine.github/src/slon] [<span class="bz_closed"><a href="show_bug.cgi?id=156" title="RESOLVED FIXED - Slon on startup should have &quot;health check&quot;">bug156</a></span> *]
-&gt; % cat /tmp/stderr.txt
WARNING:  table [id,nsp,name]=[1,table1,public] - sl_table does not match
pg_class/pg_namespace
WARNING:  table [id,nsp,name]=[2,table2,public] - sl_table does not match
pg_class/pg_namespace
WARNING:  table [id,nsp,name]=[4,table4,public] - sl_table does not match
pg_class/pg_namespace
WARNING:  table [id,nsp,name]=[5,table5,public] - sl_table does not match
pg_class/pg_namespace
WARNING:  Mismatch found between sl_table and pg_class.  Slonik command REPAIR
CONFIG may be useful to rectify this.
postgres@cbbrowne [12:11:07] [~/slony1-engine.github/src/slon] [<span class="bz_closed"><a href="show_bug.cgi?id=156" title="RESOLVED FIXED - Slon on startup should have &quot;health check&quot;">bug156</a></span> *]
-&gt; %</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=156#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-10 07:01:37 PST
        </span>
      </div>



<pre class="bz_comment_text" >I have reviewed version 726a3f0ee1775519696b1e1ebfca804c059da6e5 from your
github repository and am now happy with this being applied against master/HEAD.


Since this is a behavior change I'm inclined to not apply it against 2.0</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=156#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-11-10 11:44:06 PST
        </span>
      </div>



<pre class="bz_comment_text" >Committed to master...

<a href="http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=48bd40e006448b00d7ab413016562e13277102e5">http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=48bd40e006448b00d7ab413016562e13277102e5</a>

I cherry picked the relevant patches into master, then squashed them into a
single patch.  

The following was rather interesting in describing how to do such:

<a href="http://stackoverflow.com/questions/598672/git-how-to-squash-the-first-two-commits">http://stackoverflow.com/questions/598672/git-how-to-squash-the-first-two-commits</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c9" 
             href="show_bug.cgi?id=156#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-11-30 13:14:35 PST
        </span>
      </div>



<pre class="bz_comment_text" >*** <span class="bz_closed"><a href="show_bug.cgi?id=253" title="RESOLVED DUPLICATE - In the event of OID mismatch, slon confirms replication events without actually actioning them">Bug 253</a></span> has been marked as a duplicate of this bug. ***</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=156">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=156">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=156">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=156" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>