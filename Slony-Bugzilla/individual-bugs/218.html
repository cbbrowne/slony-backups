<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 218 &ndash; slon often has to retry transactions due to concurrent update in 2.1.0.b2</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=218&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=218">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=218">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=218">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_slon bz_bug_218">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;218</p>
    </td>

    <td id="subtitle">
      <p class="subheader">slon often has to retry transactions due to concurrent update in 2.1.0.b2</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2011-08-11 05:02:49 PDT</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=218" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2011-08-11 05:02:49">
  <input type="hidden" name="longdesclength" value="27">
  <input type="hidden" name="id" value="218">
  <input type="hidden" name="token" value="1420952729-34a53c9cbd0fdb62fcbcf974585dcfce">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=218">
        <b>Bug&nbsp;218</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">slon often has to retry transactions due to concurrent update in 2.1.0.b2</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>slon often has to retry transactions due to concurrent update in 2.1.0.b2
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('slon often has to retry transactions due to concurrent update in 2.1.0.b2', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>slon
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">PC
       Linux
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>low
       enhancement
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Steve Singer</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=218&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=218">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2011-06-07 13:52 PDT by <span class="vcard"><span class="fn">Steve Singer</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2011-08-11 05:02 PDT 
      (<a href="show_activity.cgi?id=218">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>1 
          user
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>


      <tr class="">
        <td valign="top">
            <a name="a1" href="attachment.cgi?id=104"
               title="View the content of the attachment">
          <b>fix for bug 218</b></a>

          <span class="bz_attach_extra_info">
              (1.07 KB,
                patch)

            <br>
            <a href="#attach_104"
               title="Go to the comment associated with the attachment">2011-06-08 10:15 PDT</a>,
<span class="vcard"><span class="fn">Steve Singer</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=104&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=104&amp;action=diff">Diff</a>
        </td>
      </tr>
      <tr class="">
        <td valign="top">
            <a name="a2" href="attachment.cgi?id=120"
               title="View the content of the attachment">
          <b>Patch to fix order of locking</b></a>

          <span class="bz_attach_extra_info">
              (2.02 KB,
                patch)

            <br>
            <a href="#attach_120"
               title="Go to the comment associated with the attachment">2011-08-09 07:37 PDT</a>,
<span class="vcard"><span class="fn">Steve Singer</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=120&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=120&amp;action=diff">Diff</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
        </span>
      <a href="attachment.cgi?bugid=218&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=218&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 27;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=218#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-07 13:52:56 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Often I see slon having to rollback/retry transactions in 2.1.0.b2 due to 

 could not serialize access due to concurrent update
CONTEXT:  SQL statement &quot;delete from &quot;_slonyregress&quot;.sl_listen&quot;
    PL/pgSQL function &quot;rebuildlistenentries&quot; line 5 at SQL statement
    SQL statement &quot;SELECT &quot;_slonyregress&quot;.RebuildListenEntries()&quot;
    PL/pgSQL function &quot;storepath_int&quot; line 48 at PERFORM
STATEMENT:  select &quot;_slonyregress&quot;.storePath_int(2, 3, 'dbname=slonyregress2
host=localhost port=9432 user=slony password=test', 10); insert into
&quot;_slonyregress&quot;.sl_event     (ev_origin, ev_seqno, ev_timestamp,     
ev_snapshot, ev_type , ev_data1, ev_data2, ev_data3, ev_data4    ) values ('3',
'5000000002', '2011-06-07 16:49:12.861808-04', '217337:217337:', 'STORE_PATH',
'2', '3', 'dbname=slonyregress2 host=localhost port=9432 user=slony
password=test', '10'); insert into &quot;_slonyregress&quot;.sl_confirm     (con_origin,
con_received, con_seqno, con_timestamp)    values (3, 1, '5000000002', now());
commit transaction;


type errors.  

A run of the regression tests encountered this issue 43 types.  When I run
those tests against REL_2_0_STABLE (2.0.7rc1) I don't get any of those errors.

In one instance of testing a slon kept aborting, retrying and failing on
serialize access errors for many minutes before being lucky enough to make
progress.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=218#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-08 08:46:13 PDT
        </span>
      </div>



<pre class="bz_comment_text" >The following is an example from the postgresql query log that shows the issue.


slon.remoteWorkerThread_3 slonyregress1 4def9413.2f41 0LOG:  statement: begin
transaction; set transaction isolation level serializable; 

slon.remoteWorkerThread_3 slonyregress1 4def9413.2f41 0LOG:  statement: select
&quot;_slonyregress&quot;.storePath_int(1, 3, 'dbname=slonyregress1 host=localhost
port=9432 user=slony password=test', 10); insert into &quot;_slonyregress&quot;.sl_event 
   (ev_origin, ev_seqno, ev_timestamp,      ev_snapshot, ev_type , ev_data1,
ev_data2, ev_data3, ev_data4    ) values ('3', '5000000001', '2011-06-08
11:24:03.10834-04', '43245:43245:', 'STORE_PATH', '1', '3',
'dbname=slonyregress1 host=localhost port=9432 user=slony password=test',
'10'); insert into &quot;_slonyregress&quot;.sl_confirm       (con_origin, con_received,
con_seqno, con_timestamp)    values (3, 1, '5000000001', now()); commit
transaction;

slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 0LOG:  statement: begin
transaction; set transaction isolation level serializable; 

slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 0LOG:  statement: select
&quot;_slonyregress&quot;.storePath_int(1, 2, 'dbname=slonyregress1 host=localhost
port=9432 user=slony password=test', 10); insert into &quot;_slonyregress&quot;.sl_event 
   (ev_origin, ev_seqno, ev_timestamp,      ev_snapshot, ev_type , ev_data1,
ev_data2, ev_data3, ev_data4    ) values ('2', '5000000001', '2011-06-08
11:24:03.018181-04', '43243:43243:', 'STORE_PATH', '1', '2',
'dbname=slonyregress1 host=localhost port=9432 user=slony password=test',
'10'); insert into &quot;_slonyregress&quot;.sl_confirm      (con_origin, con_received,
con_seqno, con_timestamp)    values (2, 1, '5000000001', now()); commit
transaction;


slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258ERROR:  could not
serialize access due to read/write dependencies among transactions
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258DETAIL:  Cancelled
on conflict out to pivot 43254, during read.
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258HINT:  The
transaction might succeed if retried.
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258CONTEXT:  SQL
statement &quot;delete from &quot;_slonyregress&quot;.sl_listen&quot;
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258STATEMENT:  select
&quot;_slonyregress&quot;.storePath_int(1, 2, 'dbname=slonyregress1 host=localhost
port=9432 user=slony password=test', 10); insert into &quot;_slonyregress&quot;.sl_event 
   (ev_origin, ev_seqno, ev_timestamp,      ev_snapshot, ev_type , ev_data1,
ev_data2, ev_data3, ev_data4    ) values ('2', '5000000001', '2011-06-08
11:24:03.018181-04', '43243:43243:', 'STORE_PATH', '1', '2',
'dbname=slonyregress1 host=localhost port=9432 user=slony password=test',
'10'); insert into &quot;_slonyregress&quot;.sl_confirm       (con_origin, con_received,
con_seqno, con_timestamp)    values (2, 1, '5000000001', now()); commit
transaction;
slon.remoteWorkerThread_3 slonyregress1 4def9413.2f41 0LOG:  statement: select
li_origin, li_provider from &quot;_slonyregress&quot;.sl_listen where li_receiver = 1


I am not sure why the lock table 'sl_config_lock' at the top of storePath_int
isn't stopping this.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=218#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-08 08:54:41 PDT
        </span>
      </div>



<pre class="bz_comment_text" >
The answer to my previous question is in the PostgreSQL documentation for 'lock
table'
----------
To achieve a similar effect when running a transaction at the Serializable
isolation level, you have to execute the LOCK TABLE statement before executing
any SELECT or data modification statement. A serializable transaction's view of
data will be frozen when its first SELECT or data modification statement
begins. A LOCK TABLE later in the transaction will still prevent concurrent
writes — but it won't ensure that what the transaction reads corresponds to the
latest committed values. 
-----------------

We should move the lock table on sl_config_lock to be outside of the
storePath_int call, similar to what we did for sl_event_lock.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=218#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-08 10:15:18 PDT
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=104" name="attach_104" title="fix for bug 218">Created an attachment (id=104)</a> <a href="attachment.cgi?id=104&amp;action=edit" title="fix for bug 218">[details]</a></span>
fix for <span class="bz_closed"><a href="show_bug.cgi?id=218" title="RESOLVED FIXED - slon often has to retry transactions due to concurrent update in 2.1.0.b2">bug 218</a></span>

Lock sl_config_lock before calling storePath_int</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=218#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-08 11:55:44 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Looks like a good change to me.

I kicked off regression tests against an instance with this patch; tests are
running fine thus far.

If there's a particular test that tends to expose failures, it would be a fine
thing to point out which one it is...</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=218#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-08 13:58:20 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Fixed in 2.1.0 for the next beta

<a href="http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=9f0ff6c21eb9f7493de01a4bda16f178e97c80aa">http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=9f0ff6c21eb9f7493de01a4bda16f178e97c80aa</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=218#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 11:56:45 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Does this actually solve the problem or does it only lower the chance of
running into it?

You remember we had the discussion about LOCK TABLE with respect to snapshots
and realized, that LOCK TABLE statements at the beginning of a transaction
actually cause the lock to be taken out BEFORE the transaction snapshot is
generated. However, this LOCK TABLE cannot be done from inside of a stored
procedure because SELECTing that SP causes the snapshot to be generated before
the LOCK TABLE statement itself.

My gut feeling is that we need slonik to do the LOCK on the sl_config_log at
the beginning of any transaction, where it intends to call SPs that change the
configuration.


Jan</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=218#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 12:13:21 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c6">comment #6</a>)
<span class="quote">&gt; Does this actually solve the problem or does it only lower the chance of
&gt; running into it?
&gt; 
&gt; You remember we had the discussion about LOCK TABLE with respect to snapshots
&gt; and realized, that LOCK TABLE statements at the beginning of a transaction
&gt; actually cause the lock to be taken out BEFORE the transaction snapshot is
&gt; generated. However, this LOCK TABLE cannot be done from inside of a stored
&gt; procedure because SELECTing that SP causes the snapshot to be generated before
&gt; the LOCK TABLE statement itself.
&gt; 
&gt; My gut feeling is that we need slonik to do the LOCK on the sl_config_log at
&gt; the beginning of any transaction, where it intends to call SPs that change the
&gt; configuration.
&gt; 
&gt; 
&gt; Jan</span >

I am inclined to agree with you.  I don't think we should be taking locks in
the stored procedures, so slonik + a few parts of slon might need to do this.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=218#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 12:23:19 PDT
        </span>
      </div>



<pre class="bz_comment_text" >For what release would you consider that?</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c9" 
             href="show_bug.cgi?id=218#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 12:29:27 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c8">comment #8</a>)
<span class="quote">&gt; For what release would you consider that?</span >

I see no reason to fix this in 2.0.

In 2.1 we removed the 'lock sl_config_lock' at the top of the slon remote
worker thread, we  did this because it could cause deadlocks with the
sl_event_lock that slonik now obtains.   An argument can be made that since we
are messing with locking behaviour in 2.1 anyway, and some of our chances
exposed some of the behaviour issues under testing then we should properly fix
the problem in 2.1 

Thoughts?</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c10" 
             href="show_bug.cgi?id=218#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 13:42:28 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I agree. But that causes us to go back to development and out of BETA.


Jan</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c11" 
             href="show_bug.cgi?id=218#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 14:33:04 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I don't think this destroys &quot;beta&quot;; it should be a moderate amount of work to
shift the locks on sl_config_lock into the first query run.

I'll take a look at this.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c12" 
             href="show_bug.cgi?id=218#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-09 14:43:18 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Attempting to LOCK and already locked table only wastes some CPU cycles, so
doing it in a rather generic fashion would be OK, IMHO.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c13" 
             href="show_bug.cgi?id=218#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-10 09:44:50 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I have opened up my own &quot;<span class="bz_closed"><a href="show_bug.cgi?id=218" title="RESOLVED FIXED - slon often has to retry transactions due to concurrent update in 2.1.0.b2">bug218</a></span>&quot; branch, and added the following patch:

<a href="https://github.com/cbbrowne/slony1-engine/commit/9bd169a5f872ddef48d73168e66970c53b39110d">https://github.com/cbbrowne/slony1-engine/commit/9bd169a5f872ddef48d73168e66970c53b39110d</a>

It adds requests for locks on sl_config_lock to remote_worker.c and slonik.c.

The interesting part is that, in many cases, the initial statement locks both
sl_config_lock *and* sl_event_lock, which seems likely to be quite an
improvement in safety.

I'm running regression tests against this right now; if there's some other test
load that is better to try, let me know.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c14" 
             href="show_bug.cgi?id=218#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-10 10:31:12 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Also remember to remove the 'LOCK @NAMESPACE@.sl_config_lock' lines from
slony_funcs.sql - since a) the locking is now being done elsewhere, no point in
paying a penalty twice.  b) Leaving it in there is a bit confusing since
someone else might come along and think that it is okay to obtain
sl_config_lock in the stored functions</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c15" 
             href="show_bug.cgi?id=218#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-06-10 13:21:46 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c14">comment #14</a>)
<span class="quote">&gt; Also remember to remove the 'LOCK @NAMESPACE@.sl_config_lock' lines from
&gt; slony_funcs.sql - since a) the locking is now being done elsewhere, no point in
&gt; paying a penalty twice.  b) Leaving it in there is a bit confusing since
&gt; someone else might come along and think that it is okay to obtain
&gt; sl_config_lock in the stored functions</span >

Good point, though the price isn't too terribly high.

Have done so, and had a successful run of all the regression tests against
this.

<a href="https://github.com/cbbrowne/slony1-engine/commit/35fbb13b44e2136b808a5cd7e8457f616fcc5ccb">https://github.com/cbbrowne/slony1-engine/commit/35fbb13b44e2136b808a5cd7e8457f616fcc5ccb</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c16" 
             href="show_bug.cgi?id=218#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-07-04 07:50:44 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c15">comment #15</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=218#c14">comment #14</a>)
&gt; &gt; Also remember to remove the 'LOCK @NAMESPACE@.sl_config_lock' lines from
&gt; &gt; slony_funcs.sql - since a) the locking is now being done elsewhere, no point in
&gt; &gt; paying a penalty twice.  b) Leaving it in there is a bit confusing since
&gt; &gt; someone else might come along and think that it is okay to obtain
&gt; &gt; sl_config_lock in the stored functions
&gt; 
&gt; Good point, though the price isn't too terribly high.
&gt; 
&gt; Have done so, and had a successful run of all the regression tests against
&gt; this.
&gt; 
&gt; <a href="https://github.com/cbbrowne/slony1-engine/commit/35fbb13b44e2136b808a5cd7e8457f616fcc5ccb">https://github.com/cbbrowne/slony1-engine/commit/35fbb13b44e2136b808a5cd7e8457f616fcc5ccb</a></span >

in cleanupThread.c  there is no explicit transaction (that I can see)

This means that the LOCK TABLE  a and the 'select ..cleanupEvent(...) are done
in separate transactions, so the lock is already released before the call to
cleanupEvent.

in remote_worker.c you seem to lock config_lock before event_lock while in
slonik.c you lock event_lock before config_lock.  We should try to always get
these locks in the same order (I am not sure which order is better or if it
matters)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c17" 
             href="show_bug.cgi?id=218#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-07-05 13:45:19 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I am starting to suspect that commit 9f0ff6c21eb9f7493de01a4bda16f178e97c80aa
is causing the disorder tests (Move Set, when run as part of a larger set) to
fail.

It *seems* that prior to this commit it passes while after I get failures.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c18" 
             href="show_bug.cgi?id=218#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-07-06 08:41:48 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c16">comment #16</a>)
<span class="quote">&gt; in cleanupThread.c  there is no explicit transaction (that I can see)
&gt; 
&gt; This means that the LOCK TABLE  a and the 'select ..cleanupEvent(...) are done
&gt; in separate transactions, so the lock is already released before the call to
&gt; cleanupEvent.</span >

Eek, yes, that's doubtless so.

There wasn't an explicit transaction because the cleanup thread used to have,
as a major component, running VACUUM against Slony's tables, and that can't
take place inside a transaction.

We clearly have activity that needs a transaction, so this needs to complicate
a little bit.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c19" 
             href="show_bug.cgi?id=218#c19">Comment 19</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-07-07 14:58:51 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I have committed the BEGIN/COMMIT addition...  Over to you, Steve...

<a href="https://github.com/cbbrowne/slony1-engine/commit/f3e0776f33c345227df64f06275679ed15bf1a83">https://github.com/cbbrowne/slony1-engine/commit/f3e0776f33c345227df64f06275679ed15bf1a83</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c20" 
             href="show_bug.cgi?id=218#c20">Comment 20</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-07-08 11:21:15 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c19">comment #19</a>)
<span class="quote">&gt; I have committed the BEGIN/COMMIT addition...  Over to you, Steve...
&gt; 
&gt; <a href="https://github.com/cbbrowne/slony1-engine/commit/f3e0776f33c345227df64f06275679ed15bf1a83">https://github.com/cbbrowne/slony1-engine/commit/f3e0776f33c345227df64f06275679ed15bf1a83</a></span >

This looks okay to me, this type of change requires a fair amount of testing
but it is probably best to commit this to master so it can be part of all the
other beta testing.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c21" 
             href="show_bug.cgi?id=218#c21">Comment 21</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-07-11 11:40:32 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Committed latest changes...

<a href="http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=30023c6980f09cba689ca3ae4bc694ba54be559d">http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=30023c6980f09cba689ca3ae4bc694ba54be559d</a>

<a href="http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=ab1853d75628fa483328a4e54a82895d6ef93a19">http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=ab1853d75628fa483328a4e54a82895d6ef93a19</a>

That's not a very nice set of patches, unfortunately.  I didn't &quot;squash&quot; it
hard enough :-(.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c22" 
             href="show_bug.cgi?id=218#c22">Comment 22</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-08 13:39:12 PDT
        </span>
      </div>



<pre class="bz_comment_text" >It looks like the merge issues on this ended up merging in the version of this
fix that has remote_worker obtain sl_config_lock then sl_event_lock  compared
to slonik that obtains sl_event_lock then sl_config_lock.

See my review up thread dated &quot;2011-06-08 08:46:13 PDT&quot; on this bug.

I see the occasional deadlock with the disorder tests due to this.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c23" 
             href="show_bug.cgi?id=218#c23">Comment 23</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-09 07:37:02 PDT
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=120" name="attach_120" title="Patch to fix order of locking">Created an attachment (id=120)</a> <a href="attachment.cgi?id=120&amp;action=edit" title="Patch to fix order of locking">[details]</a></span>
Patch to fix order of locking</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c24" 
             href="show_bug.cgi?id=218#c24">Comment 24</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-10 14:20:16 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Chris please my patch to fix the locking ordering. You can also see that commit
<a href="https://github.com/ssinger/slony1-engine/commit/6cf2ba44eccdd10de07d64e8526ed5bcb1cd80c0">https://github.com/ssinger/slony1-engine/commit/6cf2ba44eccdd10de07d64e8526ed5bcb1cd80c0</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c25" 
             href="show_bug.cgi?id=218#c25">Comment 25</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-10 15:13:03 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=218#c24">comment #24</a>)
<span class="quote">&gt; Chris please my patch to fix the locking ordering. You can also see that commit
&gt; <a href="https://github.com/ssinger/slony1-engine/commit/6cf2ba44eccdd10de07d64e8526ed5bcb1cd80c0">https://github.com/ssinger/slony1-engine/commit/6cf2ba44eccdd10de07d64e8526ed5bcb1cd80c0</a></span >

Ah, quite right.

It's easy to see all the cases, and with the patch, they are now all consistent
in locking sl_event_lock before sl_config_lock.

slonik/slonpostgres@cbbrowne [06:11:41] [~/slony1-engine.github/src] [master *]
-&gt; % grep sl_config */*.c | grep sl_event
slon/remote_worker.c:                                                          
                 &quot;lock table %s.sl_event_lock,%s.sl_config_lock;&quot;,
slon/remote_worker.c:                                                          
 &quot;lock table %s.sl_event_lock,%s.sl_config_lock;&quot;
slon/remote_worker.c:                                                          
 &quot;lock table %s.sl_event_lock, %s.sl_config_lock;&quot;
slon/remote_worker.c:                                                          
 &quot;lock table %s.sl_event_lock,%s.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonpostgres@cbbrowne [06:11:41] [~/slony1-engine.github/src] [master *]
-&gt; % grep sl_config */*.c | grep sl_event
zsh: correct 'sl_event' to 'slevent' [nyae]? n
slon/remote_worker.c:                                                          
                 &quot;lock table %s.sl_event_lock,%s.sl_config_lock;&quot;,
slon/remote_worker.c:                                                          
 &quot;lock table %s.sl_event_lock,%s.sl_config_lock;&quot;
slon/remote_worker.c:                                                          
 &quot;lock table %s.sl_event_lock, %s.sl_config_lock;&quot;
slon/remote_worker.c:                                                          
 &quot;lock table %s.sl_event_lock,%s.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;,
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;,
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
ik.c:                                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;,
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;,
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
ik.c:                                 &quot;lock table \&quot;_%s\&quot;.sl_event_lock,
\&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;,
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;,
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;
slonik/slonik.c:                                 &quot;lock table
\&quot;_%s\&quot;.sl_event_lock, \&quot;_%s\&quot;.sl_config_lock;&quot;</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c26" 
             href="show_bug.cgi?id=218#c26">Comment 26</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-08-11 05:02:49 PDT
        </span>
      </div>



<pre class="bz_comment_text" >This patch has been committed
<a href="http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=3019664f5a44cb1dd12dad644c17a89d13452242">http://git.postgresql.org/gitweb/?p=slony1-engine.git;a=commit;h=3019664f5a44cb1dd12dad644c17a89d13452242</a></pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=218">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=218">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=218">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=218" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>