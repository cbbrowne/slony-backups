<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 336 &ndash; Review transaction isolation level requirements for slon database connections.</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=336&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=336">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=336">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=336">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_NEW bz_product_Slony-I bz_component_slon bz_bug_336">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;336</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Review transaction isolation level requirements for slon database connections.</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2015-12-10 11:17:04 PST</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=336" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2015-12-10 11:17:04">
  <input type="hidden" name="longdesclength" value="2">
  <input type="hidden" name="id" value="336">
  <input type="hidden" name="token" value="1483479762-b41489f788ec6d27027e402ab4c53e14">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=336">
        <b>Bug&nbsp;336</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Review transaction isolation level requirements for slon database connections.</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>Review transaction isolation level requirements for slon database connections.
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('Review transaction isolation level requirements for slon database connections.', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">NEW
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>slon
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">All
       All
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>low
       normal
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Slony Bugs List</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=336&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=336">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2014-03-19 13:26 PDT by <span class="vcard"><span class="fn">Jan Wieck</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2015-12-10 11:17 PST 
      (<a href="show_activity.cgi?id=336">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>2 
          users
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
                <option value="ttignor">ttignor</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="2">
      <a href="attachment.cgi?bugid=336&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=336&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 2;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=336#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2014-03-19 13:26:38 PDT
        </span>
      </div>



<pre class="bz_comment_text" >slon currently uses READ ONLY ISOLATION LEVEL SERIALIZABLE DEFERRABLE for some
transactions, in particular the remote listener. This causes event propagation
to stall during another long running, serializable transaction.

I believe that only event creation and copy_set done against the origin require
serializable. The copy_set can use serializable deferrable. All other slon
transaction should work fine with isolation level repeatable read.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=336#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Tom Tignor</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-12-10 11:12:47 PST
        </span>
      </div>



<pre class="bz_comment_text" >The following is a summary of discussion on a crippling performance problem
resolved by reducing the remote listener from serializable to repeatable read
isolation. Per Steve S, I'm using this ticket to recommend we move forward with
a solution like this in some future release. The consensus from the discussion
appeared to be:

 - Reduced isolation for the remote listener could be safe and effective for
certain workloads.
 - Should provide as a non-default runtime option.
 - Should include big red warnings in the documentation.

----


Hello slony1 community,
I’m part of a team at Akamai working on a notification service based on
postgres. (We call it an Alert Management System.) We’re at the point where we
need to scale past the single instance DB and so have been working with
slony1-2.2.4 (and postgresql-9.1.18) to make that happen. Most tests in the
past few months have been great, but in recent tests the reassuring
SYNC-event-output-per-two-seconds suddenly disappeared. Throughout the day, it
returns for a few minutes (normally less than 5, never 10) and then re-enters
limbo. Vigorous debugging ensued, and the problem was proven to be the
serializable isolation level set in slon/remote_listen.c. Our recent test
environment doesn’t have a tremendous write rate (measured in KB/s), but it
does have 200-400 clients at any one time, which may be a factor. Below is the
stack shown in gdb of the postgres server proc (identified via
pg_stat_activity) while slon is in limbo.
What are the thoughts on possible changes to the remote listener isolation
level and their impact? I’ve tested changes using repeatable read instead, and
also with serializable but dropping the deferrable option. The latter offers
little improvement if any, but the former seems to return us to healthy
replication. In searching around, I found Jan W filed <a href="show_bug.cgi?id=336" title="NEW - Review transaction isolation level requirements for slon database connections.">Bug 336</a> last year (link
below) which suggests we could relax the isolation level here and elsewhere. If
it was helpful, I could verify an agreed solution and submit it back as a
patch. (Not really in the slony community yet, just looking at the process
now.)
Thanks in advance,

<a href="show_bug.cgi?id=336" title="NEW - Review transaction isolation level requirements for slon database connections.">http://www.slony.info/bugzilla/show_bug.cgi?id=336</a>


(gdb) thread apply all bt

Thread 1 (process 13052):
#0  0xffffe430 in __kernel_vsyscall ()
#1  0xf76d2c0f in semop () from /lib32/libc.so.6
#2  0x08275a26 in PGSemaphoreLock (sema=0xf69d6784, interruptOK=1 '\001') at
pg_sema.c:424
#3  0x082b52cb in ProcWaitForSignal () at proc.c:1443
#4  0x082bb57a in GetSafeSnapshot (origSnapshot=&lt;optimized out&gt;) at
predicate.c:1520
#5  RegisterSerializableTransaction (snapshot=0x88105a0) at predicate.c:1580
#6  0x083b3f35 in GetTransactionSnapshot () at snapmgr.c:138
#7  0x082c460a in exec_simple_query (
    query_string=0xa87d248 &quot;select ev_origin, ev_seqno, ev_timestamp,       
ev_snapshot,        \&quot;pg_catalog\&quot;.txid_snapshot_xmin(ev_snapshot),       
\&quot;pg_catalog\&quot;.txid_snapshot_xmax(ev_snapshot),        ev_type,       
ev_data1,&quot;...)
    at postgres.c:948
#8  PostgresMain (argc=1, argv=0xa7cd1e0, dbname=0xa7cd1d0 &quot;ams&quot;,
username=0xa7cd1b8 &quot;ams_slony&quot;) at postgres.c:4021
#9  0x08284a58 in BackendRun (port=0xa808118) at postmaster.c:3657
#10 BackendStartup (port=0xa808118) at postmaster.c:3330
#11 ServerLoop () at postmaster.c:1483
#12 0x082854d8 in PostmasterMain (argc=3, argv=0xa7ccb58) at postmaster.c:1144
#13 0x080cb430 in main (argc=3, argv=0xa7ccb58) at main.c:210
(gdb)


Tom    :-)

----

The last time we had a change to isolation levels was in response to
this thread


<a href="http://lists.slony.info/pipermail/slony1-general/2011-November/011939.html">http://lists.slony.info/pipermail/slony1-general/2011-November/011939.html</a>

Also know as <span class="bz_closed"><a href="show_bug.cgi?id=255" title="RESOLVED FIXED - SSI issues with 9.1">bug #255</a></span> (<span class="bz_closed"><a href="show_bug.cgi?id=255" title="RESOLVED FIXED - SSI issues with 9.1">http://www.slony.info/bugzilla/show_bug.cgi?id=255</a></span>)

I can't recall if anyone figured out if we could reduce the remote
listener isolation level to read committed - read only or not.

One concern at the back of my mind is if a read only repeatable read
transactions would result in more pivot conflicts than a read only
serializable deferrable transaction where the conflicts are with a
serializable transaction running on the origin by some application
transaction.

----


    Hi Steve,
    Sorry for the delay getting back. Inspired by your questions, I¹ve been
reading up on SSI, the Cahill paper and slony1 and postgres code. To
answer your question, I don¹t believe reducing the isolation level for the
remote listener can increase pivot conflicts. As I understand pivots, they
sit in the middle of a ³dangerous structure,² on either side of an
rw-dependency relationship for two other transactions. So a read-only
transaction can¹t be a pivot. Also, since we¹re not changing the data
remote listener reads, I don¹t believe we¹d be creating new
rw-dependencies and so making pivots of other transactions.
    For us, I think there is a broader issue. I found the README-SSI in the
postgres 9.1.18 package. It seems clear the benefits of SSI in postgres
only arrive if all your transactions are serializable.

‹‹
    * Any transaction which is run at a transaction isolation level
other than SERIALIZABLE will not be affected by SSI.  If you want to
enforce business rules through SSI, all transactions should be run at
the SERIALIZABLE transaction isolation level, and that should
probably be set as the default.

‹‹

    Comments in predicate.c also seem to support the idea.
    I believe all the apps in our DB (other than slony1) are using the
default read committed isolation level. As I review our DB-facing procs, I
can see listeners have rw-dependencies on the remote worker (via sl_event)
and the remote worker has an rw-dependency on any of our clients writing
to sl_log_1/2. As I understand SSI, that constitutes a ³dangerous
structure,² but we still can¹t expect postgres SSI to save us if the
clients are non-serializable. Under these conditions, what benefit comes
from serializable slony1 transactions?
    Maybe a solution could be to provide a reduced serialization level as a
runtime option? Requirements vary between apps. For bank transactions,
it¹s certainly clear that everything should be bulletproof. Far better to
get it done late than to do it wrong. For our notification service,
though, timeliness is more important. No ones likes losing data, but the
value of the data degrades in minutes (and unaddressed alarms are likely
to be regenerated.) It¹s far less tolerable to stop replication in its
tracks for long periods in order to achieve serializability.
    I see this message has gotten long. Thanks in advance for your time and
consideration.

    Tom    :-)

----

For whatever it's worth, when Slony was first designed SERIALIZABLE
was the only option -- the alternative was READ COMMITTED and IIRC
there were some corner cases where the data changing in the log tables
could make a big difference (memory fails, but I think it had to do
with log switching).  ISTR it was partly a lesson we learned from
erserver, where some of the basic concepts underlying Slony had been
worked out.

I'd advocate a lot of caution in making changes, ideally by analysing
all the kinds of transaction paths Slony could be seeing.  But with
new isolation levels available, it's probably worth doing some
analysis.

A

----

On Wed, Nov 18, 2015 at 02:26:15PM +0000, Tom Tignor wrote:
...
Sorry for the delay getting back. Inspired by your questions, I¹ve been
reading up on SSI, the Cahill paper and slony1 and postgres code.
...

It should be pointed out that 9.1 goes EOL (End of Life) in less than
a year (Sep 2016), and transaction handling has changed a *lot* since then,
so any changes that core Slony makes may not even work for you.

(FWIW, I think dropping the isolation level in this particular
instance seems safe, however.)

--
Greg Sabino Mullane <a href="mailto:greg@endpoint.com">greg@endpoint.com</a>
End Point Corporation
PGP Key: 0x14964AC8

----


    Greg, Andrew,
    Thanks for the feedback. Greg, can you describe the transaction handling
changes you’re referring to? I recently got the latest pg 9.4
distribution. The README-SSI is identical and while there have been some
changes in predicate.c, they don’t appear sweeping. The doc on Transaction
Isolation appears pretty much the same too.
    A general question for the group: if we would consider a change like this
(as a runtime option or otherwise), what’s the correct way to move it
forward? Should I file a bug? Are there specific tests or analysis which
should be performed?

    Tom    :-)

----

I would use <a href="show_bug.cgi?id=336" title="NEW - Review transaction isolation level requirements for slon database connections.">bug 336</a> for this.
My gut is to make this a runtime option since I am not confident that
downgrading the isolation level won't impact someones workload, having
said that I am open to being convinced otherwise.  I would also be
inclined to leave the default value unchanged for 2.2.x and then maybe
consider changing the default in 2.3.   If we actually any concrete
plans for a 2.3 version I would say just leave the change for 2.3 but I
don't see a 2.3 release happening soon and I don't want to change the
default behaviour in a minor release.


Generally when we make a change like this I try to do lots of runs
through the disorder/clustertest suite that doesn't cover all types of
workloads.  Have you tried this change on your workload? Does it
actually help things?

It would be great if Jan and Chris were to comment on this thread

----


    Yes indeed. With this change, we see replication on all three subscriber
nodes in the 2-5 secs range per SYNC event. (We’re configured with the
2-sec default.) Without it, the subscribers spend most of the day
paralyzed, with sporadic blocks of some minutes of consciousness which
they use to frenetically catch up.
    Figure I’ll await others’ comments and then post excerpts to <a href="show_bug.cgi?id=336" title="NEW - Review transaction isolation level requirements for slon database connections.">bug 336</a>.
Your point on not impacting others’ workloads is very well taken. A
non-default runtime option seems like the right way forward.

    Tom    :-)

----

Without taking SYNC snapshots in a SERIALIZABLE transaction I believe
that a Slony-I replica could suffer the same inconsistency dangers that
a pg_dump without --serializable-deferrable can suffer. Namely a replica
would not be usable as a source for reporting. From the 9.4 pg_dump docs:

&quot;This option is not beneficial for a dump which is intended only for
disaster recovery. It could be useful for a dump used to load a copy of
the database for reporting or other read-only load sharing while the
original database continues to be updated. Without it the dump may
reflect a state which is not consistent with any serial execution of the
transactions eventually committed. For example, if batch processing
techniques are used, a batch may show as closed in the dump without all
of the items which are in the batch appearing.&quot;

Changing the default isolation levels(s) may therefore change, what a
replica can safely be used for and I believe that creating reports is
one of the major use cases. Using options with big, bold, red, flashing
warnings in the documentation would be the only way to go.


Regards, Jan

----

I was wondering if this is actually possible or not.

The remote slon only selects from  sl_event and sl_log_*.  The remote
worker is only going to see rows that are covered by a snapshot range in
the SYNC in sl_event.  Rows in sl_log_* might be visible from a
transaction point of view but they won't be captured by the where
conditions for pulling from sl_log.

The snapshot for the event in sl_log is done by the local sync
connection which is a read-write connection not by a slon remote
read-only connection.

(I'm ignoring copy_set from the above analysis).

----


    One point to clarify: while a general review of isolation levels could be
helpful, the problem I saw and addressed was specifically in the remote
listener. The remedy I’ve been working with is a one-line change. The
behavior we had without it seems similar to the observation Jan makes in
the <a href="show_bug.cgi?id=336" title="NEW - Review transaction isolation level requirements for slon database connections.">bug 336</a> description.


--- src/slon/remote_listen.c.SAVE    2015-11-12 11:09:06.405693227 -0500
+++ src/slon/remote_listen.c    2015-11-12 11:13:00.157825287 -0500
@@ -318,7 +318,7 @@
            }
            if (PQserverVersion(dbconn) &gt;= 90100)
            {
-                slon_mkquery(&amp;query1, &quot;SET SESSION CHARACTERISTICS AS
TRANSACTION
read only isolation level serializable deferrable&quot;);
+                slon_mkquery(&amp;query1, &quot;SET SESSION CHARACTERISTICS AS
TRANSACTION
read only isolation level repeatable read&quot;);
                res = PQexec(dbconn, dstring_data(&amp;query1));
                if (PQresultStatus(res) != PGRES_COMMAND_OK)
                {

    Tom    :-)

----

On Thu, Nov 19, 2015 at 06:09:54PM +0000, Tignor, Tom wrote:
    Thanks for the feedback. Greg, can you describe the transaction handling
changes you’re referring to?

Sorry, my bad - I misremembered the serializable overhaul as happening
in 9.2, not 9.1.

--
Greg Sabino Mullane <a href="mailto:greg@endpoint.com">greg@endpoint.com</a>
End Point Corporation
PGP Key: 0x14964AC8</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=336">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=336">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=336">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=336" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>