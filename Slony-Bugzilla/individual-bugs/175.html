<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 175 &ndash; Monitoring cluster better</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=175&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=175">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=175">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=175">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_core_scripts bz_bug_175">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;175</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Monitoring cluster better</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2011-03-18 12:11:16 PDT</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=175" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2011-03-18 12:11:16">
  <input type="hidden" name="longdesclength" value="19">
  <input type="hidden" name="id" value="175">
  <input type="hidden" name="token" value="1394942773-fddbf99857bdc5bb4a0070c24b1e6438">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=175">
        <b>Bug&nbsp;175</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Monitoring cluster better</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td>Monitoring cluster better
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('Monitoring cluster better', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>core scripts
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>devel
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">All
       All
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>low
       enhancement
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <a href="http://wiki.postgresql.org/wiki/SlonyBrainstorming#Slon_monitoring"><u>U</u>RL</a></b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href="http://wiki.postgresql.org/wiki/SlonyBrainstorming#Slon_monitoring"><span title="http://wiki.postgresql.org/wiki/SlonyBrainstorming#Slon_monitoring">http://wiki.postgresql.org/wiki/Slony...
        </span></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    <span class="bz_closed"><a href="show_bug.cgi?id=167" title="RESOLVED FIXED - Slow down of slon with large backlog">167</a></span> 
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=175&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=175">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2010-12-03 13:45 PST by <span class="vcard"><span class="fn">Christopher Browne</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2011-03-18 12:11 PDT 
      (<a href="show_activity.cgi?id=175">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>1 
          user
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="2">
      <a href="attachment.cgi?bugid=175&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=175&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 19;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=175#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-12-03 13:45:56 PST
        </span>
      </div>



<pre class="bz_comment_text" >* slon records in a queryable form what it's working on
* Requires writing (+COMMIT) at the start of the event loop
* [As noted by Yehuda] This ought to also be useful with slonik, to allow
indicating &quot;whazzup&quot;?

Debate took place surrounding various mechanisms.  The only one without
dramatically unacceptable properties was to add a table to the Slony-I schema.

; SNMP
: Existing standard for network-based monitoring
: Downside - requires extra infrastructure including libraries and possibly
additional tooling to use it
; [<a href="http://www.spread.org/">http://www.spread.org/</a> Spread]
: Fast
: Downside - requires extra infrastructure that's not particularly &quot;standard&quot;
; NOTIFY/LISTEN
: Built-in to Postgres - no new infrastructure needed
: In Postgres 9.0+ can carry payload
: Only becomes visible upon COMMIT
: Results are not stored; listeners must pre-declare their interest
; SQL table
: Built-in to Postgres - no new infrastructure needed
: Only becomes visible upon COMMIT
: Another table to manage and clean up

==== Monitoring Requirements ====

Crucial facts that we want to know about:
# Is replication behind?
# What are components (e.g. - slon, slonik) doing? &lt;BR&gt; Note that slon has
numerous threads
# Recent abnormal states for events (e.g. - error messages)
# Are any non-SYNC events outstanding?
# Backlog volume?
# What is the cluster's configuration?

===== Replication Behind? =====

The existing view sl_status captures this from a what-is-confirmed perspective.
 That is not perfect, but it is not obvious that there is high priority to
enhancing this.

===== What are components doing? =====

Nothing relevant is captured in a usable fashion.

It is thought that what we may do is to add a table where each thread would
capture ''what am I doing?'' (which would replace whatever was previously being
done)

This table would contain a tuple for:
# Each remote worker thread
# Cleanup thread
# Each remote listener thread
# Local SYNC thread

It would track things such as:
# Time processing started
# What thread/process am I?
# What node am I for?
# What am I doing?  &lt;BR&gt; Possibly in several pieces, to cover the following
sorts of facts:
## Event ID
## Event type &lt;BR&gt; Though this could be pulled from sl_event, given node and
event ID
## Additional event activity &lt;BR&gt; Again, could be pulled from sl_event, given
node and event ID

Note that the contents of this table should be quite tiny; a tuple per slon
thread on a node.

This also needs to be able to capture what '''slonik''' is doing; this seems
more troublesome.
# It is possible to have multiple slonik instances acting concurrently -
multiple concurrent events!
# There is no natural &quot;event loop&quot; such that slonik activities would be
expected to clean themselves up over time

====== Suggested slon implementation ======

Two approaches emerged for establishing connections to capture this monitoring
data
# Each thread opens its own DB connection &lt;BR&gt; Unacceptable: Leads to
''enormous'' increase in use of DB connections that are mostly basically idle
# Establish a &quot;monitoring thread&quot;
## A message queue allows other threads to stow entries (complete with
timestamps) that the monitoring thread periodically flushes to the database
## It is plausible that this thread could be merged into the existing local
SYNC thread which isn't terribly busy

===== Recent abnormal states for events  =====

This captures messages about the most recent problem that occurred, storing:
# Time of abnormality
# Event ID
# Node ID
# Description / Error Message

===== non-SYNC events outstanding? =====

This information is already captured, and may be revealed by running a query
that asks, on the source node, for all events that are:
# Not SYNC events
# Have not been confirmed by the subscriber

===== Backlog volume =====

[<a href="show_bug.cgi?id=166" title="NEW - Provide a way of counting the number of outstanding operations in a sync">http://www.slony.info/bugzilla/show_bug.cgi?id=166</a> <a href="show_bug.cgi?id=166" title="NEW - Provide a way of counting the number of outstanding operations in a sync">Bug #166</a>]

This seems troublesome; calculating the number of sl_log_* tuples involved in a
particular SYNC requires running the same complex query that the remote_worker
thread uses to determine which tuples are to be applied.

This is a query that is complex to generate that is fairly expensive to run.

Note that [<span class="bz_closed"><a href="show_bug.cgi?id=167" title="RESOLVED FIXED - Slow down of slon with large backlog">http://www.slony.info/bugzilla/show_bug.cgi?id=167</a></span> <span class="bz_closed"><a href="show_bug.cgi?id=167" title="RESOLVED FIXED - Slow down of slon with large backlog">Bug #167</a></span>] is
changing this query.

===== Cluster configuration =====

There is an existing tool that does some analysis of cluster configuration; see
[<a href="http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob;f=tools/test_slony_state.pl;h=fdc9dcc060229f39a1e1ac8608e33d63054658bf;hb=refs/heads/master">http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob;f=tools/test_slony_state.pl;h=fdc9dcc060229f39a1e1ac8608e33d63054658bf;hb=refs/heads/master</a>
test_slony_state.pl]

It is desirable to have something that generates diagrams of the relationships
between nodes, capturing:
# Nodes
# Subscription Sets, and the paths they take
# Paths between nodes
# Listen paths

It would be nice for the Subscription Set diagram to include indication of
replication state/lag for each node, indicating things like:
# Event Number
# Events Behind Parent
# Time Behind Parent
# Events Behind Origin
# Time Behind Origin</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=175#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-12-06 14:02:16 PST
        </span>
      </div>



<pre class="bz_comment_text" >Note that the cluster analysis portion has been put into <a href="show_bug.cgi?id=176" title="ASSIGNED - Cluster Analysis Tool">bug #176</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=175#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-12-14 10:16:56 PST
        </span>
      </div>



<pre class="bz_comment_text" >Set up a branch for <span class="bz_closed"><a href="show_bug.cgi?id=175" title="RESOLVED FIXED - Monitoring cluster better">bug #175</a></span>
<a href="https://github.com/cbbrowne/slony1-engine/tree/bug175">https://github.com/cbbrowne/slony1-engine/tree/bug175</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=175#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-01-27 09:23:06 PST
        </span>
      </div>



<pre class="bz_comment_text" >More diagrams that might be useful...

- For each set, what nodes are permissible failover targets?

- For each set, which nodes are vulnerable to loss on failover?</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=175#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-14 10:03:51 PST
        </span>
      </div>



<pre class="bz_comment_text" >Sample output:

-&gt; % psql -d slonyregress2 -c &quot;select * from _slony_regress1.sl_components ;&quot;
       co_actor       | co_pid | co_node | co_connection_pid | co_activity |   
  co_starttime      |  co_event  | co_eventtype
----------------------+--------+---------+-------------------+-------------+------------------------+------------+--------------
 local_sync           |   1399 |       0 |              1410 |             |
2011-02-14 17:37:32+00 |            |
 local_monitor        |   1399 |       0 |              1411 |             |
2011-02-14 17:37:32+00 |            |
 remote listener      |   1399 |       1 |              1412 |             |
2011-02-14 17:37:32+00 |            |
 local_cleanup        |   1399 |       0 |              1413 |             |
2011-02-14 17:37:32+00 |            |
 local_listen         |   1399 |       2 |              1403 | SYNC        |
2011-02-14 17:37:50+00 |            | SYNC
 remoteWorkerThread_1 |   1399 |       1 |              1409 | SYNC        |
2011-02-14 17:37:56+00 | 5000000053 | SYNC
(6 rows)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=175#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-17 12:29:50 PST
        </span>
      </div>



<pre class="bz_comment_text" >Suggestion from Jan...

Implement as a stack.

When pushing, see if the entry is for &quot;my&quot; thread; if so, update rather than
pushing a new entry.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=175#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-18 15:23:36 PST
        </span>
      </div>



<pre class="bz_comment_text" >I started taking a poke at adding this monitoring to Slonik, and that looks
like it's liable to be troublesome and/or overly intrusive.

The trouble is that for this to be useful, it needs to generate extra
connections to databases, and do many COMMITs during the course of a Slonik
script, which is going to lead to a flurry of extra DB connections.

I'm not sure but that this is more trouble than the would-be gain.  It also
looks like it requires quite a lot of extra instrumentation code in slonik.c. 
So the &quot;first shot&quot; on this involves not changing slonik.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=175#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-02-25 13:50:28 PST
        </span>
      </div>



<pre class="bz_comment_text" >I have run pgindent against this, to apply typical PG indentation policy.

Should be ready for review.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=175#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-14 06:48:38 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=175#c7">comment #7</a>)
<span class="quote">&gt; I have run pgindent against this, to apply typical PG indentation policy.
&gt; 
&gt; Should be ready for review.</span >

Review at 

<a href="http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html">http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c9" 
             href="show_bug.cgi?id=175#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-15 10:16:15 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=175#c8">comment #8</a>)
<span class="quote">&gt; (In reply to <a href="show_bug.cgi?id=175#c7">comment #7</a>)
&gt; &gt; I have run pgindent against this, to apply typical PG indentation policy.
&gt; &gt; 
&gt; &gt; Should be ready for review.
&gt; 
&gt; Review at 
&gt; 
&gt; <a href="http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html">http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html</a></span >

I have responded to this on the list; see:
<a href="http://lists.slony.info/pipermail/slony1-hackers/2011-March/000447.html">http://lists.slony.info/pipermail/slony1-hackers/2011-March/000447.html</a>

There are patches for virtually all of the items mentioned in the review:

<a href="https://github.com/cbbrowne/slony1-engine/commit/c6082bc77f460e985c7a2891c45269c9648347c9">https://github.com/cbbrowne/slony1-engine/commit/c6082bc77f460e985c7a2891c45269c9648347c9</a>

<a href="https://github.com/cbbrowne/slony1-engine/commit/72ed0337641eefda095cfcb706562d71d9c03413">https://github.com/cbbrowne/slony1-engine/commit/72ed0337641eefda095cfcb706562d71d9c03413</a>

<a href="https://github.com/cbbrowne/slony1-engine/commit/7a3c5f54dcf72bcf67a49f6ed5b80ed673fc0ed5">https://github.com/cbbrowne/slony1-engine/commit/7a3c5f54dcf72bcf67a49f6ed5b80ed673fc0ed5</a>

<a href="https://github.com/cbbrowne/slony1-engine/commit/0543c96506eb55012c4366f78009f886b9464d59">https://github.com/cbbrowne/slony1-engine/commit/0543c96506eb55012c4366f78009f886b9464d59</a>

<a href="https://github.com/cbbrowne/slony1-engine/commit/03f52daf1fb7ae2d819ecd0c411342a594f6884d">https://github.com/cbbrowne/slony1-engine/commit/03f52daf1fb7ae2d819ecd0c411342a594f6884d</a>

<a href="https://github.com/cbbrowne/slony1-engine/commit/d00574d2d1793a372467bc103a7772030fd939ab">https://github.com/cbbrowne/slony1-engine/commit/d00574d2d1793a372467bc103a7772030fd939ab</a>

There were two other issues mentioned which I'll quote as items to specifically
respond to.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c10" 
             href="show_bug.cgi?id=175#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-15 10:17:30 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Per Steve Singer:
&lt;<a href="http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html">http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html</a>&gt;

A general comment:
This monitor thread calls slon_retry() a bunch of times.  We've created a whole
bunch of new failure points for slon.  I'm not sure issues recording the
monitor state should result in a slon falling over. I feel that if the monitor
thread hits an error it can reset the database connections for the monitor
thread but it should leave the threads doing real work alone.   Having said
that we might also want a maximum size of the queue.  If the queue exceeds a
certain size (maybe because the monitor thread keeps hitting issues) then we
stop putting new  elements on the queue or discard the oldest ones.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c11" 
             href="show_bug.cgi?id=175#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-15 10:18:07 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Per Steve Singer:
&lt;<a href="http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html">http://lists.slony.info/pipermail/slony1-hackers/2011-March/000446.html</a>&gt;

I would also like to know what the performance impact in terms of system load
is of running the monitoring stuff.  Ie run some tests without the monitoring
stuff measure average cpu load and run the same test with the monitoring code
and measure average cpu load.  I don't think the impact is going to be high but
we should still measure it.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c12" 
             href="show_bug.cgi?id=175#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-16 13:46:31 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Per Steve's recommendation, monitoring thread problems aren't necessarily
serious problems warranting restarting the slon.

This patch implements that:
<a href="https://github.com/cbbrowne/slony1-engine/commit/d1a5be153e51cd10ac12a3dcb9cbb63856a18306">https://github.com/cbbrowne/slony1-engine/commit/d1a5be153e51cd10ac12a3dcb9cbb63856a18306</a>

Note that there are still some slon_retry() calls remaining, in the scenario
where the slon process runs out of memory.  That seems pretty fatal to me...

I realized that there are cases where we have a horrid memory leak; if the
monitoring thread isn't working, then we shouldn't be collecting monitoring
entries.  Thus, made two changes:

1.  When we exit from the monitoring thread main loop, turn monitoring off.

2.  In the &quot;push&quot; function, if monitoring is shut off, return immediately, do
not attempt to queue up monitoring data.

<a href="https://github.com/cbbrowne/slony1-engine/commit/a61f4642ed29bc727d2361a4000500b81573ea11">https://github.com/cbbrowne/slony1-engine/commit/a61f4642ed29bc727d2361a4000500b81573ea11</a>

I realized that the one entry for the monitoring thread will indicate the time
when the slon daemon started.  Document that...

<a href="https://github.com/cbbrowne/slony1-engine/commit/d3f66cccb54168ca8d6a80261337a66228720cd8">https://github.com/cbbrowne/slony1-engine/commit/d3f66cccb54168ca8d6a80261337a66228720cd8</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c13" 
             href="show_bug.cgi?id=175#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-17 10:42:33 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I don't see a particularly good way to readily analyze CPU loading from this
addition, and I'm not sure that's even the best measurement, in any case.

As an alternative, I instrumented the code in two places, with the following
patch:
diff --git a/src/slon/monitor_thread.c b/src/slon/monitor_thread.c
index 108b338..d88abfd 100644
--- a/src/slon/monitor_thread.c
+++ b/src/slon/monitor_thread.c
@@ -180,6 +180,8 @@ monitorThread_main(void *dummy)
                                                free(state.activity);
                                        if (state.event_type != NULL)
                                                free(state.event_type);
+                                       slon_log(SLON_INFO, &quot;monitor_thread -
record - %s\n&quot;,
+                                                       
dstring_data(&amp;monquery));
                                        res = PQexec(dbconn,
dstring_data(&amp;monquery));
                                        if (PQresultStatus(res) !=
PGRES_TUPLES_OK)
                                        {
@@ -384,6 +386,9 @@ monitor_state(const char *actor, int node, pid_t conn_pid,
/* @null@ */ const ch
        {
                tos-&gt;event_type = NULL;
        }
+       slon_log(SLON_INFO, &quot;monitor_state(pid:%d node:%d connpid:%d event:%lld
actor[%s] activity[%s] event_type[%s]\n&quot;,
+                        tos-&gt;pid, tos-&gt;node, tos-&gt;conn_pid, tos-&gt;event,
+                        tos-&gt;actor, tos-&gt;activity, tos-&gt;event_type);
        pthread_mutex_unlock(&amp;stack_lock);
 }


a) Each time an entry is pushed onto the stack, it is recorded in the log
b) Each time an entry is to be submitted to the DB, the query is recorded in
the log.

In running a typical regression test (e.g. - test1), I saw the following
results...

Test ran from  Mar 17 13:18:00 to Mar 17 13:19:06

 grep monitor_thread /var/log/messages | grep select  | wc -l

-&gt; There were 214 calls to the component_state() function, across two nodes,
so...

214 / (66*2) = 1.6 calls per second

-&gt; There were 471 calls to monitor_state(), across those nodes, that induced
these 214 calls.

That suggests to me that Jan's recommendation to optimize by allowing
successive calls to overwrite a repeated entry for the same thread is doing a
lot of good, reducing the DB load by more than half.

I find it compelling to expect this to be a pretty nominal addition to system
load for Slony.

Poking at the table:

slonyregress1@localhost-&gt;  analyze verbose _slony_regress1.sl_components ;
INFO:  analyzing &quot;_slony_regress1.sl_components&quot;
INFO:  &quot;sl_components&quot;: scanned 1 of 1 pages, containing 6 live rows and 17
dead rows; 6 rows in sample, 6 estimated total rows
ANALYZE
slonyregress1@localhost-&gt;  \c slonyregress2
You are now connected to database &quot;slonyregress2&quot; as user &quot;postgres&quot;.
slonyregress2@localhost-&gt;  analyze verbose _slony_regress1.sl_components ;
INFO:  analyzing &quot;_slony_regress1.sl_components&quot;
INFO:  &quot;sl_components&quot;: scanned 1 of 1 pages, containing 6 live rows and 11
dead rows; 6 rows in sample, 6 estimated total rows
ANALYZE</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c14" 
             href="show_bug.cgi?id=175#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-17 10:43:06 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Thing remembered...

sl_components should be added to the set of tables that the cleanup thread
considers maintaining.

<a href="https://github.com/cbbrowne/slony1-engine/commit/cd3519bba5a03ce2f577747324f4a9ebc697d317">https://github.com/cbbrowne/slony1-engine/commit/cd3519bba5a03ce2f577747324f4a9ebc697d317</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c15" 
             href="show_bug.cgi?id=175#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-18 07:44:48 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Some additional comments based on the latest changes (these are mostly issues
that I just didn't catch in my first review)


1.  We also need to include support in the upgradeSchema() function to take a
2.0.x slony install and add in the new tables for monitoring

2.  In monitor thread - dbconn is never closed.  Especially in the cases where
we 'stop' the monitoring thread we should shutdown the connection (if we are
able). We also MIGHT want to think about emptying the queue at this point.  We
aren't going to empty it later and if the database connection was stuck for a
while before it timed out leading to the error the queue might have grown in
size.  

I also still wonder if we shouldn't be putting a maximum size on the queue, I
know we discussed this the other day and it started to sound complicated.  I
think
there must be a way of doing this with throwing away old entries that isn't
complicated.  If I can find some time I'll see if I can come up with something.
Until then I don't think that needs to hold this patch up.


I also bet we will get complaints from people 
&quot;my slon has been running fine for 3 months but slon_component table stopped
updating a few weeks ago&quot;.   Where some network blimp disabled the
monitor_thread but the rest of slony continued to chug along.  Though i think
this situation is better htan slon restarting as we had before.


3. Line 189 dstring_free(monquery) before breaking out of the loop on the
error.

The discussion on how we should be searching for performance regressions in
slony is maybe outside the scope of this bug other than we should deal with
this before we release 2.1  (looking to see if any of the 2.1 changes are a
performance issue.  I have ideas on how to do this but Jan might already have a
setup for testing this).</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c16" 
             href="show_bug.cgi?id=175#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-18 09:21:30 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=175#c15">comment #15</a>)
<span class="quote">&gt; Some additional comments based on the latest changes (these are mostly issues
&gt; that I just didn't catch in my first review)
&gt; 
&gt; 
&gt; 1.  We also need to include support in the upgradeSchema() function to take a
&gt; 2.0.x slony install and add in the new tables for monitoring</span >

I thought I had done that.  I'll add in the table if it's missing.

<a href="https://github.com/cbbrowne/slony1-engine/commit/d51049b54f014ee4f00f974fc9629a7d64ca9727">https://github.com/cbbrowne/slony1-engine/commit/d51049b54f014ee4f00f974fc9629a7d64ca9727</a>

<span class="quote">&gt; 2.  In monitor thread - dbconn is never closed.  Especially in the cases where
&gt; we 'stop' the monitoring thread we should shutdown the connection (if we are
&gt; able). We also MIGHT want to think about emptying the queue at this point.  We
&gt; aren't going to empty it later and if the database connection was stuck for a
&gt; while before it timed out leading to the error the queue might have grown in
&gt; size.  </span >

dbconn isn't closed directly - it's closed via slon_disconnect(conn).

As for emptying the queue, I don't see much value in it.  The condition on the
loop is on the waits returning SCHED_STATUS_OK.  I don't think you get to ask
it to terminate, or is there a signal you could throw that would kick just the
one thread?

<span class="quote">&gt; I also still wonder if we shouldn't be putting a maximum size on the queue, I
&gt; know we discussed this the other day and it started to sound complicated.  I
&gt; think
&gt; there must be a way of doing this with throwing away old entries that isn't
&gt; complicated.  If I can find some time I'll see if I can come up with something.
&gt; Until then I don't think that needs to hold this patch up.</span >

Idle thought: pick two numbers, m and n, and, once we've reached size m,
generate a warning every time the queue size mod n = 0.

For instance, m=100, n=10.  Once the queue is of size &gt;100, complain every time
the size increases and (size % 10) = 0.

Actually, we're doubling the size of the array each time, so it's perfectly
reasonable to gripe in the logs any time we resize and the size &gt; 100.  I'll do
that...

<span class="quote">&gt; I also bet we will get complaints from people 
&gt; &quot;my slon has been running fine for 3 months but slon_component table stopped
&gt; updating a few weeks ago&quot;.   Where some network blimp disabled the
&gt; monitor_thread but the rest of slony continued to chug along.  Though i think
&gt; this situation is better htan slon restarting as we had before.</span >

That's the risk any time we add anything :-).

<span class="quote">&gt; 3. Line 189 dstring_free(monquery) before breaking out of the loop on the
&gt; error.</span >

Fixed. 
<a href="https://github.com/cbbrowne/slony1-engine/commit/24da0a137120f4032858230836b39ed14da755fb">https://github.com/cbbrowne/slony1-engine/commit/24da0a137120f4032858230836b39ed14da755fb</a>

<span class="quote">&gt; The discussion on how we should be searching for performance regressions in
&gt; slony is maybe outside the scope of this bug other than we should deal with
&gt; this before we release 2.1  (looking to see if any of the 2.1 changes are a
&gt; performance issue.  I have ideas on how to do this but Jan might already have a
&gt; setup for testing this).</span >

I'm happy with that.

I have done a little bit of analytics that suggest that this change should have
minimal impact on performance, and that's certainly what we expected.

And it seems to make sense to look at performance more globally.  It's
acceptable for us to lose a little here and there on one feature or another if:

a) We gain material reliability improvements (e.g. - reasonable value exchange)
b) There are other changes that provide offsetting performance increases.  (Bug
#167, I'm looking at you!  :-))</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c17" 
             href="show_bug.cgi?id=175#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-18 11:01:56 PDT
        </span>
      </div>



<pre class="bz_comment_text" >
<span class="quote">&gt; 
&gt; &gt; 2.  In monitor thread - dbconn is never closed.  Especially in the cases where
&gt; &gt; we 'stop' the monitoring thread we should shutdown the connection (if we are
&gt; &gt; able). We also MIGHT want to think about emptying the queue at this point.  We
&gt; &gt; aren't going to empty it later and if the database connection was stuck for a
&gt; &gt; while before it timed out leading to the error the queue might have grown in
&gt; &gt; size.  
&gt; 
&gt; dbconn isn't closed directly - it's closed via slon_disconnect(conn).</span >

Didn't see that.  We then need to call slon_disconnect on line 92


<span class="quote">&gt; 
&gt; As for emptying the queue, I don't see much value in it.  The condition on the
&gt; loop is on the waits returning SCHED_STATUS_OK.  I don't think you get to ask
&gt; it to terminate, or is there a signal you could throw that would kick just the
&gt; one thread?
&gt; </span >

Lines: 121, 191, and to a lesser extend 212 and 95 are all on code paths where
we break out of the loop but don't free the space already used by the queue.


<span class="quote">&gt; Actually, we're doubling the size of the array each time, so it's perfectly
&gt; reasonable to gripe in the logs any time we resize and the size &gt; 100.  I'll do
&gt; that...</span >

For the moment I guess this is fine to commit, At some point I will try to find
time to implement a properly bounded queue based on the number of threads
such that old entries get thrown away when the queue hits the bound size.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c18" 
             href="show_bug.cgi?id=175#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2011-03-18 12:11:16 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Committed to head

<a href="http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=59fa974c06a1cae9f355809ea81eaa6d443f0a16">http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=59fa974c06a1cae9f355809ea81eaa6d443f0a16</a></pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=175">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=175">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=175">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=175" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>