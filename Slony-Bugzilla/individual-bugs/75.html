<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Bug 75 &ndash; Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_role and &quot;SET datestyle TO 'ISO'&quot; in slonik at connection start.</title>


<link rel="Top" href="http://www.slony.info/bugzilla/">

  

  


  
    <link rel="Show" title="Dependency Tree"
          href="showdependencytree.cgi?id=75&amp;hide_resolved=1">
      <link rel="Show" title="Dependency Graph"
            href="showdependencygraph.cgi?id=75">


      <link rel="Show" title="Bug Activity"
            href="show_activity.cgi?id=75">
      <link rel="Show" title="Printer-Friendly Version"
            href="show_bug.cgi?format=multiple&amp;id=75">


    

    
      <link href="skins/standard/global.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/yui/calendar.css"
            rel="stylesheet"
            type="text/css">
      <link href="skins/standard/show_bug.css"
            rel="stylesheet"
            type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/standard/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    
        <link href="skins/standard/global.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/yui/calendar.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
        <link href="skins/standard/show_bug.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <!--[if lte IE 7]>
      
        <link href="skins/standard/IE-fixes.css"
              rel="stylesheet"
              title="Classic"
              type="text/css">
      <![endif]-->

    
        
            <link href="skins/contrib/Dusk/global.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/yui/calendar.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
            <link href="skins/contrib/Dusk/show_bug.css"
                  rel="alternate stylesheet"
                  title="Dusk"
                  type="text/css">
        <!--[if lte IE 7]>
          
          <link href="skins/contrib/Dusk/IE-fixes.css"
                rel="alternate stylesheet"
                title="Dusk"
                type="text/css">
        <![endif]-->

    

    
        <link href="skins/custom/global.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/yui/calendar.css" rel="stylesheet" type="text/css">
        <link href="skins/custom/show_bug.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 7]>
      
      <link href="skins/custom/IE-fixes.css"
            rel="stylesheet"
            type="text/css">
    <![endif]-->

    <script src="js/yui/yahoo-dom-event.js" type="text/javascript"></script>
    <script src="js/global.js" type="text/javascript"></script>
    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        if (YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        var BUGZILLA = {
            param: {
                cookiepath: '\/'
            }
        };
    // -->
    </script>

        <script src="js/util.js" type="text/javascript"></script>
        <script src="js/field.js" type="text/javascript"></script>
        <script src="js/yui/calendar.js" type="text/javascript"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/favicon.ico" >
  </head>



  <body onload=""
        class="www-slony-info-bugzilla bz_bug bz_status_RESOLVED bz_product_Slony-I bz_component_slonik bz_bug_75">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;75</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_role and &quot;SET datestyle TO 'ISO'&quot; in slonik at connection start.</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2010-08-24 15:32:02 PDT</p>
    </td>
</tr>
</table>
<ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_top"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=75" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_top"
        onsubmit="return check_mini_login_fields( '_top' );"
  >
    <input id="Bugzilla_login_top" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_top')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_top" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_top" value="password"
           onfocus="mini_login_on_focus('_top')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_top">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_top');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_top');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>
<li id="forgot_container_top">
  <span class="separator">| </span>
  <a id="forgot_link_top" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_top')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_top"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_top" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
  </form>
</li>
</ul>

</div>

<div id="bugzilla-body">

<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>
<script type="text/javascript">
  <!--
  
  /* Outputs a link to call replyToComment(); used to reduce HTML output */
  function addReplyLink(id, real_id) {
      /* XXX this should really be updated to use the DOM Core's
       * createElement, but finding a container isn't trivial.
       */
        document.write('[<a href="#add_comment" onclick="replyToComment(' + 
                       id + ',' + real_id + ');">reply<' + '/a>]');
  }

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id, real_id) {
      var prefix = "(In reply to comment #" + id + ")\n";
      var replytext = "";
        /* pre id="comment_name_N" */
        var text_elem = document.getElementById('comment_text_'+id);
        var text = getText(text_elem);

        /* make sure we split on all newlines -- IE or Moz use \r and \n
         * respectively.
         */
        text = text.split(/\r|\n/);

        for (var i=0; i < text.length; i++) {
            replytext += "> " + text[i] + "\n"; 
        }

        replytext = prefix + replytext + "\n";


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }


  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2010-08-24 15:32:02">
  <input type="hidden" name="longdesclength" value="14">
  <input type="hidden" name="id" value="75">
  <input type="hidden" name="token" value="1483479464-14a0093a953d93409d6da3fb83ce7c9d">
<div class="bz_alias_short_desc_container edit_form">
     <a href="show_bug.cgi?id=75">
        <b>Bug&nbsp;75</b></a> - 
     <span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_role and &quot;SET datestyle TO 'ISO'&quot; in slonik at connection start.</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary">  
        
        <tr>
          <td>
            <label accesskey="s" for="short_desc"><u>S</u>ummary</label>:
          </td>
          <td><span title="Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_role and &quot;SET datestyle TO 'ISO'&quot; in slonik at connection start.">Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_r...
        </span>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript">
    hideAliasAndSummary('Bugs: (1) Initialize forgotten cs->plan_active_log. (2) Session_replication_role and \"SET datestyle TO \'ISO\'\" in slonik at connection start.', '');
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <td class="field_label">
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
<th class="field_label "
      id="field_label_product">
        <a href="describecomponents.cgi">Product:</a>
  </th>

<td class="field_value "
    id="field_container_product" >Slony-I</td>
    </tr>
        
    
    
    <tr>
      <td class="field_label">
        <label for="component" accesskey="m">
          <b><a href="describecomponents.cgi?product=Slony-I">
            Co<u>m</u>ponent</a>:
          </b>
        </label>
      </td><td>slonik
  </td>
    </tr>
    <tr>
      <td class="field_label">
        <label for="version"><b>Version</b></label>:
      </td>
<td>2.0
  </td>
    </tr>
        
    
        
    <tr>
      <td class="field_label">
        <label for="rep_platform" accesskey="h"><b>Platform</b></label>:
      </td>
      <td class="field_value">PC
       Linux
       <script type="text/javascript">
         assignToDefaultOnChange(['product', 'component']);
       </script>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <td class="field_label">
        <label for="priority" accesskey="i">
          <b><a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></b></label>:
      </td>
      <td>high
       normal
      </td>
    </tr>            
          
          <tr>
      <td class="field_label">
        <b><a href="page.cgi?id=fields.html#assigned_to">Assigned To</a></b>:
      </td>
      <td><span class="vcard"><span class="fn">Steve Singer</span>
</span>
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr>
    <td class="field_label">
      <label for="bug_file_loc" accesskey="u"><b>
          <u>U</u>RL</b></label>:
    </td>
    <td>
      <span id="bz_url_input_area">
          <a href=""></a>
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr><th class="field_label">
    <label for="dependson">Depends&nbsp;on</label>:
  </th>
  <td>    
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label">
    <label for="blocked" accesskey="b"><u>B</u>locks</label>:
  </th>
  <td>    
    <span id="blocked_input_area">
    </span>
    
  </td>
  
  <tr>
    <th>&nbsp;</th>
  
    <td colspan="2" align="left" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=75&amp;hide_resolved=1">tree</a>
  
        /&nbsp;<a href="showdependencygraph.cgi?id=75">graph</a>
    </td>
  </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <td class="field_label">
      <b>Reported</b>:
    </td>
    <td>2009-03-08 15:54 PDT by <span class="vcard"><span class="fn">Dmitry Koterov</span>
</span>
    </td>
  </tr>
  
  <tr>
    <td class="field_label">
      <b> Modified</b>:
    </td>
    <td>2010-08-24 15:32 PDT 
      (<a href="show_activity.cgi?id=75">History</a>)
    </td>
  
  </tr>
         <tr>
      <td class="field_label">
        <label for="newcc" accesskey="a"><b>CC List</b>:</label>
      </td>
      <td>1 
          user
        <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
          (<a href="#" id="cc_edit_area_showhide">show</a>)
        </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" name="cc" multiple="multiple" size="5">
                <option value="slony1-bugs">slony1-bugs</option>
            </select>
        </div>
        <script type="text/javascript">
          hideEditableField( 'cc_edit_area_showhide_container', 
                             'cc_edit_area', 
                             'cc_edit_area_showhide', 
                             '', 
                             '');  
        </script>
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
      id="field_label_see_also">
        <a href="page.cgi?id=fields.html#see_also">See Also:</a>
  </th>

<td class="field_value "
    id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  
  


<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
    }
    else {
        link.innerHTML = "Hide Obsolete";
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table" cellspacing="0" cellpadding="4">
  <tr>
    <th colspan="2" align="left">
      <a name="a0" id="a0">Attachments</a>
    </th>
  </tr>


      <tr class="">
        <td valign="top">
            <a name="a1" href="attachment.cgi?id=29"
               title="View the content of the attachment">
          <b>Patches for these 2 issues</b></a>

          <span class="bz_attach_extra_info">
              (1.30 KB,
                application/zip)

            <br>
            <a href="#attach_29"
               title="Go to the comment associated with the attachment">2009-03-08 15:54 PDT</a>,
<span class="vcard"><span class="fn">Dmitry Koterov</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=29&amp;action=edit">Details</a>
        </td>
      </tr>
      <tr class=" bz_tr_obsolete bz_default_hidden">
        <td valign="top">
            <a name="a2" href="attachment.cgi?id=50"
               title="View the content of the attachment">
          <b><span class="bz_obsolete">patch to commit session changes right away</span></b></a>

          <span class="bz_attach_extra_info">
              (1.79 KB,
                patch)

            <br>
            <a href="#attach_50"
               title="Go to the comment associated with the attachment">2010-07-13 13:18 PDT</a>,
<span class="vcard"><span class="fn">Steve Singer</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=50&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=50&amp;action=diff">Diff</a>
        </td>
      </tr>
      <tr class="">
        <td valign="top">
            <a name="a3" href="attachment.cgi?id=59"
               title="View the content of the attachment">
          <b>Proposed patch for bug 75</b></a>

          <span class="bz_attach_extra_info">
              (1.45 KB,
                patch)

            <br>
            <a href="#attach_59"
               title="Go to the comment associated with the attachment">2010-08-13 20:34 PDT</a>,
<span class="vcard"><span class="fn">Jan Wieck</span>
</span>
          </span>
        </td>


        <td valign="top">
          <a href="attachment.cgi?id=59&amp;action=edit">Details</a>
            | <a href="attachment.cgi?id=59&amp;action=diff">Diff</a>
        </td>
      </tr>

  <tr class="bz_attach_footer">
    <td colspan="2">
        <span class="bz_attach_view_hide">
            <a href="#a0" onclick="return toggle_display(this);">Show
              Obsolete</a> (1)
        </span>
      <a href="attachment.cgi?bugid=75&amp;action=enter">Add an attachment</a>
      (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>




  <br>
  <table cellpadding="1" cellspacing="1">
    <tr>
      <td id="comment_status_commit">
        <!-- The table keeps the commit button aligned with the box. -->
        <a name="add_comment"></a>
          <fieldset>
            <legend>Note</legend>
            <p>
              You need to
              <a href="show_bug.cgi?id=75&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </p>
          </fieldset>
        
        <hr>
        <div id="comments"><script type="text/javascript">
  <!--
  function updateCommentPrivacy(checkbox, id) {
    var comment_elem = document.getElementById('comment_text_'+id).parentNode;
    if (checkbox.checked) {
      if (!comment_elem.className.match('bz_private')) {
        comment_elem.className = comment_elem.className.concat(' bz_private');
      }
    }
    else {
      comment_elem.className =
        comment_elem.className.replace(/(\s*|^)bz_private(\s*|$)/, '$2');
    }
  }

  /* The functions below expand and collapse comments  */

  function toggle_comment_display(link, comment_id) {
    var comment = document.getElementById('comment_text_' + comment_id);
    var re = new RegExp(/\bcollapsed\b/);
    if (comment.className.match(re))
        expand_comment(link, comment);
    else
        collapse_comment(link, comment);
  }

  function toggle_all_comments(action) {
    var num_comments = 14;

    // If for some given ID the comment doesn't exist, this doesn't mean
    // there are no more comments, but that the comment is private and
    // the user is not allowed to view it.

    for (var id = 0; id < num_comments; id++) {
        var comment = document.getElementById('comment_text_' + id);
        if (!comment)
            continue;

        var link = document.getElementById('comment_link_' + id);
        if (action == 'collapse')
            collapse_comment(link, comment);
        else
            expand_comment(link, comment);
    }
  }

  function collapse_comment(link, comment) {
    link.innerHTML = "[+]";
    link.title = "Expand the comment.";
    YAHOO.util.Dom.addClass(comment, 'collapsed');
  }

  function expand_comment(link, comment) {
    link.innerHTML = "[-]";
    link.title = "Collapse the comment";
    YAHOO.util.Dom.removeClass(comment, 'collapsed');
  }

  /* This way, we are sure that browsers which do not support JS
   * won't display this link  */

  function addCollapseLink(count) {
    document.write(' <a href="#" class="bz_collapse_comment"' +
                   ' id="comment_link_' + count +
                   '" onclick="toggle_comment_display(this, ' +  count +
                   '); return false;" title="Collapse the comment.">[-]<\/a> ');
  }
  //-->
  </script>








<div class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a name="c0" 
             href="show_bug.cgi?id=75#c0">Description</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Dmitry Koterov</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2009-03-08 15:54:14 PDT
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=29" name="attach_29" title="Patches for these 2 issues">Created an attachment (id=29)</a> <a href="attachment.cgi?id=29&amp;action=edit" title="Patches for these 2 issues">[details]</a></span>
Patches for these 2 issues

First, a little patch (1)
-------------------------

--- slony1-2.0.1-orig/src/backend/slony1_funcs.c        2009-02-23
22:09:40.000000000 +0300
+++ slony1-2.0.1/src/backend/slony1_funcs.c     2009-03-08 21:58:38.000000000
+0300
@@ -332,5 +332,5 @@
         * Do the following only once per transaction.
         */
-       if (!TransactionIdEquals(cs-&gt;currentXid, newXid))
+       if (!TransactionIdEquals(cs-&gt;currentXid, newXid) ||
!cs-&gt;plan_active_log)
        {
                int32           log_status;

The patch just adds logical consistence: the code inside this &quot;if&quot; initializes
both cs-&gt;currentXid and plan_active_log once per transaction, but checks only
cs-&gt;currentXid. Additional check for cs-&gt;currentXid is safe and seems to be
reasonable anyway.

(Note that this issue correlate with the second one, so it will break slony if
you will not apply the second patch too. The effect of the second bug is
destroyed by the first bug.)


Second, bug with new session_replication_role and &quot;SET datestyle TO 'ISO'&quot; (2)
------------------------------------------------------------------------------

I detected that logTrigger is NOT turned off during the EXECUTE QUERY in
Slony-I v2.0.1.
Take a look at the following query log produced by slonik:

[postgres@slonopotam_m 1623] LOG:  команда: begin transaction;
[postgres@slonopotam_m 1623] LOG:  команда: SET datestyle TO 'ISO'; SET
session_replication_role TO local;
[postgres@slonopotam_m 1623] LOG:  команда: select version();
[postgres@slonopotam_m 1623] LOG:  команда: rollback transaction;
...
[postgres@slonopotam_m 1623] LOG:  команда: begin transaction;
[postgres@slonopotam_m 1623] LOG:  команда: select
&quot;_sloncluster&quot;.ddlScript_prepare(4725, 2736);
[postgres@slonopotam_m 1623] LOG:  команда: UPDATE a SET id_copy = id;
[postgres@slonopotam_m 1623] LOG:  execute &lt;unnamed&gt;: select
&quot;_sloncluster&quot;.ddlScript_complete(4725, $1::text, 2736);
[postgres@slonopotam_m 1623] LOG:  команда: commit transaction;
...

You see, the effect of &quot;SET session_replication_role TO local&quot; is NOT visible
within a next transaction, because it is rolled back. This is because
db_connect() executes it on a connection start (correct), but via
db_exec_command (wrong), and db_exec_command begins a transaction at its first
run.

(Frankly, thanks to (1) it is not visible, because cs-&gt;plan_active_log is
surprisely null within a logTrigger call. So, logTrigger IS CALLED, but
executes a NULL query which is ignored by Postgres.)

The solution is to perform connection initialization outside a transaction, via
direct PQexec call, not via db_begin_xact().
Here is the patch:

diff -U2 slony1-2.0.1-orig/src/slonik/dbutil.c slony1-2.0.1/src/slonik/dbutil.c
--- slony1-2.0.1-orig/src/slonik/dbutil.c       2008-04-24 00:34:21.000000000
+0400
+++ slony1-2.0.1/src/slonik/dbutil.c    2009-03-08 23:26:18.000000000 +0300
@@ -113,4 +113,5 @@
        PGconn     *dbconn;
        SlonDString     query;
+       PGresult   *res;

        db_notice_stmt = stmt;
@@ -144,10 +145,20 @@

        adminfo-&gt;dbconn = dbconn;
-       if (db_exec_command(stmt, adminfo, &amp;query) &lt; 0)
+
+       res = PQexec(adminfo-&gt;dbconn, dstring_data(&amp;query));
+       if (PQresultStatus(res) != PGRES_COMMAND_OK &amp;&amp;
+               PQresultStatus(res) != PGRES_TUPLES_OK &amp;&amp;
+               PQresultStatus(res) != PGRES_EMPTY_QUERY)
        {
+               fprintf(stderr, &quot;%s:%d: %s %s - %s&quot;,
+                               stmt-&gt;stmt_filename, stmt-&gt;stmt_lno,
+                               PQresStatus(PQresultStatus(res)),
+                               dstring_data(&amp;query),
PQresultErrorMessage(res));
                printf(&quot;Unable to set datestyle\n&quot;);
+               PQclear(res);
                dstring_free(&amp;query);
                return -1;
        }
+       PQclear(res);
        dstring_free(&amp;query);
        return 0;




P.S.
Why postgres rolls back session variable assigned via &quot;SET
session_replication_role TO local&quot;? Because it is the standard behaviour, and
here is an illustration:

postgres=# show session_replication_role;
--&gt; origin
postgres=# begin;
--&gt; BEGIN
postgres=# set session_replication_role to replica;
--&gt; SET
postgres=# show session_replication_role;
--&gt; replica
postgres=# rollback;
--&gt; ROLLBACK
postgres=# show se ssion_replication_role;
--&gt; origin</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c1" 
             href="show_bug.cgi?id=75#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-07-06 11:40:37 PDT
        </span>
      </div>



<pre class="bz_comment_text" >plan_active_log can only be NULL on the very first trigger call in a session.
At this time, the currentXid is invalid, so the check for !cs-&gt;plan_active_log
is redundant.

About setting date style and replication role, wouldn't committing the
transaction instead of rolling it back have the desired effects? 


Jan</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c2" 
             href="show_bug.cgi?id=75#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Dmitry Koterov</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-07-08 11:13:25 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I do not remember exact details of this issue, but what I am clearly remenber -
is that I spend many hours debugging this place a year ago and I discovered two
bugs which correlate to each other and destroy the total effect then they are
executed simultaneously. 

Because of the first bug, Slony executes useless NULL query (please see what
happens when cs-&gt;plan_active_log == NULL, what query is executed). I had seen
these NULL queries in logs, so I corrected this (added ||
!cs-&gt;plan_active_log), but when I had done this, the second bug (SET datestyle
TO 'ISO' execution within rolled-back transaction) appeared.

So, could you please review this bug report again? Sorry, I don't remember
details and have no test cluster to reproduce it again...</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c3" 
             href="show_bug.cgi?id=75#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-07-08 11:33:45 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Please note that cs-&gt;currentXid is initialized to InvalidTransactionId inside
of getClusterStatus(), when it creates a new cs. So on the first call for this
cluster, the conditional code is executed and initializes plan_active_log. I do
not see any possible code path how plan_active_log could be the source of your
NULL queries.

Setting the date style to ISO should stick if we simply commit the transaction,
instead of rolling it back.


Jan</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c4" 
             href="show_bug.cgi?id=75#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-07-09 07:02:31 PDT
        </span>
      </div>



<pre class="bz_comment_text" >I wrote up a patch to add a &quot;commit transaction&quot; at the top of
remoteWorkerThread_main appended after the &quot;set session_replication_role&quot;.

When I test it I get warnings, &quot;WARNING:  there is no transaction in progress&quot;.
 Nor do I see where we start the transaction.  This was with 8.3 is there
either a configuration option, environment variable or change with a newer
version that makes libpq default to auto-commit=false?  Otherwise I don't see
why the set session_replication would be rolled back because it isn't done as
part of a transaction.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c5" 
             href="show_bug.cgi?id=75#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-07-13 13:18:27 PDT
        </span>
      </div>



<pre class="bz_comment_text" ><span class="bz_obsolete"><a href="attachment.cgi?id=50" name="attach_50" title="patch to commit session changes right away">Created an attachment (id=50)</a> <a href="attachment.cgi?id=50&amp;action=edit" title="patch to commit session changes right away">[details]</a></span>
patch to commit session changes right away</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c6" 
             href="show_bug.cgi?id=75#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-11 09:32:48 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=75#c5">comment #5</a>)
<span class="quote">&gt; Created an <span class="bz_obsolete"><a href="attachment.cgi?id=50" name="attach_50" title="patch to commit session changes right away">attachment (id=50)</a> <a href="attachment.cgi?id=50&amp;action=edit" title="patch to commit session changes right away">[details]</a></span> [details]
&gt; patch to commit session changes right away</span >

Looks good to me.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c7" 
             href="show_bug.cgi?id=75#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-13 20:00:34 PDT
        </span>
      </div>



<pre class="bz_comment_text" >This is wrong. The problem is actually in src/slonik/dbutils.c (I know, it's
always a mistake to have identically named files in multiple directories).

There, db_connect() doesn't use PQexec() to set the datestyle, but it uses
db_exec_command(), which automatically starts a transaction if none is open
yet. That transaction needs to be committed by db_connect() via
db_xact_commit().</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c8" 
             href="show_bug.cgi?id=75#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-13 20:01:42 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Making this a 2.0 issue since it is an actual bug that needs to be fixed for
2.0.5.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c9" 
             href="show_bug.cgi?id=75#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-13 20:34:34 PDT
        </span>
      </div>



<pre class="bz_comment_text" ><span class=""><a href="attachment.cgi?id=59" name="attach_59" title="Proposed patch for bug 75">Created an attachment (id=59)</a> <a href="attachment.cgi?id=59&amp;action=edit" title="Proposed patch for bug 75">[details]</a></span>
Proposed patch for <span class="bz_closed"><a href="show_bug.cgi?id=75" title="RESOLVED FIXED - Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_role and &quot;SET datestyle TO 'ISO'&quot; in slonik at connection start.">bug 75</a></span>

Patch to commit session settings. Available also at github as a branch off
REL_2_0_STABLE here: <a href="http://github.com/wieck/slony1-engine/tree/bug75">http://github.com/wieck/slony1-engine/tree/bug75</a></pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c10" 
             href="show_bug.cgi?id=75#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-19 13:39:16 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=75#c9">comment #9</a>)
<span class="quote">&gt; Created an <span class=""><a href="attachment.cgi?id=59" name="attach_59" title="Proposed patch for bug 75">attachment (id=59)</a> <a href="attachment.cgi?id=59&amp;action=edit" title="Proposed patch for bug 75">[details]</a></span> [details]
&gt; Proposed patch for <span class="bz_closed"><a href="show_bug.cgi?id=75" title="RESOLVED FIXED - Bugs: (1) Initialize forgotten cs-&gt;plan_active_log. (2) Session_replication_role and &quot;SET datestyle TO 'ISO'&quot; in slonik at connection start.">bug 75</a></span>
&gt; 
&gt; Patch to commit session settings. Available also at github as a branch off
&gt; REL_2_0_STABLE here: <a href="http://github.com/wieck/slony1-engine/tree/bug75">http://github.com/wieck/slony1-engine/tree/bug75</a></span >

This compiles and runs fine for me, against the &quot;testddl&quot; test
(<a href="http://github.com/wieck/slony1-engine/tree/master/tests/testddl/">http://github.com/wieck/slony1-engine/tree/master/tests/testddl/</a>).

Unfortunately, according to the bug, we're masking the problem.

Is there a straightforward way to induce the bug to express itself, so that we
can expressly see that it's fixed?  I'd think there should be some update we
could do to &quot;testddl&quot; that would exercise the bug, even if all it involves is
spelunking in the Postgres logs to verify that raised notices indicate the
right values.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c11" 
             href="show_bug.cgi?id=75#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Steve Singer</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-23 09:51:56 PDT
        </span>
      </div>



<pre class="bz_comment_text" >The patch looks okay to me but I'm not able to come up with a test that
replicates this issue.

I tried executing a script via execute script that does a 'ROLLBACK' and as one
DDL then as a second one does a INSERT's the output of SELECT
current_config('datestyle') into a table on a database with a non-ISO default
datestyle and I'm not able to replicate this issue (without the patch)</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c12" 
             href="show_bug.cgi?id=75#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Christopher Browne</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-23 10:23:38 PDT
        </span>
      </div>



<pre class="bz_comment_text" >(In reply to <a href="show_bug.cgi?id=75#c11">comment #11</a>)
<span class="quote">&gt; The patch looks okay to me but I'm not able to come up with a test that
&gt; replicates this issue.</span >

I don't have a big problem if Jan concludes that it's a good change to commit,
even absent a visible test case.  It would be nice to have one, though.</pre>
    </div>
  <div class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a name="c13" 
             href="show_bug.cgi?id=75#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user"><span class="vcard"><span class="fn">Jan Wieck</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2010-08-24 15:32:02 PDT
        </span>
      </div>



<pre class="bz_comment_text" >Patch applied.</pre>
    </div>
        </div>
        
      </td>
    </tr>
  </table>
</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=75">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=75">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=75">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>        


<div class="navigation">
  
  
  <i><font color="#777777">First</font></i>
  <i><font color="#777777">Last</font></i>
  <i><font color="#777777">Prev</font></i>
  <i><font color="#777777">Next</font></i>
  &nbsp;&nbsp;
  <i><font color="#777777">No search results available</font></i>
</div>

<br>
</div>



<div id="footer">
  <div class="intro"></div>




<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch">
    <input class="btn" type="submit" value="Find" id="find_bottom"></form></li>

  <li><span class="separator">| </span><a href="report.cgi">Reports</a></li>

  <li></li>


  <li>
        <span class="separator">| </span>
        <a href="docs/en/html/bug_page.html" target="_blank">Help</a>
      </li>
    
      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="?GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>
  <form action="http://www.slony.info/bugzilla/show_bug.cgi?id=75" method="POST" 
        class="mini_login bz_default_hidden"
        id="mini_login_bottom"
        onsubmit="return check_mini_login_fields( '_bottom' );"
  >
    <input id="Bugzilla_login_bottom" 
           class="bz_login"
           name="Bugzilla_login"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input class="bz_password" 
           id="Bugzilla_password_bottom" 
           name="Bugzilla_password"
           type="password"
    >
    <input class="bz_password bz_default_hidden bz_mini_login_help" type="text" 
           id="Bugzilla_password_dummy_bottom" value="password"
           onfocus="mini_login_on_focus('_bottom')"
    >
    <input type="submit" name="GoAheadAndLogIn" value="Log in" 
            id="log_in_bottom">
    <script type="text/javascript">
      mini_login_constants = {
          "login" : "login",
          "warning" : "You must set the login and password before logging in."
      };
      
      if (YAHOO.env.ua.gecko || YAHOO.env.ua.ie || YAHOO.env.ua.opera) {
          YAHOO.util.Event.onDOMReady(function() {
              init_mini_login_form('_bottom');
          });
      }
      else {
          YAHOO.util.Event.on(window, 'load', function () {
              window.setTimeout(function() {
                  init_mini_login_form('_bottom');
              }, 200);
          });
    }
    </script>
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>
<li id="forgot_container_bottom">
  <span class="separator">| </span>
  <a id="forgot_link_bottom" href="?GoAheadAndLogIn=1#forgot"
     onclick="return show_forgot_form('_bottom')">Forgot Password</a>
  <form action="token.cgi" method="post" id="forgot_form_bottom"
        class="mini_forgot bz_default_hidden">
    <label>Login: <input type="text" name="loginname" size="20"></label>
    <input id="forgot_button_bottom" value="Reset Password" 
           type="submit">
    <input type="hidden" name="a" value="reqpw">
    <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
  </form>
</li>
</ul>
  </li>

  
    

  


  
</ul>

  <div class="outro"></div>
</div>

</body>
</html>