From davidtecher at yahoo.fr  Wed Apr  4 03:25:15 2012
From: davidtecher at yahoo.fr (David TECHER)
Date: Wed, 4 Apr 2012 11:25:15 +0100 (BST)
Subject: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
Message-ID: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>

Hi 


I am using Slony 1.2.22

I've noticed that when a CreateEvent occurs

biopacs_production=# select * from pg_stat_activity where procpid=25021;
?datid |????? datname?????? | procpid | usesysid |?? usename??? |???????????????????????? current_query????????????????????????? | waiting |?????????? query_start??????????? |????????? backend_start?????????? | client_addr | client_port
-------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
?16387 | biopacs_production |?? 25021 |?????? 10 | enterprisedb | select "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f?????? | 04-APR-12 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1?? |?????? 42050
(1 row)



Then by querying pg_locks I've noticed that there is a 'AccessSharelock' on all replicated objects (tables and sequences).

It is normal?

Since our database used intensive CPU (high load) I asked myself if it could explained my issue.

Thanks for letting me know.

Kind regards.

David.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-hackers/attachments/20120404/d2a762dc/attachment.htm 

From ssinger at ca.afilias.info  Wed Apr  4 08:25:09 2012
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 04 Apr 2012 11:25:09 -0400
Subject: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
In-Reply-To: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
References: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
Message-ID: <4F7C67D5.8060908@ca.afilias.info>

On 12-04-04 06:25 AM, David TECHER wrote:
> Hi


I can't think of an obvious reason why a generic SYNC event would get a 
lock on all of your tables. I don't think the SYNC event looks at 
replicated tables .

What transactions are holding the locks?  You should be able to see this 
in your pg_locks output (joining back to pg_class to get the tablenames 
from the oids)






>
> I am using Slony 1.2.22
>
> I've noticed that when a CreateEvent occurs
>
> biopacs_production=# select * from pg_stat_activity where procpid=25021;
> datid | datname | procpid | usesysid | usename | current_query | waiting
> | query_start | backend_start | client_addr | client_port
> -------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
> 16387 | biopacs_production | 25021 | 10 | enterprisedb | select
> "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f | 04-APR-12
> 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1 |
> 42050
> (1 row)
>
>
> Then by querying pg_locks I've noticed that there is a 'AccessSharelock'
> on all replicated objects (tables and sequences).
>
> It is normal?
>
> Since our database used intensive CPU (high load) I asked myself if it
> could explained my issue.
>
> Thanks for letting me know.
>
> Kind regards.
>
> David.
>
>
>
> _______________________________________________
> Slony1-hackers mailing list
> Slony1-hackers at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-hackers


From davidtecher at yahoo.fr  Wed Apr  4 08:30:11 2012
From: davidtecher at yahoo.fr (David TECHER)
Date: Wed, 4 Apr 2012 16:30:11 +0100 (BST)
Subject: [Slony1-hackers] Re : CreateEvent and Lokcs on replicated objects
In-Reply-To: <4F7C67D5.8060908@ca.afilias.info>
References: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
	<4F7C67D5.8060908@ca.afilias.info>
Message-ID: <1333553411.37256.YahooMailNeo@web29806.mail.ird.yahoo.com>

Steve

Thanks to reply

This is for the process with pid 25021



Without joining and using the following query I see the tablenames (the 14 first lines)


biopacs_production=# select locktype, relation::regclass as relname,mode,granted from pg_locks where transaction is not null and pid=25021 order by relname limit 14;
?locktype |?????????????????????????????????? relname??????????????????????????????????? |????? mode?????? | granted
----------+------------------------------------------------------------------------------+-----------------+---------
?relation | pg_class???????????????????????????????????????????????????????????????????? | AccessShareLock | t
?relation | pg_namespace???????????????????????????????????????????????????????????????? | AccessShareLock | t
?relation | pg_class_oid_index?????????????????????????????????????????????????????????? | AccessShareLock | t
?relation | _sysrep._unittesting_key_seq???????????????????????????????????????????????? | AccessShareLock | t
?relation | _sysrep.sequence_test??????????????????????????????????????????????????????? | AccessShareLock | t
?relation | globaldata."Address_AddressID_seq"?????????????????????????????????????????? | AccessShareLock | t
?relation | globaldata."AnonymizationRuleAssociation_AnonymizationRuleAssociationID_seq" | AccessShareLock | t
?relation | globaldata."AnonymizationRule_AnonymizationRuleID_seq"?????????????????????? | AccessShareLock | t
?relation | globaldata."Attachment_AttachmentID_seq"???????????????????????????????????? | AccessShareLock | t
?relation | globaldata."AuditAddress_ID_seq"???????????????????????????????????????????? | AccessShareLock | t
?relation | globaldata."AuditAnonymizationRule_ID_seq"?????????????????????????????????? | AccessShareLock | t
?relation | globaldata."AuditAnonymizationRuleAssociation_ID_seq"??????????????????????? | AccessShareLock | t
?relation | globaldata."AuditAttachment_ID_seq"????????????????????????????????????????? | AccessShareLock | t
?relation | globaldata."AuditAttachmentLocation_ID_seq"????????????????????????????????? | AccessShareLock | t
(14 rows)





________________________________
 De?: Steve Singer <ssinger at ca.afilias.info>
??: David TECHER <davidtecher at yahoo.fr> 
Cc?: Slony Hackers <slony1-hackers at lists.slony.info> 
Envoy? le : Mercredi 4 avril 2012 17h25
Objet?: Re: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
 
On 12-04-04 06:25 AM, David TECHER wrote:
> Hi


I can't think of an obvious reason why a generic SYNC event would get a 
lock on all of your tables. I don't think the SYNC event looks at 
replicated tables .

What transactions are holding the locks?? You should be able to see this 
in your pg_locks output (joining back to pg_class to get the tablenames 
from the oids)






>
> I am using Slony 1.2.22
>
> I've noticed that when a CreateEvent occurs
>
> biopacs_production=# select * from pg_stat_activity where procpid=25021;
> datid | datname | procpid | usesysid | usename | current_query | waiting
> | query_start | backend_start | client_addr | client_port
> -------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
> 16387 | biopacs_production | 25021 | 10 | enterprisedb | select
> "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f | 04-APR-12
> 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1 |
> 42050
> (1 row)
>
>
> Then by querying pg_locks I've noticed that there is a 'AccessSharelock'
> on all replicated objects (tables and sequences).
>
> It is normal?
>
> Since our database used intensive CPU (high load) I asked myself if it
> could explained my issue.
>
> Thanks for letting me know.
>
> Kind regards.
>
> David.
>
>
>
> _______________________________________________
> Slony1-hackers mailing list
> Slony1-hackers at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-hackers
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-hackers/attachments/20120404/ad988d43/attachment.htm 

From davidtecher at yahoo.fr  Wed Apr  4 08:40:03 2012
From: davidtecher at yahoo.fr (David TECHER)
Date: Wed, 4 Apr 2012 16:40:03 +0100 (BST)
Subject: [Slony1-hackers] Re : CreateEvent and Lokcs on replicated objects
In-Reply-To: <4F7C67D5.8060908@ca.afilias.info>
References: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
	<4F7C67D5.8060908@ca.afilias.info>
Message-ID: <1333554003.4395.YahooMailNeo@web29804.mail.ird.yahoo.com>

Steve

Using a query taken from?

http://wiki.postgresql.org/wiki/Lock_Monitoring


I've got (the 10 first lines)


biopacs_production=#? select????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? pg_class.relname,pg_locks.transactionid, pg_locks.mode,????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? substr(pg_stat_activity.current_query,1,30),
 pg_stat_activity.query_start,?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? age(now(),pg_stat_activity.query_start) as "age", pg_stat_activity.procpid???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? from pg_stat_activity,pg_locks
 left??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? outer join pg_class on (pg_locks.relation = pg_class.oid)????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? where pg_locks.pid=pg_stat_activity.procpid order by query_start limit 10;
???????????????????????? relname???????????????????????? | transactionid |????? mode?????? |???????????? substr???????????? |?????????? query_start??????????? |???? age???? | procpid
---------------------------------------------------------+---------------+-----------------+--------------------------------+----------------------------------+-------------+---------
?AuditTimePoint_ID_seq?????????????????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?AuditDegradedImage_ID_seq?????????????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?Screenshot_ScreenshotID_seq???????????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?QuestionRule_QuestionRuleID_seq???????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?AuditAllocationStatus_ID_seq??????????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?AuditQCCheckList_ID_seq???????????????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?QueueItemType_QueueItemTypeID_seq?????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?AuditInstitutionType_ID_seq???????????????????????????? |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?AuditExportPublishTables_AuditExportPublishTablesID_seq |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
?AuditCheckParameterRule_ExpectedProtocolSequence_ID_seq |?????????????? | AccessShareLock | select "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs |?? 25021
(10 rows)


Please let me understand



________________________________
 De?: Steve Singer <ssinger at ca.afilias.info>
??: David TECHER <davidtecher at yahoo.fr> 
Cc?: Slony Hackers <slony1-hackers at lists.slony.info> 
Envoy? le : Mercredi 4 avril 2012 17h25
Objet?: Re: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
 
On 12-04-04 06:25 AM, David TECHER wrote:
> Hi


I can't think of an obvious reason why a generic SYNC event would get a 
lock on all of your tables. I don't think the SYNC event looks at 
replicated tables .

What transactions are holding the locks?? You should be able to see this 
in your pg_locks output (joining back to pg_class to get the tablenames 
from the oids)






>
> I am using Slony 1.2.22
>
> I've noticed that when a CreateEvent occurs
>
> biopacs_production=# select * from pg_stat_activity where procpid=25021;
> datid | datname | procpid | usesysid | usename | current_query | waiting
> | query_start | backend_start | client_addr | client_port
> -------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
> 16387 | biopacs_production | 25021 | 10 | enterprisedb | select
> "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f | 04-APR-12
> 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1 |
> 42050
> (1 row)
>
>
> Then by querying pg_locks I've noticed that there is a 'AccessSharelock'
> on all replicated objects (tables and sequences).
>
> It is normal?
>
> Since our database used intensive CPU (high load) I asked myself if it
> could explained my issue.
>
> Thanks for letting me know.
>
> Kind regards.
>
> David.
>
>
>
> _______________________________________________
> Slony1-hackers mailing list
> Slony1-hackers at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-hackers
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-hackers/attachments/20120404/f2c3aeb3/attachment-0001.htm 

From ssinger at ca.afilias.info  Wed Apr  4 08:45:52 2012
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 04 Apr 2012 11:45:52 -0400
Subject: [Slony1-hackers] Re : CreateEvent and Lokcs on replicated
	objects
In-Reply-To: <1333553411.37256.YahooMailNeo@web29806.mail.ird.yahoo.com>
References: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
	<4F7C67D5.8060908@ca.afilias.info>
	<1333553411.37256.YahooMailNeo@web29806.mail.ird.yahoo.com>
Message-ID: <4F7C6CB0.4040003@ca.afilias.info>

On 12-04-04 11:30 AM, David TECHER wrote:
> Steve
>
> Thanks to reply
>
> This is for the process with pid 25021

Can you determine who process 25021 (who is connecting to process 25021) is?

Is it a slonik, a slon or your application?



>
>
> Without joining and using the following query I see the tablenames (the
> 14 first lines)
>
> biopacs_production=# select locktype, relation::regclass as
> relname,mode,granted from pg_locks where transaction is not null and
> pid=25021 order by relname limit 14;
> locktype | relname | mode | granted
> ----------+------------------------------------------------------------------------------+-----------------+---------
> relation | pg_class | AccessShareLock | t
> relation | pg_namespace | AccessShareLock | t
> relation | pg_class_oid_index | AccessShareLock | t
> relation | _sysrep._unittesting_key_seq | AccessShareLock | t
> relation | _sysrep.sequence_test | AccessShareLock | t
> relation | globaldata."Address_AddressID_seq" | AccessShareLock | t
> relation |
> globaldata."AnonymizationRuleAssociation_AnonymizationRuleAssociationID_seq"
> | AccessShareLock | t
> relation | globaldata."AnonymizationRule_AnonymizationRuleID_seq" |
> AccessShareLock | t
> relation | globaldata."Attachment_AttachmentID_seq" | AccessShareLock | t
> relation | globaldata."AuditAddress_ID_seq" | AccessShareLock | t
> relation | globaldata."AuditAnonymizationRule_ID_seq" | AccessShareLock | t
> relation | globaldata."AuditAnonymizationRuleAssociation_ID_seq" |
> AccessShareLock | t
> relation | globaldata."AuditAttachment_ID_seq" | AccessShareLock | t
> relation | globaldata."AuditAttachmentLocation_ID_seq" | AccessShareLock | t
> (14 rows)
>
>
> ------------------------------------------------------------------------
> *De :* Steve Singer <ssinger at ca.afilias.info>
> *? :* David TECHER <davidtecher at yahoo.fr>
> *Cc :* Slony Hackers <slony1-hackers at lists.slony.info>
> *Envoy? le :* Mercredi 4 avril 2012 17h25
> *Objet :* Re: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
>
> On 12-04-04 06:25 AM, David TECHER wrote:
>  > Hi
>
>
> I can't think of an obvious reason why a generic SYNC event would get a
> lock on all of your tables. I don't think the SYNC event looks at
> replicated tables .
>
> What transactions are holding the locks? You should be able to see this
> in your pg_locks output (joining back to pg_class to get the tablenames
> from the oids)
>
>
>
>
>
>
>  >
>  > I am using Slony 1.2.22
>  >
>  > I've noticed that when a CreateEvent occurs
>  >
>  > biopacs_production=# select * from pg_stat_activity where procpid=25021;
>  > datid | datname | procpid | usesysid | usename | current_query | waiting
>  > | query_start | backend_start | client_addr | client_port
>  >
> -------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
>  > 16387 | biopacs_production | 25021 | 10 | enterprisedb | select
>  > "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f | 04-APR-12
>  > 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1 |
>  > 42050
>  > (1 row)
>  >
>  >
>  > Then by querying pg_locks I've noticed that there is a 'AccessSharelock'
>  > on all replicated objects (tables and sequences).
>  >
>  > It is normal?
>  >
>  > Since our database used intensive CPU (high load) I asked myself if it
>  > could explained my issue.
>  >
>  > Thanks for letting me know.
>  >
>  > Kind regards.
>  >
>  > David.
>  >
>  >
>  >
>  > _______________________________________________
>  > Slony1-hackers mailing list
>  > Slony1-hackers at lists.slony.info <mailto:Slony1-hackers at lists.slony.info>
>  > http://lists.slony.info/mailman/listinfo/slony1-hackers
>
>
>


From ssinger at ca.afilias.info  Wed Apr  4 08:51:48 2012
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 04 Apr 2012 11:51:48 -0400
Subject: [Slony1-hackers] Re : CreateEvent and Lokcs on replicated
	objects
In-Reply-To: <1333554003.4395.YahooMailNeo@web29804.mail.ird.yahoo.com>
References: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
	<4F7C67D5.8060908@ca.afilias.info>
	<1333554003.4395.YahooMailNeo@web29804.mail.ird.yahoo.com>
Message-ID: <4F7C6E14.2080807@ca.afilias.info>

On 12-04-04 11:40 AM, David TECHER wrote:
> Steve
>
> Using a query taken from
>

Also, I ONLY see sequences listed in the below output.  I don't see any 
examples of tables.  Are you only seeing this for sequences or did you 
just not paste enough lines to cover tables.




> http://wiki.postgresql.org/wiki/Lock_Monitoring
>
> I've got (the 10 first lines)
>
> biopacs_production=# select pg_class.relname,pg_locks.transactionid,
> pg_locks.mode, &nbs p; substr(pg_stat_activity.current_query,1,30),
> pg_stat_activity.query_start, & nbsp;
> age(now(),pg_stat_activity.query_start) as "age",
> pg_stat_activity.procpid from pg_stat_activity,pg_locks left &n bsp;
> outer join pg_class on (pg_locks.relation = pg_class.oid) ; where
> pg_locks.pid=pg_stat_activity.procpid order by query_start limit 10;
> relname | transactionid | mode | substr | query_start | age | procpid
> ---------------------------------------------------------+---------------+-----------------+--------------------------------+----------------------------------+-------------+---------
> AuditTimePoint_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditDegradedImage_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> Screenshot_ScreenshotID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> QuestionRule_QuestionRuleID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditAllocationStatus_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditQCCheckList_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> QueueItemType_QueueItemTypeID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditInstitutionType_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditExportPublishTables_AuditExportPublishTablesID_seq | |
> AccessShareLock | select "_biocluster".createEve | 04-APR-12
> 11:38:11.809813 -04:00 | @ 0.97 secs | 25021
> AuditCheckParameterRule_ExpectedProtocolSequence_ID_seq | |
> AccessShareLock | select "_biocluster".createEve | 04-APR-12
> 11:38:11.809813 -04:00 | @ 0.97 secs | 25021
> (10 rows)
>
> Please let me understand
>
> ------------------------------------------------------------------------
> *De :* Steve Singer <ssinger at ca.afilias.info>
> *? :* David TECHER <davidtecher at yahoo.fr>
> *Cc :* Slony Hackers <slony1-hackers at lists.slony.info>
> *Envoy? le :* Mercredi 4 avril 2012 17h25
> *Objet :* Re: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
>
> On 12-04-04 06:25 AM, David TECHER wrote:
>  > Hi
>
>
> I can't think of an obvious reason why a generic SYNC event would get a
> lock on all of your tables. I don't think the SYNC event looks at
> replicated tables .
>
> What transactions are holding the locks? You should be able to see this
> in your pg_locks output (joining back to pg_class to get the tablenames
> from the oids)
>
>
>
>
>
>
>  >
>  > I am using Slony 1.2.22
>  >
>  > I've noticed that when a CreateEvent occurs
>  >
>  > biopacs_production=# select * from pg_stat_activity where procpid=25021;
>  > datid | datname | procpid | usesysid | usename | current_query | waiting
>  > | query_start | backend_start | client_addr | client_port
>  >
> -------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
>  > 16387 | biopacs_production | 25021 | 10 | enterprisedb | select
>  > "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f | 04-APR-12
>  > 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1 |
>  > 42050
>  > (1 row)
>  >
>  >
>  > Then by querying pg_locks I've noticed that there is a 'AccessSharelock'
>  > on all replicated objects (tables and sequences).
>  >
>  > It is normal?
>  >
>  > Since our database used intensive CPU (high load) I asked myself if it
>  > could explained my issue.
>  >
>  > Thanks for letting me know.
>  >
>  > Kind regards.
>  >
>  > David.
>  >
>  >
>  >
>  > _______________________________________________
>  > Slony1-hackers mailing list
>  > Slony1-hackers at lists.slony.info <mailto:Slony1-hackers at lists.slony.info>
>  > http://lists.slony.info/mailman/listinfo/slony1-hackers
>
>
>


From davidtecher at yahoo.fr  Wed Apr  4 09:12:02 2012
From: davidtecher at yahoo.fr (David TECHER)
Date: Wed, 4 Apr 2012 17:12:02 +0100 (BST)
Subject: [Slony1-hackers] Re : Re : CreateEvent and Lokcs on replicated
	objects
In-Reply-To: <4F7C6E14.2080807@ca.afilias.info>
References: <1333535115.32327.YahooMailNeo@web29805.mail.ird.yahoo.com>
	<4F7C67D5.8060908@ca.afilias.info>
	<1333554003.4395.YahooMailNeo@web29804.mail.ird.yahoo.com>
	<4F7C6E14.2080807@ca.afilias.info>
Message-ID: <1333555922.39370.YahooMailNeo@web29804.mail.ird.yahoo.com>

Steve

I wrote a mistake. I see it only for sequences.

However I see Slony's tables: sl_event, sl_seqlog and so on...

I want to be sure that it is normal that "CreateEvent" uses a lot of "AccessShareLock" on all sequences. 


Any mistake for Slony 1.2.22 or is it the requested behavior?

biopacs_production=#? select????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????? pg_class.relname,pg_locks.transactionid, pg_locks.mode,??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????&
nbs
p;?????????????????????? substr(pg_stat_activity.current_query,1,30), pg_stat_activity.query_start,????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????&a
mp;
nbsp;????? age(now(),pg_stat_activity.query_start) as "age", pg_stat_activity.procpid?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
??? from pg_stat_activity,pg_locks left????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????&am
p;n
bsp;?????????????????????????????????????????? outer join pg_class on (pg_locks.relation = pg_class.oid)???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
;?????????????????? where pg_locks.pid=pg_stat_activity.procpid and not ( pg_class.relname ~ '_seq$' )order by query_start limit 30;
????????????????????????????
 relname???????????????????????????? | transactionid |?????? mode?????? 
|???????????? substr???????????? |?????????? query_start???????????
 |???? age???? | procpid
-----------------------------------------------------------------+---------------+------------------+--------------------------------+----------------------------------+-------------+---------
?ExpectedProtocolSequenceAttribute_ExpectedProtocolSequenceAttri
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?ExpectedProtocolSequenceAttribute_ExpectedProtocolSequenceAttri
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?ExpectedProtocolSequenceAttribute_ExpectedProtocolSequenceAttri
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?ExpectedProtocolSequenceAttribute_ExpectedProtocolSequenceAttri
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?sl_seqlog?????????????????????????????????????????????????????? |?????????????? | RowExclusiveLock | select
 "_biocluster".createEve | 04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?ExpectedProtocolSequenceAttribute_ExpectedProtocolSequenceAttri
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?ExpectedProtocolSequenceAttribute_ExpectedProtocolSequenceAttri
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |??
 25021
?sl_event???????????????????????????????????????????????????????
 |?????????????? | RowExclusiveLock | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?sl_event???????????????????????????????????????????????????????
 |?????????????? | ExclusiveLock??? | select "_biocluster".createEve | 04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021
?sl_set?????????????????????????????????????????????????????????
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |??
 25021
?pg_class_oid_index?????????????????????????????????????????????
 |?????????????? | AccessShareLock? | select "_biocluster".createEve | 
04-APR-12 12:03:06.372674 -04:00 | @ 0.96 secs |?? 25021


________________________________
 De?: Steve Singer <ssinger at ca.afilias.info>
??: David TECHER <davidtecher at yahoo.fr> 
Cc?: Slony Hackers <slony1-hackers at lists.slony.info> 
Envoy? le : Mercredi 4 avril 2012 17h51
Objet?: Re: Re : [Slony1-hackers] CreateEvent and Lokcs on replicated objects
 
On 12-04-04 11:40 AM, David TECHER wrote:
> Steve
>
> Using a query taken from
>

Also, I ONLY see sequences listed in the below output.? I don't see any 
examples of tables.? Are you only seeing this for sequences or did you 
just not paste enough lines to cover tables.




> http://wiki.postgresql.org/wiki/Lock_Monitoring
>
> I've got (the 10 first lines)
>
> biopacs_production=# select pg_class.relname,pg_locks.transactionid,
> pg_locks.mode, &nbs p; substr(pg_stat_activity.current_query,1,30),
> pg_stat_activity.query_start, & nbsp;
> age(now(),pg_stat_activity.query_start) as "age",
> pg_stat_activity.procpid from pg_stat_activity,pg_locks left &n bsp;
> outer join pg_class on (pg_locks.relation = pg_class.oid) ; where
> pg_locks.pid=pg_stat_activity.procpid order by query_start limit 10;
> relname | transactionid | mode | substr | query_start | age | procpid
> ---------------------------------------------------------+---------------+-----------------+--------------------------------+----------------------------------+-------------+---------
> AuditTimePoint_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditDegradedImage_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> Screenshot_ScreenshotID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> QuestionRule_QuestionRuleID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditAllocationStatus_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditQCCheckList_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> QueueItemType_QueueItemTypeID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditInstitutionType_ID_seq | | AccessShareLock | select
> "_biocluster".createEve | 04-APR-12 11:38:11.809813 -04:00 | @ 0.97 secs
> | 25021
> AuditExportPublishTables_AuditExportPublishTablesID_seq | |
> AccessShareLock | select "_biocluster".createEve | 04-APR-12
> 11:38:11.809813 -04:00 | @ 0.97 secs | 25021
> AuditCheckParameterRule_ExpectedProtocolSequence_ID_seq | |
> AccessShareLock | select "_biocluster".createEve | 04-APR-12
> 11:38:11.809813 -04:00 | @ 0.97 secs | 25021
> (10 rows)
>
> Please let me understand
>
> ------------------------------------------------------------------------
> *De :* Steve Singer <ssinger at ca.afilias.info>
> *? :* David TECHER <davidtecher at yahoo.fr>
> *Cc :* Slony Hackers <slony1-hackers at lists.slony.info>
> *Envoy? le :* Mercredi 4 avril 2012 17h25
> *Objet :* Re: [Slony1-hackers] CreateEvent and Lokcs on replicated objects
>
> On 12-04-04 06:25 AM, David TECHER wrote:
>? > Hi
>
>
> I can't think of an obvious reason why a generic SYNC event would get a
> lock on all of your tables. I don't think the SYNC event looks at
> replicated tables .
>
> What transactions are holding the locks? You should be able to see this
> in your pg_locks output (joining back to pg_class to get the tablenames
> from the oids)
>
>
>
>
>
>
>? >
>? > I am using Slony 1.2.22
>? >
>? > I've noticed that when a CreateEvent occurs
>? >
>? > biopacs_production=# select * from pg_stat_activity where procpid=25021;
>? > datid | datname | procpid | usesysid | usename | current_query | waiting
>? > | query_start | backend_start | client_addr | client_port
>? >
> -------+--------------------+---------+----------+--------------+----------------------------------------------------------------+---------+----------------------------------+----------------------------------+-------------+-------------
>? > 16387 | biopacs_production | 25021 | 10 | enterprisedb | select
>? > "_biocluster".createEvent('_biocluster', 'SYNC', NULL); | f | 04-APR-12
>? > 06:22:24.804654 -04:00 | 01-APR-12 06:53:33.363283 -04:00 | 127.0.1.1 |
>? > 42050
>? > (1 row)
>? >
>? >
>? > Then by querying pg_locks I've noticed that there is a 'AccessSharelock'
>? > on all replicated objects (tables and sequences).
>? >
>? > It is normal?
>? >
>? > Since our database used intensive CPU (high load) I asked myself if it
>? > could explained my issue.
>? >
>? > Thanks for letting me know.
>? >
>? > Kind regards.
>? >
>? > David.
>? >
>? >
>? >
>? > _______________________________________________
>? > Slony1-hackers mailing list
>? > Slony1-hackers at lists.slony.info <mailto:Slony1-hackers at lists.slony.info>
>? > http://lists.slony.info/mailman/listinfo/slony1-hackers
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-hackers/attachments/20120404/a4479a60/attachment-0001.htm 

From davidtecher at yahoo.fr  Wed Apr  4 11:34:14 2012
From: davidtecher at yahoo.fr (David TECHER)
Date: Wed, 4 Apr 2012 19:34:14 +0100 (BST)
Subject: [Slony1-hackers] Number of lock for CreateEvents and performance
Message-ID: <1333564454.96743.YahooMailNeo@web29802.mail.ird.yahoo.com>

Hi

I am using Slony 1.2.22.? When a createEvents occurs, I noticed that AccessShareLock is assigned on 11700 sequences in the same transaction.
I've got a lot of objects to replicated.

Could the number of objects being locked having when a createEvent ocurs have a impact?

Kind regards.

David.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-hackers/attachments/20120404/2f7739e5/attachment.htm 

From cbbrowne at afilias.info  Wed Apr  4 12:34:30 2012
From: cbbrowne at afilias.info (Christopher Browne)
Date: Wed, 4 Apr 2012 15:34:30 -0400
Subject: [Slony1-hackers] Number of lock for CreateEvents and performance
In-Reply-To: <1333564454.96743.YahooMailNeo@web29802.mail.ird.yahoo.com>
References: <1333564454.96743.YahooMailNeo@web29802.mail.ird.yahoo.com>
Message-ID: <CANfbgbb-6S1-V5QV6bvby+UpPVa-0EOY7nSM3QvjFFtNR4F0dw@mail.gmail.com>

On Wed, Apr 4, 2012 at 2:34 PM, David TECHER <davidtecher at yahoo.fr> wrote:
>
> Hi
>
> I am using Slony 1.2.22.? When a createEvents occurs, I noticed that AccessShareLock is assigned on 11700 sequences in the same transaction.
> I've got a lot of objects to replicated.
>
> Could the number of objects being locked having when a createEvent ocurs have a impact?

This isn't a particular surprise...

Upon creating an event, the slon process needs to capture which
sequence values have changed.

In 2.0, we optimized this to only capture those that changed.  In 1.2,
all values of all sequences are captured in sl_seqlog in *every* SYNC
(which corresponds to createEvent).

The improvement in 2.0 means that less data is tracked, though the
locking would still occur on the 11700 sequences.

So all in all, this isn't a phenomenon that I find surprising.

You'll find that table sl_seqlog is a *very* busy table in your
replication infrastructure.  11700 sequences is a mighty lot of
sequences to be replicating.

From davidtecher at yahoo.fr  Wed Apr  4 12:43:28 2012
From: davidtecher at yahoo.fr (David TECHER)
Date: Wed, 4 Apr 2012 20:43:28 +0100 (BST)
Subject: [Slony1-hackers] Re : Number of lock for CreateEvents and
	performance
In-Reply-To: <CANfbgbb-6S1-V5QV6bvby+UpPVa-0EOY7nSM3QvjFFtNR4F0dw@mail.gmail.com>
References: <1333564454.96743.YahooMailNeo@web29802.mail.ird.yahoo.com>
	<CANfbgbb-6S1-V5QV6bvby+UpPVa-0EOY7nSM3QvjFFtNR4F0dw@mail.gmail.com>
Message-ID: <1333568608.836.YahooMailNeo@web29806.mail.ird.yahoo.com>

Hi Christopher,

Thanks for your reply.

So there is a significant impact. I was sure about that.



________________________________
 De?: Christopher Browne <cbbrowne at afilias.info>
??: David TECHER <davidtecher at yahoo.fr> 
Cc?: Slony Hackers <slony1-hackers at lists.slony.info> 
Envoy? le : Mercredi 4 avril 2012 21h34
Objet?: Re: [Slony1-hackers] Number of lock for CreateEvents and performance
 
On Wed, Apr 4, 2012 at 2:34 PM, David TECHER <davidtecher at yahoo.fr> wrote:
>
> Hi
>
> I am using Slony 1.2.22.? When a createEvents occurs, I noticed that AccessShareLock is assigned on 11700 sequences in the same transaction.
> I've got a lot of objects to replicated.
>
> Could the number of objects being locked having when a createEvent ocurs have a impact?

This isn't a particular surprise...

Upon creating an event, the slon process needs to capture which
sequence values have changed.

In 2.0, we optimized this to only capture those that changed.? In 1.2,
all values of all sequences are captured in sl_seqlog in *every* SYNC
(which corresponds to createEvent).

The improvement in 2.0 means that less data is tracked, though the
locking would still occur on the 11700 sequences.

So all in all, this isn't a phenomenon that I find surprising.

You'll find that table sl_seqlog is a *very* busy table in your
replication infrastructure.? 11700 sequences is a mighty lot of
sequences to be replicating.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-hackers/attachments/20120404/c3b8498b/attachment.htm 

