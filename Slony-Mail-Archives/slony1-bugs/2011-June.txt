From bugzilla-daemon at main.slony.info  Thu Jun  2 13:52:01 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  2 Jun 2011 13:52:01 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110602205202.0A6F0290DB6@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #9 from Steve Singer <ssinger at ca.afilias.info> 2011-06-02 13:52:01 PDT ---
These patches do not work with 9.0

tgargs in pg_trigger is now stored in a different format.

Does anyone know how to decode this? 
In a way that works in all versions of PG?

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun  3 11:58:32 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri,  3 Jun 2011 11:58:32 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110603185832.2C1F6290DAD@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #10 from Steve Singer <ssinger at ca.afilias.info> 2011-06-03 11:58:31 PDT ---
Created an attachment (id=102)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=102)
updates to the patch for 9.0 support

This update to the patch adds a C function that will decode tgargs in 9.0.

It will also print a warning on tables that need repair but are skipped because
no lock was previously obtained on the table.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Tue Jun  7 13:52:56 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Tue,  7 Jun 2011 13:52:56 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] New: slon often has to retry transactions
 due to concurrent update in 2.1.0.b2
Message-ID: <bug-218-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

           Summary: slon often has to retry transactions due to concurrent
                    update in 2.1.0.b2
           Product: Slony-I
           Version: devel
          Platform: PC
        OS/Version: Linux
            Status: NEW
          Severity: enhancement
          Priority: low
         Component: slon
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: ssinger at ca.afilias.info
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


Often I see slon having to rollback/retry transactions in 2.1.0.b2 due to 

 could not serialize access due to concurrent update
CONTEXT:  SQL statement "delete from "_slonyregress".sl_listen"
    PL/pgSQL function "rebuildlistenentries" line 5 at SQL statement
    SQL statement "SELECT "_slonyregress".RebuildListenEntries()"
    PL/pgSQL function "storepath_int" line 48 at PERFORM
STATEMENT:  select "_slonyregress".storePath_int(2, 3, 'dbname=slonyregress2
host=localhost port=9432 user=slony password=test', 10); insert into
"_slonyregress".sl_event     (ev_origin, ev_seqno, ev_timestamp,     
ev_snapshot, ev_type , ev_data1, ev_data2, ev_data3, ev_data4    ) values ('3',
'5000000002', '2011-06-07 16:49:12.861808-04', '217337:217337:', 'STORE_PATH',
'2', '3', 'dbname=slonyregress2 host=localhost port=9432 user=slony
password=test', '10'); insert into "_slonyregress".sl_confirm     (con_origin,
con_received, con_seqno, con_timestamp)    values (3, 1, '5000000002', now());
commit transaction;


type errors.  

A run of the regression tests encountered this issue 43 types.  When I run
those tests against REL_2_0_STABLE (2.0.7rc1) I don't get any of those errors.

In one instance of testing a slon kept aborting, retrying and failing on
serialize access errors for many minutes before being lucky enough to make
progress.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 07:50:24 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 07:50:24 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 219] New: truncate triggers in 9.1 don't load
Message-ID: <bug-219-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=219

           Summary: truncate triggers in 9.1 don't load
           Product: Slony-I
           Version: devel
          Platform: PC
        OS/Version: Linux
            Status: NEW
          Severity: enhancement
          Priority: low
         Component: trigger SPI
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: ssinger at ca.afilias.info
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


Under postgresql 9.1 beta x (master sometime after beta 1)

I see the following in my postgresql log

WARNING:  This node is running PostgreSQL 8.3 - cannot apply TRUNCATE triggers
CONTEXT:  SQL statement "SELECT "_slonyregress".add_truncate_triggers()"
    PL/pgSQL function "upgradeschema" line 12 at PERFORM



slonik seems to be defaulting to 8.3 behaviour when it can't recognize the
version instead of 8.4

see load_slony_functions in slonik.c

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 07:57:54 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 07:57:54 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 219] truncate triggers in 9.1 don't load
In-Reply-To: <bug-219-4@http.www.slony.info/bugzilla/>
References: <bug-219-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608145755.00A37290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=219

--- Comment #1 from Steve Singer <ssinger at ca.afilias.info> 2011-06-08 07:57:54 PDT ---
Created an attachment (id=103)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=103)
fix for bug 219

This is a proposed fix for bug 219.

The problem only applies to 2.1, REL_2_0_STABLE already seems to have the
correct behaviour.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 08:46:13 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 08:46:13 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608154613.6DA8B29032D@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #1 from Steve Singer <ssinger at ca.afilias.info> 2011-06-08 08:46:13 PDT ---
The following is an example from the postgresql query log that shows the issue.


slon.remoteWorkerThread_3 slonyregress1 4def9413.2f41 0LOG:  statement: begin
transaction; set transaction isolation level serializable; 

slon.remoteWorkerThread_3 slonyregress1 4def9413.2f41 0LOG:  statement: select
"_slonyregress".storePath_int(1, 3, 'dbname=slonyregress1 host=localhost
port=9432 user=slony password=test', 10); insert into "_slonyregress".sl_event 
   (ev_origin, ev_seqno, ev_timestamp,      ev_snapshot, ev_type , ev_data1,
ev_data2, ev_data3, ev_data4    ) values ('3', '5000000001', '2011-06-08
11:24:03.10834-04', '43245:43245:', 'STORE_PATH', '1', '3',
'dbname=slonyregress1 host=localhost port=9432 user=slony password=test',
'10'); insert into "_slonyregress".sl_confirm       (con_origin, con_received,
con_seqno, con_timestamp)    values (3, 1, '5000000001', now()); commit
transaction;

slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 0LOG:  statement: begin
transaction; set transaction isolation level serializable; 

slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 0LOG:  statement: select
"_slonyregress".storePath_int(1, 2, 'dbname=slonyregress1 host=localhost
port=9432 user=slony password=test', 10); insert into "_slonyregress".sl_event 
   (ev_origin, ev_seqno, ev_timestamp,      ev_snapshot, ev_type , ev_data1,
ev_data2, ev_data3, ev_data4    ) values ('2', '5000000001', '2011-06-08
11:24:03.018181-04', '43243:43243:', 'STORE_PATH', '1', '2',
'dbname=slonyregress1 host=localhost port=9432 user=slony password=test',
'10'); insert into "_slonyregress".sl_confirm      (con_origin, con_received,
con_seqno, con_timestamp)    values (2, 1, '5000000001', now()); commit
transaction;


slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258ERROR:  could not
serialize access due to read/write dependencies among transactions
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258DETAIL:  Cancelled
on conflict out to pivot 43254, during read.
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258HINT:  The
transaction might succeed if retried.
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258CONTEXT:  SQL
statement "delete from "_slonyregress".sl_listen"
slon.remoteWorkerThread_2 slonyregress1 4def9413.2f3e 43258STATEMENT:  select
"_slonyregress".storePath_int(1, 2, 'dbname=slonyregress1 host=localhost
port=9432 user=slony password=test', 10); insert into "_slonyregress".sl_event 
   (ev_origin, ev_seqno, ev_timestamp,      ev_snapshot, ev_type , ev_data1,
ev_data2, ev_data3, ev_data4    ) values ('2', '5000000001', '2011-06-08
11:24:03.018181-04', '43243:43243:', 'STORE_PATH', '1', '2',
'dbname=slonyregress1 host=localhost port=9432 user=slony password=test',
'10'); insert into "_slonyregress".sl_confirm       (con_origin, con_received,
con_seqno, con_timestamp)    values (2, 1, '5000000001', now()); commit
transaction;
slon.remoteWorkerThread_3 slonyregress1 4def9413.2f41 0LOG:  statement: select
li_origin, li_provider from "_slonyregress".sl_listen where li_receiver = 1


I am not sure why the lock table 'sl_config_lock' at the top of storePath_int
isn't stopping this.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 08:54:41 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 08:54:41 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608155441.8E0CC29032D@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #2 from Steve Singer <ssinger at ca.afilias.info> 2011-06-08 08:54:41 PDT ---

The answer to my previous question is in the PostgreSQL documentation for 'lock
table'
----------
To achieve a similar effect when running a transaction at the Serializable
isolation level, you have to execute the LOCK TABLE statement before executing
any SELECT or data modification statement. A serializable transaction's view of
data will be frozen when its first SELECT or data modification statement
begins. A LOCK TABLE later in the transaction will still prevent concurrent
writes ? but it won't ensure that what the transaction reads corresponds to the
latest committed values. 
-----------------

We should move the lock table on sl_config_lock to be outside of the
storePath_int call, similar to what we did for sl_event_lock.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 10:15:18 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 10:15:18 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608171518.D764C290DAD@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #3 from Steve Singer <ssinger at ca.afilias.info> 2011-06-08 10:15:18 PDT ---
Created an attachment (id=104)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=104)
fix for bug 218

Lock sl_config_lock before calling storePath_int

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 11:55:44 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 11:55:44 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608185544.CB36D290D77@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|slony1-bugs at lists.slony.inf |ssinger at ca.afilias.info
                   |o                           |
             Status|NEW                         |ASSIGNED

--- Comment #4 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-08 11:55:44 PDT ---
Looks like a good change to me.

I kicked off regression tests against an instance with this patch; tests are
running fine thus far.

If there's a particular test that tends to expose failures, it would be a fine
thing to point out which one it is...

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 13:58:20 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 13:58:20 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608205820.C1636290D92@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

Steve Singer <ssinger at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         Resolution|                            |FIXED
             Status|ASSIGNED                    |RESOLVED

--- Comment #5 from Steve Singer <ssinger at ca.afilias.info> 2011-06-08 13:58:20 PDT ---
Fixed in 2.1.0 for the next beta

http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=9f0ff6c21eb9f7493de01a4bda16f178e97c80aa

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 14:11:53 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 14:11:53 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 204] Failover to a non-direct subscriber fails
In-Reply-To: <bug-204-4@http.www.slony.info/bugzilla/>
References: <bug-204-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608211153.E389D290DA8@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=204

--- Comment #3 from Steve Singer <ssinger at ca.afilias.info> 2011-06-08 14:11:54 PDT ---
Additional fixes that first fix didn't get rid of the problem

in master
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=e3313e04357e7c084c4e412c87fe47aa64dc0ea9

in 2.0
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=dadc17788c604175b07d03597a01160f7249b14d

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Jun  8 15:05:10 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  8 Jun 2011 15:05:10 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110608220510.40921290DB1@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #11 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-08 15:05:10 PDT ---
Created an attachment (id=105)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=105)
Add PK test to the set of regression tests typically run

Here's an additional patch to add in the additional regression test.

FYI, it ran fine for me against 2.0, based on your branch, bug217_20.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 06:20:07 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 06:20:07 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 220] New: parameters to reshape subscription are
 passed in the wrong order
Message-ID: <bug-220-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=220

           Summary: parameters to reshape subscription are passed in the
                    wrong order
           Product: Slony-I
           Version: 2.0
          Platform: PC
        OS/Version: Linux
            Status: NEW
          Severity: enhancement
          Priority: low
         Component: slonik
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: ssinger at ca.afilias.info
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


Bug report from Glyn Still
--
Hi Guys,

Just had an issue with subscribe set in 2.0.6.  From what I can see somehow
slonik is passing parameters 
to reshapesubscription in the wrong order, instead of (sub_set, sub_provider,
sub_receiver) it seems to be 
sending (sub_provider, sub_set, sub_receiver).  In turn that made slonik hang
on me and borked my subscriptions. 

Here's what I submitted to slonik:

    SUBSCRIBE SET ( ID = 1000, PROVIDER = 4, RECEIVER = 5, FORWARD = YES );

Here's the error message I get from slonik:

    Way5b:/pgsql/slony# slonik reshape.scr
    reshape.scr:17: ATTEMPT:  SUBSCRIBE SET
    reshape.scr:18: NOTICE:  subscribe set: omit_copy=f
    reshape.scr:18: NOTICE:  subscribe set: omit_copy=f
    CONTEXT:  SQL statement "SELECT  "_main_replication".subscribeSet_int( $1 ,
 $2 ,  $3 ,  $4 ,  $5 )"
    PL/pgSQL function "subscribeset" line 77 at PERFORM
    reshape.scr:18: PGRES_FATAL_ERROR select
"_main_replication".reshapeSubscription(4,1000,5); - ERROR:  insert or update
on table "sl_subscribe" violates foreign key constraint
"sl_subscribe-sl_path-ref"
    DETAIL:  Key (sub_provider,sub_receiver)=(1000,5) is not present in table
"sl_path".
    CONTEXT:  SQL statement "update "_main_replication".sl_subscribe set
sub_provider= $1  WHERE sub_set= $2  AND sub_receiver= $3 "
    PL/pgSQL function "reshapesubscription" line 11 at SQL statement
    error reshaping subscriber

And here's what my reshapesubscription looks like:

    CREATE OR REPLACE FUNCTION _main_replication.reshapesubscription(integer,
integer, integer)
      RETURNS integer AS
    $BODY$
    declare
        p_sub_set            alias for $1;
        p_sub_provider        alias for $2;
        p_sub_receiver        alias for $3;
    begin
        -- ----
        -- Grab the central configuration lock
        -- ----
        lock table "_main_replication".sl_config_lock;

        update "_main_replication".sl_subscribe set sub_provider=p_sub_provider
               WHERE sub_set=p_sub_set AND sub_receiver=p_sub_receiver;
        if found then
           perform "_main_replication".RebuildListenEntries();
           notify "_main_replication_Restart";
        end if;
        return 0;
    end
    $BODY$
    LANGUAGE plpgsql VOLATILE;

Looking in the slonik.c starting on on line 3541 I can see the following:

                slon_mkquery(&query,
                                         "select
\"_%s\".reshapeSubscription(%d,%d,%d);",
                                         stmt->hdr.script->clustername,
                                         stmt->sub_provider,stmt->sub_setid,
                                         stmt->sub_receiver);

Unless I'm going crazy (It is now 4am), that pretty much looks the wrong way
around to me?

Thanks
Glyn

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 06:24:25 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 06:24:25 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 220] parameters to reshape subscription are
 passed in the wrong order
In-Reply-To: <bug-220-4@http.www.slony.info/bugzilla/>
References: <bug-220-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609132425.98149290DB2@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=220

--- Comment #1 from Steve Singer <ssinger at ca.afilias.info> 2011-06-09 06:24:25 PDT ---
Created an attachment (id=106)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=106)
proposed fix

Proposed fix.
Will need to be applied against both master and REL_2_0_STABLE

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 08:27:55 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 08:27:55 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 220] parameters to reshape subscription are
 passed in the wrong order
In-Reply-To: <bug-220-4@http.www.slony.info/bugzilla/>
References: <bug-220-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609152755.A822C29032D@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=220

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|slony1-bugs at lists.slony.inf |ssinger at ca.afilias.info
                   |o                           |
             Status|NEW                         |ASSIGNED

--- Comment #2 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-09 08:27:55 PDT ---
+1 from me

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 09:38:42 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 09:38:42 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609163842.D014E290DB5@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|slony1-bugs at lists.slony.inf |ssinger at ca.afilias.info
                   |o                           |
             Status|NEW                         |ASSIGNED

--- Comment #12 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-09 09:38:42 PDT ---
It scares me that decoding trigger arguments required an SPI function.

Actually, poking at pg_trigger suggests that the problem isn't at the Slony
level...  I wonder who came up with the notion that the following was
reasonable...

slonyregress1 at localhost->  select tgnargs, tgargs from pg_trigger where tgnargs
> 0;
 tgnargs |                           tgargs
---------+------------------------------------------------------------
       3 | \x5f736c6f6e795f72656772657373310031006b00
       1 | \x5f736c6f6e795f726567726573733100
       3 | \x5f736c6f6e795f72656772657373310032006b00
       1 | \x5f736c6f6e795f726567726573733100
       3 | \x5f736c6f6e795f72656772657373310034006b00
       1 | \x5f736c6f6e795f726567726573733100
       3 | \x5f736c6f6e795f72656772657373310035006b76766b767676766b00
       1 | \x5f736c6f6e795f726567726573733100
(8 rows)

I'd be inclined to feed some griping about this representation up to
pgsql-hackers, in the hopes of getting something nicer, maybe?

Not that that's too likely for 9.1 :-)

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 11:56:45 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 11:56:45 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609185645.64A27290DAD@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #6 from Jan Wieck <janwieck at yahoo.com> 2011-06-09 11:56:45 PDT ---
Does this actually solve the problem or does it only lower the chance of
running into it?

You remember we had the discussion about LOCK TABLE with respect to snapshots
and realized, that LOCK TABLE statements at the beginning of a transaction
actually cause the lock to be taken out BEFORE the transaction snapshot is
generated. However, this LOCK TABLE cannot be done from inside of a stored
procedure because SELECTing that SP causes the snapshot to be generated before
the LOCK TABLE statement itself.

My gut feeling is that we need slonik to do the LOCK on the sl_config_log at
the beginning of any transaction, where it intends to call SPs that change the
configuration.


Jan

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 12:04:01 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 12:04:01 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609190401.C65B8290366@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #13 from Jan Wieck <janwieck at yahoo.com> 2011-06-09 12:04:01 PDT ---
Maybe we aren't supposed to query pg_trigger, but query the
information_schema.triggers view instead?


Jan

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 12:13:21 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 12:13:21 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609191321.401ED290C43@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

Steve Singer <ssinger at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         Resolution|FIXED                       |
             Status|RESOLVED                    |REOPENED

--- Comment #7 from Steve Singer <ssinger at ca.afilias.info> 2011-06-09 12:13:21 PDT ---
(In reply to comment #6)
> Does this actually solve the problem or does it only lower the chance of
> running into it?
> 
> You remember we had the discussion about LOCK TABLE with respect to snapshots
> and realized, that LOCK TABLE statements at the beginning of a transaction
> actually cause the lock to be taken out BEFORE the transaction snapshot is
> generated. However, this LOCK TABLE cannot be done from inside of a stored
> procedure because SELECTing that SP causes the snapshot to be generated before
> the LOCK TABLE statement itself.
> 
> My gut feeling is that we need slonik to do the LOCK on the sl_config_log at
> the beginning of any transaction, where it intends to call SPs that change the
> configuration.
> 
> 
> Jan

I am inclined to agree with you.  I don't think we should be taking locks in
the stored procedures, so slonik + a few parts of slon might need to do this.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 12:23:19 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 12:23:19 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609192319.31848290C43@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #8 from Jan Wieck <janwieck at yahoo.com> 2011-06-09 12:23:19 PDT ---
For what release would you consider that?

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 12:29:27 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 12:29:27 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609192927.AB6B0290C43@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #9 from Steve Singer <ssinger at ca.afilias.info> 2011-06-09 12:29:27 PDT ---
(In reply to comment #8)
> For what release would you consider that?

I see no reason to fix this in 2.0.

In 2.1 we removed the 'lock sl_config_lock' at the top of the slon remote
worker thread, we  did this because it could cause deadlocks with the
sl_event_lock that slonik now obtains.   An argument can be made that since we
are messing with locking behaviour in 2.1 anyway, and some of our chances
exposed some of the behaviour issues under testing then we should properly fix
the problem in 2.1 

Thoughts?

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 12:37:07 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 12:37:07 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609193707.F22A1290C43@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #14 from Steve Singer <ssinger at ca.afilias.info> 2011-06-09 12:37:08 PDT ---
(In reply to comment #13)
> Maybe we aren't supposed to query pg_trigger, but query the
> information_schema.triggers view instead?
> 
> 
> Jan

The information schema gives rows like


 EXECUTE PROCEDURE _slonyregress.logtrigger('_slonyregress', '1', 'k')


we could

a) build up a similar line in the query in the plpgsql function and do a text
comparision
b) Do regex matching to extract the 'k' from the arguments
c) use the C function like the patch proposes.

I dislike (b).  I'm not opposed to (a), but comparing just the trigger
arguments seems more direct to me, even if it involves a C function to get them

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 13:42:28 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 13:42:28 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609204228.07D78290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #10 from Jan Wieck <janwieck at yahoo.com> 2011-06-09 13:42:28 PDT ---
I agree. But that causes us to go back to development and out of BETA.


Jan

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 13:52:25 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 13:52:25 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609205225.782F3290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #15 from Jan Wieck <janwieck at yahoo.com> 2011-06-09 13:52:25 PDT ---
I would favor a). Although it will lead to a rather cryptic and non-intuitive
behavior should the information_schema.triggers view ever change the
representation (it didn't since 8.3 and I didn't bother checking earlier
versions). What it would tell is that all the unlocked tables have changed but
it won't do anything about it. Then again any regexp implementation could
behave just the same, so there is not much to gain from that.


Jan

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 14:28:30 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 14:28:30 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 216] monitor threads don't work on Win32
In-Reply-To: <bug-216-4@http.www.slony.info/bugzilla/>
References: <bug-216-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609212830.203DB290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=216

--- Comment #3 from Steve Singer <ssinger at ca.afilias.info> 2011-06-09 14:28:30 PDT ---
Created an attachment (id=107)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=107)
patch to use time from epoch

This patch should avoid the issue since slon will now send postgres the time
in seconds from epoch.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 14:29:56 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 14:29:56 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609212956.4AF6D290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #16 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-09 14:29:56 PDT ---
(In reply to comment #15)
> I would favor a). Although it will lead to a rather cryptic and non-intuitive
> behavior should the information_schema.triggers view ever change the
> representation (it didn't since 8.3 and I didn't bother checking earlier
> versions). What it would tell is that all the unlocked tables have changed but
> it won't do anything about it. Then again any regexp implementation could
> behave just the same, so there is not much to gain from that.

I suggest that if we guard ourselves by having a decent regression test, so
that if the view changes, we're quite likely to notice, then yes, a) seems
better to me.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 14:33:04 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 14:33:04 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609213304.A67BF290D8A@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|ssinger at ca.afilias.info     |cbbrowne at ca.afilias.info

--- Comment #11 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-09 14:33:04 PDT ---
I don't think this destroys "beta"; it should be a moderate amount of work to
shift the locks on sl_config_lock into the first query run.

I'll take a look at this.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Jun  9 14:43:18 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  9 Jun 2011 14:43:18 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110609214318.9A64E290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #12 from Jan Wieck <janwieck at yahoo.com> 2011-06-09 14:43:18 PDT ---
Attempting to LOCK and already locked table only wastes some CPU cycles, so
doing it in a rather generic fashion would be OK, IMHO.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 05:14:47 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 05:14:47 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 220] parameters to reshape subscription are
 passed in the wrong order
In-Reply-To: <bug-220-4@http.www.slony.info/bugzilla/>
References: <bug-220-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610121447.08FDC290DBA@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=220

Steve Singer <ssinger at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         Resolution|                            |FIXED
             Status|ASSIGNED                    |RESOLVED

--- Comment #3 from Steve Singer <ssinger at ca.afilias.info> 2011-06-10 05:14:47 PDT ---
Applied to master 
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=46faa6b75f2fddcab98d317b91584cfffad749b4

REL_2_0_STABLE
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=8f681a8cb06571396b8e99be220a38f92f1d3baf

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 06:39:39 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 06:39:39 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610133939.D9D37290DB7@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #17 from Steve Singer <ssinger at ca.afilias.info> 2011-06-10 06:39:39 PDT ---
Created an attachment (id=108)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=108)
replace C function to decode trigger arguments with string matching

This patch to be appplied ontop of the others will remove the C function that
decodes the trigger arguments and replaces it with string matching code against
information_schema.triggers.

I feel that the C function is cleaner and more future proof.  To get this patch
to work I had to be careful about matching spaces and quotes in the function
with the format the information schema returns.  I have not yet done a lot of
testing and suspect that this version of the patch might break with mixed case
slony clusternames (if so that should be fixable).

The C function works and should continue to work with future postgres versions
because it uses the same infrastructure to decode tgargs as postgersql uses
when it invokes the trigger.  With the string matching approach we are
depending on a unit test to tell us that something suttle has changed in
postgresql after the fact.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 07:52:22 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 07:52:22 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610145222.55B7D290382@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

Steve Singer <ssinger at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
 Attachment #108 is|0                           |1
           obsolete|                            |

--- Comment #18 from Steve Singer <ssinger at ca.afilias.info> 2011-06-10 07:52:22 PDT ---
Created an attachment (id=109)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=109)
replace C function to decode trigger arguments (updated)

Updating patch to not print extra warning messages + deal better with mixed
case slony schemas

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 09:44:50 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 09:44:50 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610164450.33D13290DA8@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #13 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-10 09:44:50 PDT ---
I have opened up my own "bug218" branch, and added the following patch:

https://github.com/cbbrowne/slony1-engine/commit/9bd169a5f872ddef48d73168e66970c53b39110d

It adds requests for locks on sl_config_lock to remote_worker.c and slonik.c.

The interesting part is that, in many cases, the initial statement locks both
sl_config_lock *and* sl_event_lock, which seems likely to be quite an
improvement in safety.

I'm running regression tests against this right now; if there's some other test
load that is better to try, let me know.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 10:31:11 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 10:31:11 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610173111.EFD13290DA8@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #14 from Steve Singer <ssinger at ca.afilias.info> 2011-06-10 10:31:12 PDT ---
Also remember to remove the 'LOCK @NAMESPACE at .sl_config_lock' lines from
slony_funcs.sql - since a) the locking is now being done elsewhere, no point in
paying a penalty twice.  b) Leaving it in there is a bit confusing since
someone else might come along and think that it is okay to obtain
sl_config_lock in the stored functions

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 13:21:46 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 13:21:46 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 218] slon often has to retry transactions due to
 concurrent update in 2.1.0.b2
In-Reply-To: <bug-218-4@http.www.slony.info/bugzilla/>
References: <bug-218-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610202146.92F61290382@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=218

--- Comment #15 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-10 13:21:46 PDT ---
(In reply to comment #14)
> Also remember to remove the 'LOCK @NAMESPACE at .sl_config_lock' lines from
> slony_funcs.sql - since a) the locking is now being done elsewhere, no point in
> paying a penalty twice.  b) Leaving it in there is a bit confusing since
> someone else might come along and think that it is okay to obtain
> sl_config_lock in the stored functions

Good point, though the price isn't too terribly high.

Have done so, and had a successful run of all the regression tests against
this.

https://github.com/cbbrowne/slony1-engine/commit/35fbb13b44e2136b808a5cd7e8457f616fcc5ccb

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 13:31:51 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 13:31:51 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 214] Slonikconfdump.sh lost
In-Reply-To: <bug-214-4@http.www.slony.info/bugzilla/>
References: <bug-214-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610203151.78B252903BF@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=214

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         Resolution|                            |FIXED
             Status|NEW                         |RESOLVED

--- Comment #1 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-10 13:31:51 PDT ---
Added back to both relevant branches...

2.0:

http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=8333b6136ddedcce4059815ba68f4d221ccd0c2d

HEAD:

http://git.postgresql.org/gitweb?p=slony1-engine.git;a=commit;h=c8230ac298420ff9b93b68efcfbca511f32b1b23

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Fri Jun 10 13:35:13 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Fri, 10 Jun 2011 13:35:13 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 215] Add Slony to PGXN
In-Reply-To: <bug-215-4@http.www.slony.info/bugzilla/>
References: <bug-215-4@http.www.slony.info/bugzilla/>
Message-ID: <20110610203513.A67B5290D89@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=215

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|cbbrowne at ca.afilias.info    |slony1-bugs at lists.slony.inf
                   |                            |o

--- Comment #2 from Christopher Browne <cbbrowne at ca.afilias.info> 2011-06-10 13:35:13 PDT ---
Consider it to be an open question, for now, whether or not something more
extensive should be done about this.

It would be an interesting idea to have Slony components loaded as extensions,
as this might be an easier way for users to deploy it.

Details as to how this sort of thing would work will probably emerge after the
release of PG 9.1, so it doesn't make sense to do anything more with this for
the time being.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Sat Jun 11 01:53:59 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Sat, 11 Jun 2011 01:53:59 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 221] New: implicit cast (int to text) make ERROR
 at initialize and cleanup
Message-ID: <bug-221-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=221

           Summary: implicit cast (int to text) make ERROR at initialize
                    and cleanup
           Product: Slony-I
           Version: 2.0
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: minor
          Priority: low
         Component: core scripts
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: harukat at sraoss.co.jp
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


I report a problem on slony-I 2.0.6 (or HEAD).

We define a implicit cast on INT to TEXT for the migration 
PostgreSQL 8.2.x to 9.0.x. This causes Slony-I errors at
initialize and cleanup-thread.

It seems to me that to add explicit cast in addPartialLogIndices()
is the workaround.


cast definition:

CREATE CAST ( int4 AS text ) WITH INOUT AS IMPLICIT;

error message:
---
<stdin>:70: PGRES_FATAL_ERROR select "_baitoru_p01".storeSet_int
(1, 1, 'All hatarako tables');
  - ERROR:  operator is not unique: text || integer
LINE 1: ...d_baitoru_p01_sl_log_' || v_log::text || '-node-' || v_dummy...
                                                             ^
HINT:  Could not choose a best candidate operator. You might need to
 add explicit type casts.
QUERY:  SELECT 'PartInd_baitoru_p01_sl_log_' || v_log::text || '-node-'
 || v_dummy.set_origin
CONTEXT:  PL/pgSQL function "addpartiallogindices" line 28 at assignment
SQL statement "SELECT "_baitoru_p01".addPartialLogIndices()"
PL/pgSQL function "storeset_int" line 31 at PERFORM
---

workaround ? :
in src/backend/slony1_funcs.sql function @NAMESPACE at .addPartialLogIndices ()

add explicit cast

 v_iname := 'PartInd_ at CLUSTERNAME@_sl_log_' || v_log::text || '-node-' ||
             v_dummy.set_origin::text;
                               ~~~~~~

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Tue Jun 14 06:29:04 2011
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Tue, 14 Jun 2011 06:29:04 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 217] Changing the primary key of a replicated
 table leads to trouble
In-Reply-To: <bug-217-4@http.www.slony.info/bugzilla/>
References: <bug-217-4@http.www.slony.info/bugzilla/>
Message-ID: <20110614132904.0CB72290DC5@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=217

--- Comment #19 from Steve Singer <ssinger at ca.afilias.info> 2011-06-14 06:29:03 PDT ---
(In reply to comment #18)
> Created an attachment (id=109)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=109) [details]
> replace C function to decode trigger arguments (updated)
> 
> Updating patch to not print extra warning messages + deal better with mixed
> case slony schemas

It turns out that the fixes to make strings match with mixed case breaks all
lower case schema names.

This is another example of why I think the string matching approach is a bad
idea.
If you disagree with me then take a look at this then spend some time trying to
fix the patch so it works in both with the various versions of Pg.

Otherwise I think we should go back to the C function for decoding these
trigger arguments.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

