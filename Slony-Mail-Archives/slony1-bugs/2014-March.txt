From bugzilla-daemon at main.slony.info  Wed Mar  5 13:57:58 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  5 Mar 2014 13:57:58 -0800 (PST)
Subject: [Slony1-bugs] [Bug 332] New: Exclude unreplicable objects from
	replication
Message-ID: <bug-332-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=332

           Summary: Exclude unreplicable objects from replication
           Product: Slony-I
           Version: devel
          Platform: PC
        OS/Version: Linux
            Status: NEW
          Severity: enhancement
          Priority: low
         Component: stored procedures
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: cbbrowne at ca.afilias.info
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


A user reported that they made the mistake of using over-broad wildcards to
specify the sequences to replicate.

This led to the sequence that captures the node ID being replicated, which then
led to subscriber nodes all deciding they were the origin node.  This is the "I
am Spartacus!" bug. 
http://en.wikipedia.org/wiki/Spartacus_%28film%29#.22I.27m_Spartacus.21.22

We should add some error checking to the functions that control adding tables
and sequences to replication so that they will decline to add dangerous objects
to replication, specifically:

a) Slony sequences, which may be recognized by having namespace ~ '^_.*' and
name like 'sl_%'

b) Slony tables, which may be recognized by having namespace ~ '^_.*' and name
like 'sl_%'

c) Objects in schemas pg_catalog and information_schema

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Mar  5 13:58:10 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  5 Mar 2014 13:58:10 -0800 (PST)
Subject: [Slony1-bugs] [Bug 332] Exclude unreplicable objects from
	replication
In-Reply-To: <bug-332-4@http.www.slony.info/bugzilla/>
References: <bug-332-4@http.www.slony.info/bugzilla/>
Message-ID: <20140305215810.AA69329144E@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=332

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|slony1-bugs at lists.slony.inf |cbbrowne at ca.afilias.info
                   |o                           |

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Wed Mar  5 13:58:18 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  5 Mar 2014 13:58:18 -0800 (PST)
Subject: [Slony1-bugs] [Bug 332] Exclude unreplicable objects from
	replication
In-Reply-To: <bug-332-4@http.www.slony.info/bugzilla/>
References: <bug-332-4@http.www.slony.info/bugzilla/>
Message-ID: <20140305215818.29BDE29146A@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=332

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         OS/Version|Linux                       |All
           Platform|PC                          |All

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Wed Mar  5 14:15:55 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Wed,  5 Mar 2014 14:15:55 -0800 (PST)
Subject: [Slony1-bugs] [Bug 332] Exclude unreplicable objects from
	replication
In-Reply-To: <bug-332-4@http.www.slony.info/bugzilla/>
References: <bug-332-4@http.www.slony.info/bugzilla/>
Message-ID: <20140305221555.2CEC429147A@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=332

Christopher Browne <cbbrowne at ca.afilias.info> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
             Status|NEW                         |ASSIGNED

--- Comment #1 from Christopher Browne <cbbrowne at ca.afilias.info> 2014-03-05 14:15:55 PST ---
Here is a preliminary proposal for implementation.

https://github.com/cbbrowne/slony1-engine/commit/f988bc8db10b37160949b7ea5978317068fd5806

I am proposing here to do a somewhat fuzzy matching of which tables are to be
refused; I treat that if the namespace starts with "_" and the table name
starts with "sl_", then the table is to be treated as a replication table.

if v_tab_nspname ~ '^_.*' and v_tab_relname ~ '^sl_.*' then
        raise exception 'Slony-I: setAddTable_int(): % appears to be a
replication configuration table and cannot be replicated',
                p_fqname;
end if;

That may be a bit too open-ended.  What I don't want to do is to be
insufficiently open-ended; it would be broken for one slony installation to
break another one.

It would be a more precise test to check that the namespace in question has one
or more well-known Slony tables within it.  (e.g. - I could check that, in
addition, there's the table sl_log_1 in the same namespace).

Does that approach seem agreeable?

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Mar  6 09:20:10 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  6 Mar 2014 09:20:10 -0800 (PST)
Subject: [Slony1-bugs] [Bug 333] New: Deadlock with application during minor
 version upgrade.
Message-ID: <bug-333-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=333

           Summary: Deadlock with application during minor version
                    upgrade.
           Product: Slony-I
           Version: devel
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: enhancement
          Priority: low
         Component: slonik
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: janwieck at yahoo.com
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


The Slony upgrade procedure for minor versions can collide with concurrently
running applications, even with read only transactions.

During the upgrade the stored procedures to upgrade the schema configure all
log and deny access triggers. This is done with an "ALTER TABLE ...
ENABLE/DISABLE TRIGGER ..." command. This command requires an access exclusive
lock on the table, which conflicts even with read only access.

This command could be skipped if the trigger in question is already configured
in that enable/disable state, which can be determined by a lookup in
pg_trigger. I believe that during a pure minor version upgrade, none of the
triggers actually needs to be reconfigured since they all should be in the
desired state already.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Mar  6 09:21:11 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  6 Mar 2014 09:21:11 -0800 (PST)
Subject: [Slony1-bugs] [Bug 333] Deadlock with application during minor
	version upgrade.
In-Reply-To: <bug-333-4@http.www.slony.info/bugzilla/>
References: <bug-333-4@http.www.slony.info/bugzilla/>
Message-ID: <20140306172111.613A62913FC@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=333

Jan Wieck <janwieck at yahoo.com> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         AssignedTo|slony1-bugs at lists.slony.inf |rnancy at afilias.info
                   |o                           |

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

From bugzilla-daemon at main.slony.info  Thu Mar  6 15:19:09 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  6 Mar 2014 15:19:09 -0800 (PST)
Subject: [Slony1-bugs] [Bug 332] Exclude unreplicable objects from
	replication
In-Reply-To: <bug-332-4@http.www.slony.info/bugzilla/>
References: <bug-332-4@http.www.slony.info/bugzilla/>
Message-ID: <20140306231909.7AA252913D4@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=332

--- Comment #2 from Jan Wieck <janwieck at yahoo.com> 2014-03-06 15:19:09 PST ---
We do know the actual name of the current Slony cluster schema. No object in
that should be replicated by Slony. Matching the namespace exactly on that
should be sufficient.

In addition to that, nothing in pg_catalog or information_schema is supposed to
be replicated either, I think.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Mar  6 15:26:25 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu,  6 Mar 2014 15:26:25 -0800 (PST)
Subject: [Slony1-bugs] [Bug 332] Exclude unreplicable objects from
	replication
In-Reply-To: <bug-332-4@http.www.slony.info/bugzilla/>
References: <bug-332-4@http.www.slony.info/bugzilla/>
Message-ID: <20140306232625.E0D42291441@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=332

--- Comment #3 from Christopher Browne <cbbrowne at ca.afilias.info> 2014-03-06 15:26:26 PST ---
(In reply to comment #2)
> We do know the actual name of the current Slony cluster schema. No object in
> that should be replicated by Slony. Matching the namespace exactly on that
> should be sufficient.

That's (at least!) 1/2 of the problem here; yes, that's a good test.

But I'm feeling a wee bit more paranoid.  What if there are two clusters in the
database (because someone has gotten overexuberant about replication)?  Should
we consider the second cluster?

> In addition to that, nothing in pg_catalog or information_schema is supposed to
> be replicated either, I think.

Yep, that was my "item c)"

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Tue Mar 11 07:48:45 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Tue, 11 Mar 2014 07:48:45 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 333] Deadlock with application during minor
	version upgrade.
In-Reply-To: <bug-333-4@http.www.slony.info/bugzilla/>
References: <bug-333-4@http.www.slony.info/bugzilla/>
Message-ID: <20140311144845.9710629144F@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=333

--- Comment #1 from Rose Nancy <rnancy at afilias.info> 2014-03-11 07:48:45 PDT ---
Created an attachment (id=200)
 --> (http://www.slony.info/bugzilla/attachment.cgi?id=200)
Patch to fix bug333

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Tue Mar 11 07:50:55 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Tue, 11 Mar 2014 07:50:55 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 333] Deadlock with application during minor
	version upgrade.
In-Reply-To: <bug-333-4@http.www.slony.info/bugzilla/>
References: <bug-333-4@http.www.slony.info/bugzilla/>
Message-ID: <20140311145055.CBAFC291464@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=333

Jan Wieck <janwieck at yahoo.com> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
         Resolution|                            |FIXED
             Status|NEW                         |RESOLVED

--- Comment #2 from Jan Wieck <janwieck at yahoo.com> 2014-03-11 07:50:56 PDT ---
Applied to master, REL_2_2_STABLE and REL_2_1_STABLE.

Thank you.

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Tue Mar 11 07:52:25 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Tue, 11 Mar 2014 07:52:25 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 333] Deadlock with application during minor
	version upgrade.
In-Reply-To: <bug-333-4@http.www.slony.info/bugzilla/>
References: <bug-333-4@http.www.slony.info/bugzilla/>
Message-ID: <20140311145225.8D340291466@main.slony.info>

http://www.slony.info/bugzilla/show_bug.cgi?id=333

--- Comment #3 from Rose Nancy <rnancy at afilias.info> 2014-03-11 07:52:25 PDT ---
I have attached the patch. Please review

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.

From bugzilla-daemon at main.slony.info  Thu Mar 13 08:09:58 2014
From: bugzilla-daemon at main.slony.info (bugzilla-daemon at main.slony.info)
Date: Thu, 13 Mar 2014 08:09:58 -0700 (PDT)
Subject: [Slony1-bugs] [Bug 334] New: Review transaction isolation levels
Message-ID: <bug-334-4@http.www.slony.info/bugzilla/>

http://www.slony.info/bugzilla/show_bug.cgi?id=334

           Summary: Review transaction isolation levels
           Product: Slony-I
           Version: devel
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: normal
          Priority: low
         Component: slon
        AssignedTo: slony1-bugs at lists.slony.info
        ReportedBy: cbbrowne at ca.afilias.info
                CC: slony1-bugs at lists.slony.info
   Estimated Hours: 0.0


Where possible, we should consider using READ ONLY transactions.

Some cases of SERIALIZABLE likely ought to become REPEATABLE READ, if on a
Postgres version that supports it.  (Actually, on the versions that do NOT have
distinct interpretations, e.g. 9.0 and earlier, we can request REPEATABLE READ,
and will get SERIALIZABLE instead.  Which is OK, as on the elder versions,
SERIALIZABLE isn't as heavy-handed as it is in 9.1+.)

-- 
Configure bugmail: http://www.slony.info/bugzilla/userprefs.cgi?tab=email
------- You are receiving this mail because: -------
You are on the CC list for the bug.
You are the assignee for the bug.

