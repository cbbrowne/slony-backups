From JanWieck at Yahoo.com  Mon Dec  3 14:24:35 2012
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Mon, 03 Dec 2012 17:24:35 -0500
Subject: [Slony1-general] Slony version 2.1.0 switchover
In-Reply-To: <50B8D902.60804@ca.afilias.info>
References: <EE2CCD4592BF824BAE17A02DFAAC74FA1DC51775@BLUPRD0711MB401.namprd07.prod.outlook.com>
	<50B8D902.60804@ca.afilias.info>
Message-ID: <50BD26A3.30301@Yahoo.com>

On 11/30/2012 11:04 AM, Steve Singer wrote:
> On 12-11-27 11:59 AM, Frank McGeough wrote:
>> I'm writing to ask about using Slony switchover capability. I've never
>> actually been able to make this work. I'm curious about whether this is
>> a common experience or if, perhaps, there is something that I don't
>> understand about how this should function. The environment that I have
>> is a database that is in constant use. That is, there is always at least
>> a low level of DML (inserts for the most part) occurring 24 x 7, 365
>> days a year. I've found that Slony will never be able to get a lock in
>> order to perform the switchover and thus I'm left with tearing
>
> The slony MOVE SET operation needs to have an exclusive lock on all
> tables in the set at the same time.   The recommended way of doing this
> is to have your application stop traffic to the database for long enough
> so that this can be done, and then wait for the event to propogate to
> the new master and then have your application start queries against the
> new master.
>
> If slony gets its locks on a move set in this order
> Table1
> Table2
> Table3
>
> but your application access tables in this order
> Table3
> Table2
> Table1
>
> Your application and slony will deadlock each other.

What Steve said.

Also, if your application is compatible with pgbouncer's transaction 
mode (i.e. not using server side prepared statements), then you can use 
that to PAUSE and RESUME the real database connections without even 
stopping the application. This can be completely scripted and pgbouncer 
can even do the redirection of traffic on RESUME.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From drees76 at gmail.com  Tue Dec  4 12:13:11 2012
From: drees76 at gmail.com (David Rees)
Date: Tue, 4 Dec 2012 12:13:11 -0800
Subject: [Slony1-general] Multiple sets w/same table
Message-ID: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>

For some reason I thought this was possible, but I'm running into problems.

3 nodes (2 pg 8.4, one 9.0) all running slony 2.1.2.
The same database schema is on all 3 nodes.
Set 1 consists of all tables in the database - node 2 subscribes to
set 1 from node 1.
Set 2 consists of a subset of the tables in the database - node 3
subscribes to set 2 from node 2.

The problem is that when I try to create set 2, slony complains
'ERROR:  duplicate key value violates unique constraint
"sl_table_tab_reloid_key"'

Looking at sl_table_tab_reloid_key it appears that this key would
prevent any single table from being in multiple sets.

In which case, I believe that I could work around this by using a
different cluster for set 2.

Or am I missing something?

Thank you!

Dave

From steve at ssinger.info  Tue Dec  4 19:34:12 2012
From: steve at ssinger.info (Steve Singer)
Date: Tue, 4 Dec 2012 22:34:12 -0500
Subject: [Slony1-general] Multiple sets w/same table
In-Reply-To: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>
References: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>
Message-ID: <BLU0-SMTP20818CE4A2C25BABF659562DC460@phx.gbl>

On Tue, 4 Dec 2012, David Rees wrote:

> For some reason I thought this was possible, but I'm running into problems.
>
> 3 nodes (2 pg 8.4, one 9.0) all running slony 2.1.2.
> The same database schema is on all 3 nodes.
> Set 1 consists of all tables in the database - node 2 subscribes to
> set 1 from node 1.
> Set 2 consists of a subset of the tables in the database - node 3
> subscribes to set 2 from node 2.

Why don't you put your subset of tables in set 2, the rest of the tables in 
set 1.  Then

subscribe set(set id=1, provider=1,provider=2)
subscribe set(set id=2, provider=1,provider=2)
subscibe set(set id=2,provider=2,receiver=3)

You can't have the same table in multiple sets, but a node can subscribe to 
multiple sets.


>
> The problem is that when I try to create set 2, slony complains
> 'ERROR:  duplicate key value violates unique constraint
> "sl_table_tab_reloid_key"'
>
> Looking at sl_table_tab_reloid_key it appears that this key would
> prevent any single table from being in multiple sets.
>
> In which case, I believe that I could work around this by using a
> different cluster for set 2.
>
> Or am I missing something?
>
> Thank you!
>
> Dave
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From drees76 at gmail.com  Tue Dec  4 20:50:29 2012
From: drees76 at gmail.com (David Rees)
Date: Tue, 4 Dec 2012 20:50:29 -0800
Subject: [Slony1-general] Multiple sets w/same table
In-Reply-To: <BLU0-SMTP20818CE4A2C25BABF659562DC460@phx.gbl>
References: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>
	<BLU0-SMTP20818CE4A2C25BABF659562DC460@phx.gbl>
Message-ID: <CAHtT9RsANTGpan9ovnF-Evfvur71hoGRMAOdrJAs39TY6FfrMw@mail.gmail.com>

On Tue, Dec 4, 2012 at 7:34 PM, Steve Singer <steve at ssinger.info> wrote:
> On Tue, 4 Dec 2012, David Rees wrote:
>> For some reason I thought this was possible, but I'm running into
>> problems.
>>
>> 3 nodes (2 pg 8.4, one 9.0) all running slony 2.1.2.
>> The same database schema is on all 3 nodes.
>> Set 1 consists of all tables in the database - node 2 subscribes to
>> set 1 from node 1.
>> Set 2 consists of a subset of the tables in the database - node 3
>> subscribes to set 2 from node 2.
>
> Why don't you put your subset of tables in set 2, the rest of the tables in
> set 1.  Then
>
> subscribe set(set id=1, provider=1,provider=2)
> subscribe set(set id=2, provider=1,provider=2)
> subscibe set(set id=2,provider=2,receiver=3)
>
> You can't have the same table in multiple sets, but a node can subscribe to
> multiple sets.

Thanks - after some playing around (tried a separate cluster which
didn't work - no changes were propagated to node 3.

There are some foreign keys which exist on node 1/2 which would cross
the 2 sets (node 3 doesn't have those foreign keys) - are there any
issues with consistency or will all changes to the database still be
committed in the same order as they occurred on the originating node?

For example, table 1 is in set 1 and table 2 is in set 2 and table 1
has a foreign key that refers to table 2.

Changes that occur on the origin node 1 which will be the same for set
1/2 will obviously be fine, but is it possible for an event to be
committed out-of-order on node 2?

Thank you!

Dave

From ssinger at ca.afilias.info  Thu Dec  6 15:06:08 2012
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 06 Dec 2012 18:06:08 -0500
Subject: [Slony1-general] Multiple sets w/same table
In-Reply-To: <CAHtT9RsANTGpan9ovnF-Evfvur71hoGRMAOdrJAs39TY6FfrMw@mail.gmail.com>
References: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>
	<BLU0-SMTP20818CE4A2C25BABF659562DC460@phx.gbl>
	<CAHtT9RsANTGpan9ovnF-Evfvur71hoGRMAOdrJAs39TY6FfrMw@mail.gmail.com>
Message-ID: <50C124E0.7000409@ca.afilias.info>

On 12-12-04 11:50 PM, David Rees wrote:
> On Tue, Dec 4, 2012 at 7:34 PM, Steve Singer <steve at ssinger.info> wrote:


>
> For example, table 1 is in set 1 and table 2 is in set 2 and table 1
> has a foreign key that refers to table 2.
>
> Changes that occur on the origin node 1 which will be the same for set
> 1/2 will obviously be fine, but is it possible for an event to be
> committed out-of-order on node 2?
>

If you subscribe  set 2 first, then set 1 and if both set 1 and your not 
using a different forwarder node, then I think you should be okay.


> Thank you!
>
> Dave
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From drees76 at gmail.com  Thu Dec  6 15:11:52 2012
From: drees76 at gmail.com (David Rees)
Date: Thu, 6 Dec 2012 15:11:52 -0800
Subject: [Slony1-general] Multiple sets w/same table
In-Reply-To: <50C124E0.7000409@ca.afilias.info>
References: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>
	<BLU0-SMTP20818CE4A2C25BABF659562DC460@phx.gbl>
	<CAHtT9RsANTGpan9ovnF-Evfvur71hoGRMAOdrJAs39TY6FfrMw@mail.gmail.com>
	<50C124E0.7000409@ca.afilias.info>
Message-ID: <CAHtT9Rs0Wb1q5rnh8QVkOLV1E=h5DD7S-EYNLHfa17N_f9z_VA@mail.gmail.com>

On Thu, Dec 6, 2012 at 3:06 PM, Steve Singer <ssinger at ca.afilias.info> wrote:
> On 12-12-04 11:50 PM, David Rees wrote:
>> On Tue, Dec 4, 2012 at 7:34 PM, Steve Singer <steve at ssinger.info> wrote:
>> For example, table 1 is in set 1 and table 2 is in set 2 and table 1
>> has a foreign key that refers to table 2.
>>
>> Changes that occur on the origin node 1 which will be the same for set
>> 1/2 will obviously be fine, but is it possible for an event to be
>> committed out-of-order on node 2?
>
> If you subscribe  set 2 first, then set 1 and if both set 1 and your not
> using a different forwarder node, then I think you should be okay.

Thanks - I'll give it a shot in a test environment first.

-Dave

From JanWieck at Yahoo.com  Sun Dec  9 09:33:16 2012
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Sun, 09 Dec 2012 12:33:16 -0500
Subject: [Slony1-general] Multiple sets w/same table
In-Reply-To: <50C124E0.7000409@ca.afilias.info>
References: <CAHtT9RuY9OYbRyE=D80f++RErqT+GpBc+byfDMzSH8bwiu=zzQ@mail.gmail.com>
	<BLU0-SMTP20818CE4A2C25BABF659562DC460@phx.gbl>
	<CAHtT9RsANTGpan9ovnF-Evfvur71hoGRMAOdrJAs39TY6FfrMw@mail.gmail.com>
	<50C124E0.7000409@ca.afilias.info>
Message-ID: <50C4CB5C.9060901@Yahoo.com>

On 12/6/2012 6:06 PM, Steve Singer wrote:
> On 12-12-04 11:50 PM, David Rees wrote:
>> On Tue, Dec 4, 2012 at 7:34 PM, Steve Singer <steve at ssinger.info> wrote:
>
>
>>
>> For example, table 1 is in set 1 and table 2 is in set 2 and table 1
>> has a foreign key that refers to table 2.
>>
>> Changes that occur on the origin node 1 which will be the same for set
>> 1/2 will obviously be fine, but is it possible for an event to be
>> committed out-of-order on node 2?
>>
>
> If you subscribe  set 2 first, then set 1 and if both set 1 and your not
> using a different forwarder node, then I think you should be okay.

The subscriptions should work either way since it is done under 
session_replication_role=replica, which suppresses foreign key checks.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

