From ssinger at ca.afilias.info  Mon May  2 06:20:20 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 02 May 2011 09:20:20 -0400
Subject: [Slony1-general] Looking at bug #137 - DDL application change
In-Reply-To: <BANLkTin=aUcTOadXr824HxQf=7adkU9mGQ@mail.gmail.com>
References: <BANLkTin=aUcTOadXr824HxQf=7adkU9mGQ@mail.gmail.com>
Message-ID: <4DBEAF94.4070602@ca.afilias.info>

On 11-04-29 05:50 PM, Christopher Browne wrote:

<snip>

>
> What remains...
>
> slonik needs to:
> a) Lock the tables
> b) Run ddlscript_prepare(), which just does some validation, and sets
> replication mode to 'local'
> c) Split the DDL into statements
> d) Prepare a statement to drop DDL into sl_log_*
> e) For each statement
>    e.1) Run the DDL on the origin
>    e.2) Save DDL into sl_log_*
> f) Restore replication mode (probably to 'origin')
>
> slon, today, does a great deal of work, but it basically all gets dropped.
> - The DDL event doesn't need to do anything.
> - No need to split statements up.
>
> Basically, when processing sl_log_*, we'll sometimes have DDL
> statements, so that today's (Insert,Update,Delete,Truncate) augments
> to (Insert,Update,Delete,Truncate,Script), and we basically just need
> to enclose the Script items with set/restore replication mode.
>
> Still apparent complications:
> - ONLY ON NODE functionality basically just connects to the specified
> node, and omits saving the DDL in sl_log_*, right?  That's a small
> change to slonik, and requires *nothing* of slon, right?
>
> - Log shipping...  Nothing special; we're capturing sl_log_* output;
> DDL is just an addition to this.
>
> This *looks* like it turns into a considerable code simplification,
> which would be mighty nice, if so.

The algorithm you describe above sounds sane to me.  Will having slonik 
instead of slon split the ddl script up make it any less forgiving to 
bugs in the scanner (I don't think so).  I'm not sure the above changes 
will significantly simplify or reduce the code footprint.  (We still 
need the scanner just in a different place, ddlScript prepare/finish are 
fairly short, and remote_worker.c will still need a switch for 
'scripts', just under the SYNC block per row processing instead of as an 
event type).

As you stated above we still need to add in code to lock a user provided 
list of tables.


> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From Frank.Mcgeough at vocalocity.com  Mon May  9 06:29:16 2011
From: Frank.Mcgeough at vocalocity.com (Frank McGeough)
Date: Mon, 9 May 2011 06:29:16 -0700
Subject: [Slony1-general] setting up new node
Message-ID: <9F2DDBC1199E7C47B8A3B2CCCDD1E62008EB82CF45@VA3DIAXVS341.RED001.local>

Environment : postgres 8.4, slony 1.2.20
	
When adding a new node to an existing replication environment its my understanding that you would first get the slon process running on the new node. Even without subscribing sets the slon process on the new node would need to be running in order to handle events, correct? Otherwise, the sl_status st_lag_time for this new node would report a larger and larger lag time, right? 

I'm asking because someone that I know suggested that you could add a node and subscribe it a couple weeks later and it wouldn't effect replication at all in that interim period. I said that it wouldn't change replication to the existing nodes but that the new node would possibly trigger alarms if they were based on st_lag_time. Even though a new node isn't subscribed it still must handle ongoing events, right? Even if the handling is to discard them? That is, the master sends out events to all slaves and how they process them is decided on the slave slon process - the master doesn't filter things to send different events out to different nodes based on their subscription. 

Thanks,
Frank

From cbbrowne at afilias.info  Mon May  9 07:13:06 2011
From: cbbrowne at afilias.info (Christopher Browne)
Date: Mon, 9 May 2011 10:13:06 -0400
Subject: [Slony1-general] setting up new node
In-Reply-To: <9F2DDBC1199E7C47B8A3B2CCCDD1E62008EB82CF45@VA3DIAXVS341.RED001.local>
References: <9F2DDBC1199E7C47B8A3B2CCCDD1E62008EB82CF45@VA3DIAXVS341.RED001.local>
Message-ID: <BANLkTim+Hzze5VKziSwaQH6vYrw5yzoQMg@mail.gmail.com>

On Mon, May 9, 2011 at 9:29 AM, Frank McGeough
<Frank.Mcgeough at vocalocity.com> wrote:
> Environment : postgres 8.4, slony 1.2.20
>
> When adding a new node to an existing replication environment its my understanding that you would first get the slon process running on the new node. Even without subscribing sets the slon process on the new node would need to be running in order to handle events, correct? Otherwise, the sl_status st_lag_time for this new node would report a larger and larger lag time, right?
>
> I'm asking because someone that I know suggested that you could add a node and subscribe it a couple weeks later and it wouldn't effect replication at all in that interim period. I said that it wouldn't change replication to the existing nodes but that the new node would possibly trigger alarms if they were based on st_lag_time. Even though a new node isn't subscribed it still must handle ongoing events, right? Even if the handling is to discard them? That is, the master sends out events to all slaves and how they process them is decided on the slave slon process - the master doesn't filter things to send different events out to different nodes based on their subscription.

Sure, it'll have further adverse effects, too.

Since that new node has not reported confirmation of processing of
events, the cluster will hold onto *all* replicable data, so that
tables sl_log_1, sl_log_2, and the sequence log will grow unboundedly,
as nothing will be trimming their data.  I think you'll see ballooning
of sl_event and sl_confirm, too, but that won't be nearly as
significant as unbounded growth of sl_log_[12].

From ssinger at ca.afilias.info  Mon May  9 12:18:44 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 09 May 2011 15:18:44 -0400
Subject: [Slony1-general] Slony-I 2.1.0 beta 1
Message-ID: <4DC83E14.5070809@ca.afilias.info>

The Slony team is pleased to announce the first beta for the next major 
release of Slony-I (2.1.0).

Slony-I 2.1.0.b1 is available at 
http://www.slony.info/downloads/2.1/source/slony1-2.1.0.b1.tar.bz2

The documentation can be downloaded from 
http://www.slony.info/downloads/2.1/source/slony1-2.1.0.b1-docs.tar.bz2


This release includes over 20 new features and bug fixes from the last 
2.0 release.   The Slony team is asking the Slony community to try out 
this beta release and send test reports (both successful and 
unsuccessful to the slony1-general at lists.slony.info mailing list).



Highlights of 2.1.0 include:
---------------------------------
-Improvements to the performance of replication when a node is 
significantly behind (Bug # 167)

-A component status table that monitors the state of each thread in the 
slon process (Bug # 175)

-Multiple tables to a replication set can be added with a single command 
using regular expressions (Bug # 181)

-Slonik will now automatically wait for event confirmations when 
required (Bug # 179)

-Support for TRUNCATE triggers with PostgreSQL 8.4 or higher (Bug # 134)

-Support for adjusting TCP keep alive values (Bug # 126)


A complete list of changes can be found at 
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob_plain;f=RELEASE;h=3ab8d7cd49b8a934f63d5db9bbf82e41bd40581c;hb=29fa3df92c2205df877d2c864fc38f037437577c


For more information about Slony go to http://www.slony.info

From DOUGLAS.LITTLE at orbitz.com  Mon May  9 12:35:11 2011
From: DOUGLAS.LITTLE at orbitz.com (Little, Douglas)
Date: Mon, 9 May 2011 14:35:11 -0500
Subject: [Slony1-general] Slony use cases
Message-ID: <8585BA53443004458E0BAA6134C5A7FB678420EF@EGEXCMB01.oww.root.lcl>

Hi,
We use greenplum (based on PG 8.2.13) for our data warehouse. We're on a 10node system, with 1 master that coordinates the work.  We use before row triggers a lot to implement at rest encryption.

We're bringing up an additional system an need a mechanism for keeping the two clusters in sync.
We have a large installation (14000 tables,  14TB).  It's mostly batch updated, with most tables only getting <100k inserts/updates per day.  Our  biggest table  might do 5m rows/day.
We have about 1500 core tables that we'd want to replicate.

Could people comment on if this would be an appropriate use case for slony?
Thanks


Doug Little

Sr. Data Warehouse Architect | Business Intelligence Architecture | Orbitz Worldwide
500 W. Madison, Suite 1000  Chicago IL 60661| Office 312.260.2588 | Fax 312.894.5164 | Cell 847-997-5741
Douglas.Little at orbitz.com<mailto:Douglas.Little at orbitz.com>
 [cid:image001.jpg at 01CC0E56.4D172300]   orbitz.com<http://www.orbitz.com/> | ebookers.com<http://www.ebookers.com/> | hotelclub.com<http://www.hotelclub.com/> | cheaptickets.com<http://www.cheaptickets.com/> | ratestogo.com<http://www.ratestogo.com/> | asiahotels.com<http://www.asiahotels.com/>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110509/f722442a/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 2337 bytes
Desc: image001.jpg
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20110509/f722442a/attachment.jpg 

From scott.marlowe at gmail.com  Mon May  9 13:09:42 2011
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Mon, 9 May 2011 14:09:42 -0600
Subject: [Slony1-general] Slony use cases
In-Reply-To: <8585BA53443004458E0BAA6134C5A7FB678420EF@EGEXCMB01.oww.root.lcl>
References: <8585BA53443004458E0BAA6134C5A7FB678420EF@EGEXCMB01.oww.root.lcl>
Message-ID: <BANLkTinLV+LJtjYhbagbVgK6e9nTxaSUMg@mail.gmail.com>

(Please stick to plain text on the lists.  Some clients can't display
html email well.)

On Mon, May 9, 2011 at 1:35 PM, Little, Douglas
<DOUGLAS.LITTLE at orbitz.com> wrote:
>
> Hi,
>
> We use greenplum (based on PG 8.2.13) for our data warehouse. We?re on a 10node system, with 1 master that coordinates the work.? We use before row triggers a lot to implement at rest encryption.

I'd ask Greenplum, as I don't know how well their system works with
slony.  Other than that, the issues you face when dealing with a large
number of objects seem lessened with slony 2.0 versus 1.2.  1.2 has
some pretty pessimistic locking and as you get into the thousands of
objects it can get a little slow at some things like creating a set.
We replicate ~900 objects.  With lots (45k) of other objects in the
master database, we take up to 5 hours to create set.  create set from
a master without those 45k extra objects set creation takes < 5
minutes.  That's with slony 1.2.  We haven't (and probably wont) try
slony 2.0 in production any time soon.

From msquires at whitepages.com  Mon May  9 13:51:07 2011
From: msquires at whitepages.com (Michael Squires)
Date: Mon, 9 May 2011 13:51:07 -0700
Subject: [Slony1-general] Slony use cases
In-Reply-To: <8585BA53443004458E0BAA6134C5A7FB678420EF@EGEXCMB01.oww.root.lcl>
Message-ID: <C9EDA17E.103CE%msquires@whitepages.com>

Since we use Slony (2.0.3) here for some things, and also run Greenplum, I asked one of our DBAs about this. Here is his reply:

Greenplum will not work with Slony since Greenplum's trigger has a major limitation.

The Greenplum trigger function doesn't allow any SQL execution or modification of the database. So Slony will not work since it relies on triggers to replicate.

See Sing

From: "Little, Douglas" <DOUGLAS.LITTLE at orbitz.com<mailto:DOUGLAS.LITTLE at orbitz.com>>
Date: Mon, 9 May 2011 12:35:11 -0700
To: "slony1-general at lists.slony.info<mailto:slony1-general at lists.slony.info>" <slony1-general at lists.slony.info<mailto:slony1-general at lists.slony.info>>
Subject: [Slony1-general] Slony use cases

Hi,
We use greenplum (based on PG 8.2.13) for our data warehouse. We?re on a 10node system, with 1 master that coordinates the work.  We use before row triggers a lot to implement at rest encryption.

We?re bringing up an additional system an need a mechanism for keeping the two clusters in sync.
We have a large installation (14000 tables,  14TB).  It?s mostly batch updated, with most tables only getting <100k inserts/updates per day.  Our  biggest table  might do 5m rows/day.
We have about 1500 core tables that we?d want to replicate.

Could people comment on if this would be an appropriate use case for slony?
Thanks


Doug Little

Sr. Data Warehouse Architect | Business Intelligence Architecture | Orbitz Worldwide
500 W. Madison, Suite 1000  Chicago IL 60661| Office 312.260.2588 | Fax 312.894.5164 | Cell 847-997-5741
Douglas.Little at orbitz.com<mailto:Douglas.Little at orbitz.com>
 [cid:image001.jpg at 01CC0E56.4D172300]   orbitz.com<http://www.orbitz.com/> | ebookers.com<http://www.ebookers.com/> | hotelclub.com<http://www.hotelclub.com/> | cheaptickets.com<http://www.cheaptickets.com/> | ratestogo.com<http://www.ratestogo.com/> | asiahotels.com<http://www.asiahotels.com/>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110509/834fbaec/attachment-0001.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 2337 bytes
Desc: image001.jpg
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20110509/834fbaec/attachment-0001.jpg 

From DOUGLAS.LITTLE at orbitz.com  Mon May  9 15:11:49 2011
From: DOUGLAS.LITTLE at orbitz.com (Little, Douglas)
Date: Mon, 9 May 2011 17:11:49 -0500
Subject: [Slony1-general] Slony use cases
In-Reply-To: <C9EDA17E.103CE%msquires@whitepages.com>
References: <8585BA53443004458E0BAA6134C5A7FB678420EF@EGEXCMB01.oww.root.lcl>
	<C9EDA17E.103CE%msquires@whitepages.com>
Message-ID: <8585BA53443004458E0BAA6134C5A7FB678422EA@EGEXCMB01.oww.root.lcl>

Thanks to all for the replies.
Doug


From: Michael Squires [mailto:msquires at whitepages.com]
Sent: Monday, May 09, 2011 3:51 PM
To: Little, Douglas; slony1-general at lists.slony.info
Subject: Re: [Slony1-general] Slony use cases

Since we use Slony (2.0.3) here for some things, and also run Greenplum, I asked one of our DBAs about this. Here is his reply:

Greenplum will not work with Slony since Greenplum's trigger has a major limitation.

The Greenplum trigger function doesn't allow any SQL execution or modification of the database. So Slony will not work since it relies on triggers to replicate.

See Sing

From: "Little, Douglas" <DOUGLAS.LITTLE at orbitz.com<mailto:DOUGLAS.LITTLE at orbitz.com>>
Date: Mon, 9 May 2011 12:35:11 -0700
To: "slony1-general at lists.slony.info<mailto:slony1-general at lists.slony.info>" <slony1-general at lists.slony.info<mailto:slony1-general at lists.slony.info>>
Subject: [Slony1-general] Slony use cases

Hi,
We use greenplum (based on PG 8.2.13) for our data warehouse. We're on a 10node system, with 1 master that coordinates the work.  We use before row triggers a lot to implement at rest encryption.

We're bringing up an additional system an need a mechanism for keeping the two clusters in sync.
We have a large installation (14000 tables,  14TB).  It's mostly batch updated, with most tables only getting <100k inserts/updates per day.  Our  biggest table  might do 5m rows/day.
We have about 1500 core tables that we'd want to replicate.

Could people comment on if this would be an appropriate use case for slony?
Thanks


Doug Little

Sr. Data Warehouse Architect | Business Intelligence Architecture | Orbitz Worldwide
500 W. Madison, Suite 1000  Chicago IL 60661| Office 312.260.2588 | Fax 312.894.5164 | Cell 847-997-5741
Douglas.Little at orbitz.com<mailto:Douglas.Little at orbitz.com>
 [cid:image001.jpg at 01CC0E6C.2F10F8C0]   orbitz.com<http://www.orbitz.com/> | ebookers.com<http://www.ebookers.com/> | hotelclub.com<http://www.hotelclub.com/> | cheaptickets.com<http://www.cheaptickets.com/> | ratestogo.com<http://www.ratestogo.com/> | asiahotels.com<http://www.asiahotels.com/>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110509/828f2677/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.jpg
Type: image/jpeg
Size: 2337 bytes
Desc: image001.jpg
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20110509/828f2677/attachment.jpg 

From dba at richyen.com  Wed May 11 11:56:56 2011
From: dba at richyen.com (Richard Yen)
Date: Wed, 11 May 2011 11:56:56 -0700
Subject: [Slony1-general] Slony seems to have missed an event???
Message-ID: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>

Hello,

running slon version 2.0.6 here...

Would anyone be able to help me track down why slony missed a DELETE?  It
seems that my replication is broken as the subscribers are trying to process
an INSERT, but a primary key is being violated.  The origin machine does not
have the offending tuple, which leads me to believe that a DELETE was
processed, but wasn't propagated to the subscribers


From JanWieck at Yahoo.com  Wed May 11 13:12:35 2011
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 11 May 2011 16:12:35 -0400
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>
Message-ID: <4DCAEDB3.9070805@Yahoo.com>

On 5/11/2011 2:56 PM, Richard Yen wrote:
> Hello,
>
> running slon version 2.0.6 here...

This is the first time I've heard about an operation missing. I remember 
in some old version of PostgreSQL (8.1 I think) that we experienced 
duplicate sl_log rows due to index corruption. I was actually able to 
get a result set with a duplicate ctid. But never was a row missing so far.

To fix your replica(s), you should be able to manually DELETE the 
offending row using psql and doing

     set session_replication_role to "replica";
     delete from cron_lock where ...

You need to be a superuser to do so. After that SET statement, the psql 
prompt will bypass the deny_access triggers and the DELETE statement 
will behave exactly as if it was coming from slon.

I assume that by now, a log switch has probably destroyed all traces 
that could be used to debug the problem further.


Jan


>
> Would anyone be able to help me track down why slony missed a DELETE?
>   It seems that my replication is broken as the subscribers are trying
> to process an INSERT, but a primary key is being violated.  The origin
> machine does not have the offending tuple, which leads me to believe
> that a DELETE was processed, but wasn't propagated to the subscribers
>
>  From my origin machine:
> my_db=# select * from cron_lock;
>          id         |      lock_until_time
> -------------------+----------------------------
>   anonymous_marking | 2011-05-11 11:40:02.456091
> (1 row)
>
>  From my subscriber machines:
> my_db=# select * from cron_lock ;
>          id         |      lock_until_time
> -------------------+----------------------------
>   anonymous_marking | 2011-05-11 10:40:02.123721
> (1 row)
>
>  From the origin's sl_log_* tables:
> my_db=# select * from _sac_uk.sl_log_2 where log_tableid =190;
>   log_origin |  log_txid  | log_tableid | log_actionseq | log_cmdtype |
>                                              log_cmddata
> ------------+------------+-------------+---------------+-------------+-----------------------------------------------------------------------------------------------------
>            1 | 1369072247 |         190 |     239698918 | I           |
> ("id","lock_until_time") values ('anonymous_marking','2011-05-11
> 11:40:02.456091')
>            1 | 1369182578 |         190 |     239728797 | I           |
> ("id","lock_until_time") values ('process_past_due_pm_assignments.pl
> <http://process_past_due_pm_assignments.pl>','2011-05-11 11:00:23.944101')
>            1 | 1369182587 |         190 |     239728806 | D           |
> "id"='process_past_due_pm_assignments.pl
> <http://process_past_due_pm_assignments.pl>'
>            1 | 1369182626 |         190 |     239728830 | I           |
> ("id","lock_until_time") values ('process_past_due_pm_assignments.pl
> <http://process_past_due_pm_assignments.pl>','2011-05-11
> 11:00:24.525818')          1 | 1369182671 |         190 |     239728833
> | D           | "id"='process_past_due_pm_assignments.pl
> <http://process_past_due_pm_assignments.pl>'
> (5 rows)
>
> my_db=# select * from _sac_uk.sl_log_1 where log_tableid =190;
>   log_origin |  log_txid  | log_tableid | log_actionseq | log_cmdtype |
>                                     log_cmddata
> ------------+------------+-------------+---------------+-------------+------------------------------------------------------------------------------------
>           1 | 1369393174 |         190 |     239789790 | D           |
> "id"='anonymous_marking'
>            1 | 1369403276 |         190 |     239793047 | I           |
> ("id","lock_until_time") values ('anonymous_marking','2011-05-11
> 12:40:02.970433')(2 rows)
>
> On the subscriber logs:May 11 11:54:40 uk-sdb2 postgres[30851]: [926-1]
> 2011-05-11 11:54:40.755 PDT [user=slony,db=my_db 10.1.0.149(47318)
> PID:30851 XID:1509911291]ERROR:  duplicate key value violates unique
> constraint "cron_lock_pkey"
> May 11 11:54:40 uk-sdb2 postgres[30851]: [926-2] 2011-05-11 11:54:40.755
> PDT [user=slony,db=my_db 10.1.0.149(47318) PID:30851
> XID:1509911291]STATEMENT:  update only "public"."m_user" set
> "last_login"='2011-05-11 10:40:02.429308' where "id"='2459339';
>
> Any help would be much appreciated.
> --Richard
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From richyen at iparadigms.com  Wed May 11 13:18:44 2011
From: richyen at iparadigms.com (Richard Yen)
Date: Wed, 11 May 2011 13:18:44 -0700
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <4DCAEDB3.9070805@Yahoo.com>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>
	<4DCAEDB3.9070805@Yahoo.com>
Message-ID: <BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>

Thanks Jan,

I'll go ahead and do as recommended.  I was actually hoping that maybe we
could scour the sl_confirm and/or sl_event tables for clues, but if you
think it's not possible to find out what happened, I guess I'll just delete
the row and move on.

Thanks again,
--Richard



On Wed, May 11, 2011 at 1:12 PM, Jan Wieck <JanWieck at yahoo.com> wrote:

> On 5/11/2011 2:56 PM, Richard Yen wrote:
>
>> Hello,
>>
>> running slon version 2.0.6 here...
>>
>
> This is the first time I've heard about an operation missing. I remember in
> some old version of PostgreSQL (8.1 I think) that we experienced duplicate
> sl_log rows due to index corruption. I was actually able to get a result set
> with a duplicate ctid. But never was a row missing so far.
>
> To fix your replica(s), you should be able to manually DELETE the offending
> row using psql and doing
>
>    set session_replication_role to "replica";
>    delete from cron_lock where ...
>
> You need to be a superuser to do so. After that SET statement, the psql
> prompt will bypass the deny_access triggers and the DELETE statement will
> behave exactly as if it was coming from slon.
>
> I assume that by now, a log switch has probably destroyed all traces that
> could be used to debug the problem further.
>
>
> Jan
>
>
>
>> Would anyone be able to help me track down why slony missed a DELETE?
>>  It seems that my replication is broken as the subscribers are trying
>> to process an INSERT, but a primary key is being violated.  The origin
>> machine does not have the offending tuple, which leads me to believe
>> that a DELETE was processed, but wasn't propagated to the subscribers
>>
>>  From my origin machine:
>> my_db=# select * from cron_lock;
>>         id         |      lock_until_time
>> -------------------+----------------------------
>>  anonymous_marking | 2011-05-11 11:40:02.456091
>> (1 row)
>>
>>  From my subscriber machines:
>> my_db=# select * from cron_lock ;
>>         id         |      lock_until_time
>> -------------------+----------------------------
>>  anonymous_marking | 2011-05-11 10:40:02.123721
>> (1 row)
>>
>>  From the origin's sl_log_* tables:
>> my_db=# select * from _sac_uk.sl_log_2 where log_tableid =190;
>>  log_origin |  log_txid  | log_tableid | log_actionseq | log_cmdtype |
>>                                             log_cmddata
>>
>> ------------+------------+-------------+---------------+-------------+-----------------------------------------------------------------------------------------------------
>>           1 | 1369072247 |         190 |     239698918 | I           |
>> ("id","lock_until_time") values ('anonymous_marking','2011-05-11
>> 11:40:02.456091')
>>           1 | 1369182578 |         190 |     239728797 | I           |
>> ("id","lock_until_time") values ('process_past_due_pm_assignments.pl
>> <http://process_past_due_pm_assignments.pl>','2011-05-11
>> 11:00:23.944101')
>>
>>           1 | 1369182587 |         190 |     239728806 | D           |
>> "id"='process_past_due_pm_assignments.pl
>> <http://process_past_due_pm_assignments.pl>'
>>
>>           1 | 1369182626 |         190 |     239728830 | I           |
>> ("id","lock_until_time") values ('process_past_due_pm_assignments.pl
>> <http://process_past_due_pm_assignments.pl>','2011-05-11
>>
>> 11:00:24.525818')          1 | 1369182671 |         190 |     239728833
>> | D           | "id"='process_past_due_pm_assignments.pl
>> <http://process_past_due_pm_assignments.pl>'
>>
>> (5 rows)
>>
>> my_db=# select * from _sac_uk.sl_log_1 where log_tableid =190;
>>  log_origin |  log_txid  | log_tableid | log_actionseq | log_cmdtype |
>>                                    log_cmddata
>>
>> ------------+------------+-------------+---------------+-------------+------------------------------------------------------------------------------------
>>          1 | 1369393174 |         190 |     239789790 | D           |
>> "id"='anonymous_marking'
>>           1 | 1369403276 |         190 |     239793047 | I           |
>> ("id","lock_until_time") values ('anonymous_marking','2011-05-11
>> 12:40:02.970433')(2 rows)
>>
>> On the subscriber logs:May 11 11:54:40 uk-sdb2 postgres[30851]: [926-1]
>> 2011-05-11 11:54:40.755 PDT [user=slony,db=my_db 10.1.0.149(47318)
>> PID:30851 XID:1509911291]ERROR:  duplicate key value violates unique
>> constraint "cron_lock_pkey"
>> May 11 11:54:40 uk-sdb2 postgres[30851]: [926-2] 2011-05-11 11:54:40.755
>> PDT [user=slony,db=my_db 10.1.0.149(47318) PID:30851
>> XID:1509911291]STATEMENT:  update only "public"."m_user" set
>> "last_login"='2011-05-11 10:40:02.429308' where "id"='2459339';
>>
>> Any help would be much appreciated.
>> --Richard
>>
>>
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>
>
> --
> Anyone who trades liberty for security deserves neither
> liberty nor security. -- Benjamin Franklin
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110511/b1ab434c/attachment.htm 

From ssinger at ca.afilias.info  Wed May 11 13:21:31 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 11 May 2011 16:21:31 -0400
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>	<4DCAEDB3.9070805@Yahoo.com>
	<BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>
Message-ID: <4DCAEFCB.5000606@ca.afilias.info>

On 11-05-11 04:18 PM, Richard Yen wrote:
> Thanks Jan,
>
> I'll go ahead and do as recommended.  I was actually hoping that maybe
> we could scour the sl_confirm and/or sl_event tables for clues, but if
> you think it's not possible to find out what happened, I guess I'll just
> delete the row and move on.
>
> Thanks again,
> --Richard

If you can get a dump of sl_event and sl_confirm of both the master and 
the slave and send it to one of us we can take a look.

If you happen to have slon logs of the period it can't hurt to send 
those as well.


>
>
>
> On Wed, May 11, 2011 at 1:12 PM, Jan Wieck <JanWieck at yahoo.com
> <mailto:JanWieck at yahoo.com>> wrote:
>
>     On 5/11/2011 2:56 PM, Richard Yen wrote:
>
>         Hello,
>
>         running slon version 2.0.6 here...
>
>
>     This is the first time I've heard about an operation missing. I
>     remember in some old version of PostgreSQL (8.1 I think) that we
>     experienced duplicate sl_log rows due to index corruption. I was
>     actually able to get a result set with a duplicate ctid. But never
>     was a row missing so far.
>
>     To fix your replica(s), you should be able to manually DELETE the
>     offending row using psql and doing
>
>         set session_replication_role to "replica";
>         delete from cron_lock where ...
>
>     You need to be a superuser to do so. After that SET statement, the
>     psql prompt will bypass the deny_access triggers and the DELETE
>     statement will behave exactly as if it was coming from slon.
>
>     I assume that by now, a log switch has probably destroyed all traces
>     that could be used to debug the problem further.
>
>
>     Jan
>
>
>
>         Would anyone be able to help me track down why slony missed a
>         DELETE?
>           It seems that my replication is broken as the subscribers are
>         trying
>         to process an INSERT, but a primary key is being violated.  The
>         origin
>         machine does not have the offending tuple, which leads me to believe
>         that a DELETE was processed, but wasn't propagated to the
>         subscribers
>
>           From my origin machine:
>         my_db=# select * from cron_lock;
>                  id         |      lock_until_time
>         -------------------+----------------------------
>           anonymous_marking | 2011-05-11 11:40:02.456091
>         (1 row)
>
>           From my subscriber machines:
>         my_db=# select * from cron_lock ;
>                  id         |      lock_until_time
>         -------------------+----------------------------
>           anonymous_marking | 2011-05-11 10:40:02.123721
>         (1 row)
>
>           From the origin's sl_log_* tables:
>         my_db=# select * from _sac_uk.sl_log_2 where log_tableid =190;
>           log_origin |  log_txid  | log_tableid | log_actionseq |
>         log_cmdtype |
>                                                      log_cmddata
>         ------------+------------+-------------+---------------+-------------+-----------------------------------------------------------------------------------------------------
>                    1 | 1369072247 |         190 |     239698918 | I
>                |
>         ("id","lock_until_time") values ('anonymous_marking','2011-05-11
>         11:40:02.456091')
>                    1 | 1369182578 |         190 |     239728797 | I
>                |
>         ("id","lock_until_time") values
>         ('process_past_due_pm_assignments.pl
>         <http://process_past_due_pm_assignments.pl>
>         <http://process_past_due_pm_assignments.pl>','2011-05-11
>         11:00:23.944101')
>
>                    1 | 1369182587 |         190 |     239728806 | D
>                |
>         "id"='process_past_due_pm_assignments.pl
>         <http://process_past_due_pm_assignments.pl>
>         <http://process_past_due_pm_assignments.pl>'
>
>                    1 | 1369182626 |         190 |     239728830 | I
>                |
>         ("id","lock_until_time") values
>         ('process_past_due_pm_assignments.pl
>         <http://process_past_due_pm_assignments.pl>
>         <http://process_past_due_pm_assignments.pl>','2011-05-11
>
>         11:00:24.525818')          1 | 1369182671 |         190 |
>         239728833
>         | D           | "id"='process_past_due_pm_assignments.pl
>         <http://process_past_due_pm_assignments.pl>
>         <http://process_past_due_pm_assignments.pl>'
>
>         (5 rows)
>
>         my_db=# select * from _sac_uk.sl_log_1 where log_tableid =190;
>           log_origin |  log_txid  | log_tableid | log_actionseq |
>         log_cmdtype |
>                                             log_cmddata
>         ------------+------------+-------------+---------------+-------------+------------------------------------------------------------------------------------
>                   1 | 1369393174 |         190 |     239789790 | D
>              |
>         "id"='anonymous_marking'
>                    1 | 1369403276 |         190 |     239793047 | I
>                |
>         ("id","lock_until_time") values ('anonymous_marking','2011-05-11
>         12:40:02.970433')(2 rows)
>
>         On the subscriber logs:May 11 11:54:40 uk-sdb2 postgres[30851]:
>         [926-1]
>         2011-05-11 11:54:40.755 PDT [user=slony,db=my_db 10.1.0.149(47318)
>         PID:30851 XID:1509911291]ERROR:  duplicate key value violates unique
>         constraint "cron_lock_pkey"
>         May 11 11:54:40 uk-sdb2 postgres[30851]: [926-2] 2011-05-11
>         11:54:40.755
>         PDT [user=slony,db=my_db 10.1.0.149(47318) PID:30851
>         XID:1509911291]STATEMENT:  update only "public"."m_user" set
>         "last_login"='2011-05-11 10:40:02.429308' where "id"='2459339';
>
>         Any help would be much appreciated.
>         --Richard
>
>
>
>         _______________________________________________
>         Slony1-general mailing list
>         Slony1-general at lists.slony.info
>         <mailto:Slony1-general at lists.slony.info>
>         http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
>     --
>     Anyone who trades liberty for security deserves neither
>     liberty nor security. -- Benjamin Franklin
>
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From dba at richyen.com  Wed May 11 13:29:38 2011
From: dba at richyen.com (Richard Yen)
Date: Wed, 11 May 2011 13:29:38 -0700
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <4DCAEFCB.5000606@ca.afilias.info>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>
	<4DCAEDB3.9070805@Yahoo.com>
	<BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>
	<4DCAEFCB.5000606@ca.afilias.info>
Message-ID: <BANLkTimxC1hubxJ74avtx2F4Y7p0pQtXFQ@mail.gmail.com>

Thanks Steve.  I've put the dumps for the master and my two slaves at
http://richyen.com/slony/

Thanks again,
--Richard



On Wed, May 11, 2011 at 1:21 PM, Steve Singer <ssinger at ca.afilias.info>wrote:

> On 11-05-11 04:18 PM, Richard Yen wrote:
> > Thanks Jan,
> >
> > I'll go ahead and do as recommended.  I was actually hoping that maybe
> > we could scour the sl_confirm and/or sl_event tables for clues, but if
> > you think it's not possible to find out what happened, I guess I'll just
> > delete the row and move on.
> >
> > Thanks again,
> > --Richard
>
> If you can get a dump of sl_event and sl_confirm of both the master and
> the slave and send it to one of us we can take a look.
>
> If you happen to have slon logs of the period it can't hurt to send
> those as well.
>
>
> >
> >
> >
> > On Wed, May 11, 2011 at 1:12 PM, Jan Wieck <JanWieck at yahoo.com
> > <mailto:JanWieck at yahoo.com>> wrote:
> >
> >     On 5/11/2011 2:56 PM, Richard Yen wrote:
> >
> >         Hello,
> >
> >         running slon version 2.0.6 here...
> >
> >
> >     This is the first time I've heard about an operation missing. I
> >     remember in some old version of PostgreSQL (8.1 I think) that we
> >     experienced duplicate sl_log rows due to index corruption. I was
> >     actually able to get a result set with a duplicate ctid. But never
> >     was a row missing so far.
> >
> >     To fix your replica(s), you should be able to manually DELETE the
> >     offending row using psql and doing
> >
> >         set session_replication_role to "replica";
> >         delete from cron_lock where ...
> >
> >     You need to be a superuser to do so. After that SET statement, the
> >     psql prompt will bypass the deny_access triggers and the DELETE
> >     statement will behave exactly as if it was coming from slon.
> >
> >     I assume that by now, a log switch has probably destroyed all traces
> >     that could be used to debug the problem further.
> >
> >
> >     Jan
> >
> >
> >
> >         Would anyone be able to help me track down why slony missed a
> >         DELETE?
> >           It seems that my replication is broken as the subscribers are
> >         trying
> >         to process an INSERT, but a primary key is being violated.  The
> >         origin
> >         machine does not have the offending tuple, which leads me to
> believe
> >         that a DELETE was processed, but wasn't propagated to the
> >         subscribers
> >
> >           From my origin machine:
> >         my_db=# select * from cron_lock;
> >                  id         |      lock_until_time
> >         -------------------+----------------------------
> >           anonymous_marking | 2011-05-11 11:40:02.456091
> >         (1 row)
> >
> >           From my subscriber machines:
> >         my_db=# select * from cron_lock ;
> >                  id         |      lock_until_time
> >         -------------------+----------------------------
> >           anonymous_marking | 2011-05-11 10:40:02.123721
> >         (1 row)
> >
> >           From the origin's sl_log_* tables:
> >         my_db=# select * from _sac_uk.sl_log_2 where log_tableid =190;
> >           log_origin |  log_txid  | log_tableid | log_actionseq |
> >         log_cmdtype |
> >                                                      log_cmddata
> >
> ------------+------------+-------------+---------------+-------------+-----------------------------------------------------------------------------------------------------
> >                    1 | 1369072247 |         190 |     239698918 | I
> >                |
> >         ("id","lock_until_time") values ('anonymous_marking','2011-05-11
> >         11:40:02.456091')
> >                    1 | 1369182578 |         190 |     239728797 | I
> >                |
> >         ("id","lock_until_time") values
> >         ('process_past_due_pm_assignments.pl
> >         <http://process_past_due_pm_assignments.pl>
> >         <http://process_past_due_pm_assignments.pl>','2011-05-11
> >         11:00:23.944101')
> >
> >                    1 | 1369182587 |         190 |     239728806 | D
> >                |
> >         "id"='process_past_due_pm_assignments.pl
> >         <http://process_past_due_pm_assignments.pl>
> >         <http://process_past_due_pm_assignments.pl>'
> >
> >                    1 | 1369182626 |         190 |     239728830 | I
> >                |
> >         ("id","lock_until_time") values
> >         ('process_past_due_pm_assignments.pl
> >         <http://process_past_due_pm_assignments.pl>
> >         <http://process_past_due_pm_assignments.pl>','2011-05-11
> >
> >         11:00:24.525818')          1 | 1369182671 |         190 |
> >         239728833
> >         | D           | "id"='process_past_due_pm_assignments.pl
> >         <http://process_past_due_pm_assignments.pl>
> >         <http://process_past_due_pm_assignments.pl>'
> >
> >         (5 rows)
> >
> >         my_db=# select * from _sac_uk.sl_log_1 where log_tableid =190;
> >           log_origin |  log_txid  | log_tableid | log_actionseq |
> >         log_cmdtype |
> >                                             log_cmddata
> >
> ------------+------------+-------------+---------------+-------------+------------------------------------------------------------------------------------
> >                   1 | 1369393174 |         190 |     239789790 | D
> >              |
> >         "id"='anonymous_marking'
> >                    1 | 1369403276 |         190 |     239793047 | I
> >                |
> >         ("id","lock_until_time") values ('anonymous_marking','2011-05-11
> >         12:40:02.970433')(2 rows)
> >
> >         On the subscriber logs:May 11 11:54:40 uk-sdb2 postgres[30851]:
> >         [926-1]
> >         2011-05-11 11:54:40.755 PDT [user=slony,db=my_db
> 10.1.0.149(47318)
> >         PID:30851 XID:1509911291]ERROR:  duplicate key value violates
> unique
> >         constraint "cron_lock_pkey"
> >         May 11 11:54:40 uk-sdb2 postgres[30851]: [926-2] 2011-05-11
> >         11:54:40.755
> >         PDT [user=slony,db=my_db 10.1.0.149(47318) PID:30851
> >         XID:1509911291]STATEMENT:  update only "public"."m_user" set
> >         "last_login"='2011-05-11 10:40:02.429308' where "id"='2459339';
> >
> >         Any help would be much appreciated.
> >         --Richard
> >
> >
> >
> >         _______________________________________________
> >         Slony1-general mailing list
> >         Slony1-general at lists.slony.info
> >         <mailto:Slony1-general at lists.slony.info>
> >         http://lists.slony.info/mailman/listinfo/slony1-general
> >
> >
> >
> >     --
> >     Anyone who trades liberty for security deserves neither
> >     liberty nor security. -- Benjamin Franklin
> >
> >
> >
> >
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general at lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110511/d3e3d0f6/attachment.htm 

From ssinger at ca.afilias.info  Wed May 11 14:26:12 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 11 May 2011 17:26:12 -0400
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <BANLkTimxC1hubxJ74avtx2F4Y7p0pQtXFQ@mail.gmail.com>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>	<4DCAEDB3.9070805@Yahoo.com>	<BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>	<4DCAEFCB.5000606@ca.afilias.info>
	<BANLkTimxC1hubxJ74avtx2F4Y7p0pQtXFQ@mail.gmail.com>
Message-ID: <4DCAFEF4.6080707@ca.afilias.info>

On 11-05-11 04:29 PM, Richard Yen wrote:
> Thanks Steve.  I've put the dumps for the master and my two slaves at
> http://richyen.com/slony/

As Jan suspected there isn't really anything still left in the logs 
about events from before the failed insert.

When should the row have been deleted from cron_lock? immediately before 
or sometime before?

Did anything else happen around this time? (server restarts, moving 
masters etc?)


>
> Thanks again,
> --Richard
>
>
>
> On Wed, May 11, 2011 at 1:21 PM, Steve Singer <ssinger at ca.afilias.info
> <mailto:ssinger at ca.afilias.info>> wrote:
>
>     On 11-05-11 04:18 PM, Richard Yen wrote:
>      > Thanks Jan,
>      >
>      > I'll go ahead and do as recommended.  I was actually hoping that
>     maybe
>      > we could scour the sl_confirm and/or sl_event tables for clues,
>     but if
>      > you think it's not possible to find out what happened, I guess
>     I'll just
>      > delete the row and move on.
>      >
>      > Thanks again,
>      > --Richard
>
>     If you can get a dump of sl_event and sl_confirm of both the master and
>     the slave and send it to one of us we can take a look.
>
>     If you happen to have slon logs of the period it can't hurt to send
>     those as well.
>
>
>      >
>      >
>      >
>      > On Wed, May 11, 2011 at 1:12 PM, Jan Wieck <JanWieck at yahoo.com
>     <mailto:JanWieck at yahoo.com>
>      > <mailto:JanWieck at yahoo.com <mailto:JanWieck at yahoo.com>>> wrote:
>      >
>      >     On 5/11/2011 2:56 PM, Richard Yen wrote:
>      >
>      >         Hello,
>      >
>      >         running slon version 2.0.6 here...
>      >
>      >
>      >     This is the first time I've heard about an operation missing. I
>      >     remember in some old version of PostgreSQL (8.1 I think) that we
>      >     experienced duplicate sl_log rows due to index corruption. I was
>      >     actually able to get a result set with a duplicate ctid. But
>     never
>      >     was a row missing so far.
>      >
>      >     To fix your replica(s), you should be able to manually DELETE the
>      >     offending row using psql and doing
>      >
>      >         set session_replication_role to "replica";
>      >         delete from cron_lock where ...
>      >
>      >     You need to be a superuser to do so. After that SET
>     statement, the
>      >     psql prompt will bypass the deny_access triggers and the DELETE
>      >     statement will behave exactly as if it was coming from slon.
>      >
>      >     I assume that by now, a log switch has probably destroyed all
>     traces
>      >     that could be used to debug the problem further.
>      >
>      >
>      >     Jan
>      >
>      >
>      >
>      >         Would anyone be able to help me track down why slony missed a
>      >         DELETE?
>      >           It seems that my replication is broken as the
>     subscribers are
>      >         trying
>      >         to process an INSERT, but a primary key is being
>     violated.  The
>      >         origin
>      >         machine does not have the offending tuple, which leads me
>     to believe
>      >         that a DELETE was processed, but wasn't propagated to the
>      >         subscribers
>      >
>      >           From my origin machine:
>      >         my_db=# select * from cron_lock;
>      >                  id         |      lock_until_time
>      >         -------------------+----------------------------
>      >           anonymous_marking | 2011-05-11 11:40:02.456091
>      >         (1 row)
>      >
>      >           From my subscriber machines:
>      >         my_db=# select * from cron_lock ;
>      >                  id         |      lock_until_time
>      >         -------------------+----------------------------
>      >           anonymous_marking | 2011-05-11 10:40:02.123721
>      >         (1 row)
>      >
>      >           From the origin's sl_log_* tables:
>      >         my_db=# select * from _sac_uk.sl_log_2 where log_tableid
>     =190;
>      >           log_origin |  log_txid  | log_tableid | log_actionseq |
>      >         log_cmdtype |
>      >                                                      log_cmddata
>      >
>     ------------+------------+-------------+---------------+-------------+-----------------------------------------------------------------------------------------------------
>      >                    1 | 1369072247 |         190 |     239698918 | I
>      >                |
>      >         ("id","lock_until_time") values
>     ('anonymous_marking','2011-05-11
>      >         11:40:02.456091')
>      >                    1 | 1369182578 |         190 |     239728797 | I
>      >                |
>      >         ("id","lock_until_time") values
>      >         ('process_past_due_pm_assignments.pl
>     <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>','2011-05-11
>      >         11:00:23.944101')
>      >
>      >                    1 | 1369182587 |         190 |     239728806 | D
>      >                |
>      > "id"='process_past_due_pm_assignments.pl
>     <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>'
>      >
>      >                    1 | 1369182626 |         190 |     239728830 | I
>      >                |
>      >         ("id","lock_until_time") values
>      >         ('process_past_due_pm_assignments.pl
>     <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>','2011-05-11
>      >
>      >         11:00:24.525818')          1 | 1369182671 |         190 |
>      >         239728833
>      >         | D           | "id"='process_past_due_pm_assignments.pl
>     <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>
>      > <http://process_past_due_pm_assignments.pl>'
>      >
>      >         (5 rows)
>      >
>      >         my_db=# select * from _sac_uk.sl_log_1 where log_tableid
>     =190;
>      >           log_origin |  log_txid  | log_tableid | log_actionseq |
>      >         log_cmdtype |
>      >                                             log_cmddata
>      >
>     ------------+------------+-------------+---------------+-------------+------------------------------------------------------------------------------------
>      >                   1 | 1369393174 |         190 |     239789790 | D
>      >              |
>      > "id"='anonymous_marking'
>      >                    1 | 1369403276 |         190 |     239793047 | I
>      >                |
>      >         ("id","lock_until_time") values
>     ('anonymous_marking','2011-05-11
>      >         12:40:02.970433')(2 rows)
>      >
>      >         On the subscriber logs:May 11 11:54:40 uk-sdb2
>     postgres[30851]:
>      >         [926-1]
>      >         2011-05-11 11:54:40.755 PDT [user=slony,db=my_db
>     10.1.0.149(47318)
>      >         PID:30851 XID:1509911291]ERROR:  duplicate key value
>     violates unique
>      >         constraint "cron_lock_pkey"
>      >         May 11 11:54:40 uk-sdb2 postgres[30851]: [926-2] 2011-05-11
>      >         11:54:40.755
>      >         PDT [user=slony,db=my_db 10.1.0.149(47318) PID:30851
>      >         XID:1509911291]STATEMENT:  update only "public"."m_user" set
>      > "last_login"='2011-05-11 10:40:02.429308' where "id"='2459339';
>      >
>      >         Any help would be much appreciated.
>      >         --Richard
>      >
>      >
>      >
>      >         _______________________________________________
>      >         Slony1-general mailing list
>      > Slony1-general at lists.slony.info
>     <mailto:Slony1-general at lists.slony.info>
>      > <mailto:Slony1-general at lists.slony.info
>     <mailto:Slony1-general at lists.slony.info>>
>      > http://lists.slony.info/mailman/listinfo/slony1-general
>      >
>      >
>      >
>      >     --
>      >     Anyone who trades liberty for security deserves neither
>      >     liberty nor security. -- Benjamin Franklin
>      >
>      >
>      >
>      >
>      > _______________________________________________
>      > Slony1-general mailing list
>      > Slony1-general at lists.slony.info
>     <mailto:Slony1-general at lists.slony.info>
>      > http://lists.slony.info/mailman/listinfo/slony1-general
>
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general at lists.slony.info <mailto:Slony1-general at lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
>
>


From dba at richyen.com  Wed May 11 14:43:06 2011
From: dba at richyen.com (Richard Yen)
Date: Wed, 11 May 2011 14:43:06 -0700
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <4DCAFEF4.6080707@ca.afilias.info>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>
	<4DCAEDB3.9070805@Yahoo.com>
	<BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>
	<4DCAEFCB.5000606@ca.afilias.info>
	<BANLkTimxC1hubxJ74avtx2F4Y7p0pQtXFQ@mail.gmail.com>
	<4DCAFEF4.6080707@ca.afilias.info>
Message-ID: <BANLkTinL=R5U+a5gdB=t7eQOKdAm1RtOnQ@mail.gmail.com>

On Wed, May 11, 2011 at 2:26 PM, Steve Singer <ssinger at ca.afilias.info>wrote:

> On 11-05-11 04:29 PM, Richard Yen wrote:
>
>> Thanks Steve.  I've put the dumps for the master and my two slaves at
>> http://richyen.com/slony/
>>
>
> As Jan suspected there isn't really anything still left in the logs about
> events from before the failed insert.
>
> When should the row have been deleted from cron_lock? immediately before or
> sometime before?
>
The cron runs every hour, so there should have been a DELETE  at 10:40AM,
just milliseconds before the INSERT.


> Did anything else happen around this time? (server restarts, moving masters
> etc?)
>
No, we didn't do anything during this time.  The previous action I performed
on this cluster was at 10:04AM, which was to INSERT a row into another table
in the database.  The sync_interval I have is 500ms, so I'm fairly confident
that this would have been processed long before the offending INSERT to
cron_lock arrived at 10:40AM.  The oldest entry in sl_even right now is
'2011-05-11 10:40:02.354653'

If we can't get any more clues, I'll go ahead an process the DELETE.  Thanks
again for your help in trying to get to the bottom of this.
--Richard
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110511/f0461a44/attachment.htm 

From dba at richyen.com  Wed May 11 15:23:12 2011
From: dba at richyen.com (Richard Yen)
Date: Wed, 11 May 2011 15:23:12 -0700
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <BANLkTinL=R5U+a5gdB=t7eQOKdAm1RtOnQ@mail.gmail.com>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>
	<4DCAEDB3.9070805@Yahoo.com>
	<BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>
	<4DCAEFCB.5000606@ca.afilias.info>
	<BANLkTimxC1hubxJ74avtx2F4Y7p0pQtXFQ@mail.gmail.com>
	<4DCAFEF4.6080707@ca.afilias.info>
	<BANLkTinL=R5U+a5gdB=t7eQOKdAm1RtOnQ@mail.gmail.com>
Message-ID: <BANLkTim_zG+ocnN9EODQGTJBgVDG+FZp=Q@mail.gmail.com>

Steve, I've also noticed something even more bizarre.

Fortunately, I have log_shipping set up on a third subscriber, and grepping
through the files, I find the following:

[root at asp-dbr1 log_staging]# for i in `ls`; do grep -Hn cron_lock $i; done
slony1_log_3_00000000000011179582.sql:13:insert into "public"."cron_lock"
("id","lock_until_time") values ('anonymous_marking','2011-05-11
11:40:02.456091');
slony1_log_3_00000000000011180903.sql:13:insert into "public"."cron_lock"
("id","lock_until_time") values ('anonymous_marking','2011-05-11
11:40:02.456091');
slony1_log_3_00000000000011181730.sql:13:insert into "public"."cron_lock"
("id","lock_until_time") values ('anonymous_marking','2011-05-11
11:40:02.456091');
slony1_log_3_00000000000011182005.sql:13:insert into "public"."cron_lock"
("id","lock_until_time") values ('anonymous_marking','2011-05-11
11:40:02.456091');
slony1_log_3_00000000000011182466.sql:13:insert into "public"."cron_lock"
("id","lock_until_time") values ('anonymous_marking','2011-05-11
11:40:02.456091');
slony1_log_3_00000000000011183270.sql:13:insert into "public"."cron_lock"
("id","lock_until_time") values ('anonymous_marking','2011-05-11
11:40:02.456091');

[root at asp-dbr1 log_staging]# diff slony1_log_3_00000000000011179582.sql
slony1_log_3_00000000000011180903.sql
7c7
< select "_sac_uk".archiveTracking_offline('11179582', '2011-05-11
11:33:39.97637');
---
> select "_sac_uk".archiveTracking_offline('11180903', '2011-05-11
11:46:11.544073');

It seems that something has gone horribly wrong with replication such that
it's beginning to even replay events.

Does this look like an issue you may already be aware of?
--Richard



On Wed, May 11, 2011 at 2:43 PM, Richard Yen <dba at richyen.com> wrote:

>
>
> On Wed, May 11, 2011 at 2:26 PM, Steve Singer <ssinger at ca.afilias.info>wrote:
>
>> On 11-05-11 04:29 PM, Richard Yen wrote:
>>
>>> Thanks Steve.  I've put the dumps for the master and my two slaves at
>>> http://richyen.com/slony/
>>>
>>
>> As Jan suspected there isn't really anything still left in the logs about
>> events from before the failed insert.
>>
>> When should the row have been deleted from cron_lock? immediately before
>> or sometime before?
>>
> The cron runs every hour, so there should have been a DELETE  at 10:40AM,
> just milliseconds before the INSERT.
>
>
>> Did anything else happen around this time? (server restarts, moving
>> masters etc?)
>>
> No, we didn't do anything during this time.  The previous action I
> performed on this cluster was at 10:04AM, which was to INSERT a row into
> another table in the database.  The sync_interval I have is 500ms, so I'm
> fairly confident that this would have been processed long before the
> offending INSERT to cron_lock arrived at 10:40AM.  The oldest entry in
> sl_even right now is '2011-05-11 10:40:02.354653'
>
> If we can't get any more clues, I'll go ahead an process the DELETE.
>  Thanks again for your help in trying to get to the bottom of this.
> --Richard
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110511/65628e24/attachment.htm 

From ssinger at ca.afilias.info  Wed May 11 20:38:55 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 11 May 2011 23:38:55 -0400
Subject: [Slony1-general] Slony seems to have missed an event???
In-Reply-To: <BANLkTim_zG+ocnN9EODQGTJBgVDG+FZp=Q@mail.gmail.com>
References: <BANLkTimZgFHj52Uu7OMEN1MoZt_8HPUQVQ@mail.gmail.com>	<4DCAEDB3.9070805@Yahoo.com>	<BANLkTimCWSpsXiSEtKg89m4SZduZ8Pwxuw@mail.gmail.com>	<4DCAEFCB.5000606@ca.afilias.info>	<BANLkTimxC1hubxJ74avtx2F4Y7p0pQtXFQ@mail.gmail.com>	<4DCAFEF4.6080707@ca.afilias.info>	<BANLkTinL=R5U+a5gdB=t7eQOKdAm1RtOnQ@mail.gmail.com>
	<BANLkTim_zG+ocnN9EODQGTJBgVDG+FZp=Q@mail.gmail.com>
Message-ID: <4DCB564F.7060901@ca.afilias.info>

On 11-05-11 06:23 PM, Richard Yen wrote:
> Steve, I've also noticed something even more bizarre.
>
> Fortunately, I have log_shipping set up on a third subscriber, and
> grepping through the files, I find the following:
>
> [root at asp-dbr1 log_staging]# for i in `ls`; do grep -Hn cron_lock $i; done
> slony1_log_3_00000000000011179582.sql:13:insert into
> "public"."cron_lock" ("id","lock_until_time") values
> ('anonymous_marking','2011-05-11 11:40:02.456091');


> It seems that something has gone horribly wrong with replication such
> that it's beginning to even replay events.
>
> Does this look like an issue you may already be aware of?

I wonder if this is caused by
1. Slon (on the slave) writes the SQL as part of the sync to the 
logshipper file
2. slon tries to apply the SQL to the slave
3. The transaction roles back on the slave but doesn't delete anything 
from the logshipping file
4. Slon retires (goto step 1).

I'll try to look at the log shipping code in slon to see if something 
similar to the above is in fact the case.



> --Richard
>
>
>
> On Wed, May 11, 2011 at 2:43 PM, Richard Yen <dba at richyen.com
> <mailto:dba at richyen.com>> wrote:
>
>
>
>     On Wed, May 11, 2011 at 2:26 PM, Steve Singer
>     <ssinger at ca.afilias.info <mailto:ssinger at ca.afilias.info>> wrote:
>
>         On 11-05-11 04:29 PM, Richard Yen wrote:
>
>             Thanks Steve.  I've put the dumps for the master and my two
>             slaves at
>             http://richyen.com/slony/
>
>
>         As Jan suspected there isn't really anything still left in the
>         logs about events from before the failed insert.
>
>         When should the row have been deleted from cron_lock?
>         immediately before or sometime before?
>
>     The cron runs every hour, so there should have been a DELETE  at
>     10:40AM, just milliseconds before the INSERT.
>
>         Did anything else happen around this time? (server restarts,
>         moving masters etc?)
>
>     No, we didn't do anything during this time.  The previous action I
>     performed on this cluster was at 10:04AM, which was to INSERT a row
>     into another table in the database.  The sync_interval I have is
>     500ms, so I'm fairly confident that this would have been processed
>     long before the offending INSERT to cron_lock arrived at 10:40AM.
>       The oldest entry in sl_even right now is '2011-05-11 10:40:02.354653'
>
>     If we can't get any more clues, I'll go ahead an process the DELETE.
>       Thanks again for your help in trying to get to the bottom of this.
>     --Richard
>
>


From toomas.pfx at gmail.com  Sun May 15 08:50:43 2011
From: toomas.pfx at gmail.com (Toomas Vendelin)
Date: Sun, 15 May 2011 18:50:43 +0300
Subject: [Slony1-general] Instaling Slony 2.0.6 on Fedora 14: /usr/bin/ld:
	cannot find -lpgport
Message-ID: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>

Hello List,

While trying to install Slony 2.0.6 from source on Fedora 14 (x86_64),
I've stumbled upon the following compillation error:

gcc -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions
-fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic -Wall
-Wmissing-prototypes -Wmissing-declarations -I../..
-DPGSHARE="\"/usr/share/pgsql/\""  slonik.o dbutil.o parser.o
../parsestatements/scanner.o scan.o -L/usr/lib64/ -L/usr/lib64/pgsql/
-lpq  -Wl,-rpath,/usr/lib64/ -lpgport -o slonik
/usr/bin/ld: cannot find -lpgport
collect2: ld returned 1 exit status
make[2]: *** [slonik] Error 1
make[2]: Leaving directory `/home/tom/slony_rpm/BUILD/slony1-2.0.6/src/slonik'
make[1]: *** [all] Error 2
make[1]: Leaving directory `/home/tom/slony_rpm/BUILD/slony1-2.0.6/src'
make: *** [all] Error 2
error: Bad exit status from /var/tmp/rpm-tmp.62V9Fx (%build)

I'm using
Fedora 14, kernel 2.6.35.13-91.fc14.x86_64
PostgreSQL 8.4.8
postgresql-devel.x86_64.rpm

For some reason, I didn't find any chapter containing installation
instructions in the "official" documentation. Please, help.

Toomas

From ssinger_pg at sympatico.ca  Sun May 15 14:06:34 2011
From: ssinger_pg at sympatico.ca (Steve Singer)
Date: Sun, 15 May 2011 17:06:34 -0400
Subject: [Slony1-general] Instaling Slony 2.0.6 on Fedora 14:
 /usr/bin/ld: cannot find -lpgport
In-Reply-To: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
References: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
Message-ID: <BLU0-SMTP15FE86A2AEDE0247EB37ACAC8A0@phx.gbl>

On Sun, 15 May 2011, Toomas Vendelin wrote:

> Hello List,
>
> While trying to install Slony 2.0.6 from source on Fedora 14 (x86_64),
> I've stumbled upon the following compillation error:
>
> gcc -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions
> -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic -Wall
> -Wmissing-prototypes -Wmissing-declarations -I../..
> -DPGSHARE="\"/usr/share/pgsql/\""  slonik.o dbutil.o parser.o
> ../parsestatements/scanner.o scan.o -L/usr/lib64/ -L/usr/lib64/pgsql/
> -lpq  -Wl,-rpath,/usr/lib64/ -lpgport -o slonik
> /usr/bin/ld: cannot find -lpgport

What did you pass to configure?

I recommend using configure with
configure --with-pgconfigdir=/usr/bin  (or whatever the path to pg_config 
is).

I suspect this is an issue where related to a mismatch between 64 bit and 32 
bit libraries installed.


> collect2: ld returned 1 exit status
> make[2]: *** [slonik] Error 1
> make[2]: Leaving directory `/home/tom/slony_rpm/BUILD/slony1-2.0.6/src/slonik'
> make[1]: *** [all] Error 2
> make[1]: Leaving directory `/home/tom/slony_rpm/BUILD/slony1-2.0.6/src'
> make: *** [all] Error 2
> error: Bad exit status from /var/tmp/rpm-tmp.62V9Fx (%build)
>
> I'm using
> Fedora 14, kernel 2.6.35.13-91.fc14.x86_64
> PostgreSQL 8.4.8
> postgresql-devel.x86_64.rpm
>
> For some reason, I didn't find any chapter containing installation
> instructions in the "official" documentation. Please, help.
>
> Toomas
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From peter at 2ndquadrant.com  Sun May 15 15:02:42 2011
From: peter at 2ndquadrant.com (Peter Geoghegan)
Date: Sun, 15 May 2011 23:02:42 +0100
Subject: [Slony1-general] Instaling Slony 2.0.6 on Fedora 14:
 /usr/bin/ld: cannot find -lpgport
In-Reply-To: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
References: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
Message-ID: <BANLkTimii8KNRdBK5=fXfMZnuxX6Tb+22w@mail.gmail.com>

Way back in 2008 I experienced a similar issue due to the fact that
the Opensuse package maintainers decided that libpgport could be
omitted from the postgresql-devel package. They were wrong.

-- 
Peter Geoghegan ? ? ? http://www.2ndQuadrant.com/
PostgreSQL Development, 24x7 Support, Training and Services

From toomas.pfx at gmail.com  Mon May 16 00:14:41 2011
From: toomas.pfx at gmail.com (Toomas Vendelin)
Date: Mon, 16 May 2011 10:14:41 +0300
Subject: [Slony1-general] Instaling Slony 2.0.6 on Fedora 14:
 /usr/bin/ld: cannot find -lpgport
In-Reply-To: <BANLkTimii8KNRdBK5=fXfMZnuxX6Tb+22w@mail.gmail.com>
References: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
	<BANLkTimii8KNRdBK5=fXfMZnuxX6Tb+22w@mail.gmail.com>
Message-ID: <BANLkTiks6=eh1ngbhpqAJJ_xc24KC8WDKQ@mail.gmail.com>

Yep, libpgport is not included in postgresql-devel, and nothing by
that name found in system.
Nope, passing pg_config directory to ./configure didn't make it any better :(

Any suggestions on further actions?

On Mon, May 16, 2011 at 1:02 AM, Peter Geoghegan <peter at 2ndquadrant.com> wrote:
> Way back in 2008 I experienced a similar issue due to the fact that
> the Opensuse package maintainers decided that libpgport could be
> omitted from the postgresql-devel package. They were wrong.
>
> --
> Peter Geoghegan ? ? ? http://www.2ndQuadrant.com/
> PostgreSQL Development, 24x7 Support, Training and Services
>

From scott.marlowe at gmail.com  Mon May 16 10:45:16 2011
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Mon, 16 May 2011 11:45:16 -0600
Subject: [Slony1-general] Instaling Slony 2.0.6 on Fedora 14:
 /usr/bin/ld: cannot find -lpgport
In-Reply-To: <BANLkTiks6=eh1ngbhpqAJJ_xc24KC8WDKQ@mail.gmail.com>
References: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
	<BANLkTimii8KNRdBK5=fXfMZnuxX6Tb+22w@mail.gmail.com>
	<BANLkTiks6=eh1ngbhpqAJJ_xc24KC8WDKQ@mail.gmail.com>
Message-ID: <BANLkTi=7zbvAh0y0q5LUNKsQvtsfUHE5Yw@mail.gmail.com>

On Mon, May 16, 2011 at 1:14 AM, Toomas Vendelin <toomas.pfx at gmail.com> wrote:
> Yep, libpgport is not included in postgresql-devel, and nothing by
> that name found in system.
> Nope, passing pg_config directory to ./configure didn't make it any better :(
>
> Any suggestions on further actions?

Build PostgreSQL from source?
Contact the Fedora developers and get them to fix their broken packages?
See if slony is available as a package for Fedora?

From devrim at gunduz.org  Mon May 16 12:34:38 2011
From: devrim at gunduz.org (Devrim =?ISO-8859-1?Q?G=DCND=DCZ?=)
Date: Mon, 16 May 2011 12:34:38 -0700
Subject: [Slony1-general] Instaling Slony 2.0.6 on Fedora 14:
 /usr/bin/ld: cannot find -lpgport
In-Reply-To: <BANLkTi=7zbvAh0y0q5LUNKsQvtsfUHE5Yw@mail.gmail.com>
References: <BANLkTimU9gb9OQO8Luwtkr2JNhfnPGfoyA@mail.gmail.com>
	<BANLkTimii8KNRdBK5=fXfMZnuxX6Tb+22w@mail.gmail.com>
	<BANLkTiks6=eh1ngbhpqAJJ_xc24KC8WDKQ@mail.gmail.com>
	<BANLkTi=7zbvAh0y0q5LUNKsQvtsfUHE5Yw@mail.gmail.com>
Message-ID: <1305574478.2601.2.camel@lenovo01-laptop03.gunduz.org>

On Mon, 2011-05-16 at 11:45 -0600, Scott Marlowe wrote:
> Contact the Fedora developers and get them to fix their broken
> packages?

...or investigate what has changed between 2.0.5 and 2.0.6 so that it is
not built on Fedora...
-- 
Devrim G?ND?Z
Principal Systems Engineer @ EnterpriseDB: http://www.enterprisedb.com
PostgreSQL Dan??man?/Consultant, Red Hat Certified Engineer
Community: devrim~PostgreSQL.org, devrim.gunduz~linux.org.tr
http://www.gunduz.org  Twitter: http://twitter.com/devrimgunduz
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 198 bytes
Desc: This is a digitally signed message part
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20110516/7265c046/attachment.pgp 

From raghuchennuru at gmail.com  Tue May 17 06:48:15 2011
From: raghuchennuru at gmail.com (raghu ram)
Date: Tue, 17 May 2011 19:18:15 +0530
Subject: [Slony1-general] Upgrading Slony Minor version
Message-ID: <BANLkTimy3_pDgA1GZiZ2NTDw+CAtQMPOtQ@mail.gmail.com>

Dear all,

Currently we are running Slony-I 2.0.5 and we need to upgrade it to Slony-I
2.0.6.

In the documentation there is UPDATE FUNCTION mentioned and not the steps.
http://www.slony.info/documentation/slonyupgrade.html

Can any one assist me steps how to upgrade the Slony-I 2.0.5 to Slony-I
2.0.6.

--Raghu Ram
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110517/d5dfdc28/attachment.htm 

From glynastill at yahoo.co.uk  Tue May 17 08:07:15 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Tue, 17 May 2011 16:07:15 +0100 (BST)
Subject: [Slony1-general] tools/slonikconfdump.sh
Message-ID: <468217.2339.qm@web26008.mail.ukl.yahoo.com>

Has this been renamed?? I'm assuming it's slony1_dump.sh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110517/5a3c1f64/attachment.htm 

From glynastill at yahoo.co.uk  Tue May 17 08:25:06 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Tue, 17 May 2011 16:25:06 +0100 (BST)
Subject: [Slony1-general] Upgrading Slony Minor version
In-Reply-To: <BANLkTimy3_pDgA1GZiZ2NTDw+CAtQMPOtQ@mail.gmail.com>
References: <BANLkTimy3_pDgA1GZiZ2NTDw+CAtQMPOtQ@mail.gmail.com>
Message-ID: <886003.24666.qm@web26003.mail.ukl.yahoo.com>

I presume this is the same as in 1.2.x, so after updating the binaries, run update_functions against each node.? Here's how I'd be doing it on our systems, where @Server<x> is the id of the node.


INCLUDE <preamble.inc.scr>;

UPDATE FUNCTIONS ( ID = @Server5a );
UPDATE FUNCTIONS ( ID = @Server5b );
UPDATE FUNCTIONS ( ID = @Server5c );
UPDATE FUNCTIONS ( ID = @Server5d );
UPDATE FUNCTIONS ( ID = @Server5e );




>________________________________
>From: raghu ram <raghuchennuru at gmail.com>
>To: slony1-general at lists.slony.info; slony1-general-request at lists.slony.info
>Sent: Tuesday, 17 May 2011, 14:48
>Subject: [Slony1-general] Upgrading Slony Minor version
>
>
>Dear all,
>?
>Currently we are running Slony-I 2.0.5 and we need to upgrade it to Slony-I 2.0.6.? 
>?
>In the documentation there is UPDATE FUNCTION mentioned and not the steps. 
>http://www.slony.info/documentation/slonyupgrade.html
>?
>Can any one assist me steps how to upgrade the Slony-I 2.0.5 to Slony-I 2.0.6.
>?
>--Raghu Ram
>_______________________________________________
>Slony1-general mailing list
>Slony1-general at lists.slony.info
>http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110517/0ebb9d2b/attachment.htm 

From glynastill at yahoo.co.uk  Tue May 17 08:48:09 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Tue, 17 May 2011 16:48:09 +0100 (BST)
Subject: [Slony1-general] tools/slonikconfdump.sh
In-Reply-To: <468217.2339.qm@web26008.mail.ukl.yahoo.com>
References: <468217.2339.qm@web26008.mail.ukl.yahoo.com>
Message-ID: <712583.94109.qm@web26001.mail.ukl.yahoo.com>

Okay, I'm a little confised now.

I can't find slonikconfdump.shanywhere, and I'm pretty sure slony1_dump.sh is no use to me for an upgrade from 1.2.x to 2.0.6


I'm guessing all that script does is write out a slonik script for INIT CLUSTER, STORE NODE, STORE PATH, CREATE SET, SET ADD xxx and then SUBSCRIBE SET OMIT COPY?




>________________________________
>From: Glyn Astill <glynastill at yahoo.co.uk>
>To: "slony1-general at lists.slony.info" <slony1-general at lists.slony.info>
>Sent: Tuesday, 17 May 2011, 16:07
>Subject: [Slony1-general] tools/slonikconfdump.sh
>
>
>Has this been renamed?? I'm assuming it's slony1_dump.sh
>
>_______________________________________________
>Slony1-general mailing list
>Slony1-general at lists.slony.info
>http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110517/a9bcee20/attachment.htm 

From ssinger at ca.afilias.info  Tue May 17 10:11:23 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 17 May 2011 13:11:23 -0400
Subject: [Slony1-general] tools/slonikconfdump.sh
In-Reply-To: <712583.94109.qm@web26001.mail.ukl.yahoo.com>
References: <468217.2339.qm@web26008.mail.ukl.yahoo.com>
	<712583.94109.qm@web26001.mail.ukl.yahoo.com>
Message-ID: <4DD2AC3B.7090700@ca.afilias.info>

On 11-05-17 11:48 AM, Glyn Astill wrote:
> Okay, I'm a little confised now.
>
> I can't find slonikconfdump.sh anywhere, and I'm pretty sure
> slony1_dump.sh is no use to me for an upgrade from 1.2.x to 2.0.6
>
> I'm guessing all that script does is write out a slonik script for INIT
> CLUSTER, STORE NODE, STORE PATH, CREATE SET, SET ADD xxx and then
> SUBSCRIBE SET OMIT COPY?

I *think* that script is in 2.0.3 and 2.0.4.  I am not sure exactly what 
the script does (I haven't looked at it).  OMIT COPY very useful when 
upgrading from 1.2 to 2.0

I suspect this script went away due to a bad git command.


>
>     ------------------------------------------------------------------------
>     *From:* Glyn Astill <glynastill at yahoo.co.uk>
>     *To:* "slony1-general at lists.slony.info"
>     <slony1-general at lists.slony.info>
>     *Sent:* Tuesday, 17 May 2011, 16:07
>     *Subject:* [Slony1-general] tools/slonikconfdump.sh
>
>     Has this been renamed? I'm assuming it's slony1_dump.sh
>
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general at lists.slony.info <mailto:Slony1-general at lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general


From glynastill at yahoo.co.uk  Wed May 18 06:35:26 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Wed, 18 May 2011 14:35:26 +0100 (BST)
Subject: [Slony1-general] tools/slonikconfdump.sh
In-Reply-To: <4DD2AC3B.7090700@ca.afilias.info>
References: <468217.2339.qm@web26008.mail.ukl.yahoo.com>
	<712583.94109.qm@web26001.mail.ukl.yahoo.com>
	<4DD2AC3B.7090700@ca.afilias.info>
Message-ID: <202865.31227.qm@web26006.mail.ukl.yahoo.com>

Aha, got it.? Thanks Steve.




>________________________________
>From: Steve Singer <ssinger at ca.afilias.info>
>To: Glyn Astill <glynastill at yahoo.co.uk>
>Cc: "slony1-general at lists.slony.info" <slony1-general at lists.slony.info>
>Sent: Tuesday, 17 May 2011, 18:11
>Subject: Re: [Slony1-general] tools/slonikconfdump.sh
>
>On 11-05-17 11:48 AM, Glyn Astill wrote:
>> Okay, I'm a little confised now.
>>
>> I can't find slonikconfdump.sh anywhere, and I'm pretty sure
>> slony1_dump.sh is no use to me for an upgrade from 1.2.x to 2.0.6
>>
>> I'm guessing all that script does is write out a slonik script for INIT
>> CLUSTER, STORE NODE, STORE PATH, CREATE SET, SET ADD xxx and then
>> SUBSCRIBE SET OMIT COPY?
>
>I *think* that script is in 2.0.3 and 2.0.4.? I am not sure exactly what 
>the script does (I haven't looked at it).? OMIT COPY very useful when 
>upgrading from 1.2 to 2.0
>
>I suspect this script went away due to a bad git command.
>
>
>>
>>? ?  ------------------------------------------------------------------------
>>? ?  *From:* Glyn Astill <glynastill at yahoo.co.uk>
>>? ?  *To:* "slony1-general at lists.slony.info"
>>? ?  <slony1-general at lists.slony.info>
>>? ?  *Sent:* Tuesday, 17 May 2011, 16:07
>>? ?  *Subject:* [Slony1-general] tools/slonikconfdump.sh
>>
>>? ?  Has this been renamed? I'm assuming it's slony1_dump.sh
>>
>>? ?  _______________________________________________
>>? ?  Slony1-general mailing list
>>? ? Slony1-general at lists.slony.info <mailto:Slony1-general at lists.slony.info>
>>? ? http://lists.slony.info/mailman/listinfo/slony1-general
>>
>>
>>
>>
>> _______________________________________________
>> Slony1-general mailing list
>> Slony1-general at lists.slony.info
>> http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110518/6103aafc/attachment.htm 

From glynastill at yahoo.co.uk  Thu May 19 07:15:12 2011
From: glynastill at yahoo.co.uk (Glyn Astill)
Date: Thu, 19 May 2011 15:15:12 +0100 (BST)
Subject: [Slony1-general] tools/slonikconfdump.sh
In-Reply-To: <202865.31227.qm@web26006.mail.ukl.yahoo.com>
References: <468217.2339.qm@web26008.mail.ukl.yahoo.com>
	<712583.94109.qm@web26001.mail.ukl.yahoo.com>
	<4DD2AC3B.7090700@ca.afilias.info>
	<202865.31227.qm@web26006.mail.ukl.yahoo.com>
Message-ID: <233155.33880.qm@web26005.mail.ukl.yahoo.com>

Attached is a slightly fixed version of the slonconfdump.sh script from the 2.0.4 with the following changes:

- Added event node parameter for "store node" on line 55
- Added missing closing quote from comment parameter on line 93
- Changed forward value to be YES/NO rather than boolean t/f on line 124


Would be nice if we could have this back in 2.0.x




>________________________________
>From: Glyn Astill <glynastill at yahoo.co.uk>
>To: Steve Singer <ssinger at ca.afilias.info>
>Cc: "slony1-general at lists.slony.info" <slony1-general at lists.slony.info>
>Sent: Wednesday, 18 May 2011, 14:35
>Subject: Re: [Slony1-general] tools/slonikconfdump.sh
>
>
>Aha, got it.? Thanks Steve.
>
>
>
>>________________________________
>>From: Steve Singer <ssinger at ca.afilias.info>
>>To: Glyn Astill <glynastill at yahoo.co.uk>
>>Cc: "slony1-general at lists.slony.info" <slony1-general at lists.slony.info>
>>Sent: Tuesday, 17 May 2011, 18:11
>>Subject: Re: [Slony1-general] tools/slonikconfdump.sh
>>
>>On 11-05-17 11:48 AM, Glyn Astill wrote:
>>> Okay, I'm a little confised now.
>>>
>>> I can't find slonikconfdump.sh anywhere, and I'm pretty sure
>>> slony1_dump.sh is no use to me for an upgrade from 1.2.x to 2.0.6
>>>
>>> I'm guessing all that script does is write out a slonik script for INIT
>>> CLUSTER, STORE NODE, STORE PATH, CREATE SET, SET ADD xxx and then
>>> SUBSCRIBE SET OMIT COPY?
>>
>>I *think* that script is in 2.0.3 and 2.0.4.? I am not sure exactly what 
>>the script does (I haven't looked at it).? OMIT COPY very useful when 
>>upgrading from 1.2 to 2.0
>>
>>I suspect this script went away due to a bad git command.
>>
>>
>>>
>>>? ?  ------------------------------------------------------------------------
>>>? ?  *From:* Glyn Astill <glynastill at yahoo.co.uk>
>>>? ?  *To:* "slony1-general at lists.slony.info"
>>>? ?  <slony1-general at lists.slony.info>
>>>? ?  *Sent:* Tuesday, 17 May 2011, 16:07
>>>? ?  *Subject:* [Slony1-general] tools/slonikconfdump.sh
>>>
>>>? ?  Has this been renamed? I'm assuming it's slony1_dump.sh
>>>
>>>? ?  _______________________________________________
>>>? ?  Slony1-general mailing list
>>>? ? Slony1-general at lists.slony.info <mailto:Slony1-general at lists.slony.info>
>>>? ? http://lists.slony.info/mailman/listinfo/slony1-general
>>>
>>>
>>>
>>>
>>> _______________________________________________
>>> Slony1-general mailing list
>>> Slony1-general at lists.slony.info
>>> http://lists.slony.info/mailman/listinfo/slony1-general
>>
>>
>>
>>
>_______________________________________________
>Slony1-general mailing list
>Slony1-general at lists.slony.info
>http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110519/93425fb4/attachment.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: slonikconfdump.sh
Type: application/x-sh
Size: 5296 bytes
Desc: not available
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20110519/93425fb4/attachment.sh 

From cbbrowne at afilias.info  Thu May 19 09:02:03 2011
From: cbbrowne at afilias.info (Christopher Browne)
Date: Thu, 19 May 2011 12:02:03 -0400
Subject: [Slony1-general] tools/slonikconfdump.sh
In-Reply-To: <233155.33880.qm@web26005.mail.ukl.yahoo.com>
References: <468217.2339.qm@web26008.mail.ukl.yahoo.com>
	<712583.94109.qm@web26001.mail.ukl.yahoo.com>
	<4DD2AC3B.7090700@ca.afilias.info>
	<202865.31227.qm@web26006.mail.ukl.yahoo.com>
	<233155.33880.qm@web26005.mail.ukl.yahoo.com>
Message-ID: <BANLkTi=RvydypCcT7p07dJh65n0q_ekOWA@mail.gmail.com>

On Thu, May 19, 2011 at 10:15 AM, Glyn Astill <glynastill at yahoo.co.uk> wrote:
> Attached is a slightly fixed version of the slonconfdump.sh script from the
> 2.0.4 with the following changes:
>
> - Added event node parameter for "store node" on line 55
> - Added missing closing quote from comment parameter on line 93
> - Changed forward value to be YES/NO rather than boolean t/f on line 124
>
> Would be nice if we could have this back in 2.0.x

I have set up a branch with this, and bug #214 to track this.
  https://github.com/cbbrowne/slony1-engine/tree/bug214

Jan suggests that the script needs more comments, so there should be
some non-zero amount of additional work applied to this before this
gets merged into 2.0, 2.1, and HEAD.

I haven't yet done any diffing between your submission and what was in
2.0, earlier; I definitely want to do that before merging anything in.

It's worth reviewing the docs at
<http://slony.info/documentation/2.0/appendix.html#ADMINSCRIPTS> to
make sure that expectations match reality.  (I'm in the "Patch
Reviewing" talk, and Steven Frost just recommended such :-))

From Ger.Timmens at adyen.com  Wed May 25 04:43:34 2011
From: Ger.Timmens at adyen.com (Ger Timmens)
Date: Wed, 25 May 2011 13:43:34 +0200
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300 s)
	for event selection
Message-ID: <4DDCEB66.6040609@adyen.com>

We are replicating a 500Gb database from postgresql 8.3 to
postgresql 9.0 using slony1-2.0.6.

We got the following error in our slon logs during the copy set of
one of the bigger tables:

CESTERROR  remoteListenThread_1: timeout (300 s) for event selection

The documentation:

    ERROR: remoteListenThread_%d: timeout for event selection

    This means that the listener thread (src/slon/remote_listener.c)
timed out when trying to determine what events were outstanding for it.

    This could occur because network connections broke, in which
case restarting the slon might help.

    Alternatively, this might occur because the slon for this node
has been broken for a long time, and there are an enormous number of
entries in sl_event on this or other nodes for the node to work
through, and it is taking more than slon_conf_remote_listen_timeout
seconds to run the query. In older versions of Slony-I, that
configuration parameter did not exist; the timeout was fixed at 300
seconds. In newer versions, you might increase that timeout in the
slon config file to a larger value so that it can continue to
completion. And then investigate why nobody was monitoring things
such that replication broke for such a long time...

Replication seems to continue fine after this error.
Is it save to continue ?
Or should we start from scratch ?
If so what do we have to do to prevent this error from happening again ?

Ger



From peter at 2ndquadrant.com  Wed May 25 05:03:24 2011
From: peter at 2ndquadrant.com (Peter Geoghegan)
Date: Wed, 25 May 2011 13:03:24 +0100
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300
 s) for event selection
In-Reply-To: <4DDCEB66.6040609@adyen.com>
References: <4DDCEB66.6040609@adyen.com>
Message-ID: <BANLkTinpE5um966qnMDfik8x1O6n3AJKnw@mail.gmail.com>

On 25 May 2011 12:43, Ger Timmens <Ger.Timmens at adyen.com> wrote:

> ? ?Alternatively, this might occur because the slon for this node
> has been broken for a long time, and there are an enormous number of
> entries in sl_event on this or other nodes for the node to work
> through, and it is taking more than slon_conf_remote_listen_timeout
> seconds to run the query. In older versions of Slony-I, that
> configuration parameter did not exist; the timeout was fixed at 300
> seconds. In newer versions, you might increase that timeout in the
> slon config file to a larger value so that it can continue to
> completion. And then investigate why nobody was monitoring things
> such that replication broke for such a long time...

If this is the case, then you can change the listen timeout to
something in the hundreds of seconds.

> Replication seems to continue fine after this error.
> Is it save to continue ?
> Or should we start from scratch ?
> If so what do we have to do to prevent this error from happening again ?

In general, Slony will not allow slaves to enter an inconsistent state.

Look at the "test_slony_state" Perl script which looks at various
parts of the configuration and verifies that things are running
correctly:

http://slony.info/documentation/2.0/monitoring.html

This should form part of your monitoring setup. It is common to
automatically run the script at regular intervals.

-- 
Peter Geoghegan ? ? ? http://www.2ndQuadrant.com/
PostgreSQL Development, 24x7 Support, Training and Services

From gtimmens at gmail.com  Wed May 25 04:41:08 2011
From: gtimmens at gmail.com (Ger Timmens)
Date: Wed, 25 May 2011 13:41:08 +0200
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300 s)
	for event selection
Message-ID: <BANLkTimOeYR4Q2Ft=aFDbr0pXrmMJW+Sew@mail.gmail.com>

We are replicating a 500Gb database from postgresql 8.3 to postgresql 9.0
using slony1-2.0.6.

We got the following error in our slon logs during the copy set of one of
the bigger tables:

CESTERROR  remoteListenThread_1: timeout (300 s) for event selection

The documentation:


   -

   ERROR: remoteListenThread_%d: timeout for event selection

   This means that the listener thread (src/slon/remote_listener.c) timed
   out when trying to determine what events were outstanding for it.

   This could occur because network connections broke, in which case
   restarting the slon
<http://www.slony.info/documentation/2.0/slon.html>might help.

   Alternatively, this might occur because the
slon<http://www.slony.info/documentation/2.0/slon.html>for this node
has been broken for a long time, and there are an enormous
   number of entries in sl_event on this or other nodes for the node to work
   through, and it is taking more than
slon_conf_remote_listen_timeout<http://www.slony.info/documentation/2.0/slon-config-interval.html#SLON-CONFIG-REMOTE-LISTEN-TIMEOUT>seconds
to run the query. In older versions of
   Slony-I, that configuration parameter did not exist; the timeout was
   fixed at 300 seconds. In newer versions, you might increase that timeout in
   the slon <http://www.slony.info/documentation/2.0/slon.html> config file
   to a larger value so that it can continue to completion. And then
   investigate why nobody was monitoring things such that replication broke for
   such a long time...

Replication seems to continue fine after this error. Is it save to continue
?
Or should we start from scratch ? If so what do we have to do to prevent
this error from happening again ?

Ger
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20110525/3e903cb7/attachment.htm 

From vivek at khera.org  Wed May 25 07:55:48 2011
From: vivek at khera.org (Vick Khera)
Date: Wed, 25 May 2011 10:55:48 -0400
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300
 s) for event selection
In-Reply-To: <BANLkTimOeYR4Q2Ft=aFDbr0pXrmMJW+Sew@mail.gmail.com>
References: <BANLkTimOeYR4Q2Ft=aFDbr0pXrmMJW+Sew@mail.gmail.com>
Message-ID: <BANLkTik_bF9BcPq=14L_bPi8AbL5Jx_7NA@mail.gmail.com>

On Wed, May 25, 2011 at 7:41 AM, Ger Timmens <gtimmens at gmail.com> wrote:
> Replication seems to continue fine after this error. Is it save to continue
> ?
> Or should we start from scratch ? If so what do we have to do to prevent
> this error from happening again ?
>

Slony does everything in transactions, so if something fails, it
restarts from a safe known state.  If it was able to continue after it
retried, then it was probably some transient error that you should
keep an eye out for, but should not worry too much about it having
caused data corruption.

From cbbrowne at afilias.info  Wed May 25 08:01:32 2011
From: cbbrowne at afilias.info (Christopher Browne)
Date: Wed, 25 May 2011 11:01:32 -0400
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300
 s) for event selection
In-Reply-To: <4DDCEB66.6040609@adyen.com>
References: <4DDCEB66.6040609@adyen.com>
Message-ID: <BANLkTi=3DhWhuEchxK+dOh8oEAb78ux4ng@mail.gmail.com>

On Wed, May 25, 2011 at 7:43 AM, Ger Timmens <Ger.Timmens at adyen.com> wrote:
> We are replicating a 500Gb database from postgresql 8.3 to
> postgresql 9.0 using slony1-2.0.6.
>
> We got the following error in our slon logs during the copy set of
> one of the bigger tables:
>
> CESTERROR ?remoteListenThread_1: timeout (300 s) for event selection
>
> The documentation:
>
> ? ?ERROR: remoteListenThread_%d: timeout for event selection
>
> ? ?This means that the listener thread (src/slon/remote_listener.c)
> timed out when trying to determine what events were outstanding for it.
>
> ? ?This could occur because network connections broke, in which
> case restarting the slon might help.
>
> ? ?Alternatively, this might occur because the slon for this node
> has been broken for a long time, and there are an enormous number of
> entries in sl_event on this or other nodes for the node to work
> through, and it is taking more than slon_conf_remote_listen_timeout
> seconds to run the query. In older versions of Slony-I, that
> configuration parameter did not exist; the timeout was fixed at 300
> seconds. In newer versions, you might increase that timeout in the
> slon config file to a larger value so that it can continue to
> completion. And then investigate why nobody was monitoring things
> such that replication broke for such a long time...
>
> Replication seems to continue fine after this error.
> Is it save to continue ?
> Or should we start from scratch ?
> If so what do we have to do to prevent this error from happening again ?

Well, the documentation indicates that this error tends to come up for
two reasons:

a) Because there was some sort of network glitch, or
b) Because some kind of misconfiguration left the cluster behind by
some stupendous number of events.

I think you encountered a), since the error didn't persist.

As such, I'd chalk it up to "network glitch," and while there may be
some value in doing a network investigation as to why such things
might be happening to you, it's not particularly important to
replication itself.  You shouldn't have any ongoing problem.

From dan at randomdan.homeip.net  Wed May 25 08:37:05 2011
From: dan at randomdan.homeip.net (Dan Goodliffe)
Date: Wed, 25 May 2011 16:37:05 +0100
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300
 s) for event selection
In-Reply-To: <BANLkTi=3DhWhuEchxK+dOh8oEAb78ux4ng@mail.gmail.com>
References: <4DDCEB66.6040609@adyen.com>
	<BANLkTi=3DhWhuEchxK+dOh8oEAb78ux4ng@mail.gmail.com>
Message-ID: <4DDD2221.404@randomdan.homeip.net>

I've never had an actual problem caused by this. I regularly just 
hibernate my laptop (which I replicate live data to) and when it wakes 
up again, it logs a network error, reconnects and carries on. Very 
reliable and safe in my experience.
If you're not doing something like that and it's over an "always on" 
connection, it might be indicative of some other problem, but slony1 
won't actually mind.
One thing to note however, I had trouble with 2.0.6 *not* reconnecting 
and carrying on, I would have to manually restart the slony1 service; 
2.0.5 however worked fine. I'm using 2.1beta something now, that also 
works fine.

On 25/05/11 16:01, Christopher Browne wrote:
> On Wed, May 25, 2011 at 7:43 AM, Ger Timmens<Ger.Timmens at adyen.com>  wrote:
>> We are replicating a 500Gb database from postgresql 8.3 to
>> postgresql 9.0 using slony1-2.0.6.
>>
>> We got the following error in our slon logs during the copy set of
>> one of the bigger tables:
>>
>> CESTERROR  remoteListenThread_1: timeout (300 s) for event selection
>>
>> The documentation:
>>
>>     ERROR: remoteListenThread_%d: timeout for event selection
>>
>>     This means that the listener thread (src/slon/remote_listener.c)
>> timed out when trying to determine what events were outstanding for it.
>>
>>     This could occur because network connections broke, in which
>> case restarting the slon might help.
>>
>>     Alternatively, this might occur because the slon for this node
>> has been broken for a long time, and there are an enormous number of
>> entries in sl_event on this or other nodes for the node to work
>> through, and it is taking more than slon_conf_remote_listen_timeout
>> seconds to run the query. In older versions of Slony-I, that
>> configuration parameter did not exist; the timeout was fixed at 300
>> seconds. In newer versions, you might increase that timeout in the
>> slon config file to a larger value so that it can continue to
>> completion. And then investigate why nobody was monitoring things
>> such that replication broke for such a long time...
>>
>> Replication seems to continue fine after this error.
>> Is it save to continue ?
>> Or should we start from scratch ?
>> If so what do we have to do to prevent this error from happening again ?
> Well, the documentation indicates that this error tends to come up for
> two reasons:
>
> a) Because there was some sort of network glitch, or
> b) Because some kind of misconfiguration left the cluster behind by
> some stupendous number of events.
>
> I think you encountered a), since the error didn't persist.
>
> As such, I'd chalk it up to "network glitch," and while there may be
> some value in doing a network investigation as to why such things
> might be happening to you, it's not particularly important to
> replication itself.  You shouldn't have any ongoing problem.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

From cbbrowne at afilias.info  Wed May 25 09:03:35 2011
From: cbbrowne at afilias.info (Christopher Browne)
Date: Wed, 25 May 2011 12:03:35 -0400
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout (300
 s) for event selection
In-Reply-To: <4DDD2221.404@randomdan.homeip.net>
References: <4DDCEB66.6040609@adyen.com>
	<BANLkTi=3DhWhuEchxK+dOh8oEAb78ux4ng@mail.gmail.com>
	<4DDD2221.404@randomdan.homeip.net>
Message-ID: <BANLkTincRRXB6iugZFK94e2MgCXJTS_sXw@mail.gmail.com>

On Wed, May 25, 2011 at 11:37 AM, Dan Goodliffe
<dan at randomdan.homeip.net> wrote:
> I've never had an actual problem caused by this. I regularly just
> hibernate my laptop (which I replicate live data to) and when it wakes
> up again, it logs a network error, reconnects and carries on. Very
> reliable and safe in my experience.

It's possible for you to have "problem b)" for this...

If your laptop was offline for a Remarkably Long Time, and there were
tens of thousands of events logged, in the interim, then the 300
second timeout is liable to be a problem.

The next time the laptop reconnects, it tries to pull in the list of
newer events, and if it takes 15 minutes for that query to pull the
list of events, you'll encounter this error, and it's liable to occur
repeatedly, because the retry will, again, take considerably more than
300 seconds.

That can be remedied by, at least temporarily, increasing the slon
configuration parameter, remote_listen_timeout.

But as has been commented, the work Slony does always takes place
inside the context of a transaction, so that in the vast majority of
cases, it's reasonable to expect that "kill slon, kill all the DB
connections, restart slon" will drop any half-baked updates, and
*cleanly* retry things in the scope of nice, fresh, new transactions.

In the early days, the solution to a whole lot of problems was "kill
off the slons and let them restart," and that wouldn't ever corrupt
data.

In any case, I think the existing documentation is pretty valid.  It
indicates the most likely causes, points to reasonable diagnoses, and
to the configuration fiddling that *might* be needful if the cause was
the more serious one.

From ssinger at ca.afilias.info  Wed May 25 14:33:38 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 25 May 2011 17:33:38 -0400
Subject: [Slony1-general] Slony 2.0.7 rc1 released
Message-ID: <4DDD75B2.2080504@ca.afilias.info>


Slony-I 2.0.7 rc1 has been released and is available at

http://www.slony.info/downloads/2.0/source/slony1-2.0.7.rc1-docs.tar.bz2
http://www.slony.info/downloads/2.0/source/slony1-2.0.7.rc1.tar.bz2


This is a minor update to the slony 2.0 stream that includes the 
following changes.


- Fix for bug where slon was not properly detecting connection failures 
   when receiving events from the remote listener.

- Bug #193 - vac_count not being reset to 0 (bug between 1.2 and 2.0 in
   restructure of cleanup thread), so vacuums were being done every time

- Bug #195 - change slon_quote_* functions to IMMUTABLE

- Bug #204 - Fix issue with FAILOVER to a non-direct subscriber
introduced in 2.0.5

- Support for building with Visual Studio on Win32

- Bug # 214 - tools/slonikconfdump.sh was added back in


An official 2.0.7 release is expected once we get some positive feedback 
from the packagers.


From Ger.Timmens at adyen.com  Wed May 25 14:39:13 2011
From: Ger.Timmens at adyen.com (Ger Timmens)
Date: Wed, 25 May 2011 23:39:13 +0200
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout,
	(300 s) for event selection
In-Reply-To: <mailman.109.1306339419.6921.slony1-general@lists.slony.info>
References: <mailman.109.1306339419.6921.slony1-general@lists.slony.info>
Message-ID: <4DDD7701.9030407@adyen.com>


> In the early days, the solution to a whole lot of problems was "kill
> off the slons and let them restart," and that wouldn't ever corrupt
> data.

Correct, however not during a copy set, if I'm right. In that
case a restart of the slon process would start copying the set
from the start again..... Not a big deal for smaller sets, but
if you're replicating multiple Gigabytes.....


Ger

From JanWieck at Yahoo.com  Wed May 25 18:06:38 2011
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Wed, 25 May 2011 21:06:38 -0400
Subject: [Slony1-general] CESTERROR remoteListenThread_1: timeout,
 (300 s) for event selection
In-Reply-To: <4DDD7701.9030407@adyen.com>
References: <mailman.109.1306339419.6921.slony1-general@lists.slony.info>
	<4DDD7701.9030407@adyen.com>
Message-ID: <4DDDA79E.2060808@Yahoo.com>

On 5/25/2011 5:39 PM, Ger Timmens wrote:
>
>>  In the early days, the solution to a whole lot of problems was "kill
>>  off the slons and let them restart," and that wouldn't ever corrupt
>>  data.
>
> Correct, however not during a copy set, if I'm right. In that
> case a restart of the slon process would start copying the set
> from the start again..... Not a big deal for smaller sets, but
> if you're replicating multiple Gigabytes.....

Makes no difference with respect to data integrity. Yes, it has to start 
over from scratch, but if you think there is a reason to kill your slon 
processes over and over again, you need to find out what exactly is 
wrong with either your network, you setup or yourself.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From mark at mark.mielke.cc  Thu May 26 00:34:40 2011
From: mark at mark.mielke.cc (Mark Mielke)
Date: Thu, 26 May 2011 03:34:40 -0400
Subject: [Slony1-general] Support for EnterpriseDB version string?
Message-ID: <4DDE0290.4020603@mark.mielke.cc>

Hi all:

I've attached a patch against Slony-I 2.0.4 that we are currently using 
to allow our PostgreSQL 8.4.8 + Slony-I 2.0.4 work properly with 
EnterpriseDB 8.4.7.20 + EnterpriseDB's version of Slony-I 2.0.4. Please 
take a look and see whether you agree that this should be incorporated 
up stream.

It's a very trivial patch - but I guess it implies that Slony-I 
introduces recognition of EnterpriseDB's build of PostgreSQL more 
officially?

I had a similar patch against Slony-I 2.0.6 that I can provide if this 
patch file isn't good enough - but due to EnterpriseDB still 
distributing Slony-I 2.0.4, we're version locked on Slony-I 2.0.4 for now...

Thanks!

-- 
Mark Mielke<mark at mielke.cc>

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: slony1-2.0.4-ciena1.patch
Url: http://lists.slony.info/pipermail/slony1-general/attachments/20110526/42419c3c/attachment.txt 

From greg at endpoint.com  Thu May 26 03:04:06 2011
From: greg at endpoint.com (Greg Sabino Mullane)
Date: Thu, 26 May 2011 06:04:06 -0400
Subject: [Slony1-general] Support for EnterpriseDB version string?
In-Reply-To: <4DDE0290.4020603@mark.mielke.cc>
References: <4DDE0290.4020603@mark.mielke.cc>
Message-ID: <CABF91A0-A47D-4548-9C1B-C8BB0CDBD196@endpoint.com>

Probably better to simply grab the first three numbers and not worry about the name.

-- 
Greg Sabino Mullane
Via iPhone

On May 26, 2011, at 3:34 AM, Mark Mielke <mark at mark.mielke.cc> wrote:

> Hi all:
> 
> I've attached a patch against Slony-I 2.0.4 that we are currently using to 

From JanWieck at Yahoo.com  Fri May 27 06:48:19 2011
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Fri, 27 May 2011 09:48:19 -0400
Subject: [Slony1-general] Support for EnterpriseDB version string?
In-Reply-To: <CABF91A0-A47D-4548-9C1B-C8BB0CDBD196@endpoint.com>
References: <4DDE0290.4020603@mark.mielke.cc>
	<CABF91A0-A47D-4548-9C1B-C8BB0CDBD196@endpoint.com>
Message-ID: <4DDFABA3.2080403@Yahoo.com>

On 5/26/2011 6:04 AM, Greg Sabino Mullane wrote:
> Probably better to simply grab the first three numbers and not worry about the name.
>

I would agree with that if we were not talking about changing a stable 
release. Even though 2.1 is currently in Beta I would be willing to 
discuss making such a change there. But not for 2.0.


Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From ssinger at ca.afilias.info  Fri May 27 07:45:28 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Fri, 27 May 2011 10:45:28 -0400
Subject: [Slony1-general] Slony-I 2.1.0 beta 2 released
Message-ID: <4DDFB908.3000404@ca.afilias.info>

The second beta release for Slony-I 2.1.0 is now available at

http://www.slony.info/downloads/2.1/source/slony1-2.1.0.b2.tar.bz2
http://www.slony.info/downloads/2.1/source/slony1-2.1.0.b2-docs.tar.bz2

Changes from the first beta include:

- Bug #204 -  Upgrade from 2.0.x fails under PostgreSQL 8.3
- Bug 205  - Upgrade fails from 2.0.0, return type from cloneNode changes
- Bug 206  - Do not perform an accidental rollback in a try block
- Bug 208  - Fixing issues with bulk adding of tables.
- Bug 209  - Default table ID problem
- Bug 210  - merge set should wait for both sets to be subscribed
              before submitting the merge event.
- Bug 211  - Modify the altperl tools so they don't enclose statements
              that wait for events inside of a 'try' block.

Slony 2.1 includes over 20 bug fixes and feature changes from the 2.0 
series including: performance improvements for behind nodes, enhanced 
monitoring, bulk adding of tables and automatic wait for.

See 
http://git.postgresql.org/gitweb?p=slony1-engine.git;a=blob_plain;f=RELEASE;h=908796f9bf40efdd8f0d89b6f966c150d7b0d2e8;hb=b2e10ea9eed60bddad5c2e8fbf3f1ae2cf02e080 
for a complete list of changes from the last 2.0 release.

  Users testing beta2 on Microsoft Windows should disable the monitor 
threads (monitor_threads=false)

Test reports of both successful tests and issues are encouraged.

From ssinger at ca.afilias.info  Mon May 30 11:45:36 2011
From: ssinger at ca.afilias.info (Steve Singer)
Date: Mon, 30 May 2011 14:45:36 -0400
Subject: [Slony1-general] Changing primary keys with Slony 2.0.x
Message-ID: <4DE3E5D0.6050703@ca.afilias.info>

A few of the discussions with developers and users of other replication 
systems at PGCon left me a bit confused about how some things work in 
slony.  It turns changing a primary key (or unique index) of a 
replicated table i Slony 2.0.x (where x <= 6) doesn't work very well.

See
http://www.slony.info/bugzilla/show_bug.cgi?id=217  for more details.

If you are running Slony 2.0.x (x<=6) and have reason to:

a) Add columns to the primary key/unique index that slony uses
b) Drop columns from the primary key/unique index that slony uses
c) Drop any columns from a table that come before the last column 
involved in the primary key/unqiue index.

Case c is best explained by an example:

create table foo (
  a int4,
  b int4,
  c int4 primary key,
  d int4 );

If foo is a table replicated by slony and at some later point you drop 
column b then you will encounter this issue.


Clusters that encounter this issue can have DELETE or UPDATE statements 
improperly replicated to slaves.

A query that can detect if your database suffers from this issue has 
been attached to the bug along with
a function to reconfigure slony to recognize the new primary key has 
been attached to that bug.


In future versions of Slony we are considering changing EXECUTE SCRIPT 
to either

a) After the script has been executed, check ALL replicated tables for 
this condition and reconfigure those tables.  This will require EXECUTE 
SCRIPT obtaining an exclusive lock on these tables.

b) Have EXECUTE SCRIPT *only* fix the tables that the SQL script 
obtained an exclusive lock on.

Option (b)  has the benefit of fixing any tables with key modifications 
done by the current script without locking any unexpected tables.  The 
downside is that if your cluster had problem tables before (due to DDL 
done outside of execute script that didn't call the recreate trigger 
function) then you will still have that problem after calling an 
unrelated execute script.


I would appreciate feedback on which of option (a) or option (b) is 
preferred.


Steve

From stephane.schildknecht at postgresql.fr  Tue May 31 00:37:19 2011
From: stephane.schildknecht at postgresql.fr (=?ISO-8859-15?Q?=22St=E9phane_A=2E_Schildknecht=22?=)
Date: Tue, 31 May 2011 09:37:19 +0200
Subject: [Slony1-general] Changing primary keys with Slony 2.0.x
In-Reply-To: <4DE3E5D0.6050703@ca.afilias.info>
References: <4DE3E5D0.6050703@ca.afilias.info>
Message-ID: <4DE49AAF.9090200@postgresql.fr>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Le 30/05/2011 20:45, Steve Singer a ?crit :
> A few of the discussions with developers and users of other replication 
> systems at PGCon left me a bit confused about how some things work in 
> slony.  It turns changing a primary key (or unique index) of a 
> replicated table i Slony 2.0.x (where x <= 6) doesn't work very well.
> 
> See
> http://www.slony.info/bugzilla/show_bug.cgi?id=217  for more details.
> 
> If you are running Slony 2.0.x (x<=6) and have reason to:
> 
> a) Add columns to the primary key/unique index that slony uses
> b) Drop columns from the primary key/unique index that slony uses
> c) Drop any columns from a table that come before the last column 
> involved in the primary key/unqiue index.
> 
> Case c is best explained by an example:
> 
> create table foo (
>   a int4,
>   b int4,
>   c int4 primary key,
>   d int4 );
> 
> If foo is a table replicated by slony and at some later point you drop 
> column b then you will encounter this issue.
> 
> 
> Clusters that encounter this issue can have DELETE or UPDATE statements 
> improperly replicated to slaves.
> 
> A query that can detect if your database suffers from this issue has 
> been attached to the bug along with
> a function to reconfigure slony to recognize the new primary key has 
> been attached to that bug.
> 
> 
> In future versions of Slony we are considering changing EXECUTE SCRIPT 
> to either
> 
> a) After the script has been executed, check ALL replicated tables for 
> this condition and reconfigure those tables.  This will require EXECUTE 
> SCRIPT obtaining an exclusive lock on these tables.
> 
> b) Have EXECUTE SCRIPT *only* fix the tables that the SQL script 
> obtained an exclusive lock on.
> 
> Option (b)  has the benefit of fixing any tables with key modifications 
> done by the current script without locking any unexpected tables.  The 
> downside is that if your cluster had problem tables before (due to DDL 
> done outside of execute script that didn't call the recreate trigger 
> function) then you will still have that problem after calling an 
> unrelated execute script.
> 
> 
> I would appreciate feedback on which of option (a) or option (b) is 
> preferred.

I'd say option option b is more valuable, as it does not have extra locking
side-effect.

Is the downside of this option really a downside, as it has always been
explained that all DDL has to be passed through an EXECUTE SCRIPT?
I'm not sure you have to take that case into account. Or you'll have to adress
also every mistake that could ever be done by the operator.

BTW, we could think of a REPAIR_ALL_MISTAKE_I_HAVE_DONE_SO_FAR procedure ;-)
which could reconfigure every table. But that should be a one shot maintenance
script, I think.

- -- 
St?phane Schildknecht
Loxodata
Contact r?gional PostgreSQL

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Using GnuPG with Mozilla - http://enigmail.mozdev.org/

iEYEARECAAYFAk3kmq8ACgkQA+REPKWGI0GZTQCeIesdTRtrgnt/bLfLBtz8TLLi
C7UAnjziIhCFtLzznNozQGzqya813y6U
=hU76
-----END PGP SIGNATURE-----

