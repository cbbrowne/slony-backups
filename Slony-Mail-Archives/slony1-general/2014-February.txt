From david at fetter.org  Fri Feb  7 16:35:56 2014
From: david at fetter.org (David Fetter)
Date: Fri, 7 Feb 2014 16:35:56 -0800
Subject: [Slony1-general] Adding triggers to tables in a replication set
Message-ID: <20140208003556.GA23458@fetter.org>

Folks,

I'm about to embark on a new thing: auditing.  In order to get this
auditing actually done, I'll be using an extension I've written
https://github.com/disqus/pg_audit

The extension generates some triggers on tables in an extant
replication set, which triggers should fire on the origin.  What
I'd like to figure out is how to add the auditing stuff on replicas,
as the triggers should not fire there, or at least not until same gets
promoted to origin.

Any tips as to how generally to add triggers across an existing
replication set?

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From steve at ssinger.info  Sat Feb  8 09:23:55 2014
From: steve at ssinger.info (Steve Singer)
Date: Sat, 8 Feb 2014 12:23:55 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <20140208003556.GA23458@fetter.org>
References: <20140208003556.GA23458@fetter.org>
Message-ID: <BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>

On Fri, 7 Feb 2014, David Fetter wrote:

> Folks,
>
> I'm about to embark on a new thing: auditing.  In order to get this
> auditing actually done, I'll be using an extension I've written
> https://github.com/disqus/pg_audit
>
> The extension generates some triggers on tables in an extant
> replication set, which triggers should fire on the origin.  What
> I'd like to figure out is how to add the auditing stuff on replicas,
> as the triggers should not fire there, or at least not until same gets
> promoted to origin.
>
> Any tips as to how generally to add triggers across an existing
> replication set?
>

Just add the triggers to your tables as you normally would on all nodes. By 
default the triggers will fire on the origin but not fire on the replica when 
session_replication_role is replica (which it is when slon pushes stuff).

http://www.slony.info/documentation/2.2/triggers.html




> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From vivek at khera.org  Tue Feb 11 17:46:26 2014
From: vivek at khera.org (Vick Khera)
Date: Tue, 11 Feb 2014 20:46:26 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
Message-ID: <CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>

On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info> wrote:

> Just add the triggers to your tables as you normally would on all nodes.


Which is to say using slonik to run the SQL script that will add them.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140211/751d6a9d/attachment.htm 

From david at fetter.org  Tue Feb 11 19:27:06 2014
From: david at fetter.org (David Fetter)
Date: Tue, 11 Feb 2014 19:27:06 -0800
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
Message-ID: <20140212032706.GA18036@fetter.org>

On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
> On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info> wrote:
> 
> > Just add the triggers to your tables as you normally would on all nodes.
> 
> Which is to say using slonik to run the SQL script that will add them.

Thanks for clarifying that.  It's kinda important :)

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From ssinger at ca.afilias.info  Tue Feb 11 19:37:52 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 11 Feb 2014 22:37:52 -0500
Subject: [Slony1-general] Slony 2.2.2  released
Message-ID: <52FAEC90.4000109@ca.afilias.info>

The slony team is pleased to announce a bug-fix release for the 2.2
version of the slony replication system.  Slony 2.2.2
addresses a number
of bugs including:


     Bug 327 - Fix invalid free() in the logApply trigger

     Include server include paths on --with-pgport builds for slonik

Bug 327 can cause replication to not work properly for some users of 
slony 2.2.0 and 2.2.1.

Users of Slony 2.2.0  or 2.2.1 are encouraged to upgrade.  Users who are 
upgrading
from versions earlier than 2.2.0 should upgrade to version 2.2.2 instead
of 2.2.0

You can download Slony 2.2.2 at the following
http://lists.slony.info/downloads/2.2/source/slony1-2.2.2.tar.bz2

From steve at ssinger.info  Wed Feb 12 04:17:51 2014
From: steve at ssinger.info (Steve Singer)
Date: Wed, 12 Feb 2014 07:17:51 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <20140212032706.GA18036@fetter.org>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
	<20140212032706.GA18036@fetter.org>
Message-ID: <BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>

On Tue, 11 Feb 2014, David Fetter wrote:

> On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
>> On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info> wrote:
>>
>>> Just add the triggers to your tables as you normally would on all nodes.
>>
>> Which is to say using slonik to run the SQL script that will add them.
>
> Thanks for clarifying that.  It's kinda important :)

You can add the triggers via slonik EXECUTE SCRIPT, but in most cases you 
can also add the triggers to all nodes directly with psql.

With the psql method the triggers get added to all nodes immedately, even if 
the node is behind in replication.  With a origin only trigger this 
shouldn't make a difference.  If the trigger does stuff on replicas then 
this is more of an issue.



>
> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
>


From david at fetter.org  Wed Feb 12 06:51:34 2014
From: david at fetter.org (David Fetter)
Date: Wed, 12 Feb 2014 06:51:34 -0800
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
	<20140212032706.GA18036@fetter.org>
	<BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>
Message-ID: <20140212145134.GD18036@fetter.org>

On Wed, Feb 12, 2014 at 07:17:51AM -0500, Steve Singer wrote:
> On Tue, 11 Feb 2014, David Fetter wrote:
> 
> >On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
> >>On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info>
> >>wrote:
> >>
> >>>Just add the triggers to your tables as you normally would on all
> >>>nodes.
> >>
> >>Which is to say using slonik to run the SQL script that will add
> >>them.
> >
> >Thanks for clarifying that.  It's kinda important :)
> 
> You can add the triggers via slonik EXECUTE SCRIPT, but in most
> cases you can also add the triggers to all nodes directly with psql.

In what cases can't I do this?  Given our volume, I'm not a huge fan
of the size of the lock EXECUTE SCRIPT might take.

> With the psql method the triggers get added to all nodes immedately,
> even if the node is behind in replication.  With a origin only
> trigger this shouldn't make a difference.  If the trigger does stuff
> on replicas then this is more of an issue.

The trigger only does stuff on a replica if that replica takes over as
origin.

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From efraindector at motumweb.com  Wed Feb 12 11:50:58 2014
From: efraindector at motumweb.com (=?ISO-8859-1?Q?Efra=EDn_D=E9ctor?=)
Date: Wed, 12 Feb 2014 13:50:58 -0600
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver are
 not found in the includeserverdir.
Message-ID: <52FBD0A2.7030501@motumweb.com>

Hello.

I am trying to setup Slony 2.2.2 on a FreeBSD 10 Release box running 
Postgresql 9.2.6. However I cant compile Slony because I get the 
following error with the command ./configure:

configure: error: Headers for libpqserver are not found in the 
includeserverdir.
     This is the path to postgres.h. Please specify the includeserverdir 
with
     --with-pgincludeserverdir=<dir>

The directory in question is /usr/local/include/postgresql/server I 
checked and the file postgres.h is available. Using 
--with-pgincludeserverdir doesn't help because the error still shows.

With Slony 2.1.4 I can make ./configure without errors.

Can you guys please point me in the right direction?.

Thank you very much in advance.



From ssinger at ca.afilias.info  Wed Feb 12 13:10:02 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 12 Feb 2014 16:10:02 -0500
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBD0A2.7030501@motumweb.com>
References: <52FBD0A2.7030501@motumweb.com>
Message-ID: <52FBE32A.3080200@ca.afilias.info>

On 02/12/2014 02:50 PM, Efra?n D?ctor wrote:
> Hello.

Does ./configure --with-pgconfigdir= /your_pgconfig_dir_directory

make things better?



>
> I am trying to setup Slony 2.2.2 on a FreeBSD 10 Release box running
> Postgresql 9.2.6. However I cant compile Slony because I get the
> following error with the command ./configure:
>
> configure: error: Headers for libpqserver are not found in the
> includeserverdir.
>       This is the path to postgres.h. Please specify the includeserverdir
> with
>       --with-pgincludeserverdir=<dir>
>
> The directory in question is /usr/local/include/postgresql/server I
> checked and the file postgres.h is available. Using
> --with-pgincludeserverdir doesn't help because the error still shows.
>
> With Slony 2.1.4 I can make ./configure without errors.
>
> Can you guys please point me in the right direction?.
>
> Thank you very much in advance.
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From efraindector at motumweb.com  Wed Feb 12 13:37:24 2014
From: efraindector at motumweb.com (=?ISO-8859-1?Q?Efra=EDn_D=E9ctor?=)
Date: Wed, 12 Feb 2014 15:37:24 -0600
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBE32A.3080200@ca.afilias.info>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
Message-ID: <52FBE994.8020307@motumweb.com>

El 12/02/2014 03:10 p.m., Steve Singer escribi?:
>
> Does ./configure --with-pgconfigdir= /your_pgconfig_dir_directory
>
> make things better?
>

Hello.

I just tried it and it didn't help.

Thank you veru much.

From matthewh at telenav.com  Wed Feb 12 15:14:17 2014
From: matthewh at telenav.com (Hanselman, Matthew)
Date: Wed, 12 Feb 2014 23:14:17 +0000
Subject: [Slony1-general] How should I design this: DDL access segmentation?
Message-ID: <4196195759a441f3b99220561a68cc1d@BN1PR07MB150.namprd07.prod.outlook.com>

How should I design this, if it's possible?

The high-level requirement is: we need a way to isolate DDL changes and control them more tightly than data changes. We have a source database where we trust devs to alter any & all data they want real-time, but we need to enforce that DDL changes can't go live without a DBA getting involved.

This would meet our needs, if it worked: set up two Slony clusters. Given a path of nodes A -> B -> C, you could have a cluster that replicates A -> B, and another that would replicate B -> C. If you trigger a DDL change on A, it'll stop at B and require access to the slonik on B to trigger the DDL change to C.

I tried to set this up, though, and it didn't work. The initial copy of data would propagate to node C, but any further changes to data on A wouldn't propagate (it'd stop at B).

Does our (admittedly obtuse) requirement make sense? Can you think of a way to meet that requirement with Slony?

Thanks!

- Matt

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140212/c4e9ec90/attachment.htm 

From ahodgson at simkin.ca  Wed Feb 12 15:40:51 2014
From: ahodgson at simkin.ca (Alan Hodgson)
Date: Wed, 12 Feb 2014 15:40:51 -0800
Subject: [Slony1-general] How should I design this: DDL access
	segmentation?
In-Reply-To: <4196195759a441f3b99220561a68cc1d@BN1PR07MB150.namprd07.prod.outlook.com>
References: <4196195759a441f3b99220561a68cc1d@BN1PR07MB150.namprd07.prod.outlook.com>
Message-ID: <3025953.pHS84I1J46@skynet.simkin.ca>

On Wednesday, February 12, 2014 11:14:17 PM Hanselman, Matthew wrote:
> The high-level requirement is: we need a way to isolate DDL changes and
> control them more tightly than data changes. 

Well, the right answer is, don't give devs the privileges needed to make DDL 
changes. 

If you're using Slony you probably need to do this anyway just to prevent them 
from making DDL changes directly, and to keep them from running ORM 
migrations. If your devs do currently have this access, you should check the 
schema differences between the master and slaves and find out what all they've 
already broken.

But yeah I don't think Slony will do what you're asking, regardless. You can't 
make data and schema changes happen out of order.

From ssinger at ca.afilias.info  Wed Feb 12 19:36:54 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 12 Feb 2014 22:36:54 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <20140212145134.GD18036@fetter.org>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
	<20140212032706.GA18036@fetter.org>
	<BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>
	<20140212145134.GD18036@fetter.org>
Message-ID: <52FC3DD6.4000901@ca.afilias.info>

On 02/12/2014 09:51 AM, David Fetter wrote:
> On Wed, Feb 12, 2014 at 07:17:51AM -0500, Steve Singer wrote:
>> On Tue, 11 Feb 2014, David Fetter wrote:
>>
>>> On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
>>>> On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info>
>>>> wrote:
>>>>
>>>>> Just add the triggers to your tables as you normally would on all
>>>>> nodes.
>>>>
>>>> Which is to say using slonik to run the SQL script that will add
>>>> them.
>>>
>>> Thanks for clarifying that.  It's kinda important :)
>>
>> You can add the triggers via slonik EXECUTE SCRIPT, but in most
>> cases you can also add the triggers to all nodes directly with psql.
>
> In what cases can't I do this?  Given our volume, I'm not a huge fan
> of the size of the lock EXECUTE SCRIPT might take.
>

I don't think modern execute script (ie in 2.1 or 2.2) takes out much 
locking other than what your DDL is already doing.  (I think adding the 
trigger to a table requires a heavy lock on that table anyway)

If the trigger is configured to run on a replica then you can't do it 
with psql on a live system becaues the trigger might get added (and run) 
at a different point in the replication stream on different replicas vs 
the origin (unless your doing something to prevent this, like stopping 
inserts on your table by shutting down stuff)

In cases where the trigger is disabled on the replica then the only time 
I think not using execute script would be a problem is when you have 
other DDL changes pending via execute script

Ie if you create the table via EXECUTE SCRIPT, but then use psql to add 
the the trigger to the table on a replica BEFORE the execute script that 
adds the table runs on that replica you will have a problem.



>> With the psql method the triggers get added to all nodes immedately,
>> even if the node is behind in replication.  With a origin only
>> trigger this shouldn't make a difference.  If the trigger does stuff
>> on replicas then this is more of an issue.
>
> The trigger only does stuff on a replica if that replica takes over as
> origin.
>
> Cheers,
> David.
>


From sandeep.thakkar at enterprisedb.com  Thu Feb 13 04:31:49 2014
From: sandeep.thakkar at enterprisedb.com (Sandeep Thakkar)
Date: Thu, 13 Feb 2014 18:01:49 +0530
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBE994.8020307@motumweb.com>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
	<52FBE994.8020307@motumweb.com>
Message-ID: <CANFyU94Ryh9EztjJtuQ17rz0Bz11_XAp++1nKc6KWWZqZGHaqg@mail.gmail.com>

I had built Slony 2.2.1 with pgport and the following patch had worked fine.

--
diff --git a/src/slonik/Makefile b/src/slonik/Makefile
index 9929882..54c8792 100644
--- a/src/slonik/Makefile
+++ b/src/slonik/Makefile
@@ -10,8 +10,11 @@ slony_subdir = src/slonik
 slony_top_builddir = ../..
 SLFILEDESC="Slony command interpreter"
 include $(slony_top_builddir)/Makefile.global
+ifeq ($(HAVE_PGPORT),1)
+CPPFLAGS:=$(CPPFLAGS_SERVER) $(CPPFLAGS_CLIENT)
+else
 CPPFLAGS:=$(CPPFLAGS_CLIENT)
-
+endif
 ifeq ($(PORTNAME), aix)
   CFLAGS += -D_LARGE_FILES
 endif
--
1.7.10.4
---------------


On Thu, Feb 13, 2014 at 3:07 AM, Efra?n D?ctor <efraindector at motumweb.com>wrote:

> El 12/02/2014 03:10 p.m., Steve Singer escribi?:
> >
> > Does ./configure --with-pgconfigdir= /your_pgconfig_dir_directory
> >
> > make things better?
> >
>
> Hello.
>
> I just tried it and it didn't help.
>
> Thank you veru much.
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>



-- 
Sandeep Thakkar



Phone: +91.20.30589505

Website: www.enterprisedb.com
EnterpriseDB Blog: http://blogs.enterprisedb.com/
Follow us on Twitter: http://www.twitter.com/enterprisedb
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140213/eb6c48f5/attachment-0001.htm 

From ssinger at ca.afilias.info  Thu Feb 13 05:24:49 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 13 Feb 2014 08:24:49 -0500
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBE994.8020307@motumweb.com>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
	<52FBE994.8020307@motumweb.com>
Message-ID: <52FCC7A1.1010500@ca.afilias.info>

On 02/12/2014 04:37 PM, Efra?n D?ctor wrote:
> El 12/02/2014 03:10 p.m., Steve Singer escribi?:
>>
>> Does ./configure --with-pgconfigdir= /your_pgconfig_dir_directory
>>
>> make things better?

What does pg_config say about the location of

INCLUDEDIR-SERVER
INCLUDEDIR

In config.log what is the gcc command line that is failing ?


>>
>
> Hello.
>
> I just tried it and it didn't help.
>
> Thank you veru much.


From efraindector at motumweb.com  Thu Feb 13 07:04:16 2014
From: efraindector at motumweb.com (=?ISO-8859-1?Q?Efra=EDn_D=E9ctor?=)
Date: Thu, 13 Feb 2014 09:04:16 -0600
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FCC7A1.1010500@ca.afilias.info>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
	<52FBE994.8020307@motumweb.com> <52FCC7A1.1010500@ca.afilias.info>
Message-ID: <52FCDEF0.60205@motumweb.com>


El 13/02/2014 07:24 a.m., Steve Singer escribi?:
> What does pg_config say about the location of
>
> INCLUDEDIR-SERVER
> INCLUDEDIR
>
> In config.log what is the gcc command line that is failing ?

INCLUDEDIR = /usr/local/include
INCLUDEDIR-SERVER = /usr/local/include/postgresql/server

You can see config.log here http://pastebin.com/uiZw2Qit

Thank you.





From ssinger at ca.afilias.info  Thu Feb 13 07:09:26 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 13 Feb 2014 10:09:26 -0500
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FCDEF0.60205@motumweb.com>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
	<52FBE994.8020307@motumweb.com> <52FCC7A1.1010500@ca.afilias.info>
	<52FCDEF0.60205@motumweb.com>
Message-ID: <52FCE026.5070003@ca.afilias.info>

On 02/13/2014 10:04 AM, Efra?n D?ctor wrote:
>
> El 13/02/2014 07:24 a.m., Steve Singer escribi?:
>> What does pg_config say about the location of
>>
>> INCLUDEDIR-SERVER
>> INCLUDEDIR
>>
>> In config.log what is the gcc command line that is failing ?
>
> INCLUDEDIR = /usr/local/include
> INCLUDEDIR-SERVER = /usr/local/include/postgresql/server
>
> You can see config.log here http://pastebin.com/uiZw2Qit
>


Your actual error is

In file included from conftest.c:48:
In file included from /usr/local/include/postgresql/server/postgres.h:47:
/usr/local/include/postgresql/server/c.h:96:10: fatal error: 'libintl.h' 
file not found
#include <libintl.h>

You need to install libintl headers

> Thank you.
>
>
>
>


From efraindector at motumweb.com  Thu Feb 13 07:21:10 2014
From: efraindector at motumweb.com (=?ISO-8859-1?Q?Efra=EDn_D=E9ctor?=)
Date: Thu, 13 Feb 2014 09:21:10 -0600
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FCE026.5070003@ca.afilias.info>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
	<52FBE994.8020307@motumweb.com> <52FCC7A1.1010500@ca.afilias.info>
	<52FCDEF0.60205@motumweb.com> <52FCE026.5070003@ca.afilias.info>
Message-ID: <52FCE2E6.2040308@motumweb.com>


El 13/02/2014 09:09 a.m., Steve Singer escribi?:
> Your actual error is
>
> In file included from conftest.c:48:
> In file included from /usr/local/include/postgresql/server/postgres.h:47:
> /usr/local/include/postgresql/server/c.h:96:10: fatal error: 
> 'libintl.h' file not found
> #include <libintl.h>
>
> You need to install libintl headers
>

Hello.

Thank you very much for your help.

Slony 2.1.4 doesn't need libintl headers?

Thanks


From tmblue at gmail.com  Thu Feb 13 14:15:18 2014
From: tmblue at gmail.com (Tory M Blue)
Date: Thu, 13 Feb 2014 14:15:18 -0800
Subject: [Slony1-general] Wide Area Replication, Add Set, without index?
Message-ID: <CAEaSS0Z_Lvfy8t_f8q=0VH4=oqMH7RZLVpQKFijXvuS_uRFstQ@mail.gmail.com>

I had some hints given to me in the past, but no real understanding to how
it would be achieved so asking again.

I'm turning up a DR site and my past tests have failed due to some network
timeout, since the index creation of some of the tables would take a long
time, and thus no packets were being exchanged between the master and the
slave and the connection was being reaped.

so I'm wondering how do I change my scripts to create the index's at the
end? I obviously can't drop the index on the master or everything will go
to heck in a hand basket, but is there an instruction set when I'm adding a
node and adding sets to that node, to tell it to ignore the indexes?


 SLONIK_COMMANDS="$SLONIK_COMMANDS
     subscribe set ( id = 1, provider = $SLAVE_NODE, receiver =
$ADDNODE_ID, forward = yes);
     subscribe set ( id = 2, provider = $SLAVE_NODE, receiver =
$ADDNODE_ID, forward = yes);
     subscribe set ( id = 3, provider = $SLAVE_NODE, receiver =
$ADDNODE_ID, forward = yes);
 "

Wondering where or how I could make changes to allow the copies to just
continue non stop for all the tables and then again to create the index on
the backend of the replication?

Thanks
Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140213/5f4d8f31/attachment.htm 

From vivek at khera.org  Fri Feb 14 10:31:10 2014
From: vivek at khera.org (Vick Khera)
Date: Fri, 14 Feb 2014 13:31:10 -0500
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBD0A2.7030501@motumweb.com>
References: <52FBD0A2.7030501@motumweb.com>
Message-ID: <CALd+dcfPEBmsWsB8mgh4yxyKfJsaW8tZmbiOfRkYJ7Bc2to-Cg@mail.gmail.com>

On Wed, Feb 12, 2014 at 2:50 PM, Efra?n D?ctor <efraindector at motumweb.com>wrote:

> I am trying to setup Slony 2.2.2 on a FreeBSD 10 Release box running
> Postgresql 9.2.6. However I cant compile Slony because I get the
> following error with the command ./configure:
>
>
Use the freebsd port. It just works, and solves all of the
build/configure/install headaches for you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140214/a27483f0/attachment.htm 

From vivek at khera.org  Fri Feb 14 10:35:35 2014
From: vivek at khera.org (Vick Khera)
Date: Fri, 14 Feb 2014 13:35:35 -0500
Subject: [Slony1-general] Wide Area Replication, Add Set, without index?
In-Reply-To: <CAEaSS0Z_Lvfy8t_f8q=0VH4=oqMH7RZLVpQKFijXvuS_uRFstQ@mail.gmail.com>
References: <CAEaSS0Z_Lvfy8t_f8q=0VH4=oqMH7RZLVpQKFijXvuS_uRFstQ@mail.gmail.com>
Message-ID: <CALd+dcdVPPg+0PmV7QyG0RhqVMbqOgE_hsgvtbu3D+SB6-a1AA@mail.gmail.com>

On Thu, Feb 13, 2014 at 5:15 PM, Tory M Blue <tmblue at gmail.com> wrote:

> so I'm wondering how do I change my scripts to create the index's at the
> end? I obviously can't drop the index on the master or everything will go
> to heck in a hand basket, but is there an instruction set when I'm adding a
> node and adding sets to that node, to tell it to ignore the indexes?
>

I'm pretty sure slony disables indexes while copying, then re-builds them
after it is done.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140214/b7b8429d/attachment.htm 

From tmblue at gmail.com  Fri Feb 14 12:26:51 2014
From: tmblue at gmail.com (Tory M Blue)
Date: Fri, 14 Feb 2014 12:26:51 -0800
Subject: [Slony1-general] Wide Area Replication, Add Set, without index?
In-Reply-To: <CALd+dcdVPPg+0PmV7QyG0RhqVMbqOgE_hsgvtbu3D+SB6-a1AA@mail.gmail.com>
References: <CAEaSS0Z_Lvfy8t_f8q=0VH4=oqMH7RZLVpQKFijXvuS_uRFstQ@mail.gmail.com>
	<CALd+dcdVPPg+0PmV7QyG0RhqVMbqOgE_hsgvtbu3D+SB6-a1AA@mail.gmail.com>
Message-ID: <CAEaSS0YbOUfRJfxoJMF0Ook-fCUtFHRLqa=h7E1EGUqJQPpu5A@mail.gmail.com>

On Fri, Feb 14, 2014 at 10:35 AM, Vick Khera <vivek at khera.org> wrote:

>
> On Thu, Feb 13, 2014 at 5:15 PM, Tory M Blue <tmblue at gmail.com> wrote:
>
>> so I'm wondering how do I change my scripts to create the index's at the
>> end? I obviously can't drop the index on the master or everything will go
>> to heck in a hand basket, but is there an instruction set when I'm adding a
>> node and adding sets to that node, to tell it to ignore the indexes?
>>
>
> I'm pretty sure slony disables indexes while copying, then re-builds them
> after it is done.
>


Actually I believe this is beyond slony. The schema tells postgres what to
do, so if it's creating indexes when the table is created, seems like
everything pauses / waits for the index to be done, before moving on to the
next table copy.

So I think editing the schema to do the indexes at the end or not at all
(make it manual), one should be able to use that schema on a remote slon
host, that host will not pause to create indexes, and allow slony to push
the data without a significant pause (some of our indexes have taken 4+
hours to create).

I'm going to test this anyways, I don't see anything particular to slon to
stop this behaviour

Thanks
Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140214/e4371ffc/attachment.htm 

From jeff at pgexperts.com  Sat Feb 15 18:22:57 2014
From: jeff at pgexperts.com (Jeff Frost)
Date: Sat, 15 Feb 2014 18:22:57 -0800
Subject: [Slony1-general] subscriber node has wrong localnodeid after
	initial sync
Message-ID: <4781B32B-7A5E-4ACE-B7A4-9482498396AF@pgexperts.com>

I'm using slony 2.2.2 to migrate from 8.4 to 9.3 and after the initial sync has completed, I'm seeing the following in the slon logs on the subscriber (node 2):

2014-02-16 02:01:19 UTC ERROR  remoteListenThread_2: db_getLocalNodeId() returned 1 - wrong database?

And indeed, if I run this query on the subscriber:

select "_migration".getlocalnodeid('_migration');
getlocalnodeid
----------------
             1
(1 row)

Except it should be node 2.

Is there anyway to fix this without a full resync?

Do I need to revert to 2.2.1 and resync?
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 208 bytes
Desc: Message signed with OpenPGP using GPGMail
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20140215/4473747c/attachment.pgp 

From tmblue at gmail.com  Sat Feb 15 22:09:21 2014
From: tmblue at gmail.com (Tory M Blue)
Date: Sat, 15 Feb 2014 22:09:21 -0800
Subject: [Slony1-general] Still having issues with wide area replication.
 large table , copy set 2 failed
Message-ID: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>

So I've been fighting with this for a few months. I had someone on slony
Dev attempt to lend a hand but others in the group, felt it was more of a
 postgres issue. While this may be true, I'm still looking for some
assistance. Everything points to a disconnect in slony.

Wide area replication, fails on one of my largest tables. Now the table
will copy over complete no issues (using standard pgsql commands), it's the
post processing after the data is copied that seems to cause a sig term or
something on the connection, since slony states that the set failed and
tries again, fails at the same place ,

2014-02-15 15:23:00 PST CONFIG remoteWorkerThread_1: Begin COPY of table
"tracking"."spotlightimp"
2014-02-15 16:46:45 PST CONFIG remoteWorkerThread_1: 5643041332 bytes
copied for table "tracking"."spotlightimp"   <--- Completes transfer
 2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: 7870.124 seconds to
copy table "tracking"."spotlightimp"    <-- At this point it finishes the
index creation and everything else
2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: copy table
"tracking"."adimp"
2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: Begin COPY of table
"tracking"."adimp"
2014-02-15 17:34:10 PST ERROR  remoteWorkerThread_1: "select
"_slonyschema".copyFields(19);"   <--- FAILS but adimp table is there, this
is a red herring. the issue is above!
2014-02-15 17:34:10 PST WARN   remoteWorkerThread_1: data copy for set 2
failed 1 times - sleep 15 seconds
NOTICE:  Slony-I: Logswitch to sl_log_1 initiated
CONTEXT:  SQL statement "SELECT "_slonyschema".logswitch_start()"
PL/pgSQL function _slonyschema.cleanupevent(interval) line 96 at PERFORM
2014-02-15 17:34:14 PST INFO   cleanupThread: 7209.360 seconds for
cleanupEvent()


I've brought my work_mem to over 40GB and that's not helping the length of
time for this large table. I have even removed the index statement still
doesn't cut the time,  The copy is fine, all the data comes over. It's
something in the processing of the table. There is s disconnect at some
point between when slony finishes up the copy of the spotlightimp, and
Postgres processes the rules in the table, and slony starts on the next
table.


2014-02-15 18:48:27 PST CONFIG remoteWorkerThread_1: copy table
"tracking"."spotlightimp"
2014-02-15 18:48:27 PST CONFIG remoteWorkerThread_1: Begin COPY of table
"tracking"."spotlightimp"
2014-02-15 20:11:07 PST CONFIG remoteWorkerThread_1: 5643067207 bytes
copied for table "tracking"."spotlightimp"
2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: 7878.124 seconds to
copy table "tracking"."spotlightimp"
2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: copy table
"tracking"."adimp"
2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: Begin COPY of table
"tracking"."adimp"
2014-02-15 20:59:46 PST ERROR  remoteWorkerThread_1: "select
"_slonyschema".copyFields(19);"
2014-02-15 20:59:46 PST WARN   remoteWorkerThread_1: data copy for set 2
failed 1 times - sleep 15 seconds
NOTICE:  Slony-I: log switch to sl_log_2 complete - truncate sl_log_1
CONTEXT:  PL/pgSQL function _slonyschema.cleanupevent(interval) line 94 at
assignment
2014-02-15 20:59:50 PST INFO   cleanupThread: 7203.435 seconds for
cleanupEvent()

I do feel incredibly strongly it's the size of the table and how long the
process takes, the network / postgres is either reaping the connection or
other causing slony to be in an unknown state and causes the error the
minute we try to move forward from the spotlightimp table.. If I could cut
down the preprocessing after the table was copied that may solve it, but
removing the index part has not helped the situation as I hoped it would.
 This is a complicated table, as well as it's size.

I would love to get this sorted out, slony should allow for this remote
replication, but something is going wrong and man would I love to get this
resolved!

CentOS6.2
Postgres 9.2.4 slony 2.1.3

Thanks
Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140215/70527d91/attachment.htm 

From jeff at pgexperts.com  Sat Feb 15 22:48:37 2014
From: jeff at pgexperts.com (Jeff Frost)
Date: Sun, 16 Feb 2014 00:48:37 -0600 (CST)
Subject: [Slony1-general] Still having issues with wide area
	replication. large table , copy set 2 failed
In-Reply-To: <WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
Message-ID: <6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>

It's probably a firewall timing out your PostgreSQL connection while the indexes are being built on the replica. 

Look into tcp keep alive settings. 

> On Feb 15, 2014, at 22:09, Tory M Blue <tmblue at gmail.com> wrote:
> 
> 
> So I've been fighting with this for a few months. I had someone on slony Dev attempt to lend a hand but others in the group, felt it was more of a  postgres issue. While this may be true, I'm still looking for some assistance. Everything points to a disconnect in slony.
> 
> Wide area replication, fails on one of my largest tables. Now the table will copy over complete no issues (using standard pgsql commands), it's the post processing after the data is copied that seems to cause a sig term or something on the connection, since slony states that the set failed and tries again, fails at the same place ,
> 
> 2014-02-15 15:23:00 PST CONFIG remoteWorkerThread_1: Begin COPY of table "tracking"."spotlightimp"
> 2014-02-15 16:46:45 PST CONFIG remoteWorkerThread_1: 5643041332 bytes copied for table "tracking"."spotlightimp"   <--- Completes transfer
>  2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: 7870.124 seconds to copy table "tracking"."spotlightimp"    <-- At this point it finishes the index creation and everything else
> 2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: copy table "tracking"."adimp"
> 2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: Begin COPY of table "tracking"."adimp"
> 2014-02-15 17:34:10 PST ERROR  remoteWorkerThread_1: "select "_slonyschema".copyFields(19);"   <--- FAILS but adimp table is there, this is a red herring. the issue is above!
> 2014-02-15 17:34:10 PST WARN   remoteWorkerThread_1: data copy for set 2 failed 1 times - sleep 15 seconds
> NOTICE:  Slony-I: Logswitch to sl_log_1 initiated
> CONTEXT:  SQL statement "SELECT "_slonyschema".logswitch_start()"
> PL/pgSQL function _slonyschema.cleanupevent(interval) line 96 at PERFORM
> 2014-02-15 17:34:14 PST INFO   cleanupThread: 7209.360 seconds for cleanupEvent()
> 
> 
> I've brought my work_mem to over 40GB and that's not helping the length of time for this large table. I have even removed the index statement still doesn't cut the time,  The copy is fine, all the data comes over. It's something in the processing of the table. There is s disconnect at some point between when slony finishes up the copy of the spotlightimp, and Postgres processes the rules in the table, and slony starts on the next table.
> 
> 
> 2014-02-15 18:48:27 PST CONFIG remoteWorkerThread_1: copy table "tracking"."spotlightimp"
> 2014-02-15 18:48:27 PST CONFIG remoteWorkerThread_1: Begin COPY of table "tracking"."spotlightimp"
> 2014-02-15 20:11:07 PST CONFIG remoteWorkerThread_1: 5643067207 bytes copied for table "tracking"."spotlightimp"
> 2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: 7878.124 seconds to copy table "tracking"."spotlightimp"
> 2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: copy table "tracking"."adimp"
> 2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: Begin COPY of table "tracking"."adimp"
> 2014-02-15 20:59:46 PST ERROR  remoteWorkerThread_1: "select "_slonyschema".copyFields(19);" 
> 2014-02-15 20:59:46 PST WARN   remoteWorkerThread_1: data copy for set 2 failed 1 times - sleep 15 seconds
> NOTICE:  Slony-I: log switch to sl_log_2 complete - truncate sl_log_1
> CONTEXT:  PL/pgSQL function _slonyschema.cleanupevent(interval) line 94 at assignment
> 2014-02-15 20:59:50 PST INFO   cleanupThread: 7203.435 seconds for cleanupEvent()
> 
> I do feel incredibly strongly it's the size of the table and how long the process takes, the network / postgres is either reaping the connection or other causing slony to be in an unknown state and causes the error the minute we try to move forward from the spotlightimp table.. If I could cut down the preprocessing after the table was copied that may solve it, but removing the index part has not helped the situation as I hoped it would.  This is a complicated table, as well as it's size.
> 
> I would love to get this sorted out, slony should allow for this remote replication, but something is going wrong and man would I love to get this resolved!
> 
> CentOS6.2
> Postgres 9.2.4 slony 2.1.3
> 
> Thanks
> Tory
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

From tmblue at gmail.com  Sat Feb 15 23:25:23 2014
From: tmblue at gmail.com (Tory M Blue)
Date: Sat, 15 Feb 2014 23:25:23 -0800
Subject: [Slony1-general] Still having issues with wide area
 replication. large table , copy set 2 failed
In-Reply-To: <6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>
Message-ID: <CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>

On Sat, Feb 15, 2014 at 10:48 PM, Jeff Frost <jeff at pgexperts.com> wrote:

> It's probably a firewall timing out your PostgreSQL connection while the
> indexes are being built on the replica.
>
> Look into tcp keep alive settings.
>
>
Yes this is what I thought it was when I first started with this, but
didn't make any progress. Keepalives by default is set to 7200 seconds, so
2 hours, this is failing in an hour, so  I'll have to look at the firewalls
between us but since I'm connected to these boxes the entire time, from the
same network that is originating the slon configuration, I'm doubting the
firewalls are reaping the connections.

Looking at the TCP keepalive settings, I don't think there is any tuning
there that can help

net.ipv4.tcp_keepalive_time = 7200
net.ipv4.tcp_keepalive_probes = 9
net.ipv4.tcp_keepalive_intvl = 75

Well, maybe I can "reduce this" just to make some interesting traffic
happen within that hour+ that the indexes are being created.

Hmmm maybe.

Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140215/7d93a594/attachment.htm 

From jeff at pgexperts.com  Sun Feb 16 09:46:51 2014
From: jeff at pgexperts.com (Jeff Frost)
Date: Sun, 16 Feb 2014 09:46:51 -0800
Subject: [Slony1-general] Still having issues with wide area
	replication. large table , copy set 2 failed
In-Reply-To: <WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>
	<CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>
	<WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>
Message-ID: <F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>

On Feb 15, 2014, at 11:25 PM, Tory M Blue <tmblue at gmail.com> wrote:

> 
> 
> 
> On Sat, Feb 15, 2014 at 10:48 PM, Jeff Frost <jeff at pgexperts.com> wrote:
> It's probably a firewall timing out your PostgreSQL connection while the indexes are being built on the replica.
> 
> Look into tcp keep alive settings.
> 
> 
> Yes this is what I thought it was when I first started with this, but didn't make any progress. Keepalives by default is set to 7200 seconds, so 2 hours, this is failing in an hour, so  I'll have to look at the firewalls between us but since I'm connected to these boxes the entire time, from the same network that is originating the slon configuration, I'm doubting the firewalls are reaping the connections.
> 
> Looking at the TCP keepalive settings, I don't think there is any tuning there that can help
> 
> net.ipv4.tcp_keepalive_time = 7200
> net.ipv4.tcp_keepalive_probes = 9
> net.ipv4.tcp_keepalive_intvl = 75
> 
> Well, maybe I can "reduce this" just to make some interesting traffic happen within that hour+ that the indexes are being created.


Yah, so 2 hrs means that if your firewall times out in 10 minutes, it's going to kill that idle postgresql connection on you.

This is common in AWS and here are the settings I use in slony 2.2 to fix this:

# TCP keep alive configurations
# Enable sending of TCP keep alive between slon and the PostgreSQL backends
tcp_keepalive = true

# The number of seconds after which a TCP keep alive is sent across an idle
# connection. tcp_keepalive must be enabled for this to take effect. Default
# value of 0 means use operating system default
 tcp_keepalive_idle = 5

# The number of keep alive requests to the server that can be lost before
# the connection is declared dead. tcp_keepalive must be on.Default value
# of 0 means use operating system default
tcp_keepalive_count = 10

# The number of seconds in between TCP keep alive requests. tcp_keepalive
# must be enabled. Default value of 0 means use operating system defaut
tcp_keepalive_interval = 30

That's probably more aggressive than you need, but it should do the trick.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140216/54401ba2/attachment-0001.htm 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 208 bytes
Desc: Message signed with OpenPGP using GPGMail
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20140216/54401ba2/attachment-0001.pgp 

From jeff at pgexperts.com  Sun Feb 16 09:43:10 2014
From: jeff at pgexperts.com (Jeff Frost)
Date: Sun, 16 Feb 2014 09:43:10 -0800
Subject: [Slony1-general] subscriber node has wrong localnodeid after
	initial sync
In-Reply-To: <WM!b15d0c2a9eda29ce9c9d4674a4d777b51bc0c8f0ecdf16324f39dfa834f1228d3656fb81cb1fee3a9d30c5eb8750a34f!@asav-3.01.com>
References: <4781B32B-7A5E-4ACE-B7A4-9482498396AF@pgexperts.com>
	<WM!b15d0c2a9eda29ce9c9d4674a4d777b51bc0c8f0ecdf16324f39dfa834f1228d3656fb81cb1fee3a9d30c5eb8750a34f!@asav-3.01.com>
Message-ID: <AB84FD71-42CC-45F4-98DB-1511F986CB00@pgexperts.com>

I figured out what happened here.  Total user error.

Got a little too excited by the new ability to add tables/sequences by regex and just used '.*' for the sequences.

Guess what got added:

      3 |  253138138 | sl_action_seq              | _migration  |       1 | replicated sequence
      4 |  253138136 | sl_event_seq               | _migration  |       1 | replicated sequence
      5 |  253138134 | sl_local_node_id           | _migration  |       1 | replicated sequence
      6 |  253138140 | sl_log_status              | _migration  |       1 | replicated sequence
      7 |  253137956 | sl_nodelock_nl_conncnt_seq | _migration  |       1 | replicated sequence

So, setting sl_local_node_id to the correct value gets it going again, but of course I had a ton of pkey conflicts in sl_event.

I guess I'd better resync this thing.

On Feb 15, 2014, at 6:22 PM, Jeff Frost <jeff at pgexperts.com> wrote:

> I'm using slony 2.2.2 to migrate from 8.4 to 9.3 and after the initial sync has completed, I'm seeing the following in the slon logs on the subscriber (node 2):
> 
> 2014-02-16 02:01:19 UTC ERROR  remoteListenThread_2: db_getLocalNodeId() returned 1 - wrong database?
> 
> And indeed, if I run this query on the subscriber:
> 
> select "_migration".getlocalnodeid('_migration');
> getlocalnodeid
> ----------------
>             1
> (1 row)
> 
> Except it should be node 2.
> 
> Is there anyway to fix this without a full resync?
> 
> Do I need to revert to 2.2.1 and resync?
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

---
Jeff Frost <jeff at pgexperts.com>
CTO, PostgreSQL Experts, Inc.
Phone: 1-888-PG-EXPRT x506
FAX: 415-762-5122
http://www.pgexperts.com/ 






-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 208 bytes
Desc: Message signed with OpenPGP using GPGMail
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20140216/dccb4761/attachment.pgp 

From tmblue at gmail.com  Sun Feb 16 17:00:09 2014
From: tmblue at gmail.com (Tory M Blue)
Date: Sun, 16 Feb 2014 17:00:09 -0800
Subject: [Slony1-general] Still having issues with wide area
 replication. large table , copy set 2 failed
In-Reply-To: <F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>
	<CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>
	<WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>
	<F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>
Message-ID: <CAEaSS0aCtCMOz9Ypjkj3_DZtPqqP6A3EKQ59a_20EbU-W9TQVg@mail.gmail.com>

On Sun, Feb 16, 2014 at 9:46 AM, Jeff Frost <jeff at pgexperts.com> wrote:

> On Feb 15, 2014, at 11:25 PM, Tory M Blue <tmblue at gmail.com> wrote:
>
>
>
>
> On Sat, Feb 15, 2014 at 10:48 PM, Jeff Frost <jeff at pgexperts.com> wrote:
>
>> It's probably a firewall timing out your PostgreSQL connection while the
>> indexes are being built on the replica.
>>
>> Look into tcp keep alive settings.
>>
>>
> Yes this is what I thought it was when I first started with this, but
> didn't make any progress. Keepalives by default is set to 7200 seconds, so
> 2 hours, this is failing in an hour, so  I'll have to look at the firewalls
> between us but since I'm connected to these boxes the entire time, from the
> same network that is originating the slon configuration, I'm doubting the
> firewalls are reaping the connections.
>
> Looking at the TCP keepalive settings, I don't think there is any tuning
> there that can help
>
> net.ipv4.tcp_keepalive_time = 7200
> net.ipv4.tcp_keepalive_probes = 9
> net.ipv4.tcp_keepalive_intvl = 75
>
> Well, maybe I can "reduce this" just to make some interesting traffic
> happen within that hour+ that the indexes are being created.
>
>
> Yah, so 2 hrs means that if your firewall times out in 10 minutes, it's
> going to kill that idle postgresql connection on you.
>
> This is common in AWS and here are the settings I use in slony 2.2 to fix
> this:
>
> # TCP keep alive configurations
> # Enable sending of TCP keep alive between slon and the PostgreSQL backends
> tcp_keepalive = true
>
> # The number of seconds after which a TCP keep alive is sent across an idle
> # connection. tcp_keepalive must be enabled for this to take effect.
> Default
> # value of 0 means use operating system default
>  tcp_keepalive_idle = 5
>
> # The number of keep alive requests to the server that can be lost before
> # the connection is declared dead. tcp_keepalive must be on.Default value
> # of 0 means use operating system default
> tcp_keepalive_count = 10
>
> # The number of seconds in between TCP keep alive requests. tcp_keepalive
> # must be enabled. Default value of 0 means use operating system defaut
> tcp_keepalive_interval = 30
>
> That's probably more aggressive than you need, but it should do the trick.
>
>
Okay So I mucked with the settings, maybe I'm not understanding them quite
right, but still same result, this time I at least caught the disconnect in
my source postgresql logs.

2014-02-16 14:41:03 PST CONFIG remoteWorkerThread_1: Begin COPY of table
"tracking"."spotlightimp"
NOTICE:  truncate of "tracking"."spotlightimp" succeeded
2014-02-16 15:54:40 PST CONFIG remoteWorkerThread_1: 5618691807 bytes
copied for table "tracking"."spotlightimp"

------------ ORIGIN----------
2014-02-16 16:14:40 PST cls postgres 172.19.228.100(35508) 13796 2014-02-16
16:14:40.430 PSTLOG:  could not receive data from client: Connection reset
by peer
2014-02-16 16:14:40 PST cls postgres 172.19.228.100(35508) 13796 2014-02-16
16:14:40.430 PSTLOG:  unexpected EOF on client connection with an open
transaction
------------ORIGIN----------

As can be seen the connection is reaped, slon/postgres continue on their
way, it's not until the next data copy is required that it finds it's
connection is no longer there. Why it can't recreate a conneciton as one
would do if they stopped and started slon is kind of beyond me.  Just not
100% sure where it's being killed.


2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: 7183.069 seconds to
copy table "tracking"."spotlightimp"
2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: copy table
"tracking"."adimp"
2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: Begin COPY of table
"tracking"."adimp"
2014-02-16 16:40:46 PST ERROR  remoteWorkerThread_1: "select
"_cls".copyFields(19);"
2014-02-16 16:40:46 PST WARN   remoteWorkerThread_1: data copy for set 2
failed 1 times - sleep 15 seconds
NOTICE:  Slony-I: Logswitch to sl_log_2 initiated
CONTEXT:  SQL statement "SELECT "_cls".logswitch_start()"
PL/pgSQL function _cls.cleanupevent(interval) line 96 at PERFORM
2014-02-16 16:40:49 PST INFO   cleanupThread: 6541.365 seconds for
cleanupEvent()


Am I doing this wrong? figured that since I've seen connections at 15
minutes of processing complete fine, I thought that 30 minutes is more then
enough. So send the first hey are you still there at 15 minutes then
continue with them every 5 minutes, for a count of 30.

But the above seems to have been reaped in the 20 minute area..

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 30
net.ipv4.tcp_keepalive_intvl = 300

thanks for the assistance
Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140216/1cf7e2e5/attachment.htm 

From jeff at pgexperts.com  Sun Feb 16 17:06:31 2014
From: jeff at pgexperts.com (Jeff Frost)
Date: Sun, 16 Feb 2014 17:06:31 -0800
Subject: [Slony1-general] Still having issues with wide area
	replication. large table , copy set 2 failed
In-Reply-To: <WM!890ea2cf9de03d35ca89d8b92c06ed80b90cbb2f2c67b07b0640db360db50610179f72ab091ef59d50c5e04b8ef7fdff!@asav-2.01.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>
	<CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>
	<WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>
	<F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>
	<CAEaSS0aCtCMOz9Ypjkj3_DZtPqqP6A3EKQ59a_20EbU-W9TQVg@mail.gmail.com>
	<WM!890ea2cf9de03d35ca89d8b92c06ed80b90cbb2f2c67b07b0640db360db50610179f72ab091ef59d50c5e04b8ef7fdff!@asav-2.01.com>
Message-ID: <4C1F5D40-2ED1-429B-B6D2-C9F3BC00F95F@pgexperts.com>


On Feb 16, 2014, at 5:00 PM, Tory M Blue <tmblue at gmail.com> wrote:

> 
> 
> 
> As can be seen the connection is reaped, slon/postgres continue on their way, it's not until the next data copy is required that it finds it's connection is no longer there. Why it can't recreate a conneciton as one would do if they stopped and started slon is kind of beyond me.  Just not 100% sure where it's being killed.
> 

Because the initial sync must be done as a single transaction.


> 
> 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: 7183.069 seconds to copy table "tracking"."spotlightimp"
> 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: copy table "tracking"."adimp"
> 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: Begin COPY of table "tracking"."adimp"
> 2014-02-16 16:40:46 PST ERROR  remoteWorkerThread_1: "select "_cls".copyFields(19);" 
> 2014-02-16 16:40:46 PST WARN   remoteWorkerThread_1: data copy for set 2 failed 1 times - sleep 15 seconds
> NOTICE:  Slony-I: Logswitch to sl_log_2 initiated
> CONTEXT:  SQL statement "SELECT "_cls".logswitch_start()"
> PL/pgSQL function _cls.cleanupevent(interval) line 96 at PERFORM
> 2014-02-16 16:40:49 PST INFO   cleanupThread: 6541.365 seconds for cleanupEvent()
>  
> 
> Am I doing this wrong? figured that since I've seen connections at 15 minutes of processing complete fine, I thought that 30 minutes is more then enough. So send the first hey are you still there at 15 minutes then continue with them every 5 minutes, for a count of 30.
> 
> But the above seems to have been reaped in the 20 minute area..
> 
> net.ipv4.tcp_keepalive_time = 600
> net.ipv4.tcp_keepalive_probes = 30
> net.ipv4.tcp_keepalive_intvl = 300


Set it so that it's sending keepalives every 30 seconds.

Something like this:

net.ipv4.tcp_keepalive_time = 30
net.ipv4.tcp_keepalive_probes = 10
net.ipv4.tcp_keepalive_intvl = 30

What version of slony are you using?  You may need to specifically enabled keepalive.  


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 208 bytes
Desc: Message signed with OpenPGP using GPGMail
Url : http://lists.slony.info/pipermail/slony1-general/attachments/20140216/62d461a2/attachment.pgp 

From diptatapa at gmail.com  Tue Feb 18 00:51:29 2014
From: diptatapa at gmail.com (Soni M)
Date: Tue, 18 Feb 2014 15:51:29 +0700
Subject: [Slony1-general] Error compiling Slony on Ubuntu
Message-ID: <CAAMgDX=vbFY8emAh562j9-3E9bUx7=bZFNQ=5G+XUftgJrG9=A@mail.gmail.com>

Hello everyone.

I have a problem when compiling Slony on Ubuntu 10.04.4 LTS.

PostgreSQL version : postgresql-9.1 from ubuntu packages
libpq-dev and postgresql-server-dev-9.1 has also been installed

I try to compile some different version of Slony, which are : 2.0.7; 2.1.1;
2.2.0, and 2.2.2.

I only succeeded compiling and installing 2.2.2. Other version throw same
error.

The error messages are :

/usr/include/postgresql/9.1/server/catalog/pg_attribute.h:57: error:
expected specifier-qualifier-list before 'int4'
/usr/include/postgresql/9.1/server/parser/parse_node.h:129: error: expected
declaration specifiers or '...' before '(' token
/usr/include/postgresql/9.1/server/parser/parse_node.h:129: error: field
'set_errcontext_domain' declared as a function

Googling can't give a solution.

Can anyone help?

Thanks before.

-- 
Regards,

Soni Maula Harriz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140218/8cbab382/attachment.htm 

From ssinger at ca.afilias.info  Tue Feb 18 05:32:47 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 18 Feb 2014 08:32:47 -0500
Subject: [Slony1-general] Error compiling Slony on Ubuntu
In-Reply-To: <CAAMgDX=vbFY8emAh562j9-3E9bUx7=bZFNQ=5G+XUftgJrG9=A@mail.gmail.com>
References: <CAAMgDX=vbFY8emAh562j9-3E9bUx7=bZFNQ=5G+XUftgJrG9=A@mail.gmail.com>
Message-ID: <530360FF.6070702@ca.afilias.info>

On 02/18/2014 03:51 AM, Soni M wrote:
> Hello everyone.
>
> I have a problem when compiling Slony on Ubuntu 10.04.4 LTS.
>
> PostgreSQL version : postgresql-9.1 from ubuntu packages
> libpq-dev and postgresql-server-dev-9.1 has also been installed
>
> I try to compile some different version of Slony, which are : 2.0.7;
> 2.1.1; 2.2.0, and 2.2.2.
>
> I only succeeded compiling and installing 2.2.2. Other version throw
> same error.
>

Perhaps this is bug 315? 
(http://www.slony.info/bugzilla/show_bug.cgi?id=315)

What version of slony do you want to run?
If it is bug 315 then REL_2_1_STABLE should also work, but we haven't 
yet packaged a 2.1.5 release.






> The error messages are :
>
> /usr/include/postgresql/9.1/server/catalog/pg_attribute.h:57: error:
> expected specifier-qualifier-list before ?int4?
> /usr/include/postgresql/9.1/server/parser/parse_node.h:129: error:
> expected declaration specifiers or ?...? before ?(? token
> /usr/include/postgresql/9.1/server/parser/parse_node.h:129: error: field
> ?set_errcontext_domain? declared as a function
>
> Googling can't give a solution.
>
> Can anyone help?
>
> Thanks before.
>
> --
> Regards,
>
> Soni Maula Harriz
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From diptatapa at gmail.com  Tue Feb 18 14:21:14 2014
From: diptatapa at gmail.com (Soni M)
Date: Wed, 19 Feb 2014 05:21:14 +0700
Subject: [Slony1-general] Error compiling Slony on Ubuntu
In-Reply-To: <530360FF.6070702@ca.afilias.info>
References: <CAAMgDX=vbFY8emAh562j9-3E9bUx7=bZFNQ=5G+XUftgJrG9=A@mail.gmail.com>
	<530360FF.6070702@ca.afilias.info>
Message-ID: <CAAMgDXmXDx5+mGj4g11M-AfSWwOt2hX0gLXnLtzgtGoaNZKWWA@mail.gmail.com>

Thanks for the reply Sir.

i think that is the same bug, i use postgresql-server-dev-9.1,
but libpq-dev and libpq5 package are from 9.3.
And yes, configure were including both -I/usr/include/postgresql and
-I/usr/include/postgresql/9.1/server.

I would like to run Slony 2.0.7, as it is running on another server. Where
can i have REL_STABLE version for Slony 2.0.7?



On Tue, Feb 18, 2014 at 8:32 PM, Steve Singer <ssinger at ca.afilias.info>wrote:

> On 02/18/2014 03:51 AM, Soni M wrote:
> > Hello everyone.
> >
> > I have a problem when compiling Slony on Ubuntu 10.04.4 LTS.
> >
> > PostgreSQL version : postgresql-9.1 from ubuntu packages
> > libpq-dev and postgresql-server-dev-9.1 has also been installed
> >
> > I try to compile some different version of Slony, which are : 2.0.7;
> > 2.1.1; 2.2.0, and 2.2.2.
> >
> > I only succeeded compiling and installing 2.2.2. Other version throw
> > same error.
> >
>
> Perhaps this is bug 315?
> (http://www.slony.info/bugzilla/show_bug.cgi?id=315)
>
> What version of slony do you want to run?
> If it is bug 315 then REL_2_1_STABLE should also work, but we haven't
> yet packaged a 2.1.5 release.
>
>
>
>
>
>
> > The error messages are :
> >
> > /usr/include/postgresql/9.1/server/catalog/pg_attribute.h:57: error:
> > expected specifier-qualifier-list before 'int4'
> > /usr/include/postgresql/9.1/server/parser/parse_node.h:129: error:
> > expected declaration specifiers or '...' before '(' token
> > /usr/include/postgresql/9.1/server/parser/parse_node.h:129: error: field
> > 'set_errcontext_domain' declared as a function
> >
> > Googling can't give a solution.
> >
> > Can anyone help?
> >
> > Thanks before.
> >
> > --
> > Regards,
> >
> > Soni Maula Harriz
> >
> >
> > _______________________________________________
> > Slony1-general mailing list
> > Slony1-general at lists.slony.info
> > http://lists.slony.info/mailman/listinfo/slony1-general
> >
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>



-- 
Regards,

Soni Maula Harriz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140219/35f4e94a/attachment.htm 

From cs_dba at consistentstate.com  Tue Feb 18 16:44:57 2014
From: cs_dba at consistentstate.com (CS DBA)
Date: Tue, 18 Feb 2014 17:44:57 -0700
Subject: [Slony1-general] Still having issues with wide area
 replication. large table , copy set 2 failed
In-Reply-To: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
Message-ID: <5303FE89.2090808@consistentstate.com>

We recently had a very similar scenario, turned out to be a timeout on 
the firewall that killed IDLE connections longer than X (2 hours in our 
case) and it saw the top level SLONY process as IDLE.  Maybe you have a 
similar firewall rule?







    On 2/15/14, 11:09 PM, Tory M Blue wrote:
>
> So I've been fighting with this for a few months. I had someone on 
> slony Dev attempt to lend a hand but others in the group, felt it was 
> more of a  postgres issue. While this may be true, I'm still looking 
> for some assistance. Everything points to a disconnect in slony.
>
> Wide area replication, fails on one of my largest tables. Now the 
> table will copy over complete no issues (using standard pgsql 
> commands), it's the post processing after the data is copied that 
> seems to cause a sig term or something on the connection, since slony 
> states that the set failed and tries again, fails at the same place ,
>
> 2014-02-15 15:23:00 PST CONFIG remoteWorkerThread_1: Begin COPY of 
> table "tracking"."spotlightimp"
> 2014-02-15 16:46:45 PST CONFIG remoteWorkerThread_1: 5643041332 bytes 
> copied for table "tracking"."spotlightimp" <--- Completes transfer
>  2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: 7870.124 seconds 
> to copy table "tracking"."spotlightimp"  <-- At this point it finishes 
> the index creation and everything else
> 2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: copy table 
> "tracking"."adimp"
> 2014-02-15 17:34:10 PST CONFIG remoteWorkerThread_1: Begin COPY of 
> table "tracking"."adimp"
> 2014-02-15 17:34:10 PST ERROR  remoteWorkerThread_1: "select 
> "_slonyschema".copyFields(19);"   <--- FAILS but adimp table is there, 
> this is a red herring. the issue is above!
> 2014-02-15 17:34:10 PST WARN   remoteWorkerThread_1: data copy for set 
> 2 failed 1 times - sleep 15 seconds
> NOTICE:  Slony-I: Logswitch to sl_log_1 initiated
> CONTEXT:  SQL statement "SELECT "_slonyschema".logswitch_start()"
> PL/pgSQL function _slonyschema.cleanupevent(interval) line 96 at PERFORM
> 2014-02-15 17:34:14 PST INFO   cleanupThread: 7209.360 seconds for 
> cleanupEvent()
>
>
> I've brought my work_mem to over 40GB and that's not helping the 
> length of time for this large table. I have even removed the index 
> statement still doesn't cut the time,  The copy is fine, all the data 
> comes over. It's something in the processing of the table. There is s 
> disconnect at some point between when slony finishes up the copy of 
> the spotlightimp, and Postgres processes the rules in the table, and 
> slony starts on the next table.
>
>
> 2014-02-15 18:48:27 PST CONFIG remoteWorkerThread_1: copy table 
> "tracking"."spotlightimp"
> 2014-02-15 18:48:27 PST CONFIG remoteWorkerThread_1: Begin COPY of 
> table "tracking"."spotlightimp"
> 2014-02-15 20:11:07 PST CONFIG remoteWorkerThread_1: 5643067207 bytes 
> copied for table "tracking"."spotlightimp"
> 2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: 7878.124 seconds 
> to copy table "tracking"."spotlightimp"
> 2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: copy table 
> "tracking"."adimp"
> 2014-02-15 20:59:46 PST CONFIG remoteWorkerThread_1: Begin COPY of 
> table "tracking"."adimp"
> 2014-02-15 20:59:46 PST ERROR  remoteWorkerThread_1: "select 
> "_slonyschema".copyFields(19);"
> 2014-02-15 20:59:46 PST WARN   remoteWorkerThread_1: data copy for set 
> 2 failed 1 times - sleep 15 seconds
> NOTICE:  Slony-I: log switch to sl_log_2 complete - truncate sl_log_1
> CONTEXT:  PL/pgSQL function _slonyschema.cleanupevent(interval) line 
> 94 at assignment
> 2014-02-15 20:59:50 PST INFO   cleanupThread: 7203.435 seconds for 
> cleanupEvent()
>
> I do feel incredibly strongly it's the size of the table and how long 
> the process takes, the network / postgres is either reaping the 
> connection or other causing slony to be in an unknown state and causes 
> the error the minute we try to move forward from the spotlightimp 
> table.. If I could cut down the preprocessing after the table was 
> copied that may solve it, but removing the index part has not helped 
> the situation as I hoped it would.  This is a complicated table, as 
> well as it's size.
>
> I would love to get this sorted out, slony should allow for this 
> remote replication, but something is going wrong and man would I love 
> to get this resolved!
>
> CentOS6.2
> Postgres 9.2.4 slony 2.1.3
>
> Thanks
> Tory
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140218/364f6c02/attachment.htm 

From JanWieck at Yahoo.com  Tue Feb 18 19:34:54 2014
From: JanWieck at Yahoo.com (Jan Wieck)
Date: Tue, 18 Feb 2014 22:34:54 -0500
Subject: [Slony1-general] Still having issues with wide area
 replication. large table , copy set 2 failed
In-Reply-To: <4C1F5D40-2ED1-429B-B6D2-C9F3BC00F95F@pgexperts.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>	<CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>	<WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>	<F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>	<CAEaSS0aCtCMOz9Ypjkj3_DZtPqqP6A3EKQ59a_20EbU-W9TQVg@mail.gmail.com>	<WM!890ea2cf9de03d35ca89d8b92c06ed80b90cbb2f2c67b07b0640db360db50610179f72ab091ef59d50c5e04b8ef7fdff!@asav-2.01.com>
	<4C1F5D40-2ED1-429B-B6D2-C9F3BC00F95F@pgexperts.com>
Message-ID: <5304265E.4040905@Yahoo.com>

On 02/16/14 20:06, Jeff Frost wrote:
> 
> On Feb 16, 2014, at 5:00 PM, Tory M Blue <tmblue at gmail.com> wrote:
> 
>> 
>> 
>> 
>> As can be seen the connection is reaped, slon/postgres continue on their way, it's not until the next data copy is required that it finds it's connection is no longer there. Why it can't recreate a conneciton as one would do if they stopped and started slon is kind of beyond me.  Just not 100% sure where it's being killed.
>> 
> 
> Because the initial sync must be done as a single transaction.
> 
> 
>> 
>> 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: 7183.069 seconds to copy table "tracking"."spotlightimp"
>> 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: copy table "tracking"."adimp"
>> 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: Begin COPY of table "tracking"."adimp"
>> 2014-02-16 16:40:46 PST ERROR  remoteWorkerThread_1: "select "_cls".copyFields(19);" 
>> 2014-02-16 16:40:46 PST WARN   remoteWorkerThread_1: data copy for set 2 failed 1 times - sleep 15 seconds
>> NOTICE:  Slony-I: Logswitch to sl_log_2 initiated
>> CONTEXT:  SQL statement "SELECT "_cls".logswitch_start()"
>> PL/pgSQL function _cls.cleanupevent(interval) line 96 at PERFORM
>> 2014-02-16 16:40:49 PST INFO   cleanupThread: 6541.365 seconds for cleanupEvent()
>>  
>> 
>> Am I doing this wrong? figured that since I've seen connections at 15 minutes of processing complete fine, I thought that 30 minutes is more then enough. So send the first hey are you still there at 15 minutes then continue with them every 5 minutes, for a count of 30.
>> 
>> But the above seems to have been reaped in the 20 minute area..
>> 
>> net.ipv4.tcp_keepalive_time = 600
>> net.ipv4.tcp_keepalive_probes = 30
>> net.ipv4.tcp_keepalive_intvl = 300
> 
> 
> Set it so that it's sending keepalives every 30 seconds.
> 
> Something like this:
> 
> net.ipv4.tcp_keepalive_time = 30
> net.ipv4.tcp_keepalive_probes = 10
> net.ipv4.tcp_keepalive_intvl = 30
> 

Jeff is right.

Really understanding these values may help too.

Since Slony allows to set them specifically for Slony in its config
file, that is where it really should be done, rather than setting the
global values in the kernel. Those kernel values should be adjusted to
more appropriate values than suitable for a link to the Moon too, but
that's another story.

tcp_keepalive_time is the number of seconds, the kernel waits since the
last transmission on a socket, before starting to "probe". In this case,
the end of the COPY, when slony is going into the long "<IDLE> in
transaction" while building the indexes, is the start of that timer.

tcp_keepalive_intvl is the interval between keepalive packets. But that
interval only kicks in once the tcp_keepalive_time has elapsed.

tcp_keepalive_probes is the number of keepalive packets, that need to be
missing in a row, before the connection is considered "lost", resulting
in a "connection reset by peer". One single keepalive received resets
the whole thing.

I actually go a lot more aggressive at this. Something like

tcp_keepalive_time = 5
tcp_keepalive_probes = 24
tcp_keepalive_intvl = 5

Pretty much all "remote" slony connections do something every couple of
seconds. And a link that cannot deal with a few keepalive packets per
minute is not suitable for running slony over anyway. And who cares
about wasting bandwidth on an idle link? Seriously! It's not like we are
paying by the kilobyte of used bandwidth these days, are we?

What is also important here that my above settings lead to a timeout and
canceling of the PostgreSQL backend within 2 minutes. There is something
really bad about hanging backends of lost Slony connections, when you
actually ever need to failover. You really want them to time out in a
timely fashion. Trust me.


Regards,
Jan

-- 
Anyone who trades liberty for security deserves neither
liberty nor security. -- Benjamin Franklin

From jeff at pgexperts.com  Wed Feb 19 13:59:33 2014
From: jeff at pgexperts.com (Jeff Frost)
Date: Wed, 19 Feb 2014 13:59:33 -0800
Subject: [Slony1-general] Still having issues with wide area
 replication. large table , copy set 2 failed
In-Reply-To: <WM!a08e22ebfc649c3767213aacdd275c46d58e72293af2e6861ce58378de704d57fa22f47bc6f76a54193b01a3fa74a9c3!@asav-2.01.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>	<CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>	<WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>	<F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>	<CAEaSS0aCtCMOz9Ypjkj3_DZtPqqP6A3EKQ59a_20EbU-W9TQVg@mail.gmail.com>	<WM!890ea2cf9de03d35ca89d8b92c06ed80b90cbb2f2c67b07b0640db360db50610179f72ab091ef59d50c5e04b8ef7fdff!@asav-2.01.com>
	<4C1F5D40-2ED1-429B-B6D2-C9F3BC00F95F@pgexperts.com>
	<5304265E.4040905@Yahoo.com>
	<WM!a08e22ebfc649c3767213aacdd275c46d58e72293af2e6861ce58378de704d57fa22f47bc6f76a54193b01a3fa74a9c3!@asav-2.01.com>
Message-ID: <53052945.9030803@pgexperts.com>

On 02/18/14 19:34, Jan Wieck wrote:
> Since Slony allows to set them specifically for Slony in its config
> file, that is where it really should be done, rather than setting the
> global values in the kernel. Those kernel values should be adjusted to
> more appropriate values than suitable for a link to the Moon too, but
> that's another story.

Jan, is that only in 2.2+?

I don't see the settings in the sample slon.conf before that version.

-- 
Jeff Frost <jeff at pgexperts.com>
CTO, PostgreSQL Experts, Inc.
Phone: 1-888-PG-EXPRT x506
FAX: 415-762-5122
http://www.pgexperts.com/ 


From diptatapa at gmail.com  Sun Feb 16 23:55:01 2014
From: diptatapa at gmail.com (Soni M)
Date: Mon, 17 Feb 2014 14:55:01 +0700
Subject: [Slony1-general] Error Compiling Slony on Ubuntu
Message-ID: <CAAMgDX=A7SFXZZNkENq5cUoRQVXNbCmzTMawRiLum0dWYKHSYw@mail.gmail.com>

Slony1 version : slony1-2.0.7
PostgreSQL version : postgresql-9.1 from ubuntu packages
libpq-dev and postgresql-server-dev-9.1 has also been installed

this is the error code :
/usr/include/postgresql/9.1/server/catalog/pg_attribute.h:57: error:
expected specifier-qualifier-list before 'int4'
/usr/include/postgresql/9.1/server/parser/parse_node.h:129: error: expected
declaration specifiers or '...' before '(' token
/usr/include/postgresql/9.1/server/parser/parse_node.h:129: error: field
'set_errcontext_domain' declared as a function

I cannot find any solution for this.
Can anyone help?

Thanks before

-- 
Regards,

Soni Maula Harriz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140217/2f6bf723/attachment.htm 

From ssinger at ca.afilias.info  Wed Feb 19 18:47:44 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 19 Feb 2014 21:47:44 -0500
Subject: [Slony1-general] Error compiling Slony on Ubuntu
In-Reply-To: <CAAMgDXmXDx5+mGj4g11M-AfSWwOt2hX0gLXnLtzgtGoaNZKWWA@mail.gmail.com>
References: <CAAMgDX=vbFY8emAh562j9-3E9bUx7=bZFNQ=5G+XUftgJrG9=A@mail.gmail.com>
	<530360FF.6070702@ca.afilias.info>
	<CAAMgDXmXDx5+mGj4g11M-AfSWwOt2hX0gLXnLtzgtGoaNZKWWA@mail.gmail.com>
Message-ID: <53056CD0.9030500@ca.afilias.info>

On 02/18/2014 05:21 PM, Soni M wrote:
> Thanks for the reply Sir.
>
> i think that is the same bug, i use postgresql-server-dev-9.1,
> but libpq-dev and libpq5 package are from 9.3.
> And yes, configure were including both -I/usr/include/postgresql and
> -I/usr/include/postgresql/9.1/server.
>
> I would like to run Slony 2.0.7, as it is running on another server.
> Where can i have REL_STABLE version for Slony 2.0.7?
>
>

I have applied those patch to REL_2_0_STABLE you can git them from the 
slony git repository. We will try to do a 2.0.8 release in the next few 
weeks.  That will likely be the last release of the 2.0.x series.
Available in the REL_2_0_STABLE branch at 
git://git.postgresql.org/git/slony1-engine.git


>
> On Tue, Feb 18, 2014 at 8:32 PM, Steve Singer <ssinger at ca.afilias.info
> <mailto:ssinger at ca.afilias.info>> wrote:
>
>     On 02/18/2014 03:51 AM, Soni M wrote:
>      > Hello everyone.
>      >
>      > I have a problem when compiling Slony on Ubuntu 10.04.4 LTS.
>      >
>      > PostgreSQL version : postgresql-9.1 from ubuntu packages
>      > libpq-dev and postgresql-server-dev-9.1 has also been installed
>      >
>      > I try to compile some different version of Slony, which are : 2.0.7;
>      > 2.1.1; 2.2.0, and 2.2.2.
>      >
>      > I only succeeded compiling and installing 2.2.2. Other version throw
>      > same error.
>      >
>
>     Perhaps this is bug 315?
>     (http://www.slony.info/bugzilla/show_bug.cgi?id=315)
>
>     What version of slony do you want to run?
>     If it is bug 315 then REL_2_1_STABLE should also work, but we haven't
>     yet packaged a 2.1.5 release.
>
>
>
>
>
>
>      > The error messages are :
>      >
>      > /usr/include/postgresql/9.1/server/catalog/pg_attribute.h:57: error:
>      > expected specifier-qualifier-list before ?int4?
>      > /usr/include/postgresql/9.1/server/parser/parse_node.h:129: error:
>      > expected declaration specifiers or ?...? before ?(? token
>      > /usr/include/postgresql/9.1/server/parser/parse_node.h:129:
>     error: field
>      > ?set_errcontext_domain? declared as a function
>      >
>      > Googling can't give a solution.
>      >
>      > Can anyone help?
>      >
>      > Thanks before.
>      >
>      > --
>      > Regards,
>      >
>      > Soni Maula Harriz
>      >
>      >
>      > _______________________________________________
>      > Slony1-general mailing list
>      > Slony1-general at lists.slony.info
>     <mailto:Slony1-general at lists.slony.info>
>      > http://lists.slony.info/mailman/listinfo/slony1-general
>      >
>
>     _______________________________________________
>     Slony1-general mailing list
>     Slony1-general at lists.slony.info <mailto:Slony1-general at lists.slony.info>
>     http://lists.slony.info/mailman/listinfo/slony1-general
>
>
>
>
> --
> Regards,
>
> Soni Maula Harriz


From tmblue at gmail.com  Fri Feb 21 17:41:11 2014
From: tmblue at gmail.com (Tory M Blue)
Date: Fri, 21 Feb 2014 17:41:11 -0800
Subject: [Slony1-general] Still having issues with wide area
 replication. large table , copy set 2 failed
In-Reply-To: <4C1F5D40-2ED1-429B-B6D2-C9F3BC00F95F@pgexperts.com>
References: <CAEaSS0YVcwmCNGTjDgwAqh-XsXRuA4zP4_EqX9fozJyBHPDqSA@mail.gmail.com>
	<WM!41439fabdae24548d4063c276ab20ec51d8570acdc787f7ce94fd51664b5e2dd52314fc672b8ee6df6c2e4121d4da7b1!@asav-1.01.com>
	<6994ACA7-C2A5-49BA-B25B-053A3640E937@pgexperts.com>
	<CAEaSS0ZLOpUGtmHZ+teK85jyF1pwUDxVZ1463kV08-7QnbOWxQ@mail.gmail.com>
	<WM!7848071ee73af99e2b0faf320e8342c37c3c6176d6ad405bd09ead1e43d7d0fc45c517ab1681ec3d76cd92da7beecd9b!@asav-2.01.com>
	<F7FD1574-4254-4D16-AF96-6F1B0B9985A3@pgexperts.com>
	<CAEaSS0aCtCMOz9Ypjkj3_DZtPqqP6A3EKQ59a_20EbU-W9TQVg@mail.gmail.com>
	<WM!890ea2cf9de03d35ca89d8b92c06ed80b90cbb2f2c67b07b0640db360db50610179f72ab091ef59d50c5e04b8ef7fdff!@asav-2.01.com>
	<4C1F5D40-2ED1-429B-B6D2-C9F3BC00F95F@pgexperts.com>
Message-ID: <CAEaSS0bYRDMLz6tWw1v77yFPdzc5_+8Qrso3yjLkDrA7BpPp2Q@mail.gmail.com>

On Sun, Feb 16, 2014 at 5:06 PM, Jeff Frost <jeff at pgexperts.com> wrote:

>
> On Feb 16, 2014, at 5:00 PM, Tory M Blue <tmblue at gmail.com> wrote:
>
> >
> >
> >
> > As can be seen the connection is reaped, slon/postgres continue on their
> way, it's not until the next data copy is required that it finds it's
> connection is no longer there. Why it can't recreate a conneciton as one
> would do if they stopped and started slon is kind of beyond me.  Just not
> 100% sure where it's being killed.
> >
>
> Because the initial sync must be done as a single transaction.
>
>
> >
> > 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: 7183.069 seconds to
> copy table "tracking"."spotlightimp"
> > 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: copy table
> "tracking"."adimp"
> > 2014-02-16 16:40:46 PST CONFIG remoteWorkerThread_1: Begin COPY of table
> "tracking"."adimp"
> > 2014-02-16 16:40:46 PST ERROR  remoteWorkerThread_1: "select
> "_cls".copyFields(19);"
> > 2014-02-16 16:40:46 PST WARN   remoteWorkerThread_1: data copy for set 2
> failed 1 times - sleep 15 seconds
> > NOTICE:  Slony-I: Logswitch to sl_log_2 initiated
> > CONTEXT:  SQL statement "SELECT "_cls".logswitch_start()"
> > PL/pgSQL function _cls.cleanupevent(interval) line 96 at PERFORM
> > 2014-02-16 16:40:49 PST INFO   cleanupThread: 6541.365 seconds for
> cleanupEvent()
> >
> >
> > Am I doing this wrong? figured that since I've seen connections at 15
> minutes of processing complete fine, I thought that 30 minutes is more then
> enough. So send the first hey are you still there at 15 minutes then
> continue with them every 5 minutes, for a count of 30.
> >
> > But the above seems to have been reaped in the 20 minute area..
> >
> > net.ipv4.tcp_keepalive_time = 600
> > net.ipv4.tcp_keepalive_probes = 30
> > net.ipv4.tcp_keepalive_intvl = 300
>
>
> Set it so that it's sending keepalives every 30 seconds.
>
> Something like this:
>
> net.ipv4.tcp_keepalive_time = 30
> net.ipv4.tcp_keepalive_probes = 10
> net.ipv4.tcp_keepalive_intvl = 30
>
> What version of slony are you using?  You may need to specifically enabled
> keepalive.
>
>
>
Slony 2.1.3

I've actually got it working, some tuning  (Sorry Jen, did it in the
kernel) and found that my vpn tunnel was set to a 30 minute timeout, so
bumped that to 120 minutes) and so far things seem to be working), took me
a long time to get this far, but I appreciate the assistance.

I'll look at the settings inside slony vs the kernel, just in case I wanted
to sync to the moon :)))

Thanks again

Tory
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140221/0edfca8e/attachment.htm 

