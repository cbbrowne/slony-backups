From david at fetter.org  Fri Feb  7 16:35:56 2014
From: david at fetter.org (David Fetter)
Date: Fri, 7 Feb 2014 16:35:56 -0800
Subject: [Slony1-general] Adding triggers to tables in a replication set
Message-ID: <20140208003556.GA23458@fetter.org>

Folks,

I'm about to embark on a new thing: auditing.  In order to get this
auditing actually done, I'll be using an extension I've written
https://github.com/disqus/pg_audit

The extension generates some triggers on tables in an extant
replication set, which triggers should fire on the origin.  What
I'd like to figure out is how to add the auditing stuff on replicas,
as the triggers should not fire there, or at least not until same gets
promoted to origin.

Any tips as to how generally to add triggers across an existing
replication set?

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From steve at ssinger.info  Sat Feb  8 09:23:55 2014
From: steve at ssinger.info (Steve Singer)
Date: Sat, 8 Feb 2014 12:23:55 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <20140208003556.GA23458@fetter.org>
References: <20140208003556.GA23458@fetter.org>
Message-ID: <BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>

On Fri, 7 Feb 2014, David Fetter wrote:

> Folks,
>
> I'm about to embark on a new thing: auditing.  In order to get this
> auditing actually done, I'll be using an extension I've written
> https://github.com/disqus/pg_audit
>
> The extension generates some triggers on tables in an extant
> replication set, which triggers should fire on the origin.  What
> I'd like to figure out is how to add the auditing stuff on replicas,
> as the triggers should not fire there, or at least not until same gets
> promoted to origin.
>
> Any tips as to how generally to add triggers across an existing
> replication set?
>

Just add the triggers to your tables as you normally would on all nodes. By 
default the triggers will fire on the origin but not fire on the replica when 
session_replication_role is replica (which it is when slon pushes stuff).

http://www.slony.info/documentation/2.2/triggers.html




> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From vivek at khera.org  Tue Feb 11 17:46:26 2014
From: vivek at khera.org (Vick Khera)
Date: Tue, 11 Feb 2014 20:46:26 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
Message-ID: <CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>

On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info> wrote:

> Just add the triggers to your tables as you normally would on all nodes.


Which is to say using slonik to run the SQL script that will add them.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140211/751d6a9d/attachment.htm 

From david at fetter.org  Tue Feb 11 19:27:06 2014
From: david at fetter.org (David Fetter)
Date: Tue, 11 Feb 2014 19:27:06 -0800
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
Message-ID: <20140212032706.GA18036@fetter.org>

On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
> On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info> wrote:
> 
> > Just add the triggers to your tables as you normally would on all nodes.
> 
> Which is to say using slonik to run the SQL script that will add them.

Thanks for clarifying that.  It's kinda important :)

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From ssinger at ca.afilias.info  Tue Feb 11 19:37:52 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Tue, 11 Feb 2014 22:37:52 -0500
Subject: [Slony1-general] Slony 2.2.2  released
Message-ID: <52FAEC90.4000109@ca.afilias.info>

The slony team is pleased to announce a bug-fix release for the 2.2
version of the slony replication system.  Slony 2.2.2
addresses a number
of bugs including:


     Bug 327 - Fix invalid free() in the logApply trigger

     Include server include paths on --with-pgport builds for slonik

Bug 327 can cause replication to not work properly for some users of 
slony 2.2.0 and 2.2.1.

Users of Slony 2.2.0  or 2.2.1 are encouraged to upgrade.  Users who are 
upgrading
from versions earlier than 2.2.0 should upgrade to version 2.2.2 instead
of 2.2.0

You can download Slony 2.2.2 at the following
http://lists.slony.info/downloads/2.2/source/slony1-2.2.2.tar.bz2

From steve at ssinger.info  Wed Feb 12 04:17:51 2014
From: steve at ssinger.info (Steve Singer)
Date: Wed, 12 Feb 2014 07:17:51 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <20140212032706.GA18036@fetter.org>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
	<20140212032706.GA18036@fetter.org>
Message-ID: <BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>

On Tue, 11 Feb 2014, David Fetter wrote:

> On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
>> On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info> wrote:
>>
>>> Just add the triggers to your tables as you normally would on all nodes.
>>
>> Which is to say using slonik to run the SQL script that will add them.
>
> Thanks for clarifying that.  It's kinda important :)

You can add the triggers via slonik EXECUTE SCRIPT, but in most cases you 
can also add the triggers to all nodes directly with psql.

With the psql method the triggers get added to all nodes immedately, even if 
the node is behind in replication.  With a origin only trigger this 
shouldn't make a difference.  If the trigger does stuff on replicas then 
this is more of an issue.



>
> Cheers,
> David.
> -- 
> David Fetter <david at fetter.org> http://fetter.org/
> Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
> Skype: davidfetter      XMPP: david.fetter at gmail.com
> iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics
>
> Remember to vote!
> Consider donating to Postgres: http://www.postgresql.org/about/donate
>


From david at fetter.org  Wed Feb 12 06:51:34 2014
From: david at fetter.org (David Fetter)
Date: Wed, 12 Feb 2014 06:51:34 -0800
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
	<20140212032706.GA18036@fetter.org>
	<BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>
Message-ID: <20140212145134.GD18036@fetter.org>

On Wed, Feb 12, 2014 at 07:17:51AM -0500, Steve Singer wrote:
> On Tue, 11 Feb 2014, David Fetter wrote:
> 
> >On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
> >>On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info>
> >>wrote:
> >>
> >>>Just add the triggers to your tables as you normally would on all
> >>>nodes.
> >>
> >>Which is to say using slonik to run the SQL script that will add
> >>them.
> >
> >Thanks for clarifying that.  It's kinda important :)
> 
> You can add the triggers via slonik EXECUTE SCRIPT, but in most
> cases you can also add the triggers to all nodes directly with psql.

In what cases can't I do this?  Given our volume, I'm not a huge fan
of the size of the lock EXECUTE SCRIPT might take.

> With the psql method the triggers get added to all nodes immedately,
> even if the node is behind in replication.  With a origin only
> trigger this shouldn't make a difference.  If the trigger does stuff
> on replicas then this is more of an issue.

The trigger only does stuff on a replica if that replica takes over as
origin.

Cheers,
David.
-- 
David Fetter <david at fetter.org> http://fetter.org/
Phone: +1 415 235 3778  AIM: dfetter666  Yahoo!: dfetter
Skype: davidfetter      XMPP: david.fetter at gmail.com
iCal: webcal://www.tripit.com/feed/ical/people/david74/tripit.ics

Remember to vote!
Consider donating to Postgres: http://www.postgresql.org/about/donate

From efraindector at motumweb.com  Wed Feb 12 11:50:58 2014
From: efraindector at motumweb.com (=?ISO-8859-1?Q?Efra=EDn_D=E9ctor?=)
Date: Wed, 12 Feb 2014 13:50:58 -0600
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver are
 not found in the includeserverdir.
Message-ID: <52FBD0A2.7030501@motumweb.com>

Hello.

I am trying to setup Slony 2.2.2 on a FreeBSD 10 Release box running 
Postgresql 9.2.6. However I cant compile Slony because I get the 
following error with the command ./configure:

configure: error: Headers for libpqserver are not found in the 
includeserverdir.
     This is the path to postgres.h. Please specify the includeserverdir 
with
     --with-pgincludeserverdir=<dir>

The directory in question is /usr/local/include/postgresql/server I 
checked and the file postgres.h is available. Using 
--with-pgincludeserverdir doesn't help because the error still shows.

With Slony 2.1.4 I can make ./configure without errors.

Can you guys please point me in the right direction?.

Thank you very much in advance.



From ssinger at ca.afilias.info  Wed Feb 12 13:10:02 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 12 Feb 2014 16:10:02 -0500
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBD0A2.7030501@motumweb.com>
References: <52FBD0A2.7030501@motumweb.com>
Message-ID: <52FBE32A.3080200@ca.afilias.info>

On 02/12/2014 02:50 PM, Efra?n D?ctor wrote:
> Hello.

Does ./configure --with-pgconfigdir= /your_pgconfig_dir_directory

make things better?



>
> I am trying to setup Slony 2.2.2 on a FreeBSD 10 Release box running
> Postgresql 9.2.6. However I cant compile Slony because I get the
> following error with the command ./configure:
>
> configure: error: Headers for libpqserver are not found in the
> includeserverdir.
>       This is the path to postgres.h. Please specify the includeserverdir
> with
>       --with-pgincludeserverdir=<dir>
>
> The directory in question is /usr/local/include/postgresql/server I
> checked and the file postgres.h is available. Using
> --with-pgincludeserverdir doesn't help because the error still shows.
>
> With Slony 2.1.4 I can make ./configure without errors.
>
> Can you guys please point me in the right direction?.
>
> Thank you very much in advance.
>
>
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From efraindector at motumweb.com  Wed Feb 12 13:37:24 2014
From: efraindector at motumweb.com (=?ISO-8859-1?Q?Efra=EDn_D=E9ctor?=)
Date: Wed, 12 Feb 2014 15:37:24 -0600
Subject: [Slony1-general] Slony 2.2.2: Error: Headers for libpqserver
 are not found in the includeserverdir.
In-Reply-To: <52FBE32A.3080200@ca.afilias.info>
References: <52FBD0A2.7030501@motumweb.com> <52FBE32A.3080200@ca.afilias.info>
Message-ID: <52FBE994.8020307@motumweb.com>

El 12/02/2014 03:10 p.m., Steve Singer escribi?:
>
> Does ./configure --with-pgconfigdir= /your_pgconfig_dir_directory
>
> make things better?
>

Hello.

I just tried it and it didn't help.

Thank you veru much.

From matthewh at telenav.com  Wed Feb 12 15:14:17 2014
From: matthewh at telenav.com (Hanselman, Matthew)
Date: Wed, 12 Feb 2014 23:14:17 +0000
Subject: [Slony1-general] How should I design this: DDL access segmentation?
Message-ID: <4196195759a441f3b99220561a68cc1d@BN1PR07MB150.namprd07.prod.outlook.com>

How should I design this, if it's possible?

The high-level requirement is: we need a way to isolate DDL changes and control them more tightly than data changes. We have a source database where we trust devs to alter any & all data they want real-time, but we need to enforce that DDL changes can't go live without a DBA getting involved.

This would meet our needs, if it worked: set up two Slony clusters. Given a path of nodes A -> B -> C, you could have a cluster that replicates A -> B, and another that would replicate B -> C. If you trigger a DDL change on A, it'll stop at B and require access to the slonik on B to trigger the DDL change to C.

I tried to set this up, though, and it didn't work. The initial copy of data would propagate to node C, but any further changes to data on A wouldn't propagate (it'd stop at B).

Does our (admittedly obtuse) requirement make sense? Can you think of a way to meet that requirement with Slony?

Thanks!

- Matt

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20140212/c4e9ec90/attachment.htm 

From ahodgson at simkin.ca  Wed Feb 12 15:40:51 2014
From: ahodgson at simkin.ca (Alan Hodgson)
Date: Wed, 12 Feb 2014 15:40:51 -0800
Subject: [Slony1-general] How should I design this: DDL access
	segmentation?
In-Reply-To: <4196195759a441f3b99220561a68cc1d@BN1PR07MB150.namprd07.prod.outlook.com>
References: <4196195759a441f3b99220561a68cc1d@BN1PR07MB150.namprd07.prod.outlook.com>
Message-ID: <3025953.pHS84I1J46@skynet.simkin.ca>

On Wednesday, February 12, 2014 11:14:17 PM Hanselman, Matthew wrote:
> The high-level requirement is: we need a way to isolate DDL changes and
> control them more tightly than data changes. 

Well, the right answer is, don't give devs the privileges needed to make DDL 
changes. 

If you're using Slony you probably need to do this anyway just to prevent them 
from making DDL changes directly, and to keep them from running ORM 
migrations. If your devs do currently have this access, you should check the 
schema differences between the master and slaves and find out what all they've 
already broken.

But yeah I don't think Slony will do what you're asking, regardless. You can't 
make data and schema changes happen out of order.

From ssinger at ca.afilias.info  Wed Feb 12 19:36:54 2014
From: ssinger at ca.afilias.info (Steve Singer)
Date: Wed, 12 Feb 2014 22:36:54 -0500
Subject: [Slony1-general] Adding triggers to tables in a replication set
In-Reply-To: <20140212145134.GD18036@fetter.org>
References: <20140208003556.GA23458@fetter.org>
	<BLU0-SMTP54E045C3AE7C430D19414EDC960@phx.gbl>
	<CALd+dce1Pci+-WF+6HygD1Gwti3-rbNYxOyDBmRn1DUD5PfZfQ@mail.gmail.com>
	<20140212032706.GA18036@fetter.org>
	<BLU0-SMTP4662AE1550F7944CE531505DC920@phx.gbl>
	<20140212145134.GD18036@fetter.org>
Message-ID: <52FC3DD6.4000901@ca.afilias.info>

On 02/12/2014 09:51 AM, David Fetter wrote:
> On Wed, Feb 12, 2014 at 07:17:51AM -0500, Steve Singer wrote:
>> On Tue, 11 Feb 2014, David Fetter wrote:
>>
>>> On Tue, Feb 11, 2014 at 08:46:26PM -0500, Vick Khera wrote:
>>>> On Sat, Feb 8, 2014 at 12:23 PM, Steve Singer <steve at ssinger.info>
>>>> wrote:
>>>>
>>>>> Just add the triggers to your tables as you normally would on all
>>>>> nodes.
>>>>
>>>> Which is to say using slonik to run the SQL script that will add
>>>> them.
>>>
>>> Thanks for clarifying that.  It's kinda important :)
>>
>> You can add the triggers via slonik EXECUTE SCRIPT, but in most
>> cases you can also add the triggers to all nodes directly with psql.
>
> In what cases can't I do this?  Given our volume, I'm not a huge fan
> of the size of the lock EXECUTE SCRIPT might take.
>

I don't think modern execute script (ie in 2.1 or 2.2) takes out much 
locking other than what your DDL is already doing.  (I think adding the 
trigger to a table requires a heavy lock on that table anyway)

If the trigger is configured to run on a replica then you can't do it 
with psql on a live system becaues the trigger might get added (and run) 
at a different point in the replication stream on different replicas vs 
the origin (unless your doing something to prevent this, like stopping 
inserts on your table by shutting down stuff)

In cases where the trigger is disabled on the replica then the only time 
I think not using execute script would be a problem is when you have 
other DDL changes pending via execute script

Ie if you create the table via EXECUTE SCRIPT, but then use psql to add 
the the trigger to the table on a replica BEFORE the execute script that 
adds the table runs on that replica you will have a problem.



>> With the psql method the triggers get added to all nodes immedately,
>> even if the node is behind in replication.  With a origin only
>> trigger this shouldn't make a difference.  If the trigger does stuff
>> on replicas then this is more of an issue.
>
> The trigger only does stuff on a replica if that replica takes over as
> origin.
>
> Cheers,
> David.
>


