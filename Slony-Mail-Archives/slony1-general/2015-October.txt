From ssinger at ca.afilias.info  Thu Oct  1 08:58:15 2015
From: ssinger at ca.afilias.info (Steve Singer)
Date: Thu, 01 Oct 2015 11:58:15 -0400
Subject: [Slony1-general] slony and bdr
In-Reply-To: <560BEB88.3080308@adyen.com>
References: <mailman.4236.1443568745.4871.slony1-general@lists.slony.info>
	<560BEB88.3080308@adyen.com>
Message-ID: <560D5817.8040609@ca.afilias.info>

On 09/30/2015 10:02 AM, Ger Timmens wrote:
> Hi,
>
> To get slony replicating again when using postgresql bdr we'll need
> primary keys added to the slony tables. At least:
>
> ALTER TABLE _slony_cluster.sl_apply_stats ADD PRIMARY KEY (as_origin);
>
> But there are maybe more. Can we add those PK's to the next patch ?
>

sl_confirm
sl_setsync
sl_log_1
sl_log_2
sl_log_script
sl_archive_counter
sl_event_lock
sl_components

are all missing primary keys.


Can anyone think of a reason why these tables shouldn't have a primary key?



> Kind Regards,
>
> P.S. Using postgresql 0.9.4/bdr 0.9.2/slony 2.2.4
> _______________________________________________
> Slony1-general mailing list
> Slony1-general at lists.slony.info
> http://lists.slony.info/mailman/listinfo/slony1-general
>


From sungh.lei at gmail.com  Fri Oct  9 20:34:23 2015
From: sungh.lei at gmail.com (Sung Hsin Lei)
Date: Fri, 9 Oct 2015 23:34:23 -0400
Subject: [Slony1-general] Slony Replication Startup Speed
Message-ID: <CAHD_kvnWruCyJsX_=xFHMiWkvxahY1U0wLtKpRonCLAHBAUQag@mail.gmail.com>

Hello,

I have a 10gig database on the Master which I backed up and restored on the
Slave. Database activity is low. When I setup Slony replication from the
Master to the Slave, it would take hours before new information from the
Master would be updated into the Slave. Postgres would be also VERY slow
for the first few hours. However, after the initial wait period, the Slave
would update within a second or so and Postgres speed would return to
normal. I'm assuming that Slony is taking time to verify the initial
database integrity between the Master and the Slave. Am i right? I would
like to know if there's a way to have the updates start within the first
few minutes of the original setup.


Thanks.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20151009/cb7d99cb/attachment.htm 

From scott.marlowe at gmail.com  Fri Oct  9 21:50:21 2015
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Fri, 9 Oct 2015 22:50:21 -0600
Subject: [Slony1-general] Slony Replication Startup Speed
In-Reply-To: <CAHD_kvnWruCyJsX_=xFHMiWkvxahY1U0wLtKpRonCLAHBAUQag@mail.gmail.com>
References: <CAHD_kvnWruCyJsX_=xFHMiWkvxahY1U0wLtKpRonCLAHBAUQag@mail.gmail.com>
Message-ID: <CAOR=d=01EHSAEm80iFyQBbqzFkHrf8e6WZnVOhS9yZnL7ER27g@mail.gmail.com>

On Fri, Oct 9, 2015 at 9:34 PM, Sung Hsin Lei <sungh.lei at gmail.com> wrote:
> Hello,
>
> I have a 10gig database on the Master which I backed up and restored on the
> Slave. Database activity is low. When I setup Slony replication from the
> Master to the Slave, it would take hours before new information from the
> Master would be updated into the Slave. Postgres would be also VERY slow for
> the first few hours. However, after the initial wait period, the Slave would
> update within a second or so and Postgres speed would return to normal. I'm
> assuming that Slony is taking time to verify the initial database integrity
> between the Master and the Slave. Am i right? I would like to know if
> there's a way to have the updates start within the first few minutes of the
> original setup.

In a normal slony sub, all you need on the slave is the schema. If
there's data there it'll get truncated / deleted, so there's no reason
to spend time copying it over.

IF and only IF you are willing to take your master offline from your
application (i.e. stop writes going to it) you can copy over the data
and then subscribe with no copy. If the master is not taken "offline"
from an application perspective then a subscribe with no copy will
result in your master and slave not having the same data (which is
bad).

From sungh.lei at gmail.com  Fri Oct  9 22:09:07 2015
From: sungh.lei at gmail.com (Sung Hsin Lei)
Date: Sat, 10 Oct 2015 01:09:07 -0400
Subject: [Slony1-general] Slony Replication Startup Speed
In-Reply-To: <CAOR=d=01EHSAEm80iFyQBbqzFkHrf8e6WZnVOhS9yZnL7ER27g@mail.gmail.com>
References: <CAHD_kvnWruCyJsX_=xFHMiWkvxahY1U0wLtKpRonCLAHBAUQag@mail.gmail.com>
	<CAOR=d=01EHSAEm80iFyQBbqzFkHrf8e6WZnVOhS9yZnL7ER27g@mail.gmail.com>
Message-ID: <CAHD_kvkNTx7zm2fmiJGYO96x9OT21kcsLa7JM=vmj6ekzn5+hw@mail.gmail.com>

Thanks for the response.

How about when you change the db schema such as adding/removing/renaming
tables, columns and dependencies? We usually stop the replication, delete
the cluster from both Master and Slave, make the changes on both Master and
Slave and run the setup from scratch. This would also freeze postgres and
take several hours for replication to start. Isn't there a way to make it
faster considering that all data is already in the Slave?

Also, how do you subscribe with no copy?



On Sat, Oct 10, 2015 at 12:50 AM, Scott Marlowe <scott.marlowe at gmail.com>
wrote:

> On Fri, Oct 9, 2015 at 9:34 PM, Sung Hsin Lei <sungh.lei at gmail.com> wrote:
> > Hello,
> >
> > I have a 10gig database on the Master which I backed up and restored on
> the
> > Slave. Database activity is low. When I setup Slony replication from the
> > Master to the Slave, it would take hours before new information from the
> > Master would be updated into the Slave. Postgres would be also VERY slow
> for
> > the first few hours. However, after the initial wait period, the Slave
> would
> > update within a second or so and Postgres speed would return to normal.
> I'm
> > assuming that Slony is taking time to verify the initial database
> integrity
> > between the Master and the Slave. Am i right? I would like to know if
> > there's a way to have the updates start within the first few minutes of
> the
> > original setup.
>
> In a normal slony sub, all you need on the slave is the schema. If
> there's data there it'll get truncated / deleted, so there's no reason
> to spend time copying it over.
>
> IF and only IF you are willing to take your master offline from your
> application (i.e. stop writes going to it) you can copy over the data
> and then subscribe with no copy. If the master is not taken "offline"
> from an application perspective then a subscribe with no copy will
> result in your master and slave not having the same data (which is
> bad).
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://lists.slony.info/pipermail/slony1-general/attachments/20151010/a5397825/attachment.htm 

From scott.marlowe at gmail.com  Fri Oct  9 23:51:26 2015
From: scott.marlowe at gmail.com (Scott Marlowe)
Date: Sat, 10 Oct 2015 00:51:26 -0600
Subject: [Slony1-general] Slony Replication Startup Speed
In-Reply-To: <CAHD_kvkNTx7zm2fmiJGYO96x9OT21kcsLa7JM=vmj6ekzn5+hw@mail.gmail.com>
References: <CAHD_kvnWruCyJsX_=xFHMiWkvxahY1U0wLtKpRonCLAHBAUQag@mail.gmail.com>
	<CAOR=d=01EHSAEm80iFyQBbqzFkHrf8e6WZnVOhS9yZnL7ER27g@mail.gmail.com>
	<CAHD_kvkNTx7zm2fmiJGYO96x9OT21kcsLa7JM=vmj6ekzn5+hw@mail.gmail.com>
Message-ID: <CAOR=d=3m8HwyzDLdpwq9d6Ptfc8A_-BVUB5PeZECFAkcFwJAWg@mail.gmail.com>

On Fri, Oct 9, 2015 at 11:09 PM, Sung Hsin Lei <sungh.lei at gmail.com> wrote:
>
>
> On Sat, Oct 10, 2015 at 12:50 AM, Scott Marlowe <scott.marlowe at gmail.com>
> wrote:
>>
>> On Fri, Oct 9, 2015 at 9:34 PM, Sung Hsin Lei <sungh.lei at gmail.com> wrote:
>> > Hello,
>> >
>> > I have a 10gig database on the Master which I backed up and restored on
>> > the
>> > Slave. Database activity is low. When I setup Slony replication from the
>> > Master to the Slave, it would take hours before new information from the
>> > Master would be updated into the Slave. Postgres would be also VERY slow
>> > for
>> > the first few hours. However, after the initial wait period, the Slave
>> > would
>> > update within a second or so and Postgres speed would return to normal.
>> > I'm
>> > assuming that Slony is taking time to verify the initial database
>> > integrity
>> > between the Master and the Slave. Am i right? I would like to know if
>> > there's a way to have the updates start within the first few minutes of
>> > the
>> > original setup.
>>
>> In a normal slony sub, all you need on the slave is the schema. If
>> there's data there it'll get truncated / deleted, so there's no reason
>> to spend time copying it over.
>>
>> IF and only IF you are willing to take your master offline from your
>> application (i.e. stop writes going to it) you can copy over the data
>> and then subscribe with no copy. If the master is not taken "offline"
>> from an application perspective then a subscribe with no copy will
>> result in your master and slave not having the same data (which is
>> bad).
>
>
> Thanks for the response.
>
> How about when you change the db schema such as adding/removing/renaming
> tables, columns and dependencies? We usually stop the replication, delete
> the cluster from both Master and Slave, make the changes on both Master and
> Slave and run the setup from scratch. This would also freeze postgres and
> take several hours for replication to start. Isn't there a way to make it
> faster considering that all data is already in the Slave?

Yes, what you are looking for is the EXECUTE SCRIPT command. See this page:
http://slony.info/adminguide/2.2/doc/adminguide/stmtddlscript.html

>
> Also, how do you subscribe with no copy?
>

There's an argument for the slonik subscribe command called "omit copy". See:
http://slony.info/adminguide/2.2/doc/adminguide/stmtsubscribeset.html

Note that all of this assumes you're running slony 2.2.latest. If
you're running on slony 1.2 etc PLEASE consider upgrading.

From dkg at fifthhorseman.net  Sun Oct 11 12:58:40 2015
From: dkg at fifthhorseman.net (Daniel Kahn Gillmor)
Date: Sun, 11 Oct 2015 15:58:40 -0400
Subject: [Slony1-general] adding a replication node instructions update?
Message-ID: <87d1wltbwv.fsf@alice.fifthhorseman.net>

hey slony people--

http://www.slony.info/documentation/2.0/administration.html#AEN697

says:

> 3.1.4. Adding a Replication Node
> 
> To add a node to the replication cluster you should
> 
>     Create a database for the node and install your application schema in it.
> 
>     createdb -h $NEWSLAVE_HOST $SLAVEDB
>     pg_dump -h $MASTER_HOST -s $MASTERDB | psql -h $NEWSLAVE_HOST $SLAVEDB

however, this step seems like it's not quite right.

in particular, this step appears to copy the master's replication
namespace into the new replication database.  This causes the subsequent
STORE NODE command to fail with a complaint that the _$CLUSTER_NAME
schema is already present.

I think if you add -N _$CLUSTERNAME to the pg_dump side of the pipeline,
then the rest of the directions should complete OK.

Is this a bug in the documentation, or have i misunderstood something?

Regards,

   --dkg

From cs_dba at consistentstate.com  Wed Oct 28 08:28:30 2015
From: cs_dba at consistentstate.com (CS DBA)
Date: Wed, 28 Oct 2015 09:28:30 -0600
Subject: [Slony1-general] Error when adding a table to replication
Message-ID: <5630E99E.6040209@consistentstate.com>

We're seeing this in the slon logs (we are doing slon archiving as well, 
the slon -a flag):

2015-10-28 07:54:56 PDTDEBUG1 remoteWorkerThread_1: connected to provider DB
2015-10-28 07:54:56 PDTDEBUG2 remoteWorkerThread_1: prepare to copy 
table "abc"."data_set_720"
2015-10-28 07:54:56 PDTDEBUG3 remoteWorkerThread_1: table 
"sch1"."data_set_720" does not require Slony-I serial key
2015-10-28 07:54:56 PDTDEBUG2 remoteWorkerThread_1: all tables for set 
14 found on subscriber
2015-10-28 07:54:56 PDTDEBUG2 remoteWorkerThread_1: copy table 
"sch1"."data_set_720"
2015-10-28 07:54:56 PDTDEBUG3 remoteWorkerThread_1: table 
"sch1"."data_set_720" does not require Slony-I serial key
2015-10-28 07:54:56 PDTDEBUG2 remoteWorkerThread_1: Begin COPY of table 
"sch1"."data_set_720"
2015-10-28 07:54:56 PDTDEBUG2 remoteWorkerThread_1:  nodeon73 is 0
NOTICE:  truncate of "sch1"."data_set_720" succeeded
2015-10-28 07:54:56 PDTERROR  remoteWorkerThread_1: Cannot write to 
archive file 
/usr/local/pgsql/slon_logs/slony1_log_2_00000000000001552202.sql.tmp - 
not open
2015-10-28 07:54:56 PDTWARN   remoteWorkerThread_1: data copy for set 14 
failed 1103 times - sleep 60 seconds
2015-10-28 07:55:04 PDTDEBUG2 remoteListenThread_1: queue event 
1,1587129 SYNC


The archive dir is writable by postgres and the file perms are:
ls -l /usr/local/pgsql/slon_logs/slony1_log_2_00000000000001552202.sql.tmp
-rw-r--r-- 1 postgres postgres 504 2015-10-27 13:18 
/usr/local/pgsql/slon_logs/slony1_log_2_00000000000001552202.sql.tmp


Thoughts?

Thanks in advance




